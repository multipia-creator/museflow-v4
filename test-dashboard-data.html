<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Data Test - MuseFlow</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .section { margin-bottom: 30px; padding: 20px; background: #2a2a2a; border-radius: 8px; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        pre { background: #0a0a0a; padding: 10px; border-radius: 4px; overflow-x: auto; }
        h2 { color: #8b5cf6; }
        .stat { display: inline-block; margin: 10px 20px 10px 0; padding: 10px 20px; background: #3a3a3a; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ” MuseFlow Dashboard Data Test</h1>
    
    <div class="section">
        <h2>1. API Connection Test</h2>
        <div id="api-test">Testing...</div>
    </div>

    <div class="section">
        <h2>2. Projects Data</h2>
        <div id="projects-data">Loading...</div>
    </div>

    <div class="section">
        <h2>3. Performance Metrics Calculation</h2>
        <div id="metrics-calc">Calculating...</div>
    </div>

    <div class="section">
        <h2>4. Team Activity Data</h2>
        <div id="team-activity">Loading...</div>
    </div>

    <div class="section">
        <h2>5. Dashboard Sections Visibility</h2>
        <div id="sections-check">Checking...</div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let token = localStorage.getItem('authToken') || localStorage.getItem('museflow_token');
        if (!token) {
            token = 'demo-token-12345';
            localStorage.setItem('museflow_token', token);
        }

        async function testAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/projects`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    document.getElementById('api-test').innerHTML = `<span class="error">âŒ API Error: ${response.status}</span>`;
                    return null;
                }
                
                const data = await response.json();
                document.getElementById('api-test').innerHTML = `
                    <span class="success">âœ… API Connected</span><br>
                    <span class="stat">Projects: ${data.projects.length}</span>
                    <span class="stat">Success: ${data.success}</span>
                `;
                return data.projects;
            } catch (error) {
                document.getElementById('api-test').innerHTML = `<span class="error">âŒ Error: ${error.message}</span>`;
                return null;
            }
        }

        async function testProjectsData(projects) {
            if (!projects) {
                document.getElementById('projects-data').innerHTML = '<span class="error">âŒ No projects data</span>';
                return;
            }

            const summary = projects.slice(0, 3).map(p => `
                <div style="margin: 10px 0; padding: 10px; background: #0a0a0a; border-radius: 4px;">
                    <strong>${p.title}</strong><br>
                    Task Count: ${p.task_count || 0} | Completed: ${p.completed_tasks || 0}<br>
                    Budget: ${(p.budget_total || 0).toLocaleString()} / Used: ${(p.budget_used || 0).toLocaleString()}
                </div>
            `).join('');

            document.getElementById('projects-data').innerHTML = `
                <span class="success">âœ… ${projects.length} Projects Loaded</span><br>
                ${summary}
            `;
        }

        async function testMetrics(projects) {
            if (!projects) {
                document.getElementById('metrics-calc').innerHTML = '<span class="error">âŒ No data for metrics</span>';
                return;
            }

            const totalTasks = projects.reduce((sum, p) => sum + (p.task_count || 0), 0);
            const completedTasks = projects.reduce((sum, p) => sum + (p.completed_tasks || 0), 0);
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            const totalBudget = projects.reduce((sum, p) => sum + (p.budget_total || 0), 0);
            const usedBudget = projects.reduce((sum, p) => sum + (p.budget_used || 0), 0);
            const budgetRate = totalBudget > 0 ? Math.round((usedBudget / totalBudget) * 100) : 0;

            document.getElementById('metrics-calc').innerHTML = `
                <span class="success">âœ… Metrics Calculated</span><br>
                <div class="stat">
                    <strong>ì‘ì—… ì™„ë£Œìœ¨</strong><br>
                    ${completedTasks} / ${totalTasks} = ${completionRate}%
                </div>
                <div class="stat">
                    <strong>ì˜ˆì‚° ì§‘í–‰ë¥ </strong><br>
                    ${usedBudget.toLocaleString()} / ${totalBudget.toLocaleString()} = ${budgetRate}%
                </div>
                <div class="stat">
                    <strong>í‰ê·  ì‘ì—… ì‹œê°„</strong><br>
                    ${24 + Math.floor(Math.random() * 24)} ì‹œê°„
                </div>
                <div class="stat">
                    <strong>íŒ€ í˜‘ì—… í™œë™</strong><br>
                    ${100 + Math.floor(Math.random() * 100)} ê±´
                </div>
            `;
        }

        async function testTeamActivity(projects) {
            const activities = [
                { user: 'ê¹€íë ˆì´í„°', action: 'ì‘í’ˆ ì„ ì • íšŒì˜ ì™„ë£Œ', time: '1ì‹œê°„ ì „', icon: 'âœ…' },
                { user: 'ì´í•™ì˜ˆì‚¬', action: 'ë„ìŠ¨íŠ¸ êµìœ¡ ìë£Œ ì‘ì„± ì¤‘', time: '2ì‹œê°„ ì „', icon: 'ğŸ“' },
                { user: 'ë°•ë””ìì´ë„ˆ', action: 'í¬ìŠ¤í„° ë””ìì¸ ì‹œì•ˆ ì—…ë¡œë“œ', time: '3ì‹œê°„ ì „', icon: 'ğŸ¨' }
            ];

            document.getElementById('team-activity').innerHTML = `
                <span class="success">âœ… Team Activity Ready</span><br>
                ${activities.map(a => `
                    <div style="margin: 10px 0; padding: 10px; background: #0a0a0a; border-radius: 4px;">
                        ${a.icon} <strong>${a.user}</strong>: ${a.action} <span style="color: #888;">(${a.time})</span>
                    </div>
                `).join('')}
            `;
        }

        async function checkDashboardSections() {
            const sections = [
                { name: 'ì„±ê³¼ ì§€í‘œ (Performance Metrics)', selector: '#metric-completion-value' },
                { name: 'ìš°ìˆ˜ ê¸°ì—¬ì (Top Contributors)', text: 'ìš°ìˆ˜ ê¸°ì—¬ì' },
                { name: 'íŒ€ í™œë™ (Team Activity)', selector: '#team-activity' },
                { name: 'ì°¨íŠ¸ ì„¹ì…˜ (Charts)', selector: '#monthlyTrendChart' }
            ];

            const results = sections.map(s => {
                if (s.selector) {
                    const el = parent.document.querySelector(s.selector);
                    return `${s.name}: ${el ? 'âœ… Found' : 'âŒ Missing'}`;
                } else if (s.text) {
                    const found = parent.document.body.textContent.includes(s.text);
                    return `${s.name}: ${found ? 'âœ… Found' : 'âŒ Missing'}`;
                }
            }).join('<br>');

            document.getElementById('sections-check').innerHTML = results || '<span class="warning">âš ï¸ Cannot check (iframe isolation)</span>';
        }

        async function runAllTests() {
            const projects = await testAPI();
            if (projects) {
                await testProjectsData(projects);
                await testMetrics(projects);
                await testTeamActivity(projects);
            }
            await checkDashboardSections();
        }

        runAllTests();
    </script>
</body>
</html>
