<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Behavior Analytics - MuseFlow V4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f9fafb;
            padding: 24px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 32px;
            color: #111827;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 16px;
            color: #6b7280;
            margin-bottom: 32px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .stat-change {
            font-size: 13px;
            font-weight: 600;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 20px;
        }

        .behavior-list {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .behavior-item {
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .behavior-item:last-child {
            border-bottom: none;
        }

        .behavior-type {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .behavior-details {
            font-size: 13px;
            color: #6b7280;
        }

        .behavior-time {
            font-size: 12px;
            color: #9ca3af;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-idle {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-help {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Behavior Analytics</h1>
        <p class="subtitle">ì‚¬ìš©ì í–‰ë™ íŒ¨í„´ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</p>

        <div class="actions">
            <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-secondary" onclick="clearData()">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
            <button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-behaviors">-</div>
                <div class="stat-label">ì´ í–‰ë™ ê¸°ë¡</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="help-offered">-</div>
                <div class="stat-label">ë„ì›€ë§ ì œê³µ íšŸìˆ˜</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="help-accepted">-</div>
                <div class="stat-label">ë„ì›€ë§ ìˆ˜ë½ íšŸìˆ˜</div>
            </div>

            <div class="stat-card">
                <div class="stat-value" id="acceptance-rate">-</div>
                <div class="stat-label">ìˆ˜ë½ë¥ </div>
                <div class="stat-change positive" id="acceptance-change"></div>
            </div>
        </div>

        <!-- Behavior Type Chart -->
        <div class="chart-container">
            <div class="chart-title">í–‰ë™ ìœ í˜•ë³„ ë¶„í¬</div>
            <canvas id="behavior-type-chart" height="100"></canvas>
        </div>

        <!-- Timeline Chart -->
        <div class="chart-container">
            <div class="chart-title">ì‹œê°„ëŒ€ë³„ í™œë™</div>
            <canvas id="timeline-chart" height="100"></canvas>
        </div>

        <!-- Recent Behaviors -->
        <div class="behavior-list">
            <div class="chart-title">ìµœê·¼ í–‰ë™ ê¸°ë¡</div>
            <div id="recent-behaviors">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“­</div>
                    <div>ì•„ì§ ê¸°ë¡ëœ í–‰ë™ì´ ì—†ìŠµë‹ˆë‹¤</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let behaviorTypeChart = null;
        let timelineChart = null;

        // Load and display data
        function loadData() {
            const behaviors = JSON.parse(localStorage.getItem('behavior_data') || '[]');
            
            if (behaviors.length === 0) {
                return;
            }

            // Update stats
            const helpOffered = behaviors.filter(b => b.type === 'help_offered').length;
            const helpAccepted = behaviors.filter(b => b.type === 'help_accepted').length;
            const acceptanceRate = helpOffered > 0 ? (helpAccepted / helpOffered * 100).toFixed(1) : 0;

            document.getElementById('total-behaviors').textContent = behaviors.length;
            document.getElementById('help-offered').textContent = helpOffered;
            document.getElementById('help-accepted').textContent = helpAccepted;
            document.getElementById('acceptance-rate').textContent = acceptanceRate + '%';

            // Render charts
            renderBehaviorTypeChart(behaviors);
            renderTimelineChart(behaviors);

            // Render recent behaviors
            renderRecentBehaviors(behaviors.slice(-20).reverse());
        }

        // Render behavior type chart
        function renderBehaviorTypeChart(behaviors) {
            const typeCounts = {};
            behaviors.forEach(b => {
                typeCounts[b.type] = (typeCounts[b.type] || 0) + 1;
            });

            const sortedTypes = Object.entries(typeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const ctx = document.getElementById('behavior-type-chart').getContext('2d');
            
            if (behaviorTypeChart) {
                behaviorTypeChart.destroy();
            }

            behaviorTypeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedTypes.map(([type]) => formatBehaviorType(type)),
                    datasets: [{
                        label: 'ë°œìƒ íšŸìˆ˜',
                        data: sortedTypes.map(([, count]) => count),
                        backgroundColor: '#4f46e5',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Render timeline chart
        function renderTimelineChart(behaviors) {
            const timeGroups = {};
            behaviors.forEach(b => {
                const hour = new Date(b.timestamp).getHours();
                timeGroups[hour] = (timeGroups[hour] || 0) + 1;
            });

            const hours = Array.from({length: 24}, (_, i) => i);
            const counts = hours.map(h => timeGroups[h] || 0);

            const ctx = document.getElementById('timeline-chart').getContext('2d');
            
            if (timelineChart) {
                timelineChart.destroy();
            }

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [{
                        label: 'í™œë™ ìˆ˜',
                        data: counts,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Render recent behaviors
        function renderRecentBehaviors(behaviors) {
            const container = document.getElementById('recent-behaviors');
            
            if (behaviors.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div>ì•„ì§ ê¸°ë¡ëœ í–‰ë™ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = behaviors.map(b => {
                const badgeClass = getBadgeClass(b.type);
                const time = new Date(b.timestamp).toLocaleTimeString('ko-KR');
                
                return `
                    <div class="behavior-item">
                        <div>
                            <div class="behavior-type">${formatBehaviorType(b.type)}</div>
                            <div class="behavior-details">${formatBehaviorDetails(b)}</div>
                        </div>
                        <div>
                            <span class="badge ${badgeClass}">${b.type}</span>
                            <div class="behavior-time">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format behavior type
        function formatBehaviorType(type) {
            const typeMap = {
                'idle_detected': 'ìœ íœ´ ìƒíƒœ ê°ì§€',
                'stuck_detected': 'ì§„í–‰ ë§‰í˜ ê°ì§€',
                'form_started': 'í¼ ì…ë ¥ ì‹œì‘',
                'form_completed': 'í¼ ì™„ë£Œ',
                'form_abandoned': 'í¼ ì´íƒˆ',
                'validation_error': 'ê²€ì¦ ì˜¤ë¥˜',
                'high_correction_rate': 'ë†’ì€ ìˆ˜ì •ë¥ ',
                'help_offered': 'ë„ì›€ë§ ì œê³µ',
                'help_accepted': 'ë„ì›€ë§ ìˆ˜ë½',
                'help_dismissed': 'ë„ì›€ë§ ê±°ë¶€',
                'page_change': 'í˜ì´ì§€ ë³€ê²½',
                'runtime_error': 'ëŸ°íƒ€ì„ ì˜¤ë¥˜',
                'api_error': 'API ì˜¤ë¥˜'
            };
            return typeMap[type] || type;
        }

        // Format behavior details
        function formatBehaviorDetails(behavior) {
            const page = behavior.page || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const step = behavior.step ? ` (Step ${behavior.step})` : '';
            return `í˜ì´ì§€: ${page}${step}`;
        }

        // Get badge class
        function getBadgeClass(type) {
            if (type.includes('idle') || type.includes('stuck')) return 'badge-idle';
            if (type.includes('error')) return 'badge-error';
            if (type.includes('help')) return 'badge-help';
            if (type.includes('completed')) return 'badge-success';
            return '';
        }

        // Refresh data
        function refreshData() {
            loadData();
        }

        // Clear data
        function clearData() {
            if (confirm('ëª¨ë“  í–‰ë™ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('behavior_data');
                location.reload();
            }
        }

        // Export data
        function exportData() {
            const behaviors = JSON.parse(localStorage.getItem('behavior_data') || '[]');
            
            if (behaviors.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Convert to CSV
            const headers = ['Timestamp', 'Type', 'Page', 'Step', 'Details'];
            const rows = behaviors.map(b => {
                const time = new Date(b.timestamp).toISOString();
                const details = JSON.stringify(b).replace(/,/g, ';');
                return [time, b.type, b.page || '', b.step || '', details];
            });

            const csv = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `behavior_data_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
    </script>
</body>
</html>
