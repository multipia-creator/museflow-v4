<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas - MuseFlow</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js for Chart Nodes -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Dashboard Design System -->
    <link href="/static/css/design-system.css" rel="stylesheet">
    <link href="/static/css/unified-navbar.css" rel="stylesheet">
    
    <style>
        /* ===============================================
           MuseFlow Canvas V3 - Hybrid UX + Dashboard Integration
           Floating Toolbar + Role-based Widget System + Unified Navbar
           =============================================== */
        
        /* Override for Canvas-specific layout with Compact Header */
        body {
            padding-top: 44px; /* Space for compact header (64px reduced to 44px) */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Colors */
            --bg-primary: #FFFFFF;
            --bg-secondary: #F5F5F5;
            --bg-tertiary: #FAFAFA;
            
            --border-primary: #E5E5E5;
            --border-secondary: #DADADA;
            --border-hover: #C4C4C4;
            
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            
            /* Default Theme: Curator (Purple) */
            --accent-primary: #8B5CF6;
            --accent-hover: #7C3AED;
            --accent-light: #EDE9FE;
            
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
        }
        
        /* Role-based Color Themes */
        body[data-role="curator"] {
            --accent-primary: #8B5CF6;
            --accent-hover: #7C3AED;
            --accent-light: #EDE9FE;
        }
        
        body[data-role="educator"] {
            --accent-primary: #3B82F6;
            --accent-hover: #2563EB;
            --accent-light: #DBEAFE;
        }
        
        body[data-role="admin"] {
            --accent-primary: #10B981;
            --accent-hover: #059669;
            --accent-light: #D1FAE5;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.16);
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 24px;
            
            /* Animation */
            --transition-fast: 0.15s ease;
            --transition-base: 0.2s ease;
            --transition-slow: 0.3s ease;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* ===============================================
           Layout
           =============================================== */
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 44px);
            width: 100vw;
            margin-top: 0;
        }
        
        /* Compact Breadcrumb */
        .breadcrumb-compact {
            font-size: 11px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 500px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .breadcrumb-compact a {
            color: var(--text-tertiary);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb-compact a:hover {
            color: var(--accent-primary);
        }
        
        .breadcrumb-compact .current {
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        /* Quick Actions (Iconified) */
        .quick-actions-compact {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .action-icon-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            position: relative;
        }
        
        .action-icon-btn:hover {
            background: var(--bg-secondary);
            color: var(--accent-primary);
        }
        
        .action-icon-btn i {
            font-size: 16px;
        }
        
        /* Tooltip for Icons */
        .action-icon-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -32px;
            left: 50%;
            transform: translateX(-50%) scale(0.8);
            background: var(--text-primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s;
            z-index: 10000;
        }
        
        .action-icon-btn:hover::after {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }
        
        /* Save Status Compact */
        .save-status-compact {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--success);
            padding: 4px 10px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
        }
        
        .save-status-compact i {
            width: 14px;
            height: 14px;
        }
        
        /* Nav Buttons Compact */
        .nav-btn-compact {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            position: relative;
        }
        
        .nav-btn-compact:hover {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent-primary);
        }
        
        .nav-btn-compact.primary {
            background: var(--accent-primary);
            color: white;
        }
        
        .nav-btn-compact.primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        
        /* ===============================================
           Compact Header - Figma/Linear Professional UX
           Single-Row Context Bar (44px height)
           =============================================== */
        
        .compact-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .compact-header.scrolled {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            background: rgba(255, 255, 255, 0.96);
        }
        
        /* Header Sections */
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header-center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Logo */
        .compact-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .compact-logo img {
            width: 24px;
            height: 24px;
            border-radius: 6px;
        }
        
        .compact-logo:hover {
            color: var(--accent-primary);
        }
        
        /* Context Selector (Unified Role + Project) */
        .context-selector {
            display: flex;
            align-items: center;
        }
        
        .context-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .context-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent-primary);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.15);
        }
        
        .role-emoji {
            font-size: 16px;
            line-height: 1;
        }
        
        .context-separator {
            color: var(--text-tertiary);
            margin: 0 4px;
            font-weight: 400;
        }
        
        .role-name-compact {
            font-weight: 600;
        }
        
        .project-name-compact {
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .chevron-icon {
            width: 14px;
            height: 14px;
            color: var(--text-tertiary);
            transition: transform 0.2s;
        }
        
        .context-btn.active .chevron-icon {
            transform: rotate(180deg);
        }
        
        /* Context Row - Shared Styles */
        .context-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-lg);
            min-height: 36px;
            transition: background var(--transition-base);
        }
        
        .context-row:hover {
            background: var(--bg-tertiary);
        }
        
        /* Role Context Row */
        .role-context {
            border-bottom: 1px solid var(--border-secondary);
            background: linear-gradient(to right, var(--accent-light), transparent);
        }
        
        .role-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .role-icon {
            width: 20px;
            height: 20px;
            padding: 4px;
            background: var(--accent-primary);
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .role-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
        }
        
        .role-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .role-switch-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: white;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .role-switch-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: var(--shadow-md);
        }
        
        /* Project Context Row */
        .project-context {
            border-bottom: 1px solid var(--border-secondary);
        }
        
        .project-info-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .project-icon {
            width: 18px;
            height: 18px;
            color: var(--accent-primary);
        }
        
        .project-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
        }
        
        .project-dropdown {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background var(--transition-base);
            max-width: 300px;
        }
        
        .project-dropdown:hover {
            background: var(--bg-secondary);
        }
        
        .project-dropdown:focus {
            outline: 2px solid var(--accent-light);
            outline-offset: 2px;
        }
        
        .project-switch-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: white;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .project-switch-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: var(--shadow-md);
        }
        
        /* Action Context Row */
        .action-context {
            min-height: 40px;
        }
        
        /* Role Switcher Modal */
        .role-switcher-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }
        
        .role-switcher-modal.active {
            display: flex;
        }
        
        .role-switcher-content {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background var(--transition-base);
        }
        
        .modal-close:hover {
            background: var(--bg-secondary);
        }
        
        .role-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .role-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .role-option:hover {
            background: var(--accent-light);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }
        
        .role-option.active {
            background: var(--accent-light);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }
        
        .role-option-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-primary);
            color: white;
            border-radius: 8px;
            font-size: 20px;
        }
        
        .role-option-info {
            flex: 1;
        }
        
        .role-option-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .role-option-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .role-option-check {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
        }
        
        .role-option.active .role-option-check {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        
        .project-info {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .save-status {
            font-size: 12px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        /* Quick Action Buttons Hover Effect */
        .quick-action-btn:hover {
            background: var(--bg-secondary) !important;
        }
        
        .quick-action-btn:active {
            transform: scale(0.95);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        
        /* Left Panel - Role-based Widget Palette */
        .left-panel {
            width: 280px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-slow);
            z-index: 50;
        }
        
        .left-panel.collapsed {
            transform: translateX(-100%);
        }
        
        .panel-toggle {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 80px;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-left: none;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-base);
            z-index: 60;
        }
        
        .panel-toggle:hover {
            background: var(--bg-secondary);
            width: 28px;
        }
        
        .left-panel.collapsed + .panel-toggle {
            left: 0;
        }
        
        /* Role Selector */
        .role-selector {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-primary);
        }
        
        .role-dropdown {
            width: 100%;
            height: 40px;
            padding: 0 var(--space-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            outline: none;
            transition: all var(--transition-base);
        }
        
        .role-dropdown:hover {
            border-color: var(--accent-primary);
        }
        
        /* Widget Palette */
        .widget-palette {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
        }
        
        .widget-group {
            margin-bottom: var(--space-xl);
        }
        
        .group-header {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            margin-bottom: var(--space-md);
        }
        
        .widget-item {
            height: 48px;
            padding: 0 var(--space-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: var(--space-md);
            cursor: grab;
            margin-bottom: var(--space-sm);
            transition: all var(--transition-base);
        }
        
        .widget-item:hover {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }
        
        .widget-item:active {
            cursor: grabbing;
        }
        
        .widget-icon {
            width: 20px;
            height: 20px;
            color: var(--accent-primary);
            flex-shrink: 0;
        }
        
        .widget-info {
            flex: 1;
        }
        
        .widget-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .widget-desc {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        
        /* Canvas Container */
        .canvas-container {
            flex: 1;
            position: relative;
            background: var(--bg-secondary);
            overflow: hidden;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        
        #canvas:active {
            cursor: grabbing;
        }
        
        #nodes-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }
        
        #nodes-container > * {
            pointer-events: auto;
        }
        
        /* Canvas Node */
        .canvas-node {
            position: absolute;
            width: 200px;
            min-height: 100px;
            background: var(--bg-primary);
            border: 2px solid var(--border-primary);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            cursor: move;
            transition: all var(--transition-base);
        }
        
        .canvas-node:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-lg);
        }
        
        .canvas-node.selected {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        
        .node-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .node-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .node-body {
            padding: var(--space-md);
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Connection Handles */
        .node-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--bg-primary);
            border: 2px solid var(--accent-primary);
            border-radius: 50%;
            cursor: crosshair;
            transition: all var(--transition-base);
            opacity: 0;
        }
        
        .canvas-node:hover .node-handle {
            opacity: 1;
        }
        
        .node-handle:hover {
            transform: scale(1.5);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        
        .node-handle.top { top: -6px; left: 50%; transform: translateX(-50%); }
        .node-handle.right { right: -6px; top: 50%; transform: translateY(-50%); }
        .node-handle.bottom { bottom: -6px; left: 50%; transform: translateX(-50%); }
        .node-handle.left { left: -6px; top: 50%; transform: translateY(-50%); }
        
        /* Floating Toolbar - Figma Style */
        .floating-toolbar {
            position: absolute;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: var(--space-sm);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            z-index: 1000;
        }
        
        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border-primary);
            margin: 0 var(--space-xs);
        }
        
        .toolbar-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
        }
        
        .toolbar-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .toolbar-btn.active {
            background: var(--accent-light);
            color: var(--accent-primary);
        }
        
        .toolbar-btn-primary {
            height: 36px;
            padding: 0 var(--space-lg);
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            transition: all var(--transition-base);
        }
        
        .toolbar-btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .zoom-display {
            min-width: 56px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        /* Right Panel - Properties */
        .right-panel {
            width: 280px;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-slow);
            z-index: 50;
        }
        
        .right-panel.collapsed {
            transform: translateX(100%);
        }
        
        .panel-header {
            height: 48px;
            padding: 0 var(--space-lg);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-primary);
            font-size: 13px;
            font-weight: 600;
        }
        
        .properties-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-xl) 0;
            color: var(--text-tertiary);
            font-size: 13px;
        }
        
        /* Right Panel - Recommendations */
        .recommendations-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .recommendation-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .recommendation-card:hover {
            background: var(--accent-light);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .rec-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .rec-icon {
            width: 20px;
            height: 20px;
            color: var(--accent-primary);
        }
        
        .rec-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .rec-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .rec-badge {
            display: inline-block;
            background: var(--accent-primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 6px;
        }
        
        /* Properties Editor */
        .property-group {
            margin-bottom: 16px;
        }
        
        .property-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        
        .property-input,
        .property-textarea,
        .property-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            font-size: 13px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color var(--transition-base);
        }
        
        .property-input:focus,
        .property-textarea:focus,
        .property-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        
        .section-divider {
            height: 1px;
            background: var(--border-primary);
            margin: 20px 0;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }
        
        /* ===============================================
           AI Chat Panel - All-in-One Canvas AI Orchestration
           =============================================== */
        .ai-chat-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 480px;
            max-height: 600px;
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            border-radius: 16px 16px 0 0;
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: all var(--transition-base);
        }
        
        .ai-chat-panel.minimized {
            max-height: 48px;
        }
        
        .ai-chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-primary);
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--bg-primary) 100%);
            border-radius: 16px 16px 0 0;
        }
        
        .ai-chat-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .ai-chat-actions {
            display: flex;
            gap: 4px;
        }
        
        .ai-action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
        }
        
        .ai-action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }
        
        .ai-chat-body {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .ai-chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
        }
        
        .ai-message {
            display: flex;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ai-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--accent-primary);
        }
        
        .ai-message-content {
            flex: 1;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        .ai-message-content p {
            margin: 0 0 8px 0;
        }
        
        .ai-message-content p:last-child {
            margin-bottom: 0;
        }
        
        .ai-welcome {
            background: var(--accent-light);
            padding: 12px;
            border-radius: 8px;
        }
        
        .user-message .ai-message-avatar {
            background: var(--text-primary);
            color: white;
        }
        
        .quick-commands {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border-primary);
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-tertiary);
            overflow-x: auto;
        }
        
        .quick-cmd-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--border-primary);
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }
        
        .quick-cmd-btn:hover {
            border-color: var(--accent-primary);
            background: var(--accent-light);
            color: var(--accent-primary);
        }
        
        .ai-chat-input-wrapper {
            padding: 16px;
        }
        
        .ai-chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .ai-chat-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            resize: none;
            transition: all var(--transition-fast);
        }
        
        .ai-chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        
        .ai-send-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: var(--accent-primary);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }
        
        .ai-send-btn:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .ai-send-btn:disabled {
            background: var(--border-secondary);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .ai-input-hint {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-tertiary);
        }
        
        /* ===============================================
           Specialized Node Types - Chart, Image, Document
           =============================================== */
        .node-chart-container {
            width: 100%;
            height: 280px; /* Increased from 200px */
            padding: 12px; /* Increased padding */
            background: white;
            border-radius: 8px;
        }
        
        .node-image-container {
            width: 100%;
            height: 180px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .node-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .node-image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: var(--text-tertiary);
            font-size: 12px;
        }
        
        .node-generate-btn {
            padding: 6px 12px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .node-generate-btn:hover {
            background: var(--accent-hover);
        }
        
        .node-document-container {
            max-height: 200px;
            overflow-y: auto;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        .node-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .node-loading i {
            animation: spin 1s linear infinite;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .left-panel,
            .right-panel {
                position: absolute;
                height: calc(100vh - 48px);
                z-index: 100;
            }
            
            .floating-toolbar {
                bottom: 16px;
                padding: var(--space-xs);
            }
            
            .toolbar-btn {
                width: 32px;
                height: 32px;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-hover);
        }
    </style>

    <style>
        /* MuseFlow Footer Styles */
        .museflow-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 999999;
            font-size: 0.75rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .museflow-footer-content {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .museflow-footer-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            color: #8B5CF6;
        }

        .museflow-footer-divider {
            width: 1px;
            height: 16px;
            background: rgba(255, 255, 255, 0.2);
        }

        .museflow-footer-text {
            color: #e5e5e5;
        }

        .museflow-footer-version {
            font-weight: 600;
            color: #60A5FA;
        }

        /* Adjust body padding to prevent content overlap */
        body {
            padding-bottom: 40px !important;
        }
    </style>

</head>
<body>
    <!-- Compact Header - Figma/Linear Professional UX (44px) -->
    <header class="compact-header" id="compact-header">
        <!-- Left: Logo + Context Selector -->
        <div class="header-left">
            <a href="/dashboard-v2.html" class="compact-logo">
                <img src="/static/images/logo-square.png" alt="M" onerror="this.src='/logo-icon.png'">
                MuseFlow
            </a>
            
            <!-- Unified Context Selector (Role + Project) -->
            <div class="context-selector">
                <button class="context-btn" id="context-btn">
                    <span class="role-emoji" id="role-emoji">üé®</span>
                    <span class="role-name-compact" id="role-name-compact">ÌïôÏòàÏÇ¨</span>
                    <span class="context-separator">¬∑</span>
                    <span class="project-name-compact" id="project-name-compact">Ï†ÑÏãú Í∏∞Ìöç ÏõåÌÅ¨ÌîåÎ°úÏö∞</span>
                    <i data-lucide="chevron-down" class="chevron-icon"></i>
                </button>
            </div>
        </div>
        
        <!-- Center: Compact Breadcrumb -->
        <div class="header-center">
            <div class="breadcrumb-compact">
                <a href="/dashboard-v2.html">Dashboard</a>
                <span>‚Ä∫</span>
                <span id="breadcrumb-role-compact">ÌïôÏòàÏÇ¨</span>
                <span>‚Ä∫</span>
                <span class="current" id="breadcrumb-project-compact">Ï†ÑÏãú Í∏∞Ìöç ÏõåÌÅ¨ÌîåÎ°úÏö∞</span>
            </div>
        </div>
        
        <!-- Right: Quick Actions + Nav Buttons -->
        <div class="header-right">
            <!-- Quick Actions (Iconified) -->
            <div class="quick-actions-compact">
                <button class="action-icon-btn" data-tooltip="Î≤ÑÏ†Ñ Í¥ÄÎ¶¨">
                    <i data-lucide="git-branch"></i>
                </button>
                <button class="action-icon-btn" data-tooltip="Í≥µÏú†ÌïòÍ∏∞">
                    <i data-lucide="share-2"></i>
                </button>
                <button class="action-icon-btn" data-tooltip="ÎÇ¥Î≥¥ÎÇ¥Í∏∞">
                    <i data-lucide="download"></i>
                </button>
            </div>
            
            <!-- Save Status -->
            <div class="save-status-compact">
                <i data-lucide="check-circle"></i>
                <span>Ï†ÄÏû•Îê®</span>
            </div>
            
            <!-- Nav Buttons -->
            <button class="nav-btn-compact" data-tooltip="ÏïåÎ¶º">
                <i class="fa fa-bell"></i>
            </button>
            <button class="nav-btn-compact" data-tooltip="ÏÑ§Ï†ï">
                <i class="fa fa-cog"></i>
            </button>
            <button class="nav-btn-compact primary" data-tooltip="ÌîÑÎ°úÌïÑ">
                <i class="fa fa-user"></i>
            </button>
        </div>
    </header>
    
    <div class="app-container">
        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel - Widget Palette -->
            <div class="left-panel" id="left-panel">
                <!-- Role Selector -->
                <div class="role-selector">
                    <select class="role-dropdown" id="role-selector">
                        <option value="curator">üé® ÌïôÏòàÏÇ¨ (Curator)</option>
                        <option value="educator">üìö ÏóêÎìÄÏºÄÏù¥ÌÑ∞ (Educator)</option>
                        <option value="admin">‚öôÔ∏è ÌñâÏ†ïÍ¥ÄÎ¶¨Ïûê (Admin)</option>
                    </select>
                </div>
                
                <!-- Widget Palette -->
                <div class="widget-palette" id="widget-palette">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Panel Toggle Button -->
            <button class="panel-toggle" id="panel-toggle">
                <i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>
            </button>
            
            <!-- Canvas Container -->
            <div class="canvas-container" id="canvas-container">
                <canvas id="canvas"></canvas>
                <div id="nodes-container"></div>
                
                <!-- Floating Toolbar -->
                <div class="floating-toolbar">
                    <button class="toolbar-btn active" title="ÏÑ†ÌÉù ÎèÑÍµ¨ (V)" data-tool="select">
                        <i data-lucide="mouse-pointer-2" style="width: 18px; height: 18px;"></i>
                    </button>
                    <button class="toolbar-btn" title="ÏÜê ÎèÑÍµ¨ (H)" data-tool="hand">
                        <i data-lucide="hand" style="width: 18px; height: 18px;"></i>
                    </button>
                    <button class="toolbar-btn" title="Ïó∞Í≤∞ ÎèÑÍµ¨ (C)" data-tool="connect">
                        <i data-lucide="move" style="width: 18px; height: 18px;"></i>
                    </button>
                    
                    <div class="toolbar-divider"></div>
                    
                    <button class="toolbar-btn" title="ÎÖ∏Îìú Ï∂îÍ∞Ä (A)">
                        <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
                    </button>
                    
                    <div class="toolbar-divider"></div>
                    
                    <button class="toolbar-btn" title="Ï∂ïÏÜå (-)">
                        <i data-lucide="minus" style="width: 18px; height: 18px;"></i>
                    </button>
                    <div class="zoom-display">100%</div>
                    <button class="toolbar-btn" title="ÌôïÎåÄ (+)">
                        <i data-lucide="plus" style="width: 18px; height: 18px;"></i>
                    </button>
                    <button class="toolbar-btn" title="ÎßûÏ∂§ (0)">
                        <i data-lucide="maximize-2" style="width: 18px; height: 18px;"></i>
                    </button>
                    
                    <div class="toolbar-divider"></div>
                    
                    <button class="toolbar-btn-primary" title="ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïã§Ìñâ (Cmd+R)">
                        <i data-lucide="play" style="width: 16px; height: 16px;"></i>
                        Ïã§Ìñâ
                    </button>
                </div>
            </div>
            
            <!-- Right Panel - Smart Properties & Recommendations -->
            <div class="right-panel" id="right-panel">
                <div class="panel-header">
                    <i data-lucide="sparkles" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                    AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏
                </div>
                
                <div class="properties-content" id="properties-content">
                    <!-- Default: Role-based Recommendations -->
                    <div id="recommendations-view" class="recommendations-section">
                        <!-- Recommendations will be rendered here -->
                    </div>
                    
                    <!-- When Node Selected: Properties Editor -->
                    <div id="properties-view" class="properties-section" style="display: none;">
                        <div class="property-group">
                            <label>ÎÖ∏Îìú Ïù¥Î¶Ñ</label>
                            <input type="text" id="node-name" class="property-input" placeholder="ÎÖ∏Îìú Ïù¥Î¶Ñ ÏûÖÎ†•">
                        </div>
                        <div class="property-group">
                            <label>ÏÑ§Î™Ö</label>
                            <textarea id="node-desc" class="property-textarea" placeholder="ÎÖ∏Îìú ÏÑ§Î™Ö ÏûÖÎ†•" rows="3"></textarea>
                        </div>
                        <div class="property-group">
                            <label>Ïö∞ÏÑ†ÏàúÏúÑ</label>
                            <select id="node-priority" class="property-select">
                                <option value="high">ÎÜíÏùå</option>
                                <option value="medium">Î≥¥ÌÜµ</option>
                                <option value="low">ÎÇÆÏùå</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Chat Panel - All-in-One Canvas AI Orchestration -->
    <div class="ai-chat-panel" id="ai-chat-panel">
        <div class="ai-chat-header">
            <div class="ai-chat-title">
                <i data-lucide="sparkles" style="width: 18px; height: 18px; color: var(--accent-primary);"></i>
                <span>AI Assistant</span>
            </div>
            <div class="ai-chat-actions">
                <button class="ai-action-btn" id="minimize-chat" title="ÏµúÏÜåÌôî">
                    <i data-lucide="minus" style="width: 16px; height: 16px;"></i>
                </button>
            </div>
        </div>
        
        <div class="ai-chat-body">
            <!-- Chat Messages -->
            <div class="ai-chat-messages" id="ai-chat-messages">
                <div class="ai-message ai-welcome">
                    <div class="ai-message-avatar">
                        <i data-lucide="bot" style="width: 16px; height: 16px;"></i>
                    </div>
                    <div class="ai-message-content">
                        <p>ÏïàÎÖïÌïòÏÑ∏Ïöî! üëã AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ÏûÖÎãàÎã§.</p>
                        <p>ÏûêÏó∞Ïñ¥Î°ú Î™ÖÎ†πÌïòÏãúÎ©¥ ÏûêÎèôÏúºÎ°ú ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏÉùÏÑ±Ìï¥ÎìúÎ¶ΩÎãàÎã§.</p>
                    </div>
                </div>
            </div>
            
            <!-- Quick Commands -->
            <div class="quick-commands">
                <button class="quick-cmd-btn" data-command="workflow" title="ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏÉùÏÑ±">
                    <i data-lucide="workflow" style="width: 16px; height: 16px;"></i>
                    <span>ÏõåÌÅ¨ÌîåÎ°úÏö∞</span>
                </button>
                <button class="quick-cmd-btn" data-command="image" title="Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±">
                    <i data-lucide="image" style="width: 16px; height: 16px;"></i>
                    <span>Ïù¥ÎØ∏ÏßÄ</span>
                </button>
                <button class="quick-cmd-btn" data-command="chart" title="Ï∞®Ìä∏ ÏÉùÏÑ±">
                    <i data-lucide="bar-chart-3" style="width: 16px; height: 16px;"></i>
                    <span>Ï∞®Ìä∏</span>
                </button>
                <button class="quick-cmd-btn" data-command="report" title="Î≥¥Í≥†ÏÑú ÏûëÏÑ±">
                    <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                    <span>Î≥¥Í≥†ÏÑú</span>
                </button>
            </div>
            
            <!-- Input Area -->
            <div class="ai-chat-input-wrapper">
                <div class="ai-chat-input-container">
                    <textarea 
                        id="ai-chat-input" 
                        class="ai-chat-input" 
                        placeholder="AIÏóêÍ≤å Î™ÖÎ†πÌïòÏÑ∏Ïöî... (Ïòà: ÌòÑÎåÄÎØ∏Ïà† Ï†ÑÏãú Í∏∞Ìöç ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÎßåÎì§Ïñ¥Ï§ò)"
                        rows="2"
                    ></textarea>
                    <button class="ai-send-btn" id="ai-send-btn" disabled>
                        <i data-lucide="send" style="width: 18px; height: 18px;"></i>
                    </button>
                </div>
                <div class="ai-input-hint">
                    <i data-lucide="lightbulb" style="width: 12px; height: 12px;"></i>
                    <span>ÏòàÏãú: "ÏòàÏÇ∞ Ï∞®Ìä∏ÏôÄ Ìè¨Ïä§ÌÑ∞ Ïù¥ÎØ∏ÏßÄÍ∞Ä Ìè¨Ìï®Îêú Ï†ÑÏãú Í∏∞Ìöç ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏÉùÏÑ±Ìï¥Ï§ò"</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Role Switcher Modal -->
    <div class="role-switcher-modal" id="role-switcher-modal">
        <div class="role-switcher-content">
            <div class="modal-header">
                <h3 class="modal-title">Ïó≠Ìï† ÏÑ†ÌÉù</h3>
                <button class="modal-close" onclick="closeRoleSwitcher()">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            
            <div class="role-options">
                <div class="role-option" data-role="curator" onclick="switchRole('curator')">
                    <div class="role-option-icon">üé®</div>
                    <div class="role-option-info">
                        <div class="role-option-title">ÌïôÏòàÏÇ¨ (Curator)</div>
                        <div class="role-option-desc">Ï†ÑÏãú Í∏∞Ìöç, ÏûëÌíà ÌÅêÎ†àÏù¥ÏÖò, Í¥ÄÎûåÍ∞ù Í≤ΩÌóò ÎîîÏûêÏù∏</div>
                    </div>
                    <div class="role-option-check">
                        <i data-lucide="check" style="width: 12px; height: 12px; color: white;"></i>
                    </div>
                </div>
                
                <div class="role-option" data-role="educator" onclick="switchRole('educator')">
                    <div class="role-option-icon">üìö</div>
                    <div class="role-option-info">
                        <div class="role-option-title">ÏóêÎìÄÏºÄÏù¥ÌÑ∞ (Educator)</div>
                        <div class="role-option-desc">ÍµêÏú° ÌîÑÎ°úÍ∑∏Îû® ÏÑ§Í≥Ñ, ÌïôÏäµ ÏΩòÌÖêÏ∏† Í∞úÎ∞ú, ÌïôÏäµ Ìö®Í≥º Ï∏°Ï†ï</div>
                    </div>
                    <div class="role-option-check">
                        <i data-lucide="check" style="width: 12px; height: 12px; color: white;"></i>
                    </div>
                </div>
                
                <div class="role-option" data-role="admin" onclick="switchRole('admin')">
                    <div class="role-option-icon">‚öôÔ∏è</div>
                    <div class="role-option-info">
                        <div class="role-option-title">ÌñâÏ†ïÍ¥ÄÎ¶¨Ïûê (Admin)</div>
                        <div class="role-option-desc">Ïö¥ÏòÅ Í¥ÄÎ¶¨, Ïû¨Î¨¥ Í¥ÄÎ¶¨, Î≥¥Ïïà Î∞è Î≤ïÎ¨¥ Í¥ÄÎ¶¨</div>
                    </div>
                    <div class="role-option-check">
                        <i data-lucide="check" style="width: 12px; height: 12px; color: white;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Role-based Widget Data
        const widgetData = {
            curator: [
                {
                    group: 'Ï†ÑÏãú Í∏∞Ìöç',
                    widgets: [
                        { id: 'ex-01', icon: 'lightbulb', title: 'Ï†ÑÏãú Ï£ºÏ†ú ÏÑ†Ï†ï', desc: 'Ï†ÑÏãú Í∏∞Ìöç' },
                        { id: 'ex-02', icon: 'image', title: 'ÏûëÌíà ÏÑ†Ï†ï', desc: 'ÌÅêÎ†àÏù¥ÌåÖ' },
                        { id: 'ex-03', icon: 'layout', title: 'Í≥µÍ∞Ñ Î∞∞Ïπò Í≥ÑÌöç', desc: 'Í≥µÍ∞Ñ ÏÑ§Í≥Ñ' },
                        { id: 'ex-04', icon: 'book-open', title: 'ÎèÑÎ°ù Ï†úÏûë', desc: 'Ï∂úÌåê' }
                    ]
                },
                {
                    group: 'ÏûëÌíà Í¥ÄÎ¶¨',
                    widgets: [
                        { id: 'col-01', icon: 'package', title: 'ÏûëÌíà Îì±Î°ù', desc: 'Ïª¨Î†âÏÖò' },
                        { id: 'col-02', icon: 'shield', title: 'Î≥¥Ï°¥ Ï≤òÎ¶¨', desc: 'Î≥¥Ï°¥' },
                        { id: 'col-03', icon: 'truck', title: 'ÎåÄÏó¨ Í¥ÄÎ¶¨', desc: 'Î¨ºÎ•ò' }
                    ]
                }
            ],
            educator: [
                {
                    group: 'ÍµêÏú° ÌîÑÎ°úÍ∑∏Îû®',
                    widgets: [
                        { id: 'edu-01', icon: 'graduation-cap', title: 'ÌîÑÎ°úÍ∑∏Îû® Í∏∞Ìöç', desc: 'ÍµêÏú°' },
                        { id: 'edu-02', icon: 'users', title: 'ÏõåÌÅ¨Ïàç ÏÑ§Í≥Ñ', desc: 'Ï∞∏Ïó¨Ìòï' },
                        { id: 'edu-03', icon: 'mic', title: 'ÎèÑÏä®Ìä∏ ÍµêÏú°', desc: 'Ìï¥ÏÑ§' },
                        { id: 'edu-04', icon: 'file-text', title: 'ÍµêÏú° ÏûêÎ£å Ï†úÏûë', desc: 'ÏΩòÌÖêÏ∏†' }
                    ]
                },
                {
                    group: 'Ï∞∏Ïó¨ ÌôúÎèô',
                    widgets: [
                        { id: 'eng-01', icon: 'heart', title: 'Î©§Î≤ÑÏã≠ Í¥ÄÎ¶¨', desc: 'ÌöåÏõê' },
                        { id: 'eng-02', icon: 'calendar', title: 'Ïù¥Î≤§Ìä∏ Í∏∞Ìöç', desc: 'ÌñâÏÇ¨' },
                        { id: 'eng-03', icon: 'share-2', title: 'SNS Ïö¥ÏòÅ', desc: 'ÏÜåÌÜµ' }
                    ]
                }
            ],
            admin: [
                {
                    group: 'Ïö¥ÏòÅ Í¥ÄÎ¶¨',
                    widgets: [
                        { id: 'adm-01', icon: 'dollar-sign', title: 'ÏòàÏÇ∞ ÏàòÎ¶Ω', desc: 'Ïû¨Î¨¥' },
                        { id: 'adm-02', icon: 'users', title: 'Ïù∏ÏÇ¨ Í¥ÄÎ¶¨', desc: 'HR' },
                        { id: 'adm-03', icon: 'building', title: 'ÏãúÏÑ§ Í¥ÄÎ¶¨', desc: 'Ïö¥ÏòÅ' },
                        { id: 'adm-04', icon: 'calendar-clock', title: 'ÏùºÏ†ï Í¥ÄÎ¶¨', desc: 'Ïä§ÏºÄÏ§Ñ' }
                    ]
                },
                {
                    group: 'Ïû¨Î¨¥',
                    widgets: [
                        { id: 'fin-01', icon: 'receipt', title: 'ÌöåÍ≥Ñ Ï≤òÎ¶¨', desc: 'ÌöåÍ≥Ñ' },
                        { id: 'fin-02', icon: 'file-signature', title: 'Í≥ÑÏïΩ Í¥ÄÎ¶¨', desc: 'Î≤ïÎ¨¥' },
                        { id: 'fin-03', icon: 'bar-chart', title: 'Î≥¥Í≥†ÏÑú ÏûëÏÑ±', desc: 'Î∂ÑÏÑù' }
                    ]
                }
            ]
        };
        
        // Role-based Recommendations Data (AI-powered)
        const recommendationsData = {
            curator: [
                {
                    icon: 'sparkles',
                    title: 'Ï†ÑÏãú Í∏∞Ìöç ÏõåÌÅ¨ÌîåÎ°úÏö∞',
                    desc: 'Ï†ÑÏãú Ï£ºÏ†ú ÏÑ†Ï†ïÎ∂ÄÌÑ∞ Ïò§ÌîàÍπåÏßÄ ÏôÑÏ†ÑÌïú ÌîÑÎ°úÏÑ∏Ïä§',
                    badge: 'Ïù∏Í∏∞'
                },
                {
                    icon: 'palette',
                    title: 'ÏûëÌíà ÌÅêÎ†àÏù¥ÏÖò ÌÖúÌîåÎ¶ø',
                    desc: 'ÏûëÌíà ÏÑ†Ï†ï, Î∞∞Ïπò, ÎèÑÎ°ù Ï†úÏûëÏùÑ ÏúÑÌïú Ï≤¥Í≥ÑÏ†Å ÌùêÎ¶Ñ',
                    badge: 'Ï∂îÏ≤ú'
                },
                {
                    icon: 'users',
                    title: 'Í¥ÄÎûåÍ∞ù Í≤ΩÌóò ÎîîÏûêÏù∏',
                    desc: 'Í¥ÄÎûåÍ∞ù Ï°∞ÏÇ¨ÏôÄ Í≤ΩÌóò ÏµúÏ†ÅÌôîÎ•º ÏúÑÌïú Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò Ï†ëÍ∑º',
                    badge: 'AI Ï†úÏïà'
                }
            ],
            educator: [
                {
                    icon: 'graduation-cap',
                    title: 'ÍµêÏú° ÌîÑÎ°úÍ∑∏Îû® ÏÑ§Í≥Ñ',
                    desc: 'ÎåÄÏÉÅ Î∂ÑÏÑùÎ∂ÄÌÑ∞ ÌèâÍ∞ÄÍπåÏßÄ ÏôÑÏ†ÑÌïú ÍµêÏú° ÌîÑÎ°úÏÑ∏Ïä§',
                    badge: 'Ïù∏Í∏∞'
                },
                {
                    icon: 'book',
                    title: 'ÌïôÏäµ ÏΩòÌÖêÏ∏† Í∞úÎ∞ú',
                    desc: 'ÍµêÏú° ÏûêÎ£å Ï†úÏûëÍ≥º ÎîîÏßÄÌÑ∏ ÏΩòÌÖêÏ∏† Í∞úÎ∞ú ÏõåÌÅ¨ÌîåÎ°úÏö∞',
                    badge: 'Ï∂îÏ≤ú'
                },
                {
                    icon: 'target',
                    title: 'ÌïôÏäµ Ìö®Í≥º Ï∏°Ï†ï',
                    desc: 'ÍµêÏú° ÌîÑÎ°úÍ∑∏Îû® ÏÑ±Í≥º Ï∏°Ï†ïÍ≥º Í∞úÏÑ†ÏùÑ ÏúÑÌïú Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù',
                    badge: 'AI Ï†úÏïà'
                }
            ],
            admin: [
                {
                    icon: 'briefcase',
                    title: 'Ïö¥ÏòÅ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú',
                    desc: 'ÏòàÏÇ∞, Ïù∏ÏÇ¨, ÏãúÏÑ§ Í¥ÄÎ¶¨Î•º ÏúÑÌïú ÌÜµÌï© ÏõåÌÅ¨ÌîåÎ°úÏö∞',
                    badge: 'Ïù∏Í∏∞'
                },
                {
                    icon: 'dollar-sign',
                    title: 'Ïû¨Î¨¥ Í¥ÄÎ¶¨ ÌîÑÎ°úÏÑ∏Ïä§',
                    desc: 'ÌöåÍ≥Ñ Ï≤òÎ¶¨, Í≥ÑÏïΩ Í¥ÄÎ¶¨, Î≥¥Í≥†ÏÑú ÏûëÏÑ± Ï≤¥Í≥Ñ',
                    badge: 'Ï∂îÏ≤ú'
                },
                {
                    icon: 'shield',
                    title: 'Î≥¥Ïïà Î∞è Î≤ïÎ¨¥ Í¥ÄÎ¶¨',
                    desc: 'Î≤ïÎ¨¥ Í≤ÄÌÜ†, Î≥¥Ïïà Í¥ÄÎ¶¨, Í∞êÏÇ¨ ÎåÄÏùë ÌîÑÎ°úÏÑ∏Ïä§',
                    badge: 'AI Ï†úÏïà'
                }
            ]
        };
        
        // State
        const state = {
            currentRole: 'curator',
            nodes: [],
            selectedNode: null,
            zoom: 1,
            tool: 'select',
            leftPanelCollapsed: false,
            rightPanelCollapsed: false
        };
        
        // Load saved role
        const savedRole = localStorage.getItem('museflow_user_role');
        if (savedRole) {
            state.currentRole = savedRole;
            document.getElementById('role-selector').value = savedRole;
        }
        
        // Render Widget Palette
        function renderWidgetPalette() {
            const palette = document.getElementById('widget-palette');
            const data = widgetData[state.currentRole];
            
            palette.innerHTML = data.map(group => `
                <div class="widget-group">
                    <div class="group-header">${group.group}</div>
                    ${group.widgets.map(widget => `
                        <div class="widget-item" draggable="true" data-id="${widget.id}">
                            <i data-lucide="${widget.icon}" class="widget-icon"></i>
                            <div class="widget-info">
                                <div class="widget-title">${widget.title}</div>
                                <div class="widget-desc">${widget.desc}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
            
            lucide.createIcons();
        }
        
        // Render Right Panel Recommendations (AI-powered)
        function renderRecommendations() {
            const container = document.getElementById('recommendations-view');
            if (!container) return;
            
            const recommendations = recommendationsData[state.currentRole] || [];
            
            container.innerHTML = `
                <div class="section-title">üéØ ${state.currentRole === 'curator' ? 'ÌïôÏòàÏÇ¨' : state.currentRole === 'educator' ? 'ÏóêÎìÄÏºÄÏù¥ÌÑ∞' : 'ÌñâÏ†ïÍ¥ÄÎ¶¨Ïûê'} Ï∂îÏ≤ú ÌÖúÌîåÎ¶ø</div>
                ${recommendations.map(rec => `
                    <div class="recommendation-card" onclick="applyTemplate('${rec.title}')">
                        <div class="rec-header">
                            <i data-lucide="${rec.icon}" class="rec-icon"></i>
                            <span class="rec-title">${rec.title}</span>
                        </div>
                        <p class="rec-desc">${rec.desc}</p>
                        <span class="rec-badge">${rec.badge}</span>
                    </div>
                `).join('')}
                
                <div class="section-divider"></div>
                
                <div class="section-title">üìä ÏµúÍ∑º ÌôúÎèô</div>
                <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 6px; font-size: 12px; color: var(--text-secondary);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>ÎßàÏßÄÎßâ Ìé∏Ïßë</span>
                        <span style="font-weight: 600;">2Î∂Ñ Ï†Ñ</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Ïã§Ìñâ ÌöüÏàò</span>
                        <span style="font-weight: 600; color: var(--success);">12Ìöå</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>ÌèâÍ∑† Ïã§Ìñâ ÏãúÍ∞Ñ</span>
                        <span style="font-weight: 600;">2.4Ï¥à</span>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
        }
        
        // Apply Template Function
        function applyTemplate(templateName) {
            showToast(`‚ú® "${templateName}" ÌÖúÌîåÎ¶ø Ï†ÅÏö© Ï§ë...`, 'success');
            console.log('Applying template:', templateName);
            // TODO: Implement template application logic
        }
        
        // Role Selector Change
        document.getElementById('role-selector').addEventListener('change', (e) => {
            state.currentRole = e.target.value;
            localStorage.setItem('museflow_user_role', e.target.value);
            renderWidgetPalette();
            renderRecommendations(); // Update recommendations when role changes
            showToast(`üé≠ Ïó≠Ìï† Î≥ÄÍ≤Ω: ${e.target.options[e.target.selectedIndex].text}`, 'info');
        });
        
        // Panel Toggle
        document.getElementById('panel-toggle').addEventListener('click', () => {
            const panel = document.getElementById('left-panel');
            const toggle = document.getElementById('panel-toggle');
            state.leftPanelCollapsed = !state.leftPanelCollapsed;
            
            if (state.leftPanelCollapsed) {
                panel.classList.add('collapsed');
                toggle.querySelector('i').setAttribute('data-lucide', 'chevron-right');
            } else {
                panel.classList.remove('collapsed');
                toggle.querySelector('i').setAttribute('data-lucide', 'chevron-left');
            }
            
            lucide.createIcons();
        });
        
        // Create Sample Workflow
        function createSampleWorkflow() {
            const hasSample = localStorage.getItem('museflow_canvas_sample_v2');
            if (hasSample) return;
            
            const sampleNodes = [
                { id: '1', type: 'ex-01', title: 'Ï†ÑÏãú Ï£ºÏ†ú ÏÑ†Ï†ï', x: 100, y: 100 },
                { id: '2', type: 'ex-02', title: 'ÏûëÌíà ÏÑ†Ï†ï', x: 350, y: 100 },
                { id: '3', type: 'ex-03', title: 'Í≥µÍ∞Ñ Î∞∞Ïπò Í≥ÑÌöç', x: 600, y: 100 },
                { id: '4', type: 'ex-04', title: 'ÎèÑÎ°ù Ï†úÏûë', x: 225, y: 280 },
                { id: '5', type: 'col-01', title: 'ÏûëÌíà Îì±Î°ù', x: 475, y: 280 }
            ];
            
            sampleNodes.forEach(node => createNode(node));
            localStorage.setItem('museflow_canvas_sample_v2', 'true');
        }
        
        // Create Node
        function createNode(data) {
            const node = document.createElement('div');
            node.className = 'canvas-node';
            node.id = `node-${data.id}`;
            node.style.left = data.x + 'px';
            node.style.top = data.y + 'px';
            
            node.innerHTML = `
                <div class="node-header">
                    <i data-lucide="circle" style="width: 16px; height: 16px; color: var(--accent-primary);"></i>
                    <span class="node-title">${data.title}</span>
                </div>
                <div class="node-body">
                    ${state.currentRole === 'curator' ? 'Ï†ÑÏãú Í∏∞Ìöç ÌîÑÎ°úÏÑ∏Ïä§' : 
                      state.currentRole === 'educator' ? 'ÍµêÏú° ÌîÑÎ°úÍ∑∏Îû® Ïö¥ÏòÅ' : 
                      'ÌñâÏ†ï Í¥ÄÎ¶¨ ÏóÖÎ¨¥'}
                </div>
                <div class="node-handle top"></div>
                <div class="node-handle right"></div>
                <div class="node-handle bottom"></div>
                <div class="node-handle left"></div>
            `;
            
            document.getElementById('nodes-container').appendChild(node);
            lucide.createIcons();
            
            // Make draggable
            makeDraggable(node);
            
            state.nodes.push({ id: data.id, element: node, data });
        }
        
        // Make Node Draggable
        function makeDraggable(node) {
            let isDragging = false;
            let startX, startY, nodeX, nodeY;
            
            node.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('node-handle')) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                nodeX = parseInt(node.style.left);
                nodeY = parseInt(node.style.top);
            });
            
            // Double-click to mark as completed
            node.addEventListener('dblclick', (e) => {
                if (e.target.classList.contains('node-handle')) return;
                const nodeId = node.id;
                markNodeAsCompleted(nodeId);
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                node.style.left = (nodeX + dx) + 'px';
                node.style.top = (nodeY + dy) + 'px';
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }
        
        // =============================================
        // Compact Header Functions
        // =============================================
        
        // Role Display Names
        const roleNames = {
            curator: 'ÌïôÏòàÏÇ¨',
            educator: 'ÏóêÎìÄÏºÄÏù¥ÌÑ∞',
            admin: 'ÌñâÏ†ïÍ¥ÄÎ¶¨Ïûê'
        };
        
        const roleEmojis = {
            curator: 'üé®',
            educator: 'üìö',
            admin: '‚öôÔ∏è'
        };
        
        // Context Button Click - Open Modal
        document.getElementById('context-btn')?.addEventListener('click', () => {
            const modal = document.getElementById('role-switcher-modal');
            modal.classList.add('active');
            
            // Highlight current role
            document.querySelectorAll('.role-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.role === state.currentRole) {
                    option.classList.add('active');
                }
            });
            
            lucide.createIcons();
        });
        
        // Close Role Switcher Modal
        function closeRoleSwitcher() {
            const modal = document.getElementById('role-switcher-modal');
            modal.classList.remove('active');
        }
        
        // Switch Role Function
        function switchRole(newRole) {
            if (newRole === state.currentRole) {
                closeRoleSwitcher();
                return;
            }
            
            state.currentRole = newRole;
            localStorage.setItem('museflow_user_role', newRole);
            
            // Update theme color
            document.body.setAttribute('data-role', newRole);
            
            // Update Compact Header UI
            document.getElementById('role-emoji').textContent = roleEmojis[newRole];
            document.getElementById('role-name-compact').textContent = roleNames[newRole];
            document.getElementById('breadcrumb-role-compact').textContent = roleNames[newRole];
            
            // Update left panel widget palette
            renderWidgetPalette();
            renderRecommendations();
            
            // Close modal
            closeRoleSwitcher();
            
            // Show toast with role-specific color
            const themeColors = {
                curator: 'Î≥¥ÎùºÏÉâ',
                educator: 'ÌååÎûÄÏÉâ',
                admin: 'ÎÖπÏÉâ'
            };
            showToast(`${roleEmojis[newRole]} Ïó≠Ìï†Ïù¥ "${roleNames[newRole]}"(Ïúº)Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§ ¬∑ ${themeColors[newRole]} ÌÖåÎßà Ï†ÅÏö©`, 'success');
        }
        
        // Close modal on outside click
        document.getElementById('role-switcher-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'role-switcher-modal') {
                closeRoleSwitcher();
            }
        });
        
        // =============================================
        // Dashboard Integration Functions
        // =============================================
        
        // Project Selector Change Handler
        document.getElementById('project-selector')?.addEventListener('change', (e) => {
            const projectId = e.target.value;
            
            // Update breadcrumb
            const projectName = e.target.options[e.target.selectedIndex].text;
            document.getElementById('breadcrumb-project').textContent = projectName;
            
            if (projectId === '4') {
                // Create new project
                const projectName = prompt('ÏÉà ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', 'ÏÉà ÏõåÌÅ¨ÌîåÎ°úÏö∞');
                if (projectName) {
                    showToast('‚úÖ ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Ï§ë...', 'success');
                    // TODO: Backend integration
                    console.log('Creating project:', projectName);
                }
                e.target.value = '1'; // Reset to first option
                return;
            }
            
            // Load project
            showToast(`üìÇ ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú Ï§ë...`, 'info');
            console.log('Loading project:', projectId);
            // TODO: Load project data from backend
        });
        
        // Quick Actions - Version Control
        document.querySelectorAll('.quick-action-btn').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                const actions = ['Î≤ÑÏ†Ñ Ï†ÄÏû•', 'ÌîÑÎ°úÏ†ùÌä∏ Í≥µÏú†', 'ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞'];
                showToast(`üöÄ ${actions[index]} Í∏∞Îä• Ïã§Ìñâ Ï§ë...`, 'info');
                console.log('Quick action:', actions[index]);
                
                // TODO: Implement actions
                if (index === 2) {
                    // Export workflow as JSON
                    const workflowData = {
                        nodes: state.nodes.map(n => n.data),
                        role: state.currentRole,
                        timestamp: new Date().toISOString()
                    };
                    console.log('Export data:', workflowData);
                }
            });
        });
        
        // Toast Notification System (0% error rate)
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(400px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Unified Navbar Scroll Effect (Professional UX)
        let lastScroll = 0;
        const navbar = document.getElementById('navbar');
        
        document.getElementById('canvas-container')?.addEventListener('scroll', () => {
            const currentScroll = document.getElementById('canvas-container').scrollTop;
            
            if (currentScroll > 50) {
                navbar?.classList.add('navbar-scrolled');
            } else {
                navbar?.classList.remove('navbar-scrolled');
            }
            
            // Auto-hide on scroll down (optional)
            if (currentScroll > lastScroll && currentScroll > 100) {
                navbar?.classList.add('navbar-hidden');
            } else {
                navbar?.classList.remove('navbar-hidden');
            }
            
            lastScroll = currentScroll;
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Initializing Compact Header Canvas (Figma/Linear Style)...');
            
            // Set initial theme based on saved role
            const savedRole = localStorage.getItem('museflow_user_role') || 'curator';
            state.currentRole = savedRole;
            document.body.setAttribute('data-role', savedRole);
            
            // Update Compact Header UI
            document.getElementById('role-emoji').textContent = roleEmojis[savedRole];
            document.getElementById('role-name-compact').textContent = roleNames[savedRole];
            document.getElementById('breadcrumb-role-compact').textContent = roleNames[savedRole];
            
            // Render components
            renderWidgetPalette();
            renderRecommendations();
            createSampleWorkflow();
            
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Scroll effect for header
            let lastScroll = 0;
            window.addEventListener('scroll', () => {
                const header = document.getElementById('compact-header');
                const currentScroll = window.scrollY;
                
                if (currentScroll > 50) {
                    header?.classList.add('scrolled');
                } else {
                    header?.classList.remove('scrolled');
                }
                
                lastScroll = currentScroll;
            });
            
            // Check for Dashboard Task (Dashboard ‚Üí Canvas Ïó∞Îèô)
            checkPendingDashboardTask();
            
            // Welcome message
            setTimeout(() => {
                showToast('‚ú® AI Canvas Ï§ÄÎπÑ ÏôÑÎ£å! AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏Í∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.', 'success');
            }, 500);
            
            // ================================================
            // AI Chat Panel Functions
            // ================================================
            
            // AI Chat Panel State
            const aiChatState = {
                isMinimized: false,
                messages: []
            };
            
            // DOM Elements
            const aiChatPanel = document.getElementById('ai-chat-panel');
            const aiChatInput = document.getElementById('ai-chat-input');
            const aiSendBtn = document.getElementById('ai-send-btn');
            const aiChatMessages = document.getElementById('ai-chat-messages');
            const minimizeBtn = document.getElementById('minimize-chat');
            
            // Enable/disable send button based on input
            aiChatInput.addEventListener('input', () => {
                const hasText = aiChatInput.value.trim().length > 0;
                aiSendBtn.disabled = !hasText;
            });
            
            // Handle Enter key (Shift+Enter for new line)
            aiChatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!aiSendBtn.disabled) {
                        sendAICommand();
                    }
                }
            });
            
            // Send button click
            aiSendBtn.addEventListener('click', sendAICommand);
            
            // Minimize/Maximize chat
            minimizeBtn.addEventListener('click', () => {
                aiChatState.isMinimized = !aiChatState.isMinimized;
                aiChatPanel.classList.toggle('minimized', aiChatState.isMinimized);
                
                const icon = minimizeBtn.querySelector('i');
                if (aiChatState.isMinimized) {
                    icon.setAttribute('data-lucide', 'maximize-2');
                } else {
                    icon.setAttribute('data-lucide', 'minus');
                }
                lucide.createIcons();
            });
            
            // Quick Command buttons
            document.querySelectorAll('.quick-cmd-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const command = btn.dataset.command;
                    handleQuickCommand(command);
                });
            });
            
            // Handle Quick Commands
            function handleQuickCommand(type) {
                const prompts = {
                    workflow: 'Ï†ÑÏãú Í∏∞Ìöç ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.',
                    image: 'Ï†ÑÏãú Ìè¨Ïä§ÌÑ∞ Ïù¥ÎØ∏ÏßÄÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.',
                    chart: 'ÏòàÏÇ∞ Í≥ÑÌöç Ï∞®Ìä∏Î•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.',
                    report: 'Ï†ÑÏãú Í∏∞ÌöçÏïà Î≥¥Í≥†ÏÑúÎ•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.'
                };
                
                const command = prompts[type];
                if (!command) return;
                
                // Add user message to chat
                addMessageToChat('user', command);
                
                // Directly generate fallback based on type
                switch(type) {
                    case 'workflow':
                        generateFallbackWorkflow(command);
                        break;
                    case 'chart':
                        addMessageToChat('ai', '‚úÖ Ï∞®Ìä∏ ÎÖ∏ÎìúÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.');
                        generateChartNode({ 
                            title: 'ÏòàÏÇ∞ Í≥ÑÌöç', 
                            x: 200, 
                            y: 200 
                        });
                        break;
                    case 'report':
                        addMessageToChat('ai', '‚úÖ Î≥¥Í≥†ÏÑú ÎÖ∏ÎìúÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.');
                        generateDocumentNode({ 
                            title: 'Ï†ÑÏãú Í∏∞ÌöçÏïà', 
                            x: 200, 
                            y: 200 
                        });
                        break;
                    case 'image':
                        addMessageToChat('ai', '‚úÖ Ïù¥ÎØ∏ÏßÄ ÎÖ∏ÎìúÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.');
                        generateImageNode({ 
                            title: 'Ï†ÑÏãú Ìè¨Ïä§ÌÑ∞', 
                            x: 200, 
                            y: 200 
                        });
                        break;
                }
            }
            
            // Send AI Command
            async function sendAICommand() {
                const userInput = aiChatInput.value.trim();
                if (!userInput) return;
                
                // Add user message to chat
                addMessageToChat('user', userInput);
                
                // Clear input
                aiChatInput.value = '';
                aiSendBtn.disabled = true;
                
                // Show loading
                const loadingId = addMessageToChat('ai', 'Î∂ÑÏÑù Ï§ë...');
                
                try {
                    // Call AI API
                    const response = await fetch('/api/ai/command', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            command: userInput,
                            role: state.currentRole,
                            currentNodes: state.nodes
                        })
                    });
                    
                    // Check response status
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('‚ùå API Error:', response.status, errorData);
                        
                        // Always use fallback on API error
                        removeMessage(loadingId);
                        addMessageToChat('ai', '‚ö†Ô∏è AI API Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Í∏∞Î≥∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.');
                        generateFallbackWorkflow(userInput);
                        return;
                    }
                    
                    const result = await response.json();
                    
                    // Check if result has required fields
                    if (!result.type || !result.nodes) {
                        console.error('‚ùå Invalid API response:', result);
                        removeMessage(loadingId);
                        addMessageToChat('ai', '‚ö†Ô∏è AI ÏùëÎãµ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. Í∏∞Î≥∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.');
                        generateFallbackWorkflow(userInput);
                        return;
                    }
                    
                    // Remove loading message
                    removeMessage(loadingId);
                    
                    // Process AI response
                    processAIResponse(result);
                    
                } catch (error) {
                    console.error('‚ùå AI Command Error:', error);
                    removeMessage(loadingId);
                    
                    // Always use fallback on any error
                    addMessageToChat('ai', '‚ö†Ô∏è AI Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Í∏∞Î≥∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.');
                    generateFallbackWorkflow(userInput);
                }
            }
            
            // Add message to chat
            function addMessageToChat(type, content) {
                const messageId = `msg-${Date.now()}`;
                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ${type === 'user' ? 'user-message' : ''}`;
                messageDiv.id = messageId;
                
                const avatarIcon = type === 'user' ? 'user' : 'bot';
                
                messageDiv.innerHTML = `
                    <div class="ai-message-avatar">
                        <i data-lucide="${avatarIcon}" style="width: 16px; height: 16px;"></i>
                    </div>
                    <div class="ai-message-content">
                        <p>${content}</p>
                    </div>
                `;
                
                aiChatMessages.appendChild(messageDiv);
                lucide.createIcons();
                
                // Scroll to bottom
                aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
                
                return messageId;
            }
            
            // Remove message
            function removeMessage(messageId) {
                const message = document.getElementById(messageId);
                if (message) {
                    message.remove();
                }
            }
            
            // Process AI Response
            function processAIResponse(result) {
                const { type, message, nodes, connections } = result;
                
                // Add AI response message
                addMessageToChat('ai', message);
                
                // Execute based on type
                switch(type) {
                    case 'workflow':
                        generateWorkflowNodes(nodes, connections);
                        break;
                    case 'image':
                        generateImageNode(nodes[0]);
                        break;
                    case 'chart':
                        generateChartNode(nodes[0]);
                        break;
                    case 'report':
                        generateDocumentNode(nodes[0]);
                        break;
                    default:
                        console.warn('Unknown AI response type:', type);
                }
                
                showToast(`‚ú® ${message}`, 'success');
            }
            
            // Generate Fallback Workflow (when API fails)
            function generateFallbackWorkflow(userInput) {
                const command = userInput.toLowerCase();
                
                // Detect keywords and generate appropriate content
                if (command.includes('Ï∞®Ìä∏') || command.includes('chart')) {
                    // Direct chart generation
                    addMessageToChat('ai', '‚úÖ Ï∞®Ìä∏Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.');
                    generateChartNode({ 
                        title: userInput.slice(0, 30) || 'Îç∞Ïù¥ÌÑ∞ Ï∞®Ìä∏', 
                        x: 200, 
                        y: 200 
                    });
                    showToast('‚ú® Ï∞®Ìä∏Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    return;
                } else if (command.includes('Î≥¥Í≥†ÏÑú') || command.includes('report') || command.includes('Î¨∏ÏÑú')) {
                    // Direct document generation
                    addMessageToChat('ai', '‚úÖ Î≥¥Í≥†ÏÑúÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.');
                    generateDocumentNode({ 
                        title: userInput.slice(0, 30) || 'Î≥¥Í≥†ÏÑú', 
                        x: 200, 
                        y: 200 
                    });
                    showToast('‚ú® Î≥¥Í≥†ÏÑúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    return;
                }
                
                let nodes = [];
                let connections = [];
                
                if (command.includes('Ï†ÑÏãú') || command.includes('exhibition')) {
                    nodes = [
                        { title: 'Ï†ÑÏãú Ï£ºÏ†ú ÏÑ†Ï†ï', type: 'idea', description: 'Ï†ÑÏãú Ïª®ÏÖâ Î∏åÎ†àÏù∏Ïä§ÌÜ†Î∞ç', x: 150, y: 150 },
                        { title: 'ÏûëÌíà ÏÑ†Ï†ï', type: 'task', description: 'ÌÅêÎ†àÏù¥ÏÖò Î∞è ÏûëÍ∞Ä ÏÑ†Ï†ï', x: 450, y: 150 }, /* x: 350 ‚Üí 450 */
                        { title: 'Ï†ÑÏãú Í≥µÍ∞Ñ ÏÑ§Í≥Ñ', type: 'task', description: 'Í≥µÍ∞Ñ Î†àÏù¥ÏïÑÏõÉ Í∏∞Ìöç', x: 750, y: 150 }, /* x: 550 ‚Üí 750 */
                        { title: 'ÏòàÏÇ∞ Í≥ÑÌöç', type: 'task', description: 'Ï†ÑÏãú ÏòàÏÇ∞ ÏàòÎ¶Ω', x: 450, y: 350 } /* x: 350 ‚Üí 450, y: 300 ‚Üí 350 */
                    ];
                    connections = [
                        { from: 0, to: 1 },
                        { from: 1, to: 2 },
                        { from: 1, to: 3 }
                    ];
                } else if (command.includes('ÍµêÏú°') || command.includes('education')) {
                    nodes = [
                        { title: 'ÌîÑÎ°úÍ∑∏Îû® Í∏∞Ìöç', type: 'idea', description: 'ÍµêÏú° ÌîÑÎ°úÍ∑∏Îû® ÏïÑÏù¥ÎîîÏñ¥', x: 150, y: 150 },
                        { title: 'ÏΩòÌÖêÏ∏† Í∞úÎ∞ú', type: 'task', description: 'ÌïôÏäµ ÏûêÎ£å Ï†úÏûë', x: 450, y: 150 }, /* x: 350 ‚Üí 450 */
                        { title: 'ÏõåÌÅ¨Ïàç ÏßÑÌñâ', type: 'task', description: 'Ïã§Ïäµ ÌîÑÎ°úÍ∑∏Îû® Ïö¥ÏòÅ', x: 750, y: 150 } /* x: 550 ‚Üí 750 */
                    ];
                    connections = [
                        { from: 0, to: 1 },
                        { from: 1, to: 2 }
                    ];
                } else {
                    // Default workflow
                    nodes = [
                        { title: '1. ÏïÑÏù¥ÎîîÏñ¥ ÏàòÏßë', type: 'idea', description: 'Î∏åÎ†àÏù∏Ïä§ÌÜ†Î∞ç', x: 150, y: 150 },
                        { title: '2. Í≥ÑÌöç ÏàòÎ¶Ω', type: 'task', description: 'Ïã§Ìñâ Í≥ÑÌöç', x: 450, y: 150 }, /* x: 350 ‚Üí 450 */
                        { title: '3. Ïã§Ìñâ', type: 'task', description: 'ÏûëÏóÖ ÏßÑÌñâ', x: 750, y: 150 }, /* x: 550 ‚Üí 750 */
                        { title: '4. ÌèâÍ∞Ä', type: 'task', description: 'Í≤∞Í≥º Î∂ÑÏÑù', x: 450, y: 350 } /* x: 350 ‚Üí 450, y: 300 ‚Üí 350 */
                    ];
                    connections = [
                        { from: 0, to: 1 },
                        { from: 1, to: 2 },
                        { from: 2, to: 3 }
                    ];
                }
                
                // Generate nodes
                addMessageToChat('ai', '‚úÖ ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.');
                generateWorkflowNodes(nodes, connections);
                showToast('‚ú® Í∏∞Î≥∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.', 'success');
            }
            
            // Generate Workflow Nodes
            function generateWorkflowNodes(nodes, connections) {
                if (!nodes || nodes.length === 0) return;
                
                // Don't clear existing nodes - just add new ones
                // This allows building complex workflows incrementally
                
                // Create nodes and store references
                const createdNodes = [];
                nodes.forEach(nodeData => {
                    const nodeElement = createNodeFromAI(nodeData);
                    createdNodes.push(nodeElement);
                });
                
                // Create connections (IMPLEMENTED - Phase C-4)
                if (connections && connections.length > 0) {
                    setTimeout(() => {
                        connections.forEach(conn => {
                            const fromNode = createdNodes[conn.from];
                            const toNode = createdNodes[conn.to];
                            
                            if (fromNode && toNode) {
                                drawConnection(fromNode, toNode);
                            }
                        });
                        
                        addMessageToChat('ai', `‚úÖ ${nodes.length}Í∞ú ÎÖ∏ÎìúÏôÄ ${connections.length}Í∞ú Ïó∞Í≤∞ÏÑ†Ïù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!`);
                    }, 200);
                } else {
                    addMessageToChat('ai', `‚úÖ ${nodes.length}Í∞úÏùò ÎÖ∏ÎìúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!`);
                }
            }
            
            // Create Node from AI data (returns node element)
            function createNodeFromAI(nodeData) {
                const node = document.createElement('div');
                node.className = 'node';
                node.style.left = `${nodeData.x || Math.random() * 500 + 100}px`;
                node.style.top = `${nodeData.y || Math.random() * 300 + 100}px`;
                node.style.width = '280px'; // Increased from 250px
                node.dataset.nodeId = `node-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                const iconMap = {
                    idea: 'lightbulb',
                    image: 'image',
                    chart: 'bar-chart-3',
                    document: 'file-text',
                    task: 'check-square'
                };
                
                const icon = iconMap[nodeData.type] || 'circle';
                
                // Enhanced node body with better visibility
                const description = nodeData.description || 'ÏÑ§Î™Ö ÏóÜÏùå';
                
                node.innerHTML = `
                    <div class="node-header">
                        <i data-lucide="${icon}" style="width: 16px; height: 16px;"></i>
                        <span class="node-title">${nodeData.title}</span>
                        <button class="node-delete">
                            <i data-lucide="x" style="width: 12px; height: 12px;"></i>
                        </button>
                    </div>
                    <div class="node-body">
                        <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">${description}</p>
                    </div>
                    <div class="node-handle node-handle-top"></div>
                    <div class="node-handle node-handle-right"></div>
                    <div class="node-handle node-handle-bottom"></div>
                    <div class="node-handle node-handle-left"></div>
                `;
                
                document.getElementById('nodes-container').appendChild(node);
                lucide.createIcons();
                makeDraggable(node);
                
                state.nodes.push({
                    id: node.dataset.nodeId,
                    title: nodeData.title,
                    type: nodeData.type,
                    description: nodeData.description
                });
                
                return node; // Return node element for connection logic
            }
            
            // Draw connection between two nodes (Phase C-4)
            function drawConnection(fromNode, toNode) {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                if (!ctx) return;
                
                // Get node positions
                const fromRect = fromNode.getBoundingClientRect();
                const toRect = toNode.getBoundingClientRect();
                const containerRect = document.getElementById('canvas-container').getBoundingClientRect();
                
                // Calculate connection points (center of nodes)
                const fromX = fromRect.left - containerRect.left + fromRect.width / 2;
                const fromY = fromRect.top - containerRect.top + fromRect.height / 2;
                const toX = toRect.left - containerRect.left + toRect.width / 2;
                const toY = toRect.top - containerRect.top + toRect.height / 2;
                
                // Draw line
                ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent-primary').trim() || '#8B5CF6';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(fromX, fromY);
                
                // Draw bezier curve for smooth connection
                const midX = (fromX + toX) / 2;
                ctx.bezierCurveTo(
                    midX, fromY,
                    midX, toY,
                    toX, toY
                );
                
                ctx.stroke();
                
                // Draw arrow at end
                const angle = Math.atan2(toY - fromY, toX - fromX);
                const arrowSize = 8;
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(
                    toX - arrowSize * Math.cos(angle - Math.PI / 6),
                    toY - arrowSize * Math.sin(angle - Math.PI / 6)
                );
                ctx.lineTo(
                    toX - arrowSize * Math.cos(angle + Math.PI / 6),
                    toY - arrowSize * Math.sin(angle + Math.PI / 6)
                );
                ctx.closePath();
                ctx.fillStyle = ctx.strokeStyle;
                ctx.fill();
            }
            
            // Generate Image Node (Placeholder for Phase C-1)
            function generateImageNode(nodeData) {
                createNodeFromAI({
                    ...nodeData,
                    type: 'image',
                    description: 'Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ÄÎπÑ Ï§ë...'
                });
                addMessageToChat('ai', 'üé® Ïù¥ÎØ∏ÏßÄ ÎÖ∏ÎìúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§. (Phase C-1ÏóêÏÑú Ïã§Ï†ú Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Íµ¨ÌòÑ ÏòàÏ†ï)');
            }
            
            // Generate Chart Node (IMPLEMENTED - Phase C-2)
            function generateChartNode(nodeData) {
                const chartId = `chart-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                const node = document.createElement('div');
                node.className = 'node';
                node.style.left = `${nodeData.x || Math.random() * 500 + 100}px`;
                node.style.top = `${nodeData.y || Math.random() * 300 + 100}px`;
                node.style.width = '420px'; // Increased from 320px
                
                node.innerHTML = `
                    <div class="node-header">
                        <i data-lucide="bar-chart-3" style="width: 14px; height: 14px;"></i>
                        <span class="node-title">${nodeData.title || 'Ï∞®Ìä∏'}</span>
                        <button class="node-delete">
                            <i data-lucide="x" style="width: 12px; height: 12px;"></i>
                        </button>
                    </div>
                    <div class="node-body">
                        <div class="node-chart-container">
                            <canvas id="${chartId}"></canvas>
                        </div>
                    </div>
                    <div class="node-handle node-handle-top"></div>
                    <div class="node-handle node-handle-right"></div>
                    <div class="node-handle node-handle-bottom"></div>
                    <div class="node-handle node-handle-left"></div>
                `;
                
                document.getElementById('nodes-container').appendChild(node);
                lucide.createIcons();
                makeDraggable(node);
                
                // Generate sample chart data based on role and title
                const chartData = generateSampleChartData(nodeData.title, state.currentRole);
                
                // Render chart using Chart.js
                setTimeout(() => {
                    const ctx = document.getElementById(chartId);
                    if (ctx) {
                        new Chart(ctx, {
                            type: chartData.type,
                            data: chartData.data,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'bottom',
                                        labels: {
                                            font: { size: 12 }, /* Increased from 10 */
                                            boxWidth: 14, /* Increased from 12 */
                                            padding: 10
                                        }
                                    },
                                    title: {
                                        display: false
                                    }
                                },
                                scales: chartData.type !== 'pie' && chartData.type !== 'doughnut' ? {
                                    y: {
                                        beginAtZero: true,
                                        ticks: { font: { size: 11 } } /* Increased from 10 */
                                    },
                                    x: {
                                        ticks: { font: { size: 11 } } /* Increased from 10 */
                                    }
                                } : {}
                            }
                        });
                    }
                }, 100);
                
                state.nodes.push({
                    id: chartId,
                    title: nodeData.title,
                    type: 'chart'
                });
                
                addMessageToChat('ai', `üìä ${nodeData.title} Ï∞®Ìä∏Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!`);
            }
            
            // Generate sample chart data
            function generateSampleChartData(title, role) {
                const lowerTitle = (title || '').toLowerCase();
                
                // Budget/Finance chart
                if (lowerTitle.includes('ÏòàÏÇ∞') || lowerTitle.includes('Ïû¨Ï†ï') || lowerTitle.includes('budget')) {
                    return {
                        type: 'bar',
                        data: {
                            labels: ['Ï†ÑÏãú', 'ÍµêÏú°', 'ÎßàÏºÄÌåÖ', 'Ïö¥ÏòÅ', 'Í∏∞ÌÉÄ'],
                            datasets: [{
                                label: 'ÏòàÏÇ∞ (ÎßåÏõê)',
                                data: [5000, 3000, 2000, 2500, 1500],
                                backgroundColor: 'rgba(139, 92, 246, 0.6)',
                                borderColor: 'rgba(139, 92, 246, 1)',
                                borderWidth: 1
                            }]
                        }
                    };
                }
                
                // Visitor/Audience chart
                if (lowerTitle.includes('Í¥ÄÎûåÍ∞ù') || lowerTitle.includes('Î∞©Î¨∏Í∞ù') || lowerTitle.includes('visitor')) {
                    return {
                        type: 'line',
                        data: {
                            labels: ['1Ïõî', '2Ïõî', '3Ïõî', '4Ïõî', '5Ïõî', '6Ïõî'],
                            datasets: [{
                                label: 'Í¥ÄÎûåÍ∞ù Ïàò',
                                data: [1200, 1900, 3000, 2500, 2800, 3500],
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        }
                    };
                }
                
                // Distribution/Category chart
                if (lowerTitle.includes('Î∂ÑÌè¨') || lowerTitle.includes('ÎπÑÏú®') || lowerTitle.includes('distribution')) {
                    return {
                        type: 'doughnut',
                        data: {
                            labels: ['Ï≤≠ÏÜåÎÖÑ', 'Ï≤≠ÎÖÑ', 'Ï§ëÎÖÑ', 'ÎÖ∏ÎÖÑ'],
                            datasets: [{
                                data: [25, 35, 30, 10],
                                backgroundColor: [
                                    'rgba(139, 92, 246, 0.8)',
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(245, 158, 11, 0.8)'
                                ]
                            }]
                        }
                    };
                }
                
                // Default bar chart
                return {
                    type: 'bar',
                    data: {
                        labels: ['Ìï≠Î™©1', 'Ìï≠Î™©2', 'Ìï≠Î™©3', 'Ìï≠Î™©4', 'Ìï≠Î™©5'],
                        datasets: [{
                            label: title || 'Îç∞Ïù¥ÌÑ∞',
                            data: [65, 59, 80, 81, 56],
                            backgroundColor: 'rgba(139, 92, 246, 0.6)',
                            borderColor: 'rgba(139, 92, 246, 1)',
                            borderWidth: 1
                        }]
                    }
                };
            }
            
            // Generate Document Node (IMPLEMENTED - Phase C-3)
            async function generateDocumentNode(nodeData) {
                const docId = `doc-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                const node = document.createElement('div');
                node.className = 'node';
                node.style.left = `${nodeData.x || Math.random() * 500 + 100}px`;
                node.style.top = `${nodeData.y || Math.random() * 300 + 100}px`;
                node.style.width = '360px';
                
                node.innerHTML = `
                    <div class="node-header">
                        <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
                        <span class="node-title">${nodeData.title || 'Î¨∏ÏÑú'}</span>
                        <button class="node-delete">
                            <i data-lucide="x" style="width: 12px; height: 12px;"></i>
                        </button>
                    </div>
                    <div class="node-body">
                        <div class="node-document-container" id="${docId}">
                            <div class="node-loading">
                                <i data-lucide="loader" style="width: 16px; height: 16px;"></i>
                                <span>AIÍ∞Ä Î¨∏ÏÑúÎ•º ÏûëÏÑ± Ï§ëÏûÖÎãàÎã§...</span>
                            </div>
                        </div>
                    </div>
                    <div class="node-handle node-handle-top"></div>
                    <div class="node-handle node-handle-right"></div>
                    <div class="node-handle node-handle-bottom"></div>
                    <div class="node-handle node-handle-left"></div>
                `;
                
                document.getElementById('nodes-container').appendChild(node);
                lucide.createIcons();
                makeDraggable(node);
                
                // Generate document content with AI
                try {
                    const content = await generateDocumentContent(nodeData.title, state.currentRole);
                    
                    const docContainer = document.getElementById(docId);
                    if (docContainer) {
                        docContainer.innerHTML = content;
                    }
                    
                    addMessageToChat('ai', `üìÑ ${nodeData.title} Î¨∏ÏÑúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!`);
                    
                } catch (error) {
                    console.error('Document generation error:', error);
                    const docContainer = document.getElementById(docId);
                    if (docContainer) {
                        // Generate fallback document content
                        const fallbackContent = generateFallbackDocument(nodeData.title, state.currentRole);
                        docContainer.innerHTML = fallbackContent;
                    }
                    addMessageToChat('ai', '‚ö†Ô∏è AI API Ïò§Î•ò. Í∏∞Î≥∏ Î¨∏ÏÑú ÌÖúÌîåÎ¶øÏùÑ ÏÉùÏÑ±ÌñàÏäµÎãàÎã§.');
                }
                
                state.nodes.push({
                    id: docId,
                    title: nodeData.title,
                    type: 'document'
                });
            }
            
            // Generate document content using AI
            async function generateDocumentContent(title, role) {
                const response = await fetch('/api/ai/document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        role: role
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Î¨∏ÏÑú ÏÉùÏÑ± API Ïò§Î•ò');
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Î¨∏ÏÑú ÏÉùÏÑ± Ïã§Ìå®');
                }
                
                return formatDocumentContent(result.content);
            }
            
            // Generate fallback document (when API fails)
            function generateFallbackDocument(title, role) {
                const templates = {
                    curator: `
                        <h3 style="font-size: 14px; font-weight: 600; margin: 0 0 12px 0;">${title}</h3>
                        <p style="margin: 8px 0; font-size: 12px; line-height: 1.6;">
                            <strong>Í∞úÏöî</strong><br>
                            Ï†ÑÏãú Í∏∞ÌöçÏùò ÌïµÏã¨ Î™©ÌëúÏôÄ Î∞©Ìñ•ÏÑ±ÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§.
                        </p>
                        <p style="margin: 8px 0; font-size: 12px; line-height: 1.6;">
                            <strong>Ï£ºÏöî ÎÇ¥Ïö©</strong><br>
                            ‚Ä¢ Ï†ÑÏãú Ï£ºÏ†ú Î∞è Ïª®ÏÖâ<br>
                            ‚Ä¢ ÏûëÌíà ÏÑ†Ï†ï Í∏∞Ï§Ä<br>
                            ‚Ä¢ Ï†ÑÏãú Í≥µÍ∞Ñ Íµ¨ÏÑ±
                        </p>
                        <p style="margin: 8px 0; font-size: 12px; line-height: 1.6;">
                            <strong>Í∏∞ÎåÄ Ìö®Í≥º</strong><br>
                            Í¥ÄÎûåÍ∞ùÏóêÍ≤å ÏùòÎØ∏ ÏûàÎäî ÏòàÏà† Í≤ΩÌóòÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.
                        </p>
                    `,
                    educator: `
                        <h3 style="font-size: 14px; font-weight: 600; margin: 0 0 12px 0;">${title}</h3>
                        <p style="margin: 8px 0; font-size: 12px; line-height: 1.6;">
                            <strong>ÌîÑÎ°úÍ∑∏Îû® Î™©Ìëú</strong><br>
                            Ï∞∏Ïó¨ÏûêÏùò ÌïôÏäµ Í≤ΩÌóòÏùÑ Í∑πÎåÄÌôîÌï©ÎãàÎã§.
                        </p>
                        <p style="margin: 8px 0; font-size: 12px; line-height: 1.6;">
                            <strong>Ï£ºÏöî ÌôúÎèô</strong><br>
                            ‚Ä¢ Ï≤¥ÌóòÌòï ÏõåÌÅ¨Ïàç<br>
                            ‚Ä¢ Ï†ÑÎ¨∏Í∞Ä Í∞ïÏó∞<br>
                            ‚Ä¢ Í∑∏Î£π ÌôúÎèô
                        </p>
                        <p style="margin: 8px 0; font-size: 12px; line-height: 1.6;">
                            <strong>ÌèâÍ∞Ä Î∞©Î≤ï</strong><br>
                            Ï∞∏Ïó¨ÎèÑÏôÄ ÎßåÏ°±ÎèÑÎ•º Í∏∞Ï§ÄÏúºÎ°ú ÌèâÍ∞ÄÌï©ÎãàÎã§.
                        </p>
                    `,
                    admin: `
                        <h3 style="font-size: 14px; font-weight: 600; margin: 0 0 12px 0;">${title}</h3>
                        <p style="margin: 8px 0; font-size: 12px; line-height: 1.6;">
                            <strong>Í¥ÄÎ¶¨ Î™©Ìëú</strong><br>
                            Ìö®Ïú®Ï†ÅÏù∏ Ïö¥ÏòÅ Î∞è ÏûêÏõê Í¥ÄÎ¶¨Î•º ÏàòÌñâÌï©ÎãàÎã§.
                        </p>
                        <p style="margin: 8px 0; font-size: 12px; line-height: 1.6;">
                            <strong>Ï£ºÏöî ÏóÖÎ¨¥</strong><br>
                            ‚Ä¢ ÏòàÏÇ∞ Í¥ÄÎ¶¨<br>
                            ‚Ä¢ Ïù∏Î†• Î∞∞Ïπò<br>
                            ‚Ä¢ ÏùºÏ†ï Ï°∞Ïú®
                        </p>
                        <p style="margin: 8px 0; font-size: 12px; line-height: 1.6;">
                            <strong>ÏÑ±Í≥º ÏßÄÌëú</strong><br>
                            Î™©Ìëú ÎåÄÎπÑ Ïã§Ï†ÅÏùÑ Ï†ïÍ∏∞Ï†ÅÏúºÎ°ú Î™®ÎãàÌÑ∞ÎßÅÌï©ÎãàÎã§.
                        </p>
                    `
                };
                
                return templates[role] || templates.curator;
            }
            
            // Format document content as HTML
            function formatDocumentContent(content) {
                if (!content) return '<p>ÎÇ¥Ïö© ÏóÜÏùå</p>';
                
                // Convert Markdown-style formatting to HTML
                let html = content
                    .replace(/### (.*)/g, '<h4 style="font-size: 13px; font-weight: 600; margin: 12px 0 6px 0;">$1</h4>')
                    .replace(/## (.*)/g, '<h3 style="font-size: 14px; font-weight: 600; margin: 14px 0 8px 0;">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/- (.*)/g, '<li style="margin-left: 16px;">$1</li>')
                    .replace(/\n\n/g, '</p><p style="margin: 8px 0;">')
                    .replace(/\n/g, '<br>');
                
                return `<p style="margin: 8px 0;">${html}</p>`;
            }
            
            // ==========================================
            // Dashboard ‚Üí Canvas ÏûêÎèô ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏÉùÏÑ±
            // ==========================================
            
            /**
             * DashboardÏóêÏÑú Ï†ÑÎã¨Îêú Task ÌôïÏù∏ Î∞è ÏûêÎèô ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏÉùÏÑ±
             */
            async function checkPendingDashboardTask() {
                const pendingTask = localStorage.getItem('pending_canvas_task');
                
                if (pendingTask) {
                    try {
                        const taskData = JSON.parse(pendingTask);
                        console.log('[Canvas] Received Dashboard task:', taskData);
                        
                        // Task Ï†ïÎ≥¥ ÌëúÏãú
                        addMessageToChat('system', `üìã DashboardÏóêÏÑú "${taskData.title}" ÏûëÏóÖÏùÑ ÏãúÏûëÌï©ÎãàÎã§.`);
                        addMessageToChat('system', 'ü§ñ AIÍ∞Ä ÏûêÎèôÏúºÎ°ú ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§...');
                        
                        // ÏûêÎèô ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏÉùÏÑ±
                        await generateTaskWorkflow(taskData);
                        
                        // ÏÇ¨Ïö© ÌõÑ ÏÇ≠Ï†ú
                        localStorage.removeItem('pending_canvas_task');
                    } catch (error) {
                        console.error('[Canvas] Error processing dashboard task:', error);
                    }
                }
            }
            
            /**
             * Task Í∏∞Î∞ò ÏûêÎèô ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏÉùÏÑ±
             */
            async function generateTaskWorkflow(taskData) {
                // Task ‚Üí Workflow Îß§Ìïë ÌÖåÏù¥Î∏î
                const TASK_TO_WORKFLOW_MAPPING = {
                    "Ï†ÑÏãú ÎùºÎ≤® ÏûëÏÑ±": {
                        workflow_type: "document",
                        auto_nodes: [
                            { type: "document", title: "Ï†ÑÏãú ÎùºÎ≤®", icon: "üìù", description: "Ï†ÑÏãú ÎùºÎ≤® ÎÇ¥Ïö© ÏûëÏÑ±" },
                            { type: "idea", title: "ÎùºÎ≤® Íµ¨ÏÑ±Ïïà", icon: "üí°", description: "ÎùºÎ≤® Íµ¨ÏÑ± ÏïÑÏù¥ÎîîÏñ¥" }
                        ]
                    },
                    "ÏòàÏÇ∞ ÏäπÏù∏": {
                        workflow_type: "budget",
                        auto_nodes: [
                            { type: "chart", title: "ÏòàÏÇ∞ Í≥ÑÌöç", icon: "üí∞", chartType: "bar", description: "ÏòàÏÇ∞ Ìï≠Î™©Î≥Ñ Î∂ÑÏÑù" },
                            { type: "document", title: "ÏòàÏÇ∞ ÏÇ∞Ï∂ú Í∑ºÍ±∞", icon: "üìä", description: "ÏòàÏÇ∞ Í≥ÑÏÇ∞ Í∑ºÍ±∞ Î¨∏ÏÑú" },
                            { type: "task", title: "ÏòàÏÇ∞ Í≤ÄÌÜ†", icon: "‚úÖ", description: "ÏµúÏ¢Ö ÏòàÏÇ∞ Í≤ÄÌÜ† Îã®Í≥Ñ" }
                        ]
                    },
                    "ÏÜåÏû•Ìíà ÏÑ†Ï†ï": {
                        workflow_type: "collection",
                        auto_nodes: [
                            { type: "image", title: "ÏÜåÏû•Ìíà Ïù¥ÎØ∏ÏßÄ", icon: "üñºÔ∏è", description: "ÏÜåÏû•Ìíà Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú" },
                            { type: "document", title: "ÏûëÌíà ÏÑ§Î™Ö", icon: "üìÑ", description: "ÏûëÌíà ÏÑ§Î™Ö Î¨∏ÏÑú ÏûëÏÑ±" },
                            { type: "chart", title: "ÏÑ†Ï†ï Í∏∞Ï§Ä Î∂ÑÏÑù", icon: "üìä", chartType: "radar", description: "ÏûëÌíà ÏÑ†Ï†ï Í∏∞Ï§Ä Î∂ÑÏÑù" }
                        ]
                    },
                    "ÌôçÎ≥¥ Í≥ÑÌöç ÏàòÎ¶Ω": {
                        workflow_type: "promotion",
                        auto_nodes: [
                            { type: "idea", title: "ÌôçÎ≥¥ Ï†ÑÎûµ", icon: "üí°", description: "ÌôçÎ≥¥ Ï†ÑÎûµ ÏïÑÏù¥ÎîîÏñ¥" },
                            { type: "image", title: "ÌôçÎ≥¥ Ìè¨Ïä§ÌÑ∞", icon: "üé®", description: "ÌôçÎ≥¥ Ìè¨Ïä§ÌÑ∞ ÎîîÏûêÏù∏" },
                            { type: "document", title: "SNS ÏΩòÌÖêÏ∏†", icon: "üì±", description: "SNS Í≤åÏãúÎ¨º ÏûëÏÑ±" },
                            { type: "chart", title: "ÌôçÎ≥¥ ÏòàÏÇ∞", icon: "üí∞", chartType: "pie", description: "ÌôçÎ≥¥ ÏòàÏÇ∞ Î∂ÑÎ∞∞" }
                        ]
                    }
                };
                
                const workflow = TASK_TO_WORKFLOW_MAPPING[taskData.title];
                
                if (workflow) {
                    // ÏûêÎèôÏúºÎ°ú Node ÏÉùÏÑ±
                    for (let i = 0; i < workflow.auto_nodes.length; i++) {
                        const nodeData = workflow.auto_nodes[i];
                        
                        await new Promise(resolve => setTimeout(resolve, i * 400)); // 0.4Ï¥à Í∞ÑÍ≤©
                        
                        if (nodeData.type === 'chart') {
                            addMessageToChat('assistant', `üìä ${nodeData.title} Ï∞®Ìä∏Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.`);
                            generateChartNode({
                                title: nodeData.title,
                                chartType: nodeData.chartType || 'bar'
                            });
                        } else if (nodeData.type === 'document') {
                            addMessageToChat('assistant', `üìÑ ${nodeData.title} Î¨∏ÏÑúÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.`);
                            generateDocumentNode({
                                title: nodeData.title
                            });
                        } else if (nodeData.type === 'image') {
                            addMessageToChat('assistant', `üñºÔ∏è ${nodeData.title} ÎÖ∏ÎìúÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.`);
                            generateImageNode({
                                title: nodeData.title
                            });
                        } else {
                            createNodeFromAI({
                                type: nodeData.type,
                                title: nodeData.title,
                                description: nodeData.description,
                                icon: nodeData.icon
                            });
                        }
                    }
                    
                    addMessageToChat('assistant', `‚úÖ ${workflow.auto_nodes.length}Í∞úÏùò ÏûëÏóÖ ÎÖ∏ÎìúÎ•º ÏÉùÏÑ±ÌñàÏäµÎãàÎã§. Ïù¥Ï†ú Í∞Å ÎÖ∏ÎìúÏóê ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.`);
                    
                    // DashboardÏóê ÏßÑÌñâ ÏÉÅÌÉú Ï†ÑÏÜ°
                    await syncTaskToDashboard({
                        task_title: taskData.title,
                        status: 'in-progress',
                        nodes_created: workflow.auto_nodes.length
                    });
                } else {
                    // Fallback: AIÏóêÍ≤å ÏûêÏó∞Ïñ¥Î°ú ÏöîÏ≤≠
                    addMessageToChat('assistant', 'ü§ñ AIÍ∞Ä ÎßûÏ∂§Ìòï ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§...');
                    await sendAICommand(`"${taskData.title}" ÏóÖÎ¨¥Î•º ÏúÑÌïú ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º ÎßåÎì§Ïñ¥Ï§ò`);
                }
            }
            
            /**
             * Canvas ‚Üí Dashboard Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî
             */
            async function syncTaskToDashboard(data) {
                try {
                    const response = await fetch('/api/dashboard/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            node_id: `task_${Date.now()}`,
                            node_type: 'workflow',
                            node_title: data.task_title,
                            status: data.status,
                            data: data
                        })
                    });
                    
                    if (response.ok) {
                        console.log('[Canvas ‚Üí Dashboard] Sync successful');
                    }
                } catch (error) {
                    console.error('[Canvas ‚Üí Dashboard] Sync failed:', error);
                }
            }
            
            /**
             * Node ÏôÑÎ£å ÌëúÏãú (Ïö∞ÌÅ¥Î¶≠ Î©îÎâ¥ÏóêÏÑú Ìò∏Ï∂ú)
             */
            async function markNodeAsCompleted(nodeId) {
                const node = state.nodes.find(n => n.id === nodeId);
                if (!node) return;
                
                // 1. Node ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                node.status = 'completed';
                node.completedAt = Date.now();
                
                // 2. Node UI ÏóÖÎç∞Ïù¥Ìä∏ (Ï¥àÎ°ùÏÉâ Ï≤¥ÌÅ¨ ÌëúÏãú)
                const nodeElement = document.getElementById(nodeId);
                if (nodeElement) {
                    nodeElement.style.border = '2px solid #10B981';
                    const header = nodeElement.querySelector('.node-header');
                    if (header && !header.querySelector('.fa-check-circle')) {
                        header.innerHTML += ' <i class="fas fa-check-circle" style="color: #10B981;"></i>';
                    }
                }
                
                // 3. DashboardÏóê Ïã§ÏãúÍ∞Ñ Ï†ÑÏÜ°
                await syncNodeToDashboard(node);
                
                addMessageToChat('system', `‚úÖ "${node.title}" ÎÖ∏ÎìúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. DashboardÏóê Î∞òÏòÅÎêòÏóàÏäµÎãàÎã§.`);
            }
            
            /**
             * Node ‚Üí Dashboard ÎèôÍ∏∞Ìôî
             */
            async function syncNodeToDashboard(nodeData) {
                try {
                    const response = await fetch('/api/dashboard/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            node_id: nodeData.id,
                            node_type: nodeData.type,
                            node_title: nodeData.title,
                            status: nodeData.status || 'in-progress',
                            completed_at: nodeData.completedAt || null,
                            data: nodeData
                        })
                    });
                    
                    if (response.ok) {
                        console.log('[Canvas ‚Üí Dashboard] Node synced:', nodeData.title);
                    }
                } catch (error) {
                    console.error('[Canvas ‚Üí Dashboard] Sync failed:', error);
                }
            }
        });
    </script>

    <!-- MuseFlow Footer -->
    <footer class="museflow-footer">
        <div class="museflow-footer-content">
            <div class="museflow-footer-logo">
                ‚ú® MuseFlow
            </div>
            <div class="museflow-footer-divider"></div>
            <div class="museflow-footer-text">
                Copyright ¬© 2026, Imageroot
            </div>
            <div class="museflow-footer-divider"></div>
            <div class="museflow-footer-text">
                Made by Hyun Woo Nam Professor
            </div>
            <div class="museflow-footer-divider"></div>
            <div class="museflow-footer-version">
                V4.0
            </div>
        </div>
    </footer>

</body>
</html>
