<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<title>MuseFlow Canvas - Enhanced</title>

<!-- Google Analytics 4 -->



<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="preload" href="/static/css/fontawesome-all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/static/css/fontawesome-all.min.css"></noscript>

<script src="https://unpkg.com/lucide@latest"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

*:not(input):not(textarea):not(select) {
    border: none !important;
    outline: none !important;
}

body {
    font-family: Inter, sans-serif;
    background: #fafbfc;
    color: #1f2937;
    overflow: hidden;
}

/* Unified Navbar - Dashboard Style */
.unified-navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1001;
    padding: 0;
}

.unified-nav-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0.75rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 64px;
}

.unified-nav-logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    color: #e5e5e5;
    font-weight: 700;
    font-size: 1.25rem;
    transition: transform 0.3s;
}

.unified-nav-logo:hover {
    transform: translateY(-2px);
}

.unified-nav-logo img {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
}

.unified-nav-links {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    list-style: none;
    padding: 0;
    margin: 0;
}

.unified-nav-links a {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    color: #9CA3AF;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s;
    font-size: 1.1rem;
}

.unified-nav-links a:hover {
    background: rgba(139, 92, 246, 0.15);
    color: #8B5CF6;
    transform: translateY(-2px);
}

.unified-nav-links a.active {
    background: rgba(139, 92, 246, 0.25);
    color: #8B5CF6;
    border: 1px solid rgba(139, 92, 246, 0.4);
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
}

.unified-nav-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.unified-nav-btn {
    background: rgba(139, 92, 246, 0.15);
    border: 1px solid rgba(139, 92, 246, 0.3);
    width: 44px;
    height: 44px;
    border-radius: 12px;
    color: #9CA3AF;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    font-size: 1.1rem;
}

.unified-nav-btn:hover {
    background: rgba(139, 92, 246, 0.25);
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    color: #8B5CF6;
}

.unified-nav-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.unified-nav-btn {
    width: 44px;
    height: 44px;
    background: rgba(139, 92, 246, 0.15);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 12px;
    color: #9CA3AF;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    font-size: 1.1rem;
}

.unified-nav-btn:hover {
    background: rgba(139, 92, 246, 0.25);
    color: #8B5CF6;
    transform: scale(1.05);
}

/* Container with navbar offset */
.container {
    display: grid;
    grid-template-columns: 40px 1fr 40px;
    height: calc(100vh - 64px - 48px); /* navbar + footer */
    margin-top: 64px;
}

.sidebar {
    background: linear-gradient(180deg, #1a1a1a, #0f0f0f);
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
    padding: 8px 3px;
    gap: 4px;
}

.sidebar.right {
    border-left: 1px solid #333;
    border-right: none;
}

.icon {
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    cursor: pointer;
    border-radius: 8px;
    transition: 0.2s;
    position: relative;
}

.icon:hover {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}

.icon.active {
    background: rgba(16, 185, 129, 0.25);
    color: #10b981;
}

.badge {
    position: absolute;
    top: 2px;
    right: 2px;
    background: #ef4444;
    color: #fff;
    font-size: 9px;
    min-width: 14px;
    height: 14px;
    border-radius: 7px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
}

.canvas {
    background: #ffffff;
    overflow: hidden;
    position: relative;
    /* Grid pattern */
    background-image: 
        linear-gradient(rgba(139, 92, 246, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(139, 92, 246, 0.1) 1px, transparent 1px);
    background-size: 20px 20px;
}

.viewport {
    width: 100%;
    height: 100%;
    position: relative;
    cursor: grab;
}

.viewport.dragging {
    cursor: grabbing;
}

.panel {
    position: fixed;
    top: 64px;
    bottom: 48px;
    width: 280px;
    background: rgba(26, 26, 26, 0.98);
    border: 1px solid #333;
    z-index: 100;
    transform: translateX(-100%);
    transition: 0.3s;
    display: none;
}

.panel.left {
    left: 40px;
}

.panel.right {
    right: 40px;
    transform: translateX(100%);
}

.panel.active {
    display: block;
    transform: translateX(0);
}

.panel-header {
    padding: 16px;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
}

.panel-title {
    font-size: 14px;
    font-weight: 600;
}

.panel-close {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: #666;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.panel-close:hover {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}

.panel-content {
    padding: 16px;
    color: #999;
    font-size: 13px;
}

/* Media Card with thumbnail */
.card {
    position: absolute !important;
    width: 300px;
    min-width: 200px;
    min-height: 200px;
    background: #ffffff !important;
    border-radius: 8px !important;
    border: 0 none transparent !important;
    outline: 0 none transparent !important;
    box-shadow: 0 4px 20px rgba(139, 92, 246, 0.08), 0 2px 8px rgba(139, 92, 246, 0.04) !important;
    overflow: hidden !important;
    cursor: move;
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 8px 30px rgba(139, 92, 246, 0.12), 0 4px 12px rgba(139, 92, 246, 0.06) !important;
    transform: translateY(-2px) !important;
    border: 0 none transparent !important;
    outline: 0 none transparent !important;
}

.card.selected {
    box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.4), 0 4px 20px rgba(139, 92, 246, 0.15) !important;
    z-index: 1000 !important;
    border: 0 none transparent !important;
    outline: 0 none transparent !important;
}

.card *,
.card *::before,
.card *::after {
    border: 0 none transparent !important;
    outline: 0 none transparent !important;
}



/* Resize Handles */
.resize-handle {
    position: absolute;
    width: 12px;
    height: 12px;
    background: #8b5cf6;
    border: none;
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
}

.card.selected .resize-handle {
    opacity: 1;
}

.resize-se { bottom: -6px; right: -6px; cursor: nwse-resize; }
.resize-ne { top: -6px; right: -6px; cursor: nesw-resize; }
.resize-sw { bottom: -6px; left: -6px; cursor: nesw-resize; }
.resize-nw { top: -6px; left: -6px; cursor: nwse-resize; }
.resize-e { top: 50%; right: -6px; transform: translateY(-50%); cursor: ew-resize; }
.resize-w { top: 50%; left: -6px; transform: translateY(-50%); cursor: ew-resize; }
.resize-n { top: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
.resize-s { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }

.card-thumbnail {
    width: 100%;
    height: 160px;
    background: linear-gradient(135deg, #C8A5FF 0%, #A5D5FF 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    overflow: hidden;
    position: relative;
    border-radius: 8px 8px 0 0;
}

.card-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-thumbnail video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-thumbnail.video {
    background: linear-gradient(135deg, #FFA5A5 0%, #A5B5FF 100%);
}

.card-thumbnail.audio {
    background: linear-gradient(135deg, #A5D5FF 0%, #A5FFA5 100%);
}

.card-thumbnail.image {
    background: linear-gradient(135deg, #FFB595 0%, #FFA5D5 100%);
}

.card-thumbnail.document {
    background: linear-gradient(135deg, #FFB595 0%, #FFA5C5 100%);
}

.card-thumbnail.data {
    background: linear-gradient(135deg, #A5B5FF 0%, #A5FFB5 100%);
}

.card-header {
    padding: 10px 12px;
    background: #ffffff;
    color: #1f2937;
    font-weight: 500;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #e5e7eb;
}

.card-header.video {
    background: linear-gradient(to right, #FFF5F5, #ffffff);
    border-left: 3px solid #EF4444;
}

.card-header.audio {
    background: linear-gradient(to right, #F0F9FF, #ffffff);
    border-left: 3px solid #3B82F6;
}

.card-header.image {
    background: linear-gradient(to right, #FFF7ED, #ffffff);
    border-left: 3px solid #F59E0B;
}

.card-header.document {
    background: linear-gradient(to right, #FDF4FF, #ffffff);
    border-left: 3px solid #A855F7;
}

.card-header.data {
    background: linear-gradient(to right, #F0FDF4, #ffffff);
    border-left: 3px solid #10B981;
}

.card-title {
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
}

.card-actions {
    display: flex;
    gap: 4px;
}

.card-action-btn {
    width: 24px;
    height: 24px;
    border: none;
    background: #f3f4f6;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    color: #6b7280;
}

.card-action-btn:hover {
    background: #e5e7eb;
    color: #374151;
    transform: scale(1.05);
}

.card-action-btn:active {
    transform: scale(0.95);
}

.card-footer {
    padding: 8px 12px;
    background: #f9fafb;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 11px;
    color: #6b7280;
    border-radius: 0 0 8px 8px;
}

.card-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.controls {
    display: flex;
    gap: 8px;
    background: rgba(26, 26, 26, 0.98);
    padding: 8px 12px;
    border-radius: 12px;
    border: 1px solid #333;
    z-index: 50;
}

.ctrl-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #374151;
    background: rgba(17, 24, 39, 0.6);
    color: #9ca3af;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ctrl-btn:hover {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}

.zoom-level {
    color: #9ca3af;
    font-size: 13px;
    min-width: 45px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-input {
    position: fixed;
    bottom: 68px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 12px;
    background: rgba(26, 26, 26, 0.98);
    padding: 12px 16px;
    border-radius: 16px;
    border: 1px solid #333;
    z-index: 50;
}

.ai-select {
    padding: 6px 10px;
    background: rgba(17, 24, 39, 0.6);
    border: 1px solid #374151;
    border-radius: 8px;
    color: #e5e7eb;
    font-size: 13px;
}

.ai-field {
    flex: 1;
    min-width: 300px;
    padding: 8px 12px;
    background: rgba(17, 24, 39, 0.6);
    border: 1px solid #374151;
    border-radius: 10px;
    color: #e5e7eb;
    font-size: 14px;
}

.ai-field:focus {
    outline: none;
    border-color: #10b981;
}

.ai-send {
    width: 36px;
    height: 36px;
    border: none;
    background: #10b981;
    color: #fff;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-send:hover {
    background: #059669;
}

/* Footer */
.footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 48px;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    padding: 0 2rem;
    font-size: 13px;
    color: #9ca3af;
    z-index: 1000;
}

.footer-left {
    display: flex;
    gap: 1.5rem;
}

.footer-link {
    color: #9ca3af;
    text-decoration: none;
    transition: color 0.2s;
}

.footer-link:hover {
    color: #8B5CF6;
}

/* Animations */
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.05); }
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.card {
    animation: slideIn 0.3s ease-out;
}

/* Card Click Effects */
.card:hover {
    box-shadow: none;
    transform: none;
}

.card-thumbnail:hover {
    cursor: pointer;
}

/* Modal Viewer */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease-out;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    max-width: 90vw;
    max-height: 90vh;
    position: relative;
    animation: scaleIn 0.3s ease-out;
}

.modal-content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 12px;
}

.modal-content video {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 12px;
}

.modal-close {
    position: absolute;
    top: -50px;
    right: 0;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes scaleIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* Connection Lines (Google Opal Style) */
.connection-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
}

.card-connector {
    position: absolute;
    background: #9ca3af;
    height: 2px;
    transform-origin: 0 0;
    transition: all 0.3s ease;
    pointer-events: none;
}

.card-connector.active {
    background: #6b7280;
    height: 2px;
    box-shadow: 0 0 8px rgba(156, 163, 175, 0.4);
}

.card-connector-dot {
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #8B5CF6;
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
    z-index: 1;
}

.connection-handle {
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #8B5CF6;
    border: 3px solid #ffffff;
    cursor: crosshair;
    opacity: 0.6;
    transition: all 0.2s;
    z-index: 10;
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
}

.card:hover .connection-handle,
.card.selected .connection-handle {
    opacity: 1;
    transform: translateY(-50%) scale(1.2);
}

.connection-handle:hover {
    background: #f59e0b;
    border-color: #ffffff;
    box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
}

/* ============================================
   MOBILE OPTIMIZATION
   ============================================ */

@media (max-width: 768px) {
    /* Navbar Mobile */
    .unified-nav-container {
        padding: 0.5rem 1rem;
        height: 56px;
    }
    
    .unified-nav-logo {
        font-size: 1rem;
        gap: 0.5rem;
    }
    
    .unified-nav-logo img {
        width: 32px;
        height: 32px;
    }
    
    .unified-nav-links {
        gap: 0.25rem;
    }
    
    .unified-nav-links a {
        width: 38px;
        height: 38px;
        font-size: 1rem;
    }
    
    /* Sidebar Mobile - 전체 너비로 하단에 표시 */
    .left-sidebar,
    .right-sidebar {
        width: 100% !important;
        max-width: 100% !important;
        height: 60vh;
        top: auto;
        bottom: 0;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }
    
    .left-sidebar.open {
        transform: translateY(0);
    }
    
    .right-sidebar.open {
        transform: translateY(0);
    }
    
    /* Sidebar Toggle Buttons - 하단 고정 */
    .sidebar-toggle-left {
        bottom: 56px;
        top: auto;
        left: 1rem;
        width: 48px;
        height: 48px;
    }
    
    .sidebar-toggle-right {
        bottom: 56px;
        top: auto;
        right: 1rem;
        width: 48px;
        height: 48px;
    }
    
    /* Panel Selector Mobile */
    .panel-selector {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.75rem;
    }
    
    .panel-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        min-width: 60px;
    }
    
    /* Cards Mobile - 터치 친화적 크기 */
    .card {
        min-width: 200px !important;
        max-width: 280px !important;
        padding: 1rem;
    }
    
    .card-header h3 {
        font-size: 0.9rem;
    }
    
    .card-thumbnail {
        height: 120px;
    }
    
    .card-content {
        font-size: 0.8rem;
    }
    
    /* AI Input Mobile - 전체 너비 */
    .ai-input {
        left: 0;
        right: 0;
        bottom: 56px;
        transform: none;
        flex-direction: column;
        padding: 1rem;
        border-radius: 20px 20px 0 0;
        gap: 0.75rem;
        max-width: 100%;
    }
    
    .ai-select {
        width: 100%;
        padding: 0.75rem;
        font-size: 14px;
    }
    
    .ai-field {
        min-width: auto;
        width: 100%;
        padding: 0.75rem;
        font-size: 14px;
    }
    
    .ai-send {
        width: 100%;
        height: 44px;
        border-radius: 12px;
        font-size: 1rem;
    }
    
    /* Zoom Controls Mobile */
    .zoom-controls {
        bottom: 116px;
        right: 1rem;
        gap: 0.5rem;
        padding: 0.5rem;
    }
    
    .zoom-btn {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    /* Footer Mobile */
    .footer {
        height: 56px;
        padding: 0 1rem;
        font-size: 0.75rem;
        gap: 1rem;
    }
    
    .footer-left {
        gap: 0.75rem;
    }
    
    /* Canvas Viewport Mobile */
    #canvasViewport {
        top: 56px;
        bottom: 56px;
    }
    
    /* Modal Mobile */
    .modal-content {
        width: 95%;
        max-width: 95%;
        padding: 1rem;
    }
    
    .modal-close {
        top: 0.5rem;
        right: 0.5rem;
        width: 36px;
        height: 36px;
        font-size: 1.2rem;
    }
}

/* 터치 디바이스 최적화 */
@media (hover: none) and (pointer: coarse) {
    /* 터치 타겟 크기 증가 */
    .card {
        touch-action: pan-x pan-y;
    }
    
    .zoom-btn,
    .panel-btn,
    .sidebar-toggle-left,
    .sidebar-toggle-right {
        min-width: 44px;
        min-height: 44px;
    }
    
    /* 호버 효과 제거 */
    .card:hover {
        transform: none;
    }
    
    .connection-handle {
        opacity: 1;
        width: 20px;
        height: 20px;
    }
}

/* 작은 모바일 (iPhone SE 등) */
@media (max-width: 375px) {
    .unified-nav-logo span {
        display: none;
    }
    
    .card {
        min-width: 180px !important;
        max-width: 240px !important;
    }
    
    .ai-input {
        padding: 0.75rem;
    }
    
    .footer {
        font-size: 0.7rem;
    }
}

/* 가로 모드 */
@media (max-width: 768px) and (orientation: landscape) {
    .left-sidebar,
    .right-sidebar {
        height: 80vh;
    }
    
    .ai-input {
        bottom: 48px;
    }
    
    .footer {
        height: 48px;
    }
    
    #canvasViewport {
        top: 56px;
        bottom: 48px;
    }
}

/* ============================================
   WIDGET PANEL - MINIMALIST DESIGN SYSTEM
   ============================================ */

/* Lucide Icons Base */
.icon {
  width: 20px;
  height: 20px;
  stroke-width: 1.5px;
  flex-shrink: 0;
}

.icon-xs {
  width: 14px;
  height: 14px;
  stroke-width: 2px;
}

/* Widget Panel Base */
#widgetPanel .panel-content {
  padding: 4px 0;
  overflow-y: auto;
  max-height: calc(100vh - 200px); /* 스크롤 가능하도록 최대 높이 설정 */
  height: 100%; /* 전체 높이 사용 */
}

/* Search & Filter Toolbar */
.widget-toolbar {
  padding: 16px 20px;
  background: #0a0a0a;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.widget-search-box {
  position: relative;
  display: flex;
  align-items: center;
  background: #1a1a1a;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px;
  padding: 11px 14px;
  transition: all 0.2s;
}

.widget-search-box:focus-within {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.08);
  background: #222;
}

.widget-search-box .icon {
  stroke: #666;
  margin-right: 10px;
}

.widget-search-box input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #e5e5e5;
  font-size: 14px;
}

.widget-search-box input::placeholder {
  color: #666;
}

.widget-btn-clear {
  background: transparent;
  border: none;
  color: #666;
  cursor: pointer;
  padding: 4px;
  transition: color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.widget-btn-clear:hover {
  color: #e5e5e5;
}

/* Filter Chips */
.widget-filter-chips {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.widget-chip {
  padding: 7px 12px;
  background: #1a1a1a;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 20px;
  font-size: 12px;
  color: #9CA3AF;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.widget-chip:hover {
  background: #222;
  color: #e5e5e5;
  border-color: rgba(255,255,255,0.15);
}

.widget-chip.active {
  background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
  color: white;
  border-color: #8B5CF6;
}

/* Category Groups - Color System */
.category-group {
  margin: 4px 8px;
  border-radius: 12px;
  border-left: 2px solid;
  transition: all 0.2s;
}

/* Blue - Advanced Analytics */
.category-advanced-analytics {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.06) 0%, rgba(37, 99, 235, 0.03) 100%);
  border-left-color: rgba(59, 130, 246, 0.25);
}

.category-advanced-analytics .category-header {
  color: #93c5fd;
}

.category-advanced-analytics .category-icon {
  stroke: #60A5FA;
}

.category-advanced-analytics .widget-item:hover {
  background: rgba(59, 130, 246, 0.1);
  border-color: rgba(59, 130, 246, 0.35);
}

/* Amber - Museum Professional */
.category-museum-professional {
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.06) 0%, rgba(245, 158, 11, 0.03) 100%);
  border-left-color: rgba(251, 191, 36, 0.25);
}

.category-museum-professional .category-header {
  color: #FCD34D;
}

.category-museum-professional .category-icon {
  stroke: #FCD34D;
}

.category-museum-professional .widget-item:hover {
  background: rgba(251, 191, 36, 0.1);
  border-color: rgba(251, 191, 36, 0.35);
}

/* Green - Visitor Experience */
.category-visitor-experience {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.06) 0%, rgba(22, 163, 74, 0.03) 100%);
  border-left-color: rgba(34, 197, 94, 0.25);
}

.category-visitor-experience .category-header {
  color: #4ADE80;
}

.category-visitor-experience .category-icon {
  stroke: #4ADE80;
}

.category-visitor-experience .widget-item:hover {
  background: rgba(34, 197, 94, 0.1);
  border-color: rgba(34, 197, 94, 0.35);
}

/* Slate - Operations */
.category-operations {
  background: linear-gradient(135deg, rgba(100, 116, 139, 0.06) 0%, rgba(71, 85, 105, 0.03) 100%);
  border-left-color: rgba(100, 116, 139, 0.25);
}

.category-operations .category-header {
  color: #94A3B8;
}

.category-operations .category-icon {
  stroke: #94A3B8;
}

.category-operations .widget-item:hover {
  background: rgba(100, 116, 139, 0.1);
  border-color: rgba(100, 116, 139, 0.35);
}

/* Purple - Collaboration (Brand Color) */
.category-collaboration {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.06) 0%, rgba(124, 58, 237, 0.03) 100%);
  border-left-color: rgba(139, 92, 246, 0.25);
}

.category-collaboration .category-header {
  color: #c4b5fd;
}

.category-collaboration .category-icon {
  stroke: #A78BFA;
}

.category-collaboration .widget-item:hover {
  background: rgba(139, 92, 246, 0.1);
  border-color: rgba(139, 92, 246, 0.35);
}

/* Emerald - Finance */
.category-finance {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.06) 0%, rgba(5, 150, 105, 0.03) 100%);
  border-left-color: rgba(16, 185, 129, 0.25);
}

.category-finance .category-header {
  color: #34D399;
}

.category-finance .category-icon {
  stroke: #34D399;
}

.category-finance .widget-item:hover {
  background: rgba(16, 185, 129, 0.1);
  border-color: rgba(16, 185, 129, 0.35);
}

/* Category Header */
.category-header {
  display: flex;
  align-items: center;
  padding: 14px 18px;
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
  gap: 10px;
}

.category-header:hover {
  background: rgba(255,255,255,0.02);
}

.category-chevron {
  transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  stroke: currentColor;
  opacity: 0.6;
}

.category-group[data-expanded="true"] .category-chevron {
  transform: rotate(0deg);
}

.category-group[data-expanded="false"] .category-chevron {
  transform: rotate(-90deg);
}

.category-name {
  flex: 1;
  font-size: 14px;
  font-weight: 600;
}

.category-badge {
  background: rgba(255,255,255,0.08);
  color: currentColor;
  padding: 3px 9px;
  border-radius: 14px;
  font-size: 11px;
  font-weight: 600;
  opacity: 0.7;
}

/* Category Content (Accordion) */
.category-content {
  overflow: hidden;
  transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  padding-bottom: 8px;
}

/* Widget Items */
.widget-item {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  margin: 6px 12px;
  background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 10px;
  cursor: grab;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  gap: 12px;
}

.widget-item:hover {
  transform: translateX(4px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
}

.widget-item:active {
  cursor: grabbing;
  transform: translateX(2px);
}

.widget-item.dragging {
  opacity: 0.4;
}

.widget-icon-wrapper {
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.04);
  border-radius: 10px;
  flex-shrink: 0;
  transition: all 0.2s;
}

.widget-item:hover .widget-icon-wrapper {
  background: rgba(255,255,255,0.08);
  transform: scale(1.05);
}

.widget-icon-wrapper .icon {
  stroke: currentColor;
  opacity: 0.9;
}

.widget-info {
  flex: 1;
  min-width: 0;
}

.widget-name {
  font-size: 13px;
  font-weight: 600;
  color: #e5e5e5;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 7px;
  flex-wrap: wrap;
  line-height: 1.4;
}

.widget-description {
  font-size: 11.5px;
  color: #9CA3AF;
  line-height: 1.5;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.badge-premium {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 7px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 5px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.widget-price {
  font-size: 12px;
  font-weight: 700;
  color: #8B5CF6;
  margin-left: 4px;
  flex-shrink: 0;
}

/* Widget Panel Scrollbar - Improved */
#widgetPanel .panel-content::-webkit-scrollbar {
  width: 4px;
}

#widgetPanel .panel-content::-webkit-scrollbar-track {
  background: transparent;
}

#widgetPanel .panel-content::-webkit-scrollbar-thumb {
  background: rgba(139, 92, 246, 0.15);
  border-radius: 2px;
  transition: background 0.2s;
}

#widgetPanel .panel-content::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 92, 246, 0.3);
}

/* Category Badge Enhancement */
.category-badge {
  background: rgba(255,255,255,0.12);
  color: currentColor;
  padding: 4px 10px;
  border-radius: 14px;
  font-size: 12px;
  font-weight: 700;
  opacity: 0.9;
  border: 1px solid rgba(255,255,255,0.1);
  min-width: 28px;
  text-align: center;
}

/* ========================================
   Color Picker Styles
   ======================================== */
.color-picker {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}

.color-option {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  cursor: pointer;
  border: 3px solid transparent;
  transition: all 0.2s ease;
  position: relative;
}

.color-option:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.color-option.selected {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
}

.color-option.selected::after {
  content: '✓';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #000;
  font-size: 18px;
  font-weight: bold;
}

/* Search Box Enhancement */
.widget-search-box {
  position: relative;
  display: flex;
  align-items: center;
  background: linear-gradient(135deg, #1a1a1a 0%, #222 100%);
  border: 1px solid rgba(139, 92, 246, 0.15);
  border-radius: 12px;
  padding: 12px 16px;
  transition: all 0.2s;
}

.widget-search-box:focus-within {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.12);
  background: linear-gradient(135deg, #222 0%, #2a2a2a 100%);
}

.widget-search-box .icon {
  stroke: #8B5CF6;
  margin-right: 12px;
  width: 18px;
  height: 18px;
}

.widget-search-box input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #e5e5e5;
  font-size: 14px;
  font-weight: 500;
}

.widget-search-box input::placeholder {
  color: #666;
  font-weight: 400;
}

/* Widget Select Boxes */
.widget-select {
  flex: 1;
  padding: 10px 14px;
  background: rgba(139, 92, 246, 0.08);
  border: 1px solid rgba(139, 92, 246, 0.2);
  border-radius: 10px;
  color: #e5e5e5;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  outline: none;
}

.widget-select:hover {
  background: rgba(139, 92, 246, 0.12);
  border-color: rgba(139, 92, 246, 0.3);
}

.widget-select:focus {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
}

.widget-select option {
  background: #1a1a1a;
  color: #e5e5e5;
  padding: 8px;
}

/* Hint Text Below Search */
.widget-search-hint {
  margin-top: 8px;
  font-size: 11px;
  color: #666;
  text-align: center;
  padding: 0 20px;
}

.widget-search-hint kbd {
  display: inline-block;
  padding: 2px 6px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  font-family: monospace;
  font-size: 10px;
  color: #8B5CF6;
  margin: 0 2px;
}

/* ============================================
   COMMAND PALETTE (Cmd+K)
   ============================================ */

.command-palette-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  display: none;
  justify-content: center;
  align-items: flex-start;
  padding-top: 15vh;
  z-index: 10000;
  animation: fadeIn 0.2s ease-out;
}

.command-palette-overlay.active {
  display: flex;
}

.command-palette {
  width: 600px;
  max-width: 90%;
  background: linear-gradient(135deg, rgba(17, 24, 39, 0.98) 0%, rgba(31, 41, 55, 0.98) 100%);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(139, 92, 246, 0.2);
  overflow: hidden;
  animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* ========================================
   Context Menu Styles
   ======================================== */
.context-menu {
  position: fixed;
  background: rgba(17, 24, 39, 0.98);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 12px;
  padding: 8px 0;
  min-width: 200px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5),
              0 0 0 1px rgba(139, 92, 246, 0.1);
  z-index: 10000;
  backdrop-filter: blur(20px);
  animation: fadeIn 0.15s ease;
}

.context-menu-item {
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.15s ease;
  color: #e5e5e5;
  font-size: 14px;
  font-weight: 500;
}

.context-menu-item:hover {
  background: rgba(139, 92, 246, 0.15);
  color: #fff;
}

.context-menu-item i {
  width: 18px;
  height: 18px;
  color: #8B5CF6;
  flex-shrink: 0;
}

.context-menu-item.danger {
  color: #EF4444;
}

.context-menu-item.danger:hover {
  background: rgba(239, 68, 68, 0.15);
  color: #FCA5A5;
}

.context-menu-item.danger i {
  color: #EF4444;
}

.context-menu-divider {
  height: 1px;
  background: rgba(255, 255, 255, 0.1);
  margin: 4px 0;
}

.command-palette-header {
  padding: 20px 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(139, 92, 246, 0.05);
}

.command-search-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 12px;
}

.command-search-icon {
  width: 20px;
  height: 20px;
  color: #8B5CF6;
  flex-shrink: 0;
}

.command-search-input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #e5e5e5;
  font-size: 16px;
  font-weight: 500;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
}

.command-search-input::placeholder {
  color: #9CA3AF;
}

.command-palette-hint {
  font-size: 11px;
  color: #6B7280;
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.command-palette-hint kbd {
  padding: 2px 6px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  font-family: monospace;
  font-size: 10px;
}

.command-palette-body {
  max-height: 400px;
  overflow-y: auto;
}

.command-palette-body::-webkit-scrollbar {
  width: 6px;
}

.command-palette-body::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.1);
}

.command-palette-body::-webkit-scrollbar-thumb {
  background: rgba(148, 163, 184, 0.3);
  border-radius: 3px;
}

.command-palette-body::-webkit-scrollbar-thumb:hover {
  background: rgba(148, 163, 184, 0.5);
}

.command-category {
  padding: 12px 20px 8px;
  font-size: 11px;
  font-weight: 600;
  color: #6B7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.command-item {
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.15s ease;
  border-left: 3px solid transparent;
}

.command-item:hover,
.command-item.selected {
  background: rgba(139, 92, 246, 0.15);
  border-left-color: #8B5CF6;
}

.command-item-icon {
  width: 18px;
  height: 18px;
  color: #8B5CF6;
  flex-shrink: 0;
}

.command-item-info {
  flex: 1;
  min-width: 0;
}

.command-item-name {
  font-size: 14px;
  font-weight: 500;
  color: #e5e5e5;
  margin-bottom: 2px;
}

.command-item-desc {
  font-size: 12px;
  color: #9CA3AF;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.command-item-badge {
  display: inline-block;
  padding: 2px 8px;
  font-size: 9px;
  font-weight: 600;
  background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
  border-radius: 4px;
  color: white;
  flex-shrink: 0;
}

.command-palette-empty {
  padding: 60px 20px;
  text-align: center;
  color: #6B7280;
}

.command-palette-empty-icon {
  width: 48px;
  height: 48px;
  margin: 0 auto 16px;
  color: #4B5563;
}

.command-palette-empty-text {
  font-size: 14px;
  font-weight: 500;
}

.command-palette-footer {
  padding: 12px 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(0, 0, 0, 0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.command-palette-shortcuts {
  display: flex;
  gap: 16px;
  font-size: 11px;
  color: #6B7280;
}

.command-palette-shortcut {
  display: flex;
  align-items: center;
  gap: 6px;
}

.command-palette-shortcut kbd {
  padding: 2px 6px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  font-family: monospace;
  font-size: 10px;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .command-palette {
    width: 95%;
    max-height: 70vh;
  }
  
  .command-palette-body {
    max-height: 300px;
  }
}

/* ============================================
   CONTEXT MENU & EDIT MODAL
   ============================================ */

/* Context Menu */
.context-menu {
  position: fixed;
  background: linear-gradient(135deg, rgba(17, 24, 39, 0.98) 0%, rgba(31, 41, 55, 0.98) 100%);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 12px;
  padding: 8px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 20px rgba(139, 92, 246, 0.2);
  min-width: 180px;
  z-index: 10001;
  animation: contextMenuSlide 0.2s ease-out;
}

@keyframes contextMenuSlide {
  from {
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.context-menu-item {
  padding: 10px 16px;
  cursor: pointer;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
  color: #e5e5e5;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}

.context-menu-item:hover {
  background: rgba(139, 92, 246, 0.2);
  transform: translateX(4px);
}

.context-menu-item i {
  color: #8B5CF6;
}

.context-menu-danger {
  color: #EF4444;
}

.context-menu-danger i {
  color: #EF4444;
}

.context-menu-danger:hover {
  background: rgba(239, 68, 68, 0.15);
}

/* Edit Modal Overlay */
.edit-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10002;
  animation: fadeIn 0.2s ease-out;
}

/* Edit Modal */
.edit-modal {
  width: 500px;
  max-width: 90%;
  background: linear-gradient(135deg, rgba(17, 24, 39, 0.98) 0%, rgba(31, 41, 55, 0.98) 100%);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(139, 92, 246, 0.2);
  animation: modalSlideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlideUp {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.edit-modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(139, 92, 246, 0.05);
}

.edit-modal-header h3 {
  margin: 0;
  color: #e5e5e5;
  font-size: 18px;
  font-weight: 600;
}

.edit-modal-close {
  background: transparent;
  border: none;
  color: #9CA3AF;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.edit-modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #e5e5e5;
}

.edit-modal-body {
  padding: 24px;
}

.edit-form-group {
  margin-bottom: 20px;
}

.edit-form-group:last-child {
  margin-bottom: 0;
}

.edit-form-group label {
  display: block;
  margin-bottom: 8px;
  color: #9CA3AF;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.edit-input, .edit-textarea {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 12px 16px;
  color: #e5e5e5;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s;
}

.edit-input:focus, .edit-textarea:focus {
  outline: none;
  border-color: #8B5CF6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  background: rgba(255, 255, 255, 0.08);
}

.edit-input::placeholder, .edit-textarea::placeholder {
  color: #6B7280;
}

.edit-textarea {
  resize: vertical;
  min-height: 80px;
}

/* Color Picker */
.color-picker {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.color-option {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
  position: relative;
}

.color-option:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.color-option.selected {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
}

.color-option.selected::after {
  content: '✓';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-weight: bold;
  font-size: 18px;
  text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* Edit Modal Footer */
.edit-modal-footer {
  padding: 16px 24px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  background: rgba(0, 0, 0, 0.2);
}

.edit-btn-cancel, .edit-btn-save {
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.edit-btn-cancel {
  background: rgba(255, 255, 255, 0.05);
  color: #9CA3AF;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.edit-btn-cancel:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #e5e5e5;
}

.edit-btn-save {
  background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
  color: white;
}

.edit-btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

    /* Screen Reader Only - Accessibility */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
    
    .sr-only-focusable:focus {
        position: static;
        width: auto;
        height: auto;
        margin: 0;
        overflow: visible;
        clip: auto;
        white-space: normal;
    }
    
    /* Skip to Content Link - WCAG 2.1 Guideline 2.4.1 */
    .skip-link {
        position: absolute;
        top: -100px;
        left: 0;
        background: #000;
        color: #fff;
        padding: 1rem 2rem;
        text-decoration: none;
        font-weight: 600;
        z-index: 100000;
        border-radius: 0 0 8px 0;
        transition: top 0.3s ease;
    }
    
    .skip-link:focus {
        top: 0;
        outline: 3px solid #c4b5fd;
        outline-offset: 2px;
    }
    
    /* Enhanced Focus Styles for Keyboard Navigation */
    *:focus {
        outline: 2px solid #c4b5fd;
        outline-offset: 2px;
    }
    
    *:focus:not(:focus-visible) {
        outline: none;
    }
    
    *:focus-visible {
        outline: 3px solid #c4b5fd;
        outline-offset: 3px;
        box-shadow: 0 0 0 4px rgba(196, 181, 253, 0.3);
    }
    
    button:focus-visible,
    a:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
        outline: 3px solid #c4b5fd;
        outline-offset: 2px;
    }
    
    /* ============================================
     * V23.0 Phase A - Professional UX/UI Styles
     * High Visibility, Consistency, Accessibility
     * ============================================ */
    
    /* Projects Panel - Professional Design */
    .projects-toolbar {
        padding: 1rem;
        border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        background: rgba(139, 92, 246, 0.05);
    }
    
    .projects-search-box {
        position: relative;
        margin-bottom: 0.75rem;
    }
    
    .projects-search-box input {
        width: 100%;
        padding: 0.625rem 2.5rem 0.625rem 2.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1.5px solid rgba(139, 92, 246, 0.3) !important;
        border-radius: 8px;
        color: #e5e5e5;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    .projects-search-box input:focus {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(139, 92, 246, 0.6) !important;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .projects-search-box input::placeholder {
        color: #9CA3AF;
    }
    
    .projects-search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9CA3AF;
        pointer-events: none;
    }
    
    .projects-clear-btn {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        color: #9CA3AF;
        padding: 0.25rem;
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .projects-clear-btn:hover {
        color: #e5e5e5;
    }
    
    .projects-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .btn-new-project {
        flex: 1;
        padding: 0.625rem 1rem;
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .btn-new-project:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    
    .btn-new-project:active {
        transform: translateY(0);
    }
    
    .projects-sort {
        padding: 0.625rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1.5px solid rgba(139, 92, 246, 0.3) !important;
        border-radius: 8px;
        color: #e5e5e5;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .projects-sort:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(139, 92, 246, 0.5) !important;
    }
    
    #projectsList {
        padding: 1rem;
        overflow-y: auto;
        max-height: calc(100vh - 280px);
    }
    
    .project-item {
        padding: 1rem;
        background: rgba(139, 92, 246, 0.08);
        border-radius: 10px;
        border: 1.5px solid rgba(139, 92, 246, 0.2);
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.25s;
        position: relative;
    }
    
    .project-item:hover {
        background: rgba(139, 92, 246, 0.12);
        border-color: rgba(139, 92, 246, 0.4);
        transform: translateX(3px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
    }
    
    .project-item.active {
        background: rgba(139, 92, 246, 0.18);
        border-color: rgba(139, 92, 246, 0.6);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.25);
    }
    
    .project-item.active::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 60%;
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        border-radius: 0 4px 4px 0;
    }
    
    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }
    
    .project-info {
        flex: 1;
    }
    
    .project-name {
        font-weight: 600;
        color: #e5e5e5;
        font-size: 0.9375rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .project-badge {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        background: rgba(34, 197, 94, 0.2);
        color: #22C55E;
        font-size: 0.6875rem;
        font-weight: 700;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .project-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: #9CA3AF;
    }
    
    .project-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .project-description {
        font-size: 0.8125rem;
        color: #9CA3AF;
        margin-bottom: 0.5rem;
        line-height: 1.4;
    }
    
    .project-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .project-tag {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: rgba(139, 92, 246, 0.15);
        color: #A78BFA;
        font-size: 0.6875rem;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .project-time {
        font-size: 0.75rem;
        color: #6B7280;
        margin-left: auto;
    }
    
    .project-menu-btn {
        padding: 0.375rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        color: #9CA3AF;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .project-menu-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #e5e5e5;
    }
    
    /* ============================================
       TEMPLATES PANEL - Professional Design
       ============================================ */
    
    .templates-toolbar {
        padding: 1rem;
        border-bottom: 1px solid rgba(34, 197, 94, 0.2);
        background: rgba(34, 197, 94, 0.05);
    }
    
    .templates-search-box {
        position: relative;
        margin-bottom: 0.75rem;
    }
    
    .templates-search-box input {
        width: 100%;
        padding: 0.625rem 2.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1.5px solid rgba(34, 197, 94, 0.3) !important;
        border-radius: 8px;
        color: #e5e5e5;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    .templates-search-box input:focus {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(34, 197, 94, 0.6) !important;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }
    
    .templates-search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9CA3AF;
        pointer-events: none;
    }
    
    .templates-categories {
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }
    
    .template-category-btn {
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1.5px solid rgba(34, 197, 94, 0.3);
        border-radius: 20px;
        color: #9CA3AF;
        font-size: 0.8125rem;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-weight: 500;
    }
    
    .template-category-btn:hover {
        background: rgba(34, 197, 94, 0.1);
        border-color: rgba(34, 197, 94, 0.5);
        color: #e5e5e5;
    }
    
    .template-category-btn.active {
        background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
        border-color: #22C55E;
        color: white;
        font-weight: 600;
    }
    
    #templatesList {
        padding: 1rem;
        overflow-y: auto;
        max-height: calc(100vh - 320px);
    }
    
    .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 0.75rem;
    }
    
    .template-item {
        position: relative;
        aspect-ratio: 4/3;
        background: rgba(34, 197, 94, 0.08);
        border-radius: 10px;
        border: 1.5px solid rgba(34, 197, 94, 0.2);
        cursor: pointer;
        transition: all 0.25s;
        overflow: hidden;
    }
    
    .template-item:hover {
        transform: translateY(-2px);
        border-color: rgba(34, 197, 94, 0.6);
        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.2);
    }
    
    .template-preview {
        width: 100%;
        height: 70%;
        background: rgba(34, 197, 94, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: rgba(34, 197, 94, 0.6);
    }
    
    .template-info {
        padding: 0.5rem;
        background: rgba(26, 26, 26, 0.95);
        height: 30%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .template-name {
        font-size: 0.75rem;
        font-weight: 600;
        color: #e5e5e5;
        margin-bottom: 0.125rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .template-category {
        font-size: 0.6875rem;
        color: #9CA3AF;
    }
    
    .template-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        padding: 0.25rem 0.5rem;
        background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
        border-radius: 4px;
        font-size: 0.625rem;
        font-weight: 600;
        color: white;
        text-transform: uppercase;
    }
    
    .btn-save-template {
        width: 100%;
        padding: 0.75rem;
        background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .btn-save-template:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }
    
    .template-empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #9CA3AF;
    }
    
    .template-empty-state i {
        font-size: 3rem;
        color: #6B7280;
        margin-bottom: 1rem;
    }
    
    /* Tasks Panel - Professional Design */
    .tasks-toolbar {
        padding: 1rem;
        border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        background: rgba(139, 92, 246, 0.05);
    }
    
    .tasks-filters {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    
    .task-filter-btn {
        flex: 1;
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1.5px solid rgba(139, 92, 246, 0.2) !important;
        border-radius: 6px;
        color: #9CA3AF;
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .task-filter-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        color: #e5e5e5;
    }
    
    .task-filter-btn.active {
        background: rgba(139, 92, 246, 0.2);
        border-color: rgba(139, 92, 246, 0.5) !important;
        color: #A78BFA;
        font-weight: 600;
    }
    
    .tasks-controls {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-new-task {
        flex: 1;
        padding: 0.625rem 1rem;
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .btn-new-task:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    
    #tasksList {
        padding: 1rem;
        overflow-y: auto;
        max-height: calc(100vh - 320px);
    }
    
    .task-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.875rem;
        background: rgba(139, 92, 246, 0.08);
        border-radius: 8px;
        border: 1.5px solid rgba(139, 92, 246, 0.2);
        margin-bottom: 0.625rem;
        transition: all 0.2s;
        align-items: flex-start;
    }
    
    .task-item:hover {
        background: rgba(139, 92, 246, 0.12);
        border-color: rgba(139, 92, 246, 0.3);
        transform: translateX(2px);
    }
    
    .task-item.completed {
        opacity: 0.6;
    }
    
    .task-item.completed .task-title {
        text-decoration: line-through;
        color: #6B7280;
    }
    
    .task-item.overdue {
        border-color: rgba(239, 68, 68, 0.5);
        background: rgba(239, 68, 68, 0.08);
    }
    
    .task-checkbox {
        display: flex;
        align-items: center;
        padding-top: 0.125rem;
    }
    
    .task-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #8B5CF6;
    }
    
    .task-content {
        flex: 1;
        cursor: pointer;
    }
    
    .task-title {
        font-weight: 600;
        color: #e5e5e5;
        font-size: 0.875rem;
        margin-bottom: 0.375rem;
        line-height: 1.4;
    }
    
    .task-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        flex-wrap: wrap;
    }
    
    .task-priority,
    .task-due {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .task-due.overdue {
        color: #EF4444;
        font-weight: 600;
    }
    
    .task-menu-btn {
        padding: 0.25rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        color: #9CA3AF;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .task-menu-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #e5e5e5;
    }
    
    /* Context Menu - Professional Design */
    .context-menu {
        position: fixed;
        background: #2d2d2d;
        border: 1.5px solid rgba(139, 92, 246, 0.3);
        border-radius: 10px;
        padding: 0.5rem;
        min-width: 200px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4),
                    0 0 0 1px rgba(139, 92, 246, 0.1);
        z-index: 10000;
        animation: menuFadeIn 0.15s ease-out;
    }
    
    @keyframes menuFadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .context-menu button {
        width: 100%;
        padding: 0.625rem 0.875rem;
        background: transparent;
        color: #e5e5e5;
        font-size: 0.875rem;
        text-align: left;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
    }
    
    .context-menu button:hover {
        background: rgba(139, 92, 246, 0.15);
        color: #A78BFA;
    }
    
    .context-menu button.danger {
        color: #F87171;
    }
    
    .context-menu button.danger:hover {
        background: rgba(239, 68, 68, 0.15);
        color: #EF4444;
    }
    
    .menu-divider {
        height: 1px;
        background: rgba(139, 92, 246, 0.2);
        margin: 0.5rem 0;
    }
    
    /* ============================================
       LAYERS PANEL STYLES - Professional Design
       ============================================ */
    
    .layers-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.875rem 1rem;
        border-bottom: 1.5px solid rgba(139, 92, 246, 0.15);
        background: rgba(139, 92, 246, 0.03);
    }
    
    .btn-refresh-layers {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: rgba(139, 92, 246, 0.1);
        border: 1.5px solid rgba(139, 92, 246, 0.2);
        border-radius: 8px;
        color: #A78BFA;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-refresh-layers:hover {
        background: rgba(139, 92, 246, 0.15);
        border-color: rgba(139, 92, 246, 0.3);
        transform: rotate(180deg);
    }
    
    .layers-info {
        font-size: 0.875rem;
        color: #9CA3AF;
        font-weight: 500;
    }
    
    .layers-info span {
        color: #A78BFA;
        font-weight: 700;
    }
    
    #layersList {
        padding: 0.875rem;
        overflow-y: auto;
        max-height: calc(100vh - 250px);
    }
    
    .layer-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem;
        background: rgba(139, 92, 246, 0.08);
        border-radius: 8px;
        border: 1.5px solid rgba(139, 92, 246, 0.2);
        margin-bottom: 0.625rem;
        transition: all 0.2s;
        cursor: move;
        user-select: none;
    }
    
    .layer-item:hover {
        background: rgba(139, 92, 246, 0.12);
        border-color: rgba(139, 92, 246, 0.3);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
    }
    
    .layer-item.dragging {
        opacity: 0.5;
        transform: scale(0.95);
    }
    
    .layer-item.hidden {
        opacity: 0.4;
    }
    
    .layer-item.locked {
        background: rgba(75, 85, 99, 0.1);
        border-color: rgba(75, 85, 99, 0.2);
        cursor: not-allowed;
    }
    
    .layer-drag-handle {
        display: flex;
        align-items: center;
        color: #6B7280;
        cursor: move;
    }
    
    .layer-visibility {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        color: #A78BFA;
    }
    
    .layer-visibility:hover {
        background: rgba(139, 92, 246, 0.15);
        color: #C4B5FD;
    }
    
    .layer-content {
        flex: 1;
    }
    
    .layer-name {
        font-size: 0.9375rem;
        color: #e5e5e5;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .layer-info {
        font-size: 0.8125rem;
        color: #9CA3AF;
        display: flex;
        gap: 0.75rem;
    }
    
    .layer-z-index {
        color: #A78BFA;
        font-weight: 600;
    }
    
    .layer-actions {
        display: flex;
        gap: 0.375rem;
    }
    
    .layer-lock,
    .layer-delete {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        color: #6B7280;
    }
    
    .layer-lock:hover {
        background: rgba(251, 191, 36, 0.15);
        color: #FCD34D;
    }
    
    .layer-lock.locked {
        background: rgba(251, 191, 36, 0.15);
        color: #FCD34D;
    }
    
    .layer-delete:hover {
        background: rgba(239, 68, 68, 0.15);
        color: #EF4444;
    }
    
    .layers-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 1.5rem;
        text-align: center;
        color: #6B7280;
    }
    
    .layers-empty i {
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .layers-empty p {
        font-size: 0.9375rem;
        margin: 0;
    }
    
    /* ============================================
       EXPORT PANEL STYLES - Professional Design
       ============================================ */
    
    .export-format-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.625rem;
    }
    
    .export-format-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem 0.75rem;
        background: rgba(139, 92, 246, 0.08);
        border: 1.5px solid rgba(139, 92, 246, 0.2);
        border-radius: 10px;
        color: #9CA3AF;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .export-format-btn:hover {
        background: rgba(139, 92, 246, 0.12);
        border-color: rgba(139, 92, 246, 0.3);
        color: #A78BFA;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
    }
    
    .export-format-btn.active {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(99, 102, 241, 0.2) 100%);
        border-color: rgba(139, 92, 246, 0.5);
        color: #C4B5FD;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
    }
    
    .btn-export {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        border: none;
        border-radius: 10px;
        color: white;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    
    .btn-export:hover {
        background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
    }
    
    .btn-export:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }
    
    /* Empty State - Professional Design */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 1.5rem;
        text-align: center;
        color: #6B7280;
    }
    
    .empty-state i {
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .empty-state p {
        font-size: 0.9375rem;
        margin-bottom: 1rem;
        color: #9CA3AF;
    }
    
    .empty-state button {
        margin-top: 0.5rem;
    }
    
    /* Icon Sizes */
    .icon-xs {
        width: 14px;
        height: 14px;
    }
    
    .icon {
        width: 16px;
        height: 16px;
    }
    
    /* Button Styles */
    .btn-secondary {
        padding: 0.5rem 1rem;
        background: rgba(139, 92, 246, 0.15);
        color: #A78BFA;
        font-size: 0.875rem;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-secondary:hover {
        background: rgba(139, 92, 246, 0.25);
        color: #C4B5FD;
    }
    
    /* Scrollbar Styling for Panels */
    #projectsList::-webkit-scrollbar,
    #tasksList::-webkit-scrollbar {
        width: 6px;
    }
    
    #projectsList::-webkit-scrollbar-track,
    #tasksList::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
    }
    
    #projectsList::-webkit-scrollbar-thumb,
    #tasksList::-webkit-scrollbar-thumb {
        background: rgba(139, 92, 246, 0.4);
        border-radius: 3px;
    }
    
    #projectsList::-webkit-scrollbar-thumb:hover,
    #tasksList::-webkit-scrollbar-thumb:hover {
        background: rgba(139, 92, 246, 0.6);
    }
    
    /* Toast Notification Enhancement */
    .toast-notification {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        background: #2d2d2d;
        border: 1.5px solid rgba(139, 92, 246, 0.3);
        border-radius: 10px;
        color: #e5e5e5;
        font-size: 0.9375rem;
        font-weight: 500;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3),
                    0 0 0 1px rgba(139, 92, 246, 0.1);
        z-index: 10001;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease-out;
        pointer-events: none;
    }
    
    .toast-notification.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }
    
    .toast-notification.toast-success {
        border-color: rgba(34, 197, 94, 0.5);
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
    }
    
    .toast-notification.toast-error {
        border-color: rgba(239, 68, 68, 0.5);
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
    }
    
    .toast-notification.toast-info {
        border-color: rgba(59, 130, 246, 0.5);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
    }
    </style>

    <!-- ✨ Critical CSS - Inlined for instant rendering -->
    <style>/**
 * MuseFlow V18.0 - Critical CSS for Canvas Page
 * Above-the-fold styles for instant rendering
 * This will be inlined in <head> to eliminate render-blocking
 */

/* Reset & Base */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    background: #0a0a0f;
    color: #f5f5f7;
    min-height: 100vh;
    overflow: hidden;
    line-height: 1.6;
}

/* Canvas Container - Critical */
#canvas-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.05) 0%, #0a0a0f 100%);
    overflow: hidden;
}

/* Canvas Workspace */
#canvas-workspace {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: move;
    transform-origin: center center;
}

/* Grid Pattern */
.canvas-grid {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
    background-size: 50px 50px;
    pointer-events: none;
}

/* Toolbar - Above the fold */
#canvas-toolbar {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(10, 10, 15, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 1rem;
    z-index: 100;
    display: flex;
    gap: 0.75rem;
}

.toolbar-button {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.toolbar-button:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.5);
}

.toolbar-button.active {
    background: rgba(139, 92, 246, 0.3);
    border-color: #8b5cf6;
}

/* Widget Panel - Above the fold */
#widget-panel {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 320px;
    max-height: calc(100vh - 40px);
    background: rgba(10, 10, 15, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    z-index: 100;
    overflow-y: auto;
}

.widget-panel-header {
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: sticky;
    top: 0;
    background: rgba(10, 10, 15, 0.95);
    backdrop-filter: blur(20px);
    z-index: 1;
}

.widget-panel-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
}

/* Widget Search */
.widget-search {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: white;
    font-size: 0.95rem;
}

.widget-search::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

/* Widget List */
.widget-list {
    padding: 1rem;
}

.widget-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: grab;
    transition: all 0.2s;
}

.widget-item:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(139, 92, 246, 0.3);
    transform: translateY(-2px);
}

.widget-item.dragging {
    cursor: grabbing;
    opacity: 0.5;
}

/* Card - Canvas Element */
.card {
    position: absolute;
    background: rgba(10, 10, 15, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 1.5rem;
    min-width: 280px;
    max-width: 480px;
    cursor: move;
    transition: box-shadow 0.2s;
}

.card:hover {
    box-shadow: 0 8px 32px rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.3);
}

.card.selected {
    border-color: #8b5cf6;
    box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.5);
}

/* AI Assistant - Above the fold */
.ai-assistant {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(10, 10, 15, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 16px;
    padding: 1rem 1.5rem;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 1rem;
    max-width: 600px;
}

.ai-assistant-input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 1rem;
    outline: none;
}

.ai-assistant-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

/* Loading States */
.skeleton {
    background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.05) 0%, 
        rgba(255, 255, 255, 0.1) 50%, 
        rgba(255, 255, 255, 0.05) 100%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
}

@keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Prevent FOUC */
html { visibility: visible; opacity: 1; }

/* Mobile Optimization */
@media (max-width: 768px) {
    #canvas-toolbar {
        top: 10px;
        left: 10px;
        padding: 0.5rem;
        gap: 0.5rem;
    }
    
    .toolbar-button {
        width: 40px;
        height: 40px;
    }
    
    #widget-panel {
        top: auto;
        bottom: 0;
        right: 0;
        left: 0;
        width: 100%;
        max-height: 60vh;
        border-radius: 16px 16px 0 0;
    }
    
    .ai-assistant {
        bottom: 10px;
        left: 10px;
        right: 10px;
        max-width: none;
        transform: none;
    }
}
</style>
    
    <!-- ⚡ Lazy Loading Script for Performance -->
    <script src="/static/js/lazy-loading.js"></script>
    
    <!-- 📊 Google Analytics 4 - Advanced Event Tracking -->
    <script src="/static/js/analytics-ga4.js" async></script>
    </head>
<body>
    <!-- Skip to Content for Keyboard Navigation -->
    <a href="#canvas-container" class="skip-link">
        메인 콘텐츠로 건너뛰기
    </a>
    

<!-- Unified Navigation Bar - Dashboard Style -->
<nav class="unified-navbar">
    <div class="unified-nav-container">
        <a href="/" class="unified-nav-logo">
            <img loading="lazy" src="/static/images/logo-neon-m.png" alt="MuseFlow">
            <span>MuseFlow</span>
        </a>
        <ul class="unified-nav-links">
            <li><a href="/dashboard.html" data-tooltip="대시보드"><i class="fas fa-home" aria-hidden="true"></i></a></li>
            <li><a href="/canvas-ultimate-clean.html" class="active" data-tooltip="캔버스"><i class="fas fa-palette" aria-hidden="true"></i></a></li>
            <li><a href="/workflow.html" data-tooltip="워크플로우"><i class="fas fa-project-diagram" aria-hidden="true"></i></a></li>
            <li><a href="/analytics-dashboard.html" data-tooltip="분석"><i class="fas fa-chart-line" aria-hidden="true"></i></a></li>
        </ul>
        <div class="unified-nav-actions">
            <button class="unified-nav-btn" title="설정"><i class="fas fa-cog" aria-hidden="true"></i></button>
            <button class="unified-nav-btn" title="계정"><i class="fas fa-user-circle" aria-hidden="true"></i></button>
        </div>
    </div>
</nav>

<!-- Main Container -->
<div class="container">
    <div class="sidebar left">
        <div class="icon" data-panel="history"><i data-lucide="clock" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="actions"><i data-lucide="zap" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="projects"><i data-lucide="folder" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="templates"><i data-lucide="layout-template" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="export"><i data-lucide="download" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="settings"><i data-lucide="settings" style="width:16px;height:16px"></i></div>
    </div>
    <div class="canvas">
        <div class="viewport" id="vp"></div>
    </div>
    <div class="sidebar right">
        <div class="icon" data-panel="stats"><i data-lucide="bar-chart-2" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="widget"><i data-lucide="package" style="width:16px;height:16px"></i><span class="badge">87</span></div>
        <div class="icon" data-panel="tasks"><i data-lucide="check-square" style="width:16px;height:16px"></i><span class="badge">2</span></div>
        <div class="icon" data-panel="layers"><i data-lucide="layers" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="ai"><i data-lucide="sparkles" style="width:16px;height:16px"></i><span class="badge">1</span></div>
        <div class="icon" data-panel="alerts"><i data-lucide="bell" style="width:16px;height:16px"></i><span class="badge">3</span></div>
    </div>
</div>

<!-- Panels -->
<div class="panel left" id="historyPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">History</span>
        <button class="panel-close" onclick="closePanel('historyPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #8B5CF6;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="image" style="width:16px;height:16px;color:#8B5CF6;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">포스터 이미지 편집</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">방금 전</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #6366F1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="video" style="width:16px;height:16px;color:#6366F1;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">영상 렌더링 완료</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">5분 전</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #22C55E;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="link" style="width:16px;height:16px;color:#22C55E;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">카드 연결 생성</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">10분 전</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #F97316;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="move" style="width:16px;height:16px;color:#F97316;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">카드 재배치</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">15분 전</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #3B82F6;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="save" style="width:16px;height:16px;color:#3B82F6;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">프로젝트 저장</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">30분 전</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel left" id="actionsPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">Actions</span>
        <button class="panel-close" onclick="closePanel('actionsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <button onclick="createNewCard()" style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); border: none; padding: 0.75rem 1rem; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <i data-lucide="plus" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    새 카드 만들기
                </button>
                <button onclick="uploadFile()" style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.75rem 1rem; border-radius: 8px; color: #e5e5e5; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.25)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.15)'">
                    <i data-lucide="upload" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    파일 업로드
                </button>
                <button onclick="arrangeLayout()" style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.75rem 1rem; border-radius: 8px; color: #e5e5e5; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.25)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.15)'">
                    <i data-lucide="layout" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    레이아웃 정렬
                </button>
                <button onclick="saveProject()" style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.75rem 1rem; border-radius: 8px; color: #e5e5e5; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.25)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.15)'">
                    <i data-lucide="save" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    프로젝트 저장
                </button>
            </div>
        </div>
    </div>
</div>

<div class="panel left" id="projectsPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">
            <i data-lucide="folder" class="icon" style="margin-right:8px;"></i>
            Projects
        </span>
        <button class="panel-close" onclick="closePanel('projectsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <!-- Projects Toolbar -->
    <div class="projects-toolbar">
        <!-- Search Box -->
        <div class="projects-search-box">
            <i data-lucide="search" class="icon projects-search-icon"></i>
            <input type="text" 
                   id="projectSearch" 
                   placeholder="프로젝트 검색..."
                   autocomplete="off">
            <button class="projects-clear-btn" 
                    id="projectsClearBtn" 
                    style="display:none;"
                    onclick="document.getElementById('projectSearch').value=''; ProjectsManager.filterProjects(''); this.style.display='none';">
                <i data-lucide="x" class="icon-xs"></i>
            </button>
        </div>
        
        <!-- Controls: New Project + Sort -->
        <div class="projects-controls">
            <button class="btn-new-project" id="newProjectBtn">
                <i data-lucide="plus" class="icon-xs"></i>
                새 프로젝트
            </button>
            <select class="projects-sort" id="projectSort">
                <option value="recent">최근 수정순</option>
                <option value="name">이름순</option>
                <option value="created">생성순</option>
            </select>
        </div>
    </div>
    
    <!-- Projects List (Dynamic) -->
    <div class="panel-content">
        <div id="projectsList">
            <!-- Projects will be dynamically rendered here by ProjectsManager -->
        </div>
    </div>
</div>

<!-- ============================================
     TEMPLATES PANEL - Museum Templates Library
     ============================================ -->
<div class="panel left" id="templatesPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">
            <i data-lucide="layout-template" class="icon" style="margin-right:8px;"></i>
            Templates
        </span>
        <button class="panel-close" onclick="closePanel('templatesPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <!-- Templates Toolbar -->
    <div class="templates-toolbar">
        <!-- Search Box -->
        <div class="templates-search-box">
            <i data-lucide="search" class="icon templates-search-icon"></i>
            <input type="text" 
                   id="templateSearch" 
                   placeholder="템플릿 검색..."
                   autocomplete="off">
        </div>
        
        <!-- Category Filters -->
        <div class="templates-categories">
            <button class="template-category-btn active" data-category="all">전체</button>
            <button class="template-category-btn" data-category="exhibition">전시기획</button>
            <button class="template-category-btn" data-category="collection">소장품관리</button>
            <button class="template-category-btn" data-category="visitor">관람객서비스</button>
            <button class="template-category-btn" data-category="education">교육프로그램</button>
            <button class="template-category-btn" data-category="marketing">마케팅</button>
        </div>
    </div>
    
    <!-- Templates List (Dynamic) -->
    <div class="panel-content">
        <div id="templatesList">
            <!-- Templates will be dynamically rendered here by TemplatesManager -->
        </div>
        
        <!-- Save Current as Template Button -->
        <button class="btn-save-template" id="saveTemplateBtn">
            <i data-lucide="save" class="icon-xs"></i>
            현재 캔버스를 템플릿으로 저장
        </button>
    </div>
</div>

<!-- ============================================
     EXPORT PANEL - Canvas Export Functions
     ============================================ -->
<div class="panel left" id="exportPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">
            <i data-lucide="download" class="icon" style="margin-right:8px;"></i>
            Export
        </span>
        <button class="panel-close" onclick="closePanel('exportPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <!-- Export Options -->
    <div class="panel-content" style="padding: 1rem;">
        <div style="display: flex; flex-direction: column; gap: 1.25rem;">
            
            <!-- Export Format -->
            <div>
                <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.75rem; font-size: 0.9375rem;">
                    내보내기 형식
                </div>
                <div class="export-format-grid">
                    <button class="export-format-btn active" data-format="png" id="formatPNG">
                        <i data-lucide="image" style="width:20px;height:20px;"></i>
                        PNG
                    </button>
                    <button class="export-format-btn" data-format="jpg" id="formatJPG">
                        <i data-lucide="image" style="width:20px;height:20px;"></i>
                        JPG
                    </button>
                    <button class="export-format-btn" data-format="svg" id="formatSVG">
                        <i data-lucide="code" style="width:20px;height:20px;"></i>
                        SVG
                    </button>
                    <button class="export-format-btn" data-format="pdf" id="formatPDF">
                        <i data-lucide="file-text" style="width:20px;height:20px;"></i>
                        PDF
                    </button>
                </div>
            </div>
            
            <!-- Resolution/Quality -->
            <div>
                <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.75rem; font-size: 0.9375rem;">
                    해상도
                </div>
                <select id="exportResolution" style="width: 100%; padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border: 1.5px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: #e5e5e5; cursor: pointer; font-weight: 500;">
                    <option value="1">1x (Original)</option>
                    <option value="2" selected>2x (High Quality)</option>
                    <option value="3">3x (Print Quality)</option>
                    <option value="4">4x (Ultra HD)</option>
                </select>
            </div>
            
            <!-- Background -->
            <div>
                <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.75rem; font-size: 0.9375rem;">
                    배경
                </div>
                <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                    <input type="checkbox" id="exportTransparent" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="color: #e5e5e5; font-size: 0.9375rem; font-weight: 500;">투명 배경</span>
                </label>
            </div>
            
            <!-- Export Button -->
            <button class="btn-export" id="exportBtn">
                <i data-lucide="download" style="width:16px;height:16px;"></i>
                내보내기
            </button>
            
            <!-- Export Info -->
            <div style="padding: 0.875rem; background: rgba(139, 92, 246, 0.08); border-radius: 8px; border: 1.5px solid rgba(139, 92, 246, 0.2);">
                <div style="font-size: 0.8125rem; color: #9CA3AF; line-height: 1.6;">
                    <strong style="color: #A78BFA;">💡 Tip:</strong><br>
                    • PNG: 투명 배경 지원, 최고 품질<br>
                    • JPG: 작은 파일 크기<br>
                    • SVG: 벡터 형식, 무한 확대<br>
                    • PDF: 문서 공유 최적화
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel left" id="settingsPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">
            <i data-lucide="settings" class="icon" style="margin-right:8px;"></i>
            Settings
        </span>
        <button class="panel-close" onclick="closePanel('settingsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">테마</div>
                    <select id="themeSelect" style="width: 100%; padding: 0.5rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3) !important; border-radius: 8px; color: #e5e5e5; cursor: pointer;">
                        <option value="dark">다크 모드</option>
                        <option value="light">라이트 모드</option>
                        <option value="system">시스템 설정</option>
                    </select>
                </div>
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">그리드 크기</div>
                    <input type="range" id="gridSizeSlider" min="50" max="500" value="150" style="width: 100%; cursor: pointer;">
                    <div id="gridSizeValue" style="font-size: 0.8125rem; color: #9CA3AF; margin-top: 0.25rem;">150px</div>
                </div>
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">그리드 표시</div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="showGrid" checked style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="color: #e5e5e5; font-size: 0.9375rem;">그리드 표시</span>
                    </label>
                </div>
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">스냅 기능</div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="snapToGrid" checked style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="color: #e5e5e5; font-size: 0.9375rem;">그리드에 스냅</span>
                    </label>
                </div>
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">자동 저장</div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="autoSave" checked style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="color: #e5e5e5; font-size: 0.9375rem;">변경 사항 자동 저장</span>
                    </label>
                </div>
                <button id="saveSettingsBtn" style="width: 100%; background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); border: none; padding: 0.75rem; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; margin-top: 1rem;">
                    <i data-lucide="save" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    설정 저장
                </button>
                <button id="resetSettingsBtn" style="width: 100%; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3) !important; padding: 0.75rem; border-radius: 8px; color: #EF4444; cursor: pointer; font-weight: 600; margin-top: 0.5rem;">
                    <i data-lucide="refresh-cw" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    설정 초기화
                </button>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="statsPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">Stats</span>
        <button class="panel-close" onclick="closePanel('statsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">총 카드 수</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #8B5CF6;" data-stat="cards">9</div>
                </div>
                <div style="padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">연결 수</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #3B82F6;" data-stat="connections">0</div>
                </div>
                <div style="padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">마지막 저장</div>
                    <div style="font-size: 1rem; font-weight: 600; color: #22C55E;" data-stat="last-saved">방금 전</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="tasksPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">
            <i data-lucide="check-square" class="icon" style="margin-right:8px;"></i>
            Tasks
        </span>
        <button class="panel-close" onclick="closePanel('tasksPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <!-- Tasks Toolbar -->
    <div class="tasks-toolbar">
        <!-- Filter Buttons -->
        <div class="tasks-filters">
            <button class="task-filter-btn active" data-task-filter="all">전체</button>
            <button class="task-filter-btn" data-task-filter="active">진행중</button>
            <button class="task-filter-btn" data-task-filter="completed">완료</button>
        </div>
        
        <!-- Controls: New Task + Sort -->
        <div class="tasks-controls">
            <button class="btn-new-task" id="newTaskBtn">
                <i data-lucide="plus" class="icon-xs"></i>
                새 작업
            </button>
            <select class="projects-sort" id="taskSort">
                <option value="dueDate">기한순</option>
                <option value="priority">우선순위순</option>
                <option value="created">생성순</option>
            </select>
        </div>
    </div>
    
    <!-- Tasks List (Dynamic) -->
    <div class="panel-content">
        <div id="tasksList">
            <!-- Tasks will be dynamically rendered here by TasksManager -->
        </div>
    </div>
</div>

<!-- ============================================
     LAYERS PANEL - Z-index & Layer Management
     ============================================ -->
<div class="panel right" id="layersPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">
            <i data-lucide="layers" class="icon" style="margin-right:8px;"></i>
            Layers
        </span>
        <button class="panel-close" onclick="closePanel('layersPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <!-- Layers Toolbar -->
    <div class="layers-toolbar">
        <button class="btn-refresh-layers" id="refreshLayersBtn" title="레이어 새로고침">
            <i data-lucide="refresh-cw" class="icon-xs"></i>
        </button>
        <div class="layers-info">
            <span id="layersCount">0</span> layers
        </div>
    </div>
    
    <!-- Layers List (Dynamic - Drag & Drop) -->
    <div class="panel-content">
        <div id="layersList">
            <!-- Layers will be dynamically rendered here by LayersManager -->
        </div>
    </div>
</div>

<div class="panel right" id="aiPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">AI Assistant</span>
        <button class="panel-close" onclick="closePanel('aiPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="width: 8px; height: 8px; border-radius: 50%; background: #22C55E; animation: pulse 2s infinite;"></div>
                        <div style="font-weight: 600; color: #e5e5e5;">이미지 생성 중...</div>
                    </div>
                    <div style="font-size: 0.875rem; color: #9CA3AF;">진행률: 73%</div>
                    <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 0.5rem; overflow: hidden;">
                        <div style="width: 73%; height: 100%; background: linear-gradient(90deg, #8B5CF6, #6366F1); transition: width 0.3s;"></div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px;">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">최근 AI 작업</div>
                    <div style="font-size: 0.9375rem; color: #e5e5e5;">• 배경 제거 (3분 전)</div>
                    <div style="font-size: 0.9375rem; color: #e5e5e5;">• 텍스트 번역 (15분 전)</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="alertsPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">Alerts</span>
        <button class="panel-close" onclick="closePanel('alertsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #EF4444;">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <i data-lucide="alert-circle" style="width:16px;height:16px;color:#EF4444;flex-shrink:0;margin-top:2px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">프로젝트 마감일 임박</div>
                            <div style="font-size: 0.875rem; color: #9CA3AF;">뮤지엄 전시 - 2일 남음</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3B82F6;">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <i data-lucide="info" style="width:16px;height:16px;color:#3B82F6;flex-shrink:0;margin-top:2px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">새로운 업데이트</div>
                            <div style="font-size: 0.875rem; color: #9CA3AF;">Canvas v4 기능 추가됨</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 3px solid #22C55E;">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <i data-lucide="check-circle" style="width:16px;height:16px;color:#22C55E;flex-shrink:0;margin-top:2px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">작업 완료</div>
                            <div style="font-size: 0.875rem; color: #9CA3AF;">오디오 가이드 녹음 완료</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Widget Panel -->
<div class="panel right" id="widgetPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">
            <i data-lucide="package" class="icon" style="margin-right:8px;"></i>
            위젯
        </span>
        <button class="panel-close" onclick="closePanel('widgetPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <!-- Search & Filter Toolbar -->
    <div class="widget-toolbar">
        <div class="widget-search-box">
            <i data-lucide="search" class="icon"></i>
            <input type="text" 
                   id="widgetSearch" 
                   placeholder="🔍 위젯 검색... (Cmd+K로 빠른 접근)"
                   autocomplete="off">
            <button id="widgetClearSearch" class="widget-btn-clear" style="display:none;">
                <i data-lucide="x" class="icon"></i>
            </button>
        </div>
        
        <div class="widget-filter-chips">
            <button class="widget-chip active" data-filter="all">
                <i data-lucide="grid-3x3" class="icon-xs"></i>
                전체
            </button>
            <button class="widget-chip" data-filter="premium">
                <i data-lucide="star" class="icon-xs"></i>
                프리미엄
            </button>
            <button class="widget-chip" data-filter="free">
                <i data-lucide="gift" class="icon-xs"></i>
                무료
            </button>
            <button class="widget-chip" data-filter="recent">
                <i data-lucide="clock" class="icon-xs"></i>
                최근
            </button>
        </div>
        
        <!-- Category & Sort Controls -->
        <div style="display: flex; gap: 12px; margin-top: 12px;">
            <select id="categoryFilter" class="widget-select">
                <option value="all">모든 카테고리</option>
                <option value="advanced-analytics">📊 고급 분석 & 인사이트</option>
                <option value="museum-professional">🏛️ 뮤지엄 전문 기능</option>
                <option value="visitor-experience">👥 관람객 경험</option>
                <option value="operations">💼 운영 & 관리</option>
                <option value="collaboration">🤝 협업 & 커뮤니케이션</option>
                <option value="financial">💰 재무 & 수익 분석</option>
            </select>
            
            <select id="sortFilter" class="widget-select">
                <option value="default">기본 정렬</option>
                <option value="name-asc">이름 (가나다순)</option>
                <option value="name-desc">이름 (역순)</option>
                <option value="price-asc">가격 (낮은순)</option>
                <option value="price-desc">가격 (높은순)</option>
            </select>
        </div>
        
        <div class="widget-search-hint">
            💡 <kbd>Cmd</kbd> + <kbd>K</kbd> 로 빠르게 검색하거나, 카테고리를 클릭하여 위젯을 탐색하세요
        </div>
    </div>
    
    <div class="panel-content">
        <div id="widgetCategoryList">
            <!-- 📊 고급 분석 & 인사이트 -->
            <div class="category-group category-advanced-analytics" 
                 data-category="advanced-analytics"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('advanced-analytics')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="trending-up" class="icon category-icon"></i>
                    <span class="category-name">고급 분석 & 인사이트</span>
                    <span class="category-badge">17</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="visitor-dwell-time" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="clock" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">관람객 체류 시간 분석 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">전시실별 평균 체류 시간과 인기 전시물 패턴 분석</div>
                        </div>
                        <div class="widget-price">₩7,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="predictive-visitors" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="brain" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">예측 관람객 수 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">AI 기반 방문자 예측 및 최적 인력 배치 제안</div>
                        </div>
                        <div class="widget-price">₩9,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="exhibition-effectiveness" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="bar-chart-3" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">전시 효과성 대시보드 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">관람객 피드백, QR 스캔율, 오디오 가이드 사용률 종합</div>
                        </div>
                        <div class="widget-price">₩7,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="heatmap-tracking" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="map" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">관람객 동선 히트맵 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">전시실별 관람객 이동 패턴 시각화</div>
                        </div>
                        <div class="widget-price">₩8,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="engagement-metrics" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="activity" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">콘텐츠 참여도 분석 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">전시물별 상호작용 시간 및 빈도 측정</div>
                        </div>
                        <div class="widget-price">₩7,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="demographic-insights" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="pie-chart" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">방문자 인구통계 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">연령·성별·지역별 방문자 데이터</div>
                        </div>
                        <div class="widget-price">₩6,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="conversion-funnel" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="trending-up" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">티켓 구매 전환율 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">온라인→오프라인 전환 분석</div>
                        </div>
                        <div class="widget-price">₩9,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="sentiment-analysis" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="message-circle" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">소셜 미디어 감성 분석 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">SNS 언급 및 감정 분석</div>
                        </div>
                        <div class="widget-price">₩11,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="benchmark-comparison" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="bar-chart-2" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">경쟁 뮤지엄 벤치마크 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">타 기관 대비 성과 비교</div>
                        </div>
                        <div class="widget-price">₩8,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="predictive-maintenance" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="alert-triangle" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">시설 예측 유지보수 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">AI 기반 설비 고장 예측</div>
                        </div>
                        <div class="widget-price">₩10,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="roi-calculator" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="calculator" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">전시 ROI 계산기 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">투자 대비 수익률 분석</div>
                        </div>
                        <div class="widget-price">₩7,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="anomaly-detection" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="shield-alert" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">이상 행동 탐지 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">보안·안전 위험 실시간 알림</div>
                        </div>
                        <div class="widget-price">₩12,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="cohort-analysis" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="users-2" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">재방문 코호트 분석 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">방문자 그룹별 재방문율 추적</div>
                        </div>
                        <div class="widget-price">₩8,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="energy-monitoring">
                        <div class="widget-icon-wrapper"><i data-lucide="zap" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">에너지 사용 모니터링</div>
                            <div class="widget-description">실시간 전력·수도 사용량</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="accessibility-metrics">
                        <div class="widget-icon-wrapper"><i data-lucide="accessibility" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">접근성 지표 대시보드</div>
                            <div class="widget-description">장애인 편의시설 이용률</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="queue-analytics" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="clock-3" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">대기열 분석 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">입장 대기 시간 최적화</div>
                        </div>
                        <div class="widget-price">₩6,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="weather-impact">
                        <div class="widget-icon-wrapper"><i data-lucide="cloud-rain" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">날씨 영향 분석</div>
                            <div class="widget-description">날씨와 방문객 수 상관관계</div>
                        </div>
                        
                    </div>
                </div>
            </div>
            <!-- 📊 뮤지엄 전문 기능 -->
            <div class="category-group category-museum-professional" 
                 data-category="museum-professional"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('museum-professional')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="landmark" class="icon category-icon"></i>
                    <span class="category-name">뮤지엄 전문 기능</span>
                    <span class="category-badge">20</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="artifact-loan-status">
                        <div class="widget-icon-wrapper"><i data-lucide="package" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">소장품 대출 현황</div>
                            <div class="widget-description">외부 기관 대출 작품의 위치와 상태 추적</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="conservation-workflow">
                        <div class="widget-icon-wrapper"><i data-lucide="wrench" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">보존 처리 워크플로우</div>
                            <div class="widget-description">작품 보존 프로세스와 담당자 배정</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="digitization-tracker">
                        <div class="widget-icon-wrapper"><i data-lucide="scan" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">디지털화 진행 현황</div>
                            <div class="widget-description">소장품 3D 스캔 진척도</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="provenance-research" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="search" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">소장품 출처 조사 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">작품 이력 문서화 도구</div>
                        </div>
                        <div class="widget-price">₩9,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="condition-reporting">
                        <div class="widget-icon-wrapper"><i data-lucide="file-text" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">상태 보고서 생성</div>
                            <div class="widget-description">작품 손상도 자동 기록</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="deaccession-workflow">
                        <div class="widget-icon-wrapper"><i data-lucide="archive" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">소장품 폐기 워크플로우</div>
                            <div class="widget-description">처분 승인 프로세스 관리</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="exhibition-calendar">
                        <div class="widget-icon-wrapper"><i data-lucide="calendar" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">전시 캘린더</div>
                            <div class="widget-description">전시 일정 통합 관리</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="artwork-insurance" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="shield" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">작품 보험 관리 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">보험 만료일 알림</div>
                        </div>
                        <div class="widget-price">₩7,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="catalog-generator" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="book-open" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">카탈로그 자동 생성 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">전시 도록 PDF 자동화</div>
                        </div>
                        <div class="widget-price">₩11,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="rights-management" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="copyright" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">저작권 관리 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">이미지 사용 권한 추적</div>
                        </div>
                        <div class="widget-price">₩8,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="loan-agreement">
                        <div class="widget-icon-wrapper"><i data-lucide="file-signature" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">대출 계약서 템플릿</div>
                            <div class="widget-description">표준 계약서 자동 생성</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="curator-notes">
                        <div class="widget-icon-wrapper"><i data-lucide="sticky-note" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">큐레이터 노트</div>
                            <div class="widget-description">전시 기획 메모 공유</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="collection-inventory">
                        <div class="widget-icon-wrapper"><i data-lucide="clipboard-list" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">소장품 재고 조사</div>
                            <div class="widget-description">연례 재고조사 체크리스트</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="donor-tracking" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="gift" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">기증자 관리 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">기증품 이력 추적</div>
                        </div>
                        <div class="widget-price">₩6,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="exhibition-budget">
                        <div class="widget-icon-wrapper"><i data-lucide="dollar-sign" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">전시 예산 관리</div>
                            <div class="widget-description">항목별 예산 집행 현황</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="security-log">
                        <div class="widget-icon-wrapper"><i data-lucide="lock" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">보안 일지</div>
                            <div class="widget-description">작품 이동 기록</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="digital-archive">
                        <div class="widget-icon-wrapper"><i data-lucide="database" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">디지털 아카이브</div>
                            <div class="widget-description">고해상도 이미지 저장소 및 검색</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="exhibition-planning">
                        <div class="widget-icon-wrapper"><i data-lucide="layout-template" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">전시 기획 보드</div>
                            <div class="widget-description">아이디어 수집부터 실행까지 전 과정 관리</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="high-value-loans" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="bell-ring" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">고가 소장품 대출 알림 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">보험가액 1억원 이상 작품의 대출 일정</div>
                        </div>
                        <div class="widget-price">₩5,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="digitization-progress">
                        <div class="widget-icon-wrapper"><i data-lucide="camera" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">디지털화 진행률</div>
                            <div class="widget-description">3D 스캔 및 사진 촬영 완료율</div>
                        </div>
                        
                    </div>
                </div>
            </div>
            <!-- 📊 관람객 경험 -->
            <div class="category-group category-visitor-experience" 
                 data-category="visitor-experience"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('visitor-experience')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="users" class="icon category-icon"></i>
                    <span class="category-name">관람객 경험</span>
                    <span class="category-badge">15</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="audio-guide-stats">
                        <div class="widget-icon-wrapper"><i data-lucide="headphones" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">오디오 가이드 사용 통계</div>
                            <div class="widget-description">대여 빈도와 인기 콘텐츠 트래킹</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="live-satisfaction">
                        <div class="widget-icon-wrapper"><i data-lucide="smile" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">실시간 만족도 조사</div>
                            <div class="widget-description">전시 관람 후 즉석 설문 수집</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="virtual-tour" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="monitor" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">가상 투어 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">온라인 전시 관람</div>
                        </div>
                        <div class="widget-price">₩14,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="ar-guide" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="smartphone" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">AR 가이드 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">증강현실 전시 해설</div>
                        </div>
                        <div class="widget-price">₩19,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="kids-zone">
                        <div class="widget-icon-wrapper"><i data-lucide="gamepad-2" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">어린이 체험존</div>
                            <div class="widget-description">교육 게임 콘텐츠</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="membership-rewards">
                        <div class="widget-icon-wrapper"><i data-lucide="award" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">멤버십 리워드</div>
                            <div class="widget-description">방문 포인트 적립</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="multilingual-chat" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="message-square" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">다국어 챗봇 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">20개 언어 지원</div>
                        </div>
                        <div class="widget-price">₩12,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="personalized-route" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="route" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">맞춤형 관람 경로 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">AI 추천 동선</div>
                        </div>
                        <div class="widget-price">₩8,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="photo-spot-map">
                        <div class="widget-icon-wrapper"><i data-lucide="camera" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">포토존 맵</div>
                            <div class="widget-description">인스타그램 스팟 안내</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="exhibition-quiz">
                        <div class="widget-icon-wrapper"><i data-lucide="help-circle" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">전시 퀴즈</div>
                            <div class="widget-description">관람 후 퀴즈 참여</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="donation-kiosk">
                        <div class="widget-icon-wrapper"><i data-lucide="hand-heart" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">기부 키오스크</div>
                            <div class="widget-description">전시 후원 모금</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="wayfinding-system" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="navigation" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">실내 내비게이션 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">전시실 길찾기</div>
                        </div>
                        <div class="widget-price">₩9,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="social-sharing">
                        <div class="widget-icon-wrapper"><i data-lucide="share-2" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">소셜 공유</div>
                            <div class="widget-description">방문 인증 이벤트</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="group-booking">
                        <div class="widget-icon-wrapper"><i data-lucide="users" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">단체 예약 관리</div>
                            <div class="widget-description">학교·기업 단체 예약</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="lost-found">
                        <div class="widget-icon-wrapper"><i data-lucide="search" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">분실물 센터</div>
                            <div class="widget-description">분실물 신고·조회</div>
                        </div>
                        
                    </div>
                </div>
            </div>
            <!-- 📊 운영 & 관리 -->
            <div class="category-group category-operations" 
                 data-category="operations"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('operations')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="settings" class="icon category-icon"></i>
                    <span class="category-name">운영 & 관리</span>
                    <span class="category-badge">15</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="facility-inspection">
                        <div class="widget-icon-wrapper"><i data-lucide="clipboard-check" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">시설 점검 체크리스트</div>
                            <div class="widget-description">일일 점검 항목과 이슈 보고</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="cctv-monitoring" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="video" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">CCTV 모니터링 현황 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">카메라 작동 상태와 녹화 용량</div>
                        </div>
                        <div class="widget-price">₩5,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="staff-scheduling">
                        <div class="widget-icon-wrapper"><i data-lucide="calendar-clock" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">직원 근무 스케줄</div>
                            <div class="widget-description">시프트 자동 배정</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="facility-booking">
                        <div class="widget-icon-wrapper"><i data-lucide="building" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">공간 대관 관리</div>
                            <div class="widget-description">대관 일정 조율</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="vendor-management">
                        <div class="widget-icon-wrapper"><i data-lucide="truck" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">협력업체 관리</div>
                            <div class="widget-description">계약 업체 연락처</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="incident-reporting">
                        <div class="widget-icon-wrapper"><i data-lucide="alert-octagon" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">사고 보고서</div>
                            <div class="widget-description">안전사고 기록</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="hvac-control" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="thermometer" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">공조 시스템 제어 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">온·습도 원격 조절</div>
                        </div>
                        <div class="widget-price">₩13,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="lighting-schedule">
                        <div class="widget-icon-wrapper"><i data-lucide="lightbulb" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">조명 스케줄</div>
                            <div class="widget-description">전시 조명 타이머</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="cleaning-checklist">
                        <div class="widget-icon-wrapper"><i data-lucide="check-square" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">청소 체크리스트</div>
                            <div class="widget-description">일일 청소 점검</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="supply-inventory">
                        <div class="widget-icon-wrapper"><i data-lucide="package-2" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">비품 재고 관리</div>
                            <div class="widget-description">소모품 발주 알림</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="parking-monitor">
                        <div class="widget-icon-wrapper"><i data-lucide="car" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">주차장 모니터링</div>
                            <div class="widget-description">실시간 주차 현황</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="fire-alarm-test">
                        <div class="widget-icon-wrapper"><i data-lucide="flame" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">소방 설비 점검</div>
                            <div class="widget-description">정기 점검 일정</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="mail-tracking">
                        <div class="widget-icon-wrapper"><i data-lucide="mail" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">우편물 추적</div>
                            <div class="widget-description">택배·서신 수령 기록</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="key-management">
                        <div class="widget-icon-wrapper"><i data-lucide="key" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">열쇠 관리</div>
                            <div class="widget-description">대여·반납 이력</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="equipment-maintenance">
                        <div class="widget-icon-wrapper"><i data-lucide="wrench" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">장비 유지보수 일지</div>
                            <div class="widget-description">A/V 장비 및 조명 정기 점검</div>
                        </div>
                        
                    </div>
                </div>
            </div>
            <!-- 📊 협업 & 커뮤니케이션 -->
            <div class="category-group category-collaboration" 
                 data-category="collaboration"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('collaboration')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="message-square" class="icon category-icon"></i>
                    <span class="category-name">협업 & 커뮤니케이션</span>
                    <span class="category-badge">10</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="project-kanban">
                        <div class="widget-icon-wrapper"><i data-lucide="trello" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">프로젝트 칸반</div>
                            <div class="widget-description">업무 진행 상태 보드</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="document-library">
                        <div class="widget-icon-wrapper"><i data-lucide="folder" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">문서 라이브러리</div>
                            <div class="widget-description">공유 파일 저장소</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="meeting-notes">
                        <div class="widget-icon-wrapper"><i data-lucide="file-edit" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">회의록</div>
                            <div class="widget-description">회의 내용 기록</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="approval-workflow" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="check-circle-2" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">결재 워크플로우 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">전자 결재 시스템</div>
                        </div>
                        <div class="widget-price">₩8,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="team-chat">
                        <div class="widget-icon-wrapper"><i data-lucide="messages-square" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">팀 채팅</div>
                            <div class="widget-description">부서별 채팅방</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="brainstorming-board">
                        <div class="widget-icon-wrapper"><i data-lucide="lightbulb-off" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">브레인스토밍 보드</div>
                            <div class="widget-description">아이디어 공유 보드</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="task-assignment">
                        <div class="widget-icon-wrapper"><i data-lucide="user-check" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">업무 배정</div>
                            <div class="widget-description">담당자 지정</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="shared-calendar">
                        <div class="widget-icon-wrapper"><i data-lucide="calendar-days" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">공유 캘린더</div>
                            <div class="widget-description">부서별 일정 조율</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="announcement-board">
                        <div class="widget-icon-wrapper"><i data-lucide="megaphone" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">공지사항</div>
                            <div class="widget-description">전체 공지 게시판</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="feedback-system">
                        <div class="widget-icon-wrapper"><i data-lucide="message-circle-heart" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">피드백 시스템</div>
                            <div class="widget-description">동료 평가 및 제안</div>
                        </div>
                        
                    </div>
                </div>
            </div>
            <!-- 📊 재무 & 수익 분석 -->
            <div class="category-group category-financial" 
                 data-category="financial"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('financial')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="dollar-sign" class="icon category-icon"></i>
                    <span class="category-name">재무 & 수익 분석</span>
                    <span class="category-badge">10</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="monthly-budget">
                        <div class="widget-icon-wrapper"><i data-lucide="wallet" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">월별 예산 현황</div>
                            <div class="widget-description">부서별 예산 대비 실제 지출 비교</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="budget-alert">
                        <div class="widget-icon-wrapper"><i data-lucide="alert-circle" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">예산 초과 알림</div>
                            <div class="widget-description">지출 80% 도달 시 자동 경고</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="financial-forecast" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="trending-up" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">재무 예측 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">다음 분기 수익 예측 모델</div>
                        </div>
                        <div class="widget-price">₩8,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="ticket-sales">
                        <div class="widget-icon-wrapper"><i data-lucide="ticket" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">티켓 판매 현황</div>
                            <div class="widget-description">일일 매출 통계</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="gift-shop-pos" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="shopping-cart" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">기념품점 POS <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">상품 판매 관리</div>
                        </div>
                        <div class="widget-price">₩15,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="sponsorship-tracking">
                        <div class="widget-icon-wrapper"><i data-lucide="piggy-bank" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">후원금 관리</div>
                            <div class="widget-description">후원자 기부 내역</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="grant-application">
                        <div class="widget-icon-wrapper"><i data-lucide="file-badge" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">지원금 신청</div>
                            <div class="widget-description">정부 지원금 양식</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="expense-report">
                        <div class="widget-icon-wrapper"><i data-lucide="receipt" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">경비 보고서</div>
                            <div class="widget-description">지출 증빙 제출</div>
                        </div>
                        
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="fundraising-campaign" data-premium="true">
                        <div class="widget-icon-wrapper"><i data-lucide="heart-handshake" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">모금 캠페인 <span class="badge-premium"><i data-lucide="star" class="icon-xs"></i>Premium</span></div>
                            <div class="widget-description">온라인 모금 진행</div>
                        </div>
                        <div class="widget-price">₩9,900</div>
                    </div>
                    <div class="widget-item" draggable="true" data-widget-type="tax-filing">
                        <div class="widget-icon-wrapper"><i data-lucide="file-spreadsheet" class="icon"></i></div>
                        <div class="widget-info">
                            <div class="widget-name">세무 서류</div>
                            <div class="widget-description">연말정산 자료</div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Input -->
<div class="ai-input">
    <select class="ai-select">
        <option>GPT-4o</option>
        <option>Claude 3.5</option>
        <option>Gemini Pro</option>
    </select>
    <button class="ai-voice" id="voiceBtn" title="음성 입력">
        <i data-lucide="mic" style="width:16px;height:16px"></i>
    </button>
    <input class="ai-field" id="aiInput" placeholder="AI에게 질문하거나 음성 입력...">
    
    <!-- Zoom Controls (moved here) -->
    <div class="controls">
        <button class="ctrl-btn" id="zoomOut">
            <i data-lucide="zoom-out" style="width:14px;height:14px"></i>
        </button>
        <span class="zoom-level" id="zoomLevel">100%</span>
        <button class="ctrl-btn" id="zoomIn">
            <i data-lucide="zoom-in" style="width:14px;height:14px"></i>
        </button>
        <button class="ctrl-btn" id="fitScreen">
            <i data-lucide="maximize-2" style="width:14px;height:14px"></i>
        </button>
        <button class="ctrl-btn" id="connectionMode" onclick="enableConnectionMode()" 
                title="연결 모드 (C 키)" style="margin-left: 0.5rem;">
            <i data-lucide="link" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <button class="ai-send">
        <i data-lucide="send" style="width:16px;height:16px"></i>
    </button>
</div>

<!-- Modal Viewer -->
<div class="modal-overlay" id="modalViewer">
    <button class="modal-close" onclick="closeModal()">×</button>
    <div class="modal-content" id="modalContent"></div>
</div>

<!-- Context Menu for Widget Nodes -->
<div class="context-menu" id="widgetContextMenu" style="display: none;">
    <div class="context-menu-item" onclick="editWidgetNode()">
        <i data-lucide="edit" style="width:16px;height:16px;"></i>
        <span>편집</span>
    </div>
    <div class="context-menu-item" onclick="duplicateWidgetNode()">
        <i data-lucide="copy" style="width:16px;height:16px;"></i>
        <span>복제</span>
    </div>
    <div class="context-menu-item context-menu-danger" onclick="deleteWidgetNode()">
        <i data-lucide="trash-2" style="width:16px;height:16px;"></i>
        <span>삭제</span>
    </div>
</div>

<!-- Widget Edit Modal -->
<div class="edit-modal-overlay" id="widgetEditModal" style="display: none;">
    <div class="edit-modal">
        <div class="edit-modal-header">
            <h3>✏️ Widget 편집</h3>
            <button class="edit-modal-close" onclick="closeEditModal()">
                <i data-lucide="x" style="width:18px;height:18px;"></i>
            </button>
        </div>
        <div class="edit-modal-body">
            <div class="edit-form-group">
                <label>이름</label>
                <input type="text" id="editWidgetName" class="edit-input" placeholder="Widget 이름">
            </div>
            <div class="edit-form-group">
                <label>설명</label>
                <textarea id="editWidgetDescription" class="edit-textarea" placeholder="Widget 설명" rows="3"></textarea>
            </div>
            <div class="edit-form-group">
                <label>색상</label>
                <div class="color-picker">
                    <div class="color-option" data-color="#FFFFFF" style="background: #FFFFFF;" title="기본"></div>
                    <div class="color-option" data-color="#8B5CF6" style="background: #8B5CF6;" title="보라색"></div>
                    <div class="color-option" data-color="#3B82F6" style="background: #3B82F6;" title="파란색"></div>
                    <div class="color-option" data-color="#10B981" style="background: #10B981;" title="녹색"></div>
                    <div class="color-option" data-color="#F59E0B" style="background: #F59E0B;" title="노란색"></div>
                    <div class="color-option" data-color="#EF4444" style="background: #EF4444;" title="빨간색"></div>
                </div>
            </div>
        </div>
        <div class="edit-modal-footer">
            <button class="edit-btn-cancel" onclick="closeEditModal()">취소</button>
            <button class="edit-btn-save" onclick="saveWidgetEdit()">저장</button>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu" style="display: none;">
    <div class="context-menu-item" onclick="editNodeFromContextMenu()">
        <i data-lucide="edit-3"></i>
        <span>편집</span>
    </div>
    <div class="context-menu-item" onclick="duplicateNodeFromContextMenu()">
        <i data-lucide="copy"></i>
        <span>복제</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="deleteNodeFromContextMenu()">
        <i data-lucide="trash-2"></i>
        <span>삭제</span>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div class="footer-left">
        <span>© 2025 MuseFlow</span>
        <a href="#" class="footer-link">도움말</a>
        <a href="#" class="footer-link">개인정보처리방침</a>
        <a href="#" class="footer-link">서비스 약관</a>
    </div>
    <div class="footer-right">
        <span>v4.0.0</span>
    </div>
</footer>

<script>
lucide.createIcons();

// ============================================
// Widget 드래그앤드롭 - 전역 변수 및 함수 (최우선 정의)
// ============================================
let draggedWidgetData = null;

// ============================================
// Widget 커스터마이징 - 전역 변수
// ============================================
let currentEditingNode = null;
let selectedColor = '#FFFFFF';
let contextMenuTarget = null;

// localStorage 키
const WIDGET_CONFIGS_KEY = 'canvas_widget_configs';
const WIDGET_USAGE_STATS_KEY = 'widget_usage_stats';

// Widget 설정 로드
function loadWidgetConfigs() {
    const configs = localStorage.getItem(WIDGET_CONFIGS_KEY);
    return configs ? JSON.parse(configs) : {};
}

// Widget 설정 저장
function saveWidgetConfig(widgetId, config) {
    const configs = loadWidgetConfigs();
    configs[widgetId] = {
        ...config,
        updated_at: new Date().toISOString()
    };
    localStorage.setItem(WIDGET_CONFIGS_KEY, JSON.stringify(configs));
    console.log('💾 Widget config saved:', widgetId, config);
}

// Widget 아이템에 드래그 이벤트 리스너 추가하는 함수
function attachWidgetDragListeners() {
    const widgets = document.querySelectorAll('.widget-item');
    
    widgets.forEach(widget => {
        // 이미 리스너가 등록되어 있으면 스킵
        if (widget.dataset.dragListenerAttached) return;
        
        // dragstart 이벤트
        widget.addEventListener('dragstart', (e) => {
            const widgetType = widget.dataset.widgetType;
            const widgetName = widget.querySelector('.widget-name')?.textContent?.replace(/Premium/g, '').trim() || 'New Widget';
            const widgetDesc = widget.querySelector('.widget-description')?.textContent || '';
            const isPremium = widget.querySelector('.badge-premium') !== null;
            
            draggedWidgetData = {
                type: widgetType,
                name: widgetName,
                description: widgetDesc,
                isPremium: isPremium
            };
            
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', JSON.stringify(draggedWidgetData));
            
            // 드래그 중 시각적 피드백
            widget.style.opacity = '0.5';
            
            // Add to recent widgets
            addToRecentWidgets(widgetType);
            
            console.log('🎨 Widget 드래그 시작:', widgetName, draggedWidgetData);
        });
        
        // dragend 이벤트
        widget.addEventListener('dragend', (e) => {
            widget.style.opacity = '1';
            console.log('🎨 Widget 드래그 종료');
        });
        
        // 리스너 등록 플래그
        widget.dataset.dragListenerAttached = 'true';
    });
    
    console.log(`✅ Widget 드래그 리스너 등록 완료: ${widgets.length}개`);
}

// ========== WIDGET PANEL - ACCORDION & SEARCH ==========
function toggleWidgetCategory(categoryId) {
  const group = document.querySelector(`[data-category="${categoryId}"]`);
  if (!group) return;
  
  const content = group.querySelector('.category-content');
  const isExpanded = group.dataset.expanded === 'true';
  
  // Toggle
  group.dataset.expanded = !isExpanded;
  
  // Animation
  if (!isExpanded) {
    content.style.display = 'block';
    const height = content.scrollHeight;
    content.style.maxHeight = '0px';
    requestAnimationFrame(() => {
      content.style.maxHeight = height + 'px';
    });
  } else {
    content.style.maxHeight = '0px';
    setTimeout(() => {
      content.style.display = 'none';
    }, 350);
  }
  
  // Re-initialize Lucide icons
  lucide.createIcons();
  
  // 카테고리 펼침 시 Widget 드래그 리스너 재등록
  if (!isExpanded && typeof attachWidgetDragListeners === 'function') {
    setTimeout(() => {
      attachWidgetDragListeners();
    }, 100);
  }
}

// Widget Search
const widgetSearchInput = document.getElementById('widgetSearch');
const widgetClearBtn = document.getElementById('widgetClearSearch');

widgetSearchInput?.addEventListener('input', (e) => {
  const query = e.target.value.trim().toLowerCase();
  
  if (query.length > 0) {
    filterWidgets(query);
    widgetClearBtn.style.display = 'flex';
  } else {
    resetWidgetFilter();
    widgetClearBtn.style.display = 'none';
  }
});

widgetClearBtn?.addEventListener('click', () => {
  widgetSearchInput.value = '';
  resetWidgetFilter();
  widgetClearBtn.style.display = 'none';
});

function filterWidgets(query) {
  const allWidgets = document.querySelectorAll('.widget-item');
  const allCategories = document.querySelectorAll('.category-group');
  
  allCategories.forEach(category => {
    const categoryWidgets = category.querySelectorAll('.widget-item');
    let hasVisibleWidget = false;
    
    categoryWidgets.forEach(widget => {
      const name = widget.querySelector('.widget-name')?.textContent.toLowerCase() || '';
      const desc = widget.querySelector('.widget-description')?.textContent.toLowerCase() || '';
      
      if (name.includes(query) || desc.includes(query)) {
        widget.style.display = 'flex';
        hasVisibleWidget = true;
      } else {
        widget.style.display = 'none';
      }
    });
    
    // Show category if it has visible widgets
    if (hasVisibleWidget) {
      category.style.display = 'block';
      category.dataset.expanded = 'true';
      category.querySelector('.category-content').style.display = 'block';
      category.querySelector('.category-content').style.maxHeight = '9999px';
    } else {
      category.style.display = 'none';
    }
  });
  
  lucide.createIcons();
}

// ============================================
// Widget Filter Functions
// ============================================
let currentFilter = 'all';
let recentWidgets = [];

// Filter Chips Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    const filterChips = document.querySelectorAll('.widget-chip');
    
    filterChips.forEach(chip => {
        chip.addEventListener('click', () => {
            const filterType = chip.dataset.filter;
            
            // Update active state
            filterChips.forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            
            // Apply filter
            currentFilter = filterType;
            applyWidgetFilter(filterType);
            
            console.log('🔍 Filter 적용:', filterType);
        });
    });
    
    // Category Filter
    const categoryFilter = document.getElementById('categoryFilter');
    categoryFilter?.addEventListener('change', (e) => {
        const category = e.target.value;
        applyCategoryFilter(category);
        console.log('📂 Category Filter:', category);
    });
    
    // Sort Filter
    const sortFilter = document.getElementById('sortFilter');
    sortFilter?.addEventListener('change', (e) => {
        const sortType = e.target.value;
        applySortFilter(sortType);
        console.log('🔢 Sort Filter:', sortType);
    });
    
    // Load recent widgets from localStorage
    loadRecentWidgets();
});

function applyWidgetFilter(filterType) {
    const allWidgets = document.querySelectorAll('.widget-item');
    const allCategories = document.querySelectorAll('.category-group');
    
    allCategories.forEach(category => {
        const categoryWidgets = category.querySelectorAll('.widget-item');
        let hasVisibleWidget = false;
        
        categoryWidgets.forEach(widget => {
            const isPremium = widget.dataset.premium === 'true';
            const widgetType = widget.dataset.widgetType;
            let isVisible = false;
            
            switch(filterType) {
                case 'all':
                    isVisible = true;
                    break;
                case 'premium':
                    isVisible = isPremium;
                    break;
                case 'free':
                    isVisible = !isPremium;
                    break;
                case 'recent':
                    isVisible = recentWidgets.includes(widgetType);
                    break;
            }
            
            widget.style.display = isVisible ? 'flex' : 'none';
            if (isVisible) hasVisibleWidget = true;
        });
        
        // Show/hide category
        if (hasVisibleWidget) {
            category.style.display = 'block';
            category.dataset.expanded = 'true';
            const content = category.querySelector('.category-content');
            content.style.display = 'block';
            content.style.maxHeight = '9999px';
        } else {
            category.style.display = 'none';
        }
    });
    
    lucide.createIcons();
}

function loadRecentWidgets() {
    const saved = localStorage.getItem('recent_widgets');
    recentWidgets = saved ? JSON.parse(saved) : [];
    console.log('📋 Recent Widgets 로드:', recentWidgets.length);
}

function addToRecentWidgets(widgetType) {
    if (!recentWidgets.includes(widgetType)) {
        recentWidgets.unshift(widgetType);
        
        // Keep only last 10
        if (recentWidgets.length > 10) {
            recentWidgets = recentWidgets.slice(0, 10);
        }
        
        localStorage.setItem('recent_widgets', JSON.stringify(recentWidgets));
        console.log('✅ Recent Widget 추가:', widgetType);
    }
}

// ============================================
// Category Filter Function
// ============================================
function applyCategoryFilter(category) {
    const allCategories = document.querySelectorAll('.category-group');
    
    if (category === 'all') {
        // Show all categories
        allCategories.forEach(cat => {
            cat.style.display = 'block';
        });
    } else {
        // Show only selected category
        allCategories.forEach(cat => {
            if (cat.dataset.category === category) {
                cat.style.display = 'block';
                cat.dataset.expanded = 'true';
                const content = cat.querySelector('.category-content');
                content.style.display = 'block';
                content.style.maxHeight = '9999px';
            } else {
                cat.style.display = 'none';
            }
        });
    }
    
    lucide.createIcons();
}

// ============================================
// Sort Filter Function
// ============================================
function applySortFilter(sortType) {
    const allCategories = document.querySelectorAll('.category-group');
    
    allCategories.forEach(category => {
        const widgetList = Array.from(category.querySelectorAll('.widget-item'));
        const content = category.querySelector('.category-content');
        
        // Sort widgets
        widgetList.sort((a, b) => {
            const nameA = a.querySelector('.widget-name')?.textContent?.trim().toLowerCase() || '';
            const nameB = b.querySelector('.widget-name')?.textContent?.trim().toLowerCase() || '';
            const priceA = parseFloat(a.querySelector('.widget-price')?.textContent?.replace(/[^\d]/g, '') || '0');
            const priceB = parseFloat(b.querySelector('.widget-price')?.textContent?.replace(/[^\d]/g, '') || '0');
            
            switch(sortType) {
                case 'name-asc':
                    return nameA.localeCompare(nameB);
                case 'name-desc':
                    return nameB.localeCompare(nameA);
                case 'price-asc':
                    return priceA - priceB;
                case 'price-desc':
                    return priceB - priceA;
                default:
                    return 0;
            }
        });
        
        // Re-append sorted widgets
        widgetList.forEach(widget => {
            content.appendChild(widget);
        });
    });
    
    lucide.createIcons();
    
    // Re-attach drag listeners
    setTimeout(() => {
        if (typeof attachWidgetDragListeners === 'function') {
            attachWidgetDragListeners();
        }
    }, 100);
}

function resetWidgetFilter() {
    const allWidgets = document.querySelectorAll('.widget-item');
    const allCategories = document.querySelectorAll('.category-group');
  
  allWidgets.forEach(widget => {
    widget.style.display = 'flex';
  });
  
  allCategories.forEach(category => {
    category.style.display = 'block';
  });
  
  lucide.createIcons();
}

// Filter Chips
document.querySelectorAll('.widget-chip').forEach(chip => {
  chip.addEventListener('click', (e) => {
    document.querySelectorAll('.widget-chip').forEach(c => c.classList.remove('active'));
    e.currentTarget.classList.add('active');
    
    const filter = e.currentTarget.dataset.filter;
    applyWidgetFilter(filter);
  });
});

function applyWidgetFilter(filter) {
  const allWidgets = document.querySelectorAll('.widget-item');
  const allCategories = document.querySelectorAll('.category-group');
  
  allCategories.forEach(category => {
    const categoryWidgets = category.querySelectorAll('.widget-item');
    let hasVisibleWidget = false;
    
    categoryWidgets.forEach(widget => {
      let isVisible = false;
      
      switch (filter) {
        case 'premium':
          isVisible = widget.dataset.premium === 'true';
          break;
        case 'free':
          isVisible = widget.dataset.premium !== 'true';
          break;
        case 'recent':
          // TODO: Implement recent widgets from localStorage
          isVisible = false;
          break;
        case 'all':
        default:
          isVisible = true;
      }
      
      widget.style.display = isVisible ? 'flex' : 'none';
      if (isVisible) hasVisibleWidget = true;
    });
    
    if (hasVisibleWidget) {
      category.style.display = 'block';
      category.dataset.expanded = 'true';
      category.querySelector('.category-content').style.display = 'block';
      category.querySelector('.category-content').style.maxHeight = '9999px';
    } else {
      category.style.display = 'none';
    }
  });
  
  lucide.createIcons();
}

// Keyboard Shortcut (Cmd+K to focus search)
document.addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    const widgetPanel = document.getElementById('widgetPanel');
    if (!widgetPanel.classList.contains('open')) {
      openPanel('widgetPanel');
    }
    widgetSearchInput?.focus();
  }
});

// ========== WEB SPEECH API - VOICE INPUT ==========
let recognition = null;
let isRecording = false;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ko-KR';
    recognition.continuous = false;
    recognition.interimResults = true;
    
    recognition.onstart = () => {
        isRecording = true;
        const btn = document.getElementById('voiceBtn');
        btn.style.background = 'linear-gradient(135deg, #EF4444, #DC2626)';
        btn.style.animation = 'pulse 1.5s infinite';
        console.log('🎤 음성 인식 시작');
    };
    
    recognition.onresult = (event) => {
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            }
        }
        if (finalTranscript) {
            document.getElementById('aiInput').value = finalTranscript;
            console.log('✅ 인식 완료:', finalTranscript);
        }
    };
    
    recognition.onerror = (event) => {
        console.error('❌ 음성 인식 오류:', event.error);
        isRecording = false;
        const btn = document.getElementById('voiceBtn');
        btn.style.background = '';
        btn.style.animation = '';
    };
    
    recognition.onend = () => {
        isRecording = false;
        const btn = document.getElementById('voiceBtn');
        btn.style.background = '';
        btn.style.animation = '';
        console.log('🎤 음성 인식 종료');
    };
}

// Voice Button Click
document.getElementById('voiceBtn')?.addEventListener('click', () => {
    if (!recognition) {
        alert('음성 인식이 지원되지 않는 브라우저입니다.');
        return;
    }
    if (isRecording) {
        recognition.stop();
    } else {
        recognition.start();
    }
});

// ============================================
// D1 Database에서 Widget 동적 로딩
// ============================================
let widgetsLoadedFromD1 = false;

async function loadWidgetsFromD1() {
    // 이미 로드되었으면 스킵
    if (widgetsLoadedFromD1) {
        console.log('✅ Widgets already loaded from D1');
        return;
    }
    
    try {
        console.log('🔄 Loading widgets from D1 Database...');
        
        // API 호출 (6개 카테고리별)
        const categories = [
            'advanced-analytics',
            'museum-professional',
            'visitor-experience',
            'operations',
            'collaboration',
            'financial'
        ];
        
        for (const category of categories) {
            const response = await fetch(`/api/widgets?category=${category}`);
            const data = await response.json();
            
            if (!data.success) {
                console.error(`❌ Failed to load ${category} widgets:`, data.error);
                continue;
            }
            
            const widgets = data.data || [];
            console.log(`✅ Loaded ${widgets.length} widgets for category: ${category}`);
            
            // category-content 영역 찾기
            const categoryGroup = document.querySelector(`.category-${category}`);
            if (!categoryGroup) {
                console.warn(`⚠️ Category group not found: ${category}`);
                continue;
            }
            
            const categoryContent = categoryGroup.querySelector('.category-content');
            if (!categoryContent) {
                console.warn(`⚠️ Category content not found: ${category}`);
                continue;
            }
            
            // 기존 Widget 유지하고 새 Widget 추가
            const existingWidgets = categoryContent.querySelectorAll('.widget-item');
            const existingTypes = Array.from(existingWidgets).map(w => w.dataset.widgetType);
            
            widgets.forEach(widget => {
                // 이미 존재하는 Widget은 스킵
                if (existingTypes.includes(widget.type)) {
                    return;
                }
                
                // Premium 뱃지 HTML
                const premiumBadge = widget.premium ? 
                    `<span class="premium-badge">⭐ PRO</span>` : '';
                
                // Price HTML
                const priceHTML = widget.price ? 
                    `<span class="widget-price">${widget.price}</span>` : '';
                
                // Widget HTML 생성
                const widgetHTML = `
                    <div class="widget-item" draggable="true" data-widget-type="${widget.type}"${widget.premium ? ' data-premium="true"' : ''}>
                        <div class="widget-icon-wrapper">
                            <i data-lucide="${widget.icon || 'box'}" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">${widget.name} ${premiumBadge}</div>
                            <div class="widget-description">${widget.description || ''}</div>
                            ${priceHTML}
                        </div>
                    </div>
                `;
                
                // DOM에 추가
                categoryContent.insertAdjacentHTML('beforeend', widgetHTML);
            });
            
            // Lucide Icons 다시 초기화
            lucide.createIcons();
        }
        
        widgetsLoadedFromD1 = true;
        console.log('🎉 All widgets loaded from D1 Database!');
        
    } catch (error) {
        console.error('❌ Error loading widgets from D1:', error);
    }
}

// Panel Management
const activePanels = { left: null, right: null };
const viewport = document.getElementById('vp');
let scale = 1, translateX = 0, translateY = 0, isDragging = false, startX, startY;

// Pan/Zoom 객체 (Widget 드롭 좌표 계산용)
const pan = { x: 0, y: 0 };
let zoom = 1;

// Touch Support Variables
let lastTouchDistance = 0;
let isTouching = false;

function closePanel(panelId) {
    const panel = document.getElementById(panelId);
    if (!panel) return;
    panel.classList.remove('active');
    activePanels[panel.dataset.side] = null;
    const icon = document.querySelector(`[data-panel="${panelId.replace('Panel', '')}"]`);
    if (icon) icon.classList.remove('active');
}

document.querySelectorAll('.icon').forEach(icon => {
    icon.addEventListener('click', function() {
        const panelName = this.dataset.panel + 'Panel';
        const panel = document.getElementById(panelName);
        if (!panel) return;
        
        const side = panel.dataset.side;
        if (panel.classList.contains('active')) {
            closePanel(panelName);
            this.classList.remove('active');
            return;
        }
        
        if (activePanels[side]) closePanel(activePanels[side]);
        panel.classList.add('active');
        this.classList.add('active');
        activePanels[side] = panelName;
        
        // Widget Panel이 열릴 때 드래그 리스너 등록 + D1 Database에서 Widget 로드
        if (panelName === 'widgetPanel') {
            // D1 Database에서 Widget 동적 로드
            loadWidgetsFromD1();
            
            // 드래그 리스너 등록
            if (typeof attachWidgetDragListeners === 'function') {
                setTimeout(() => {
                    attachWidgetDragListeners();
                    console.log('🔧 Widget Panel 열림 → 드래그 리스너 재등록');
                }, 300); // D1 로딩 후 실행되도록 지연
            }
        }
    });
});

// Open initial panels on page load
window.addEventListener('load', function() {
    // Open left panel: Actions
    const leftIcon = document.querySelector('.icon[data-panel="actions"]');
    if (leftIcon) {
        leftIcon.click();
        console.log('✅ 왼쪽 사이드바 (Actions) 자동 열림');
    }
    
    // Open right panel: Stats
    const rightIcon = document.querySelector('.icon[data-panel="stats"]');
    if (rightIcon) {
        rightIcon.click();
        console.log('✅ 오른쪽 사이드바 (Stats) 자동 열림');
    }
});

// Canvas Interaction
viewport.addEventListener('mousedown', e => {
    // Don't drag canvas if clicking on a card
    if (e.target.closest('.card')) {
        return;
    }
    
    isDragging = true;
    viewport.classList.add('dragging');
    startX = e.pageX - translateX;
    startY = e.pageY - translateY;
});

document.addEventListener('mousemove', e => {
    if (!isDragging) return;
    e.preventDefault();
    translateX = e.pageX - startX;
    translateY = e.pageY - startY;
    
    // pan 객체 동기화 (Widget 드롭 좌표 계산용)
    pan.x = translateX;
    pan.y = translateY;
    
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
});

document.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        viewport.classList.remove('dragging');
    }
});

// ============================================
// TOUCH EVENTS for Mobile
// ============================================

// Touch Start
viewport.addEventListener('touchstart', e => {
    if (e.target.closest('.card')) {
        return;
    }
    
    if (e.touches.length === 1) {
        // Single touch - pan
        isTouching = true;
        isDragging = true;
        viewport.classList.add('dragging');
        startX = e.touches[0].pageX - translateX;
        startY = e.touches[0].pageY - translateY;
    } else if (e.touches.length === 2) {
        // Two finger pinch - zoom
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        lastTouchDistance = Math.hypot(
            touch2.pageX - touch1.pageX,
            touch2.pageY - touch1.pageY
        );
    }
}, { passive: false });

// Touch Move
viewport.addEventListener('touchmove', e => {
    if (e.touches.length === 1 && isDragging) {
        // Single touch - pan
        e.preventDefault();
        translateX = e.touches[0].pageX - startX;
        translateY = e.touches[0].pageY - startY;
        viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    } else if (e.touches.length === 2) {
        // Two finger pinch - zoom
        e.preventDefault();
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const currentDistance = Math.hypot(
            touch2.pageX - touch1.pageX,
            touch2.pageY - touch1.pageY
        );
        
        if (lastTouchDistance > 0) {
            const delta = currentDistance - lastTouchDistance;
            scale = Math.max(0.1, Math.min(3, scale * (1 + delta * 0.01)));
            viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
        }
        
        lastTouchDistance = currentDistance;
    }
}, { passive: false });

// Touch End
viewport.addEventListener('touchend', e => {
    if (e.touches.length === 0) {
        isDragging = false;
        isTouching = false;
        viewport.classList.remove('dragging');
        lastTouchDistance = 0;
    }
});

// Zoom
viewport.addEventListener('wheel', e => {
    // Allow zoom with mouse wheel (no Ctrl key required)
    e.preventDefault();
    scale = Math.max(0.1, Math.min(3, scale * (e.deltaY > 0 ? 0.9 : 1.1)));
    zoom = scale; // zoom 변수 동기화
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
});

document.getElementById('zoomIn').addEventListener('click', () => {
    scale = Math.min(3, scale * 1.2);
    zoom = scale; // zoom 변수 동기화
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
});

document.getElementById('zoomOut').addEventListener('click', () => {
    scale = Math.max(0.1, scale * 0.8);
    zoom = scale; // zoom 변수 동기화
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
});

document.getElementById('fitScreen').addEventListener('click', () => {
    scale = 1;
    translateX = 0;
    translateY = 0;
    viewport.style.transform = 'translate(0, 0) scale(1)';
    document.getElementById('zoomLevel').textContent = '100%';
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        // Close all panels
        Object.values(activePanels).forEach(p => p && closePanel(p));
        document.querySelectorAll('.icon.active').forEach(i => i.classList.remove('active'));
        
        // Deselect card
        if (selectedCard) {
            selectedCard.classList.remove('selected');
            selectedCard = null;
        }
    }
    
    // Delete selected card
    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedCard) {
        const cardTitle = selectedCard.querySelector('.card-header').textContent.trim();
        selectedCard.remove();
        selectedCard = null;
        console.log('🗑️ 카드 삭제:', cardTitle);
        e.preventDefault();
    }
    
    // Panel shortcuts (1-8)
    const num = parseInt(e.key);
    if (num >= 1 && num <= 8) {
        const icons = Array.from(document.querySelectorAll('.icon'));
        icons[num - 1]?.click();
    }
});

// Auto-center card layout calculation
function calculateCenteredLayout() {
    const canvasWidth = window.innerWidth;
    const canvasHeight = window.innerHeight;
    const cardWidth = 300;
    const cardHeight = 350;
    const cols = 3;
    const rows = 3;
    const hGap = 150;
    const vGap = 120;
    
    // Calculate total grid size
    const gridWidth = cols * cardWidth + (cols - 1) * hGap;
    const gridHeight = rows * cardHeight + (rows - 1) * vGap;
    
    // Calculate starting position to center the grid
    const startX = (canvasWidth - gridWidth) / 2;
    const startY = (canvasHeight - gridHeight) / 2 + 100; // +100 for navbar offset
    
    return { startX, startY, hGap, vGap, cardWidth };
}

// Sample Cards with Thumbnails (positions will be auto-calculated)
const cardTemplates = [
    { title: '홍보 영상', content: '전시 소개 영상 (3:45)', icon: 'video', type: 'video', size: '125 MB', format: 'MP4', preview: 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4' },
    { title: '오디오 가이드', content: '전시 해설 음성 (한/영)', icon: 'headphones', type: 'audio', size: '8.5 MB', format: 'MP3', preview: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
    { title: '전시 포스터', content: '메인 비주얼 디자인', icon: 'image', type: 'image', size: '4.2 MB', format: 'PNG', preview: 'https://picsum.photos/400/300?random=1' },
    { 
        title: '관람객 통계', 
        content: '월간 리포트', 
        icon: 'bar-chart-2', 
        type: 'data', 
        size: '1.8 MB', 
        format: 'XLSX',
        data: {
            period: '2024년 11월',
            totalVisitors: 3847,
            dailyAverage: 128,
            weekdayAvg: 95,
            weekendAvg: 215,
            peakTime: '14:00-16:00',
            ageGroups: {
                '10대': 12,
                '20대': 28,
                '30대': 35,
                '40대': 15,
                '50대+': 10
            },
            satisfaction: 4.6
        }
    },
    { 
        title: '큐레이터 노트', 
        content: '작품 해설 원고', 
        icon: 'file-text', 
        type: 'document', 
        size: '2.4 MB', 
        format: 'DOCX',
        data: {
            작품명: '시간의 흐름',
            작가: '김미래',
            제작년도: '2023',
            재료: '혼합재료, 디지털 미디어',
            크기: '150 x 200 cm',
            설명: '이 작품은 시간의 흐름과 변화를 시각적으로 표현한 작품입니다. 작가는 전통적인 회화 기법과 현대적인 디지털 미디어를 결합하여 과거와 현재, 미래가 공존하는 순간을 포착했습니다.',
            관람포인트: [
                '좌측 하단의 시계 모티프',
                '중앙의 빛의 흐름',
                '우측 상단의 추상적 형태'
            ]
        }
    },
    { 
        title: '3D 모델', 
        content: '유물 스캔 데이터', 
        icon: 'box', 
        type: 'data', 
        size: '89 MB', 
        format: 'GLB',
        data: {
            유물명: '청자 상감모란문 매병',
            시대: '고려시대 (12세기)',
            크기: '높이 42cm, 구경 8cm',
            스캔정보: {
                해상도: '0.1mm',
                폴리곤수: '2.5M',
                텍스처: '4K (4096x4096)',
                스캔방식: '구조광 3D 스캐닝'
            },
            특징: '상감기법으로 모란문양을 새긴 고려청자의 대표작',
            보존상태: '양호 (일부 복원)',
            소장처: '국립중앙박물관'
        }
    },
    { title: '현장 사진', content: '설치 진행 사진 (24장)', icon: 'camera', type: 'image', size: '45 MB', format: 'JPG', preview: 'https://picsum.photos/400/300?random=2' },
    { 
        title: '피드백', 
        content: '관람객 의견 수집', 
        icon: 'message-circle', 
        type: 'document', 
        size: '512 KB', 
        format: 'PDF',
        data: {
            총응답수: 156,
            평균평점: 4.6,
            긍정: 142,
            부정: 14,
            주요의견: [
                { 평점: 5, 의견: '작품 배치가 동선을 고려해서 잘 되어있어요', 날짜: '2024-12-05' },
                { 평점: 5, 의견: '오디오 가이드가 정말 유익했습니다', 날짜: '2024-12-05' },
                { 평점: 4, 의견: '조명이 조금 어두운 것 같아요', 날짜: '2024-12-04' },
                { 평점: 5, 의견: '전시 구성이 훌륭합니다!', 날짜: '2024-12-04' },
                { 평점: 3, 의견: '휴식 공간이 부족합니다', 날짜: '2024-12-03' }
            ]
        }
    },
    { 
        title: '일정표', 
        content: '전시 운영 스케줄', 
        icon: 'calendar', 
        type: 'document', 
        size: '1.2 MB', 
        format: 'PDF',
        data: {
            전시기간: '2024.11.01 - 2025.01.31',
            운영시간: '10:00 - 18:00 (입장마감 17:30)',
            휴관일: '매주 월요일, 1월 1일',
            특별이벤트: [
                { 날짜: '2024-12-14', 시간: '14:00', 이벤트: '큐레이터 토크', 장소: '전시장 내' },
                { 날짜: '2024-12-21', 시간: '15:00', 이벤트: '작가와의 대화', 장소: '세미나실' },
                { 날짜: '2024-12-28', 시간: '14:00', 이벤트: '어린이 체험 프로그램', 장소: '교육실' },
                { 날짜: '2025-01-11', 시간: '16:00', 이벤트: '전시 연계 워크숍', 장소: '교육실' }
            ],
            관람료: {
                성인: '10,000원',
                청소년: '7,000원',
                어린이: '5,000원',
                단체: '20% 할인'
            }
        }
    }
];

// Generate cards with auto-centered positions
function generateCenteredCards() {
    const layout = calculateCenteredLayout();
    const cards = cardTemplates.map((template, index) => {
        const row = Math.floor(index / 3);
        const col = index % 3;
        return {
            ...template,
            x: layout.startX + col * (layout.cardWidth + layout.hGap),
            y: layout.startY + row * (layout.cardWidth + layout.vGap)
        };
    });
    return cards;
}

const cards = generateCenteredCards();

// Global variables for card management
let selectedCard = null;
let maxZIndex = 1;

// Create card function with resize handles
function createCard(card) {
    const cardEl = document.createElement('div');
    cardEl.className = 'card';
    cardEl.style.left = card.x + 'px';
    cardEl.style.top = card.y + 'px';
    cardEl.style.zIndex = maxZIndex++;
    cardEl.dataset.type = card.type;
    cardEl.dataset.title = card.title;
    if (card.preview) cardEl.dataset.preview = card.preview;
    
    // Build thumbnail content based on type and preview availability
    let thumbnailContent = '';
    if (card.preview) {
        if (card.type === 'image') {
            thumbnailContent = `<img loading="lazy" src="${card.preview}" alt="${card.title}" style="width:100%;height:100%;object-fit:cover;">`;
        } else if (card.type === 'video') {
            thumbnailContent = `<video src="${card.preview}" style="width:100%;height:100%;object-fit:cover;" muted loop autoplay></video>`;
        } else if (card.type === 'audio') {
            thumbnailContent = `
                <i data-lucide="${card.icon}" style="width:60px;height:60px;color:rgba(255,255,255,0.9);stroke-width:1.5;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);"></i>
                <audio src="${card.preview}" controls style="position:absolute;bottom:10px;left:10px;right:10px;width:calc(100% - 20px);"></audio>
            `;
        } else {
            thumbnailContent = `<i data-lucide="${card.icon}" style="width:60px;height:60px;color:rgba(255,255,255,0.9);stroke-width:1.5"></i>`;
        }
    } else {
        thumbnailContent = `<i data-lucide="${card.icon}" style="width:60px;height:60px;color:rgba(255,255,255,0.9);stroke-width:1.5"></i>`;
    }
    
    cardEl.innerHTML = `
        <div class="card-thumbnail ${card.type}">
            ${thumbnailContent}
        </div>
        <div class="card-header ${card.type}">
            <div class="card-title">
                <i data-lucide="${card.icon}" style="width:14px;height:14px"></i>
                <span>${card.title}</span>
            </div>
            <div class="card-actions">
                <button class="card-action-btn" title="복사" onclick="event.stopPropagation(); copyCard(this)">
                    <i data-lucide="copy" style="width:14px;height:14px"></i>
                </button>
                <button class="card-action-btn" title="노션으로 내보내기" onclick="event.stopPropagation(); exportToNotion(this)">
                    <i data-lucide="book-open" style="width:14px;height:14px"></i>
                </button>
                <button class="card-action-btn" title="피그마로 내보내기" onclick="event.stopPropagation(); exportToFigma(this)">
                    <i data-lucide="figma" style="width:14px;height:14px"></i>
                </button>
            </div>
        </div>
        <div class="card-footer">
            <span class="card-meta-item"><i data-lucide="hard-drive" style="width:12px;height:12px"></i> ${card.size}</span>
            <span class="card-meta-item"><i data-lucide="file-text" style="width:12px;height:12px"></i> ${card.format}</span>
        </div>
        
        <!-- Resize Handles -->
        <div class="resize-handle resize-nw"></div>
        <div class="resize-handle resize-n"></div>
        <div class="resize-handle resize-ne"></div>
        <div class="resize-handle resize-e"></div>
        <div class="resize-handle resize-se"></div>
        <div class="resize-handle resize-s"></div>
        <div class="resize-handle resize-sw"></div>
        <div class="resize-handle resize-w"></div>
        
        <!-- Connection Handle (Google Opal Style) -->
        <div class="connection-handle" title="연결선 만들기"></div>
    `;
    
    // Thumbnail click for modal viewer
    const thumbnail = cardEl.querySelector('.card-thumbnail');
    if (thumbnail) {
        thumbnail.addEventListener('click', function(e) {
            e.stopPropagation();
            const type = cardEl.dataset.type;
            const preview = cardEl.dataset.preview;
            const title = cardEl.dataset.title;
            
            if (preview && (type === 'image' || type === 'video')) {
                openModal(type, preview, title);
            }
        });
    }
    
    // Card selection
    // Store card data
    if (card.data) {
        cardEl.dataset.cardData = JSON.stringify(card.data);
    }
    
    // Card single click - select
    cardEl.addEventListener('click', function(e) {
        if (!e.target.classList.contains('resize-handle') && !e.target.closest('.card-thumbnail') && !e.target.closest('.card-action-btn')) {
            selectCard(cardEl);
            e.stopPropagation();
        }
    });
    
    // Card double click - show data
    cardEl.addEventListener('dblclick', function(e) {
        if (!e.target.classList.contains('resize-handle') && !e.target.closest('.card-thumbnail')) {
            showCardDataModal(cardEl);
            e.stopPropagation();
        }
    });
    
    // Card drag functionality
    let cardDragging = false;
    let cardStartX, cardStartY, cardInitialX, cardInitialY;
    
    const onCardMouseDown = function(e) {
        // Don't drag if clicking on resize handles
        if (e.target.classList.contains('resize-handle')) {
            return;
        }
        
        // Don't drag if clicking on connection handle
        if (e.target.classList.contains('connection-handle')) {
            return;
        }
        
        // Don't drag if clicking on video/audio controls
        if (e.target.tagName === 'VIDEO' || e.target.tagName === 'AUDIO') {
            return;
        }
        
        // Allow drag from anywhere on the card
        cardDragging = true;
        cardStartX = e.clientX;
        cardStartY = e.clientY;
        cardInitialX = parseInt(cardEl.style.left) || 0;
        cardInitialY = parseInt(cardEl.style.top) || 0;
        cardEl.style.cursor = 'grabbing';
        
        // CRITICAL: Prevent canvas from dragging
        e.stopPropagation();
        
        const headerElement = cardEl.querySelector('.card-header');
        console.log('🎯 카드 드래그 시작:', headerElement ? headerElement.textContent.trim() : 'Unknown');
    };
    
    const onCardMouseMove = function(e) {
        if (cardDragging) {
            e.preventDefault();
            e.stopPropagation();
            
            const deltaX = (e.clientX - cardStartX) / scale;
            const deltaY = (e.clientY - cardStartY) / scale;
            cardEl.style.left = (cardInitialX + deltaX) + 'px';
            cardEl.style.top = (cardInitialY + deltaY) + 'px';
        }
    };
    
    const onCardMouseUp = function() {
        if (cardDragging) {
            cardDragging = false;
            cardEl.style.cursor = 'move';
            console.log('✅ 카드 드래그 완료');
        }
    };
    
    cardEl.addEventListener('mousedown', onCardMouseDown);
    document.addEventListener('mousemove', onCardMouseMove);
    document.addEventListener('mouseup', onCardMouseUp);
    
    // Touch Events for Card Dragging
    const onCardTouchStart = function(e) {
        if (e.target.classList.contains('resize-handle') || 
            e.target.classList.contains('connection-handle') ||
            e.target.tagName === 'VIDEO' || 
            e.target.tagName === 'AUDIO') {
            return;
        }
        
        cardDragging = true;
        const touch = e.touches[0];
        cardStartX = touch.clientX;
        cardStartY = touch.clientY;
        cardInitialX = parseInt(cardEl.style.left) || 0;
        cardInitialY = parseInt(cardEl.style.top) || 0;
        
        e.stopPropagation();
        console.log('🎯 카드 터치 드래그 시작');
    };
    
    const onCardTouchMove = function(e) {
        if (cardDragging) {
            e.preventDefault();
            e.stopPropagation();
            
            const touch = e.touches[0];
            const deltaX = (touch.clientX - cardStartX) / scale;
            const deltaY = (touch.clientY - cardStartY) / scale;
            cardEl.style.left = (cardInitialX + deltaX) + 'px';
            cardEl.style.top = (cardInitialY + deltaY) + 'px';
        }
    };
    
    const onCardTouchEnd = function() {
        if (cardDragging) {
            cardDragging = false;
            updateAllConnections();
            console.log('✅ 카드 터치 드래그 완료');
        }
    };
    
    cardEl.addEventListener('touchstart', onCardTouchStart, { passive: false });
    cardEl.addEventListener('touchmove', onCardTouchMove, { passive: false });
    cardEl.addEventListener('touchend', onCardTouchEnd);
    
    // Context Menu (Right-click)
    cardEl.addEventListener('contextmenu', (e) => showContextMenu(e, cardEl));
    
    // Resize functionality
    setupResizeHandles(cardEl);
    
    // Connection handle functionality
    setupConnectionHandles(cardEl);
    
    // Update connections when this card moves
    cardEl.addEventListener('mouseup', updateAllConnections);
    cardEl.addEventListener('touchend', updateAllConnections);
    
    viewport.appendChild(cardEl);
    return cardEl;
}

// Card selection management
function selectCard(cardEl) {
    // Deselect previous card
    if (selectedCard) {
        selectedCard.classList.remove('selected');
    }
    
    // Select new card and bring to front
    selectedCard = cardEl;
    cardEl.classList.add('selected');
    cardEl.style.zIndex = maxZIndex++;
    
    console.log('✅ 카드 선택:', cardEl.querySelector('.card-header').textContent.trim());
}

// Deselect when clicking canvas
viewport.addEventListener('click', function(e) {
    if (e.target === viewport && selectedCard) {
        selectedCard.classList.remove('selected');
        selectedCard = null;
    }
});

// Resize handles setup
function setupResizeHandles(cardEl) {
    const handles = cardEl.querySelectorAll('.resize-handle');
    
    handles.forEach(handle => {
        handle.addEventListener('mousedown', function(e) {
            e.stopPropagation();
            const direction = Array.from(handle.classList).find(c => c.startsWith('resize-')).replace('resize-', '');
            
            const startX = e.clientX;
            const startY = e.clientY;
            const startWidth = cardEl.offsetWidth;
            const startHeight = cardEl.offsetHeight;
            const startLeft = parseInt(cardEl.style.left) || 0;
            const startTop = parseInt(cardEl.style.top) || 0;
            
            function onMouseMove(e) {
                const deltaX = (e.clientX - startX) / scale;
                const deltaY = (e.clientY - startY) / scale;
                
                if (direction.includes('e')) {
                    cardEl.style.width = Math.max(200, startWidth + deltaX) + 'px';
                }
                if (direction.includes('w')) {
                    const newWidth = Math.max(200, startWidth - deltaX);
                    cardEl.style.width = newWidth + 'px';
                    cardEl.style.left = (startLeft + (startWidth - newWidth)) + 'px';
                }
                if (direction.includes('s')) {
                    cardEl.style.height = Math.max(200, startHeight + deltaY) + 'px';
                }
                if (direction.includes('n')) {
                    const newHeight = Math.max(200, startHeight - deltaY);
                    cardEl.style.height = newHeight + 'px';
                    cardEl.style.top = (startTop + (startHeight - newHeight)) + 'px';
                }
            }
            
            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                console.log('✅ 카드 크기 조절 완료:', cardEl.offsetWidth + 'x' + cardEl.offsetHeight);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });
}

// Google Opal Style Connection System
const connections = [];
let connectingFrom = null;

function createConnection(fromCard, toCard) {
    const conn = {
        from: fromCard,
        to: toCard,
        line: null
    };
    connections.push(conn);
    updateConnectionLine(conn);
    return conn;
}

function updateConnectionLine(conn) {
    // Get card positions directly from their style properties
    const fromX = parseInt(conn.from.style.left) || 0;
    const fromY = parseInt(conn.from.style.top) || 0;
    const fromWidth = conn.from.offsetWidth;
    const fromHeight = conn.from.offsetHeight;
    
    const toX = parseInt(conn.to.style.left) || 0;
    const toY = parseInt(conn.to.style.top) || 0;
    const toWidth = conn.to.offsetWidth;
    const toHeight = conn.to.offsetHeight;
    
    // Calculate connection points (right side of from card, left side of to card)
    const startX = fromX + fromWidth;
    const startY = fromY + fromHeight / 2;
    const endX = toX;
    const endY = toY + toHeight / 2;
    
    const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
    
    if (!conn.line) {
        conn.line = document.createElement('div');
        conn.line.className = 'card-connector';
        viewport.appendChild(conn.line);
    }
    
    conn.line.style.left = startX + 'px';
    conn.line.style.top = startY + 'px';
    conn.line.style.width = distance + 'px';
    conn.line.style.transform = `rotate(${angle}deg)`;
}

function updateAllConnections() {
    connections.forEach(conn => updateConnectionLine(conn));
}

// Setup connection handles for each card
function setupConnectionHandles(cardEl) {
    const handle = cardEl.querySelector('.connection-handle');
    
    handle.addEventListener('mousedown', function(e) {
        e.stopPropagation();
        e.preventDefault();
        
        connectingFrom = cardEl;
        handle.style.background = '#f59e0b';
        handle.style.boxShadow = '0 0 20px rgba(245, 158, 11, 0.8)';
        
        console.log('🔗 연결 시작:', cardEl.querySelector('.card-header').textContent.trim());
    });
}

// Listen for connection target
document.addEventListener('click', function(e) {
    if (connectingFrom) {
        const targetCard = e.target.closest('.card');
        
        if (targetCard && targetCard !== connectingFrom) {
            createConnection(connectingFrom, targetCard);
            console.log('✅ 카드 연결:', 
                connectingFrom.querySelector('.card-header').textContent.trim(), 
                '→', 
                targetCard.querySelector('.card-header').textContent.trim()
            );
        }
        
        // Reset connection state
        const handle = connectingFrom.querySelector('.connection-handle');
        handle.style.background = '';
        handle.style.boxShadow = '';
        connectingFrom = null;
    }
});

// Update connections on viewport transformation
const viewportObserver = new MutationObserver(updateAllConnections);
viewportObserver.observe(viewport, { attributes: true, attributeFilter: ['style'] });

// Create all initial cards
cards.forEach(card => createCard(card));

// Global function to add AI-generated content cards
window.addAICard = function(type, title, content, imageUrl = null) {
    const newCard = {
        title: title,
        content: content,
        icon: type === 'image' ? 'image' : type === 'video' ? 'video' : type === 'audio' ? 'headphones' : 'file',
        type: type,
        size: 'AI Generated',
        format: type.toUpperCase(),
        x: Math.random() * 500 + 100,
        y: Math.random() * 400 + 100
    };
    
    const cardEl = createCard(newCard);
    
    // If image/video URL provided, replace thumbnail
    if (imageUrl && (type === 'image' || type === 'video')) {
        const thumbnail = cardEl.querySelector('.card-thumbnail');
        thumbnail.innerHTML = type === 'image' 
            ? `<img loading="lazy" src="${imageUrl}" alt="${title}">`
            : `<video src="${imageUrl}" controls></video>`;
    }
    
    lucide.createIcons();
    selectCard(cardEl);
    
    console.log('✅ AI 생성 카드 추가:', title, '(' + type + ')');
    return cardEl;
};

// ============================================
// Context Menu Functions
// ============================================
function showContextMenu(e, nodeElement) {
    e.preventDefault();
    e.stopPropagation();
    
    const contextMenu = document.getElementById('contextMenu');
    contextMenuTarget = nodeElement;
    
    // Position context menu
    contextMenu.style.left = e.pageX + 'px';
    contextMenu.style.top = e.pageY + 'px';
    contextMenu.style.display = 'block';
    
    // Re-initialize Lucide icons
    lucide.createIcons();
    
    console.log('📋 Context Menu 열림:', nodeElement.querySelector('.card-header')?.textContent || 'Node');
}

function hideContextMenu() {
    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.display = 'none';
    contextMenuTarget = null;
}

function editNodeFromContextMenu() {
    if (!contextMenuTarget) return;
    
    const nodeHeader = contextMenuTarget.querySelector('.card-header')?.textContent || '';
    const nodeDesc = contextMenuTarget.querySelector('.card-description')?.textContent || '';
    const currentColor = contextMenuTarget.style.borderColor || '#FFFFFF';
    
    // Open edit modal
    document.getElementById('editWidgetName').value = nodeHeader;
    document.getElementById('editWidgetDescription').value = nodeDesc;
    selectedColor = currentColor;
    
    // Highlight selected color
    document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.color === currentColor);
    });
    
    document.getElementById('editModal').style.display = 'flex';
    currentEditingNode = contextMenuTarget;
    
    hideContextMenu();
    console.log('✏️ Edit 모달 열림:', nodeHeader);
}

function duplicateNodeFromContextMenu() {
    if (!contextMenuTarget) return;
    
    const original = contextMenuTarget;
    const clone = original.cloneNode(true);
    
    // Offset position
    const originalX = parseInt(original.style.left) || 0;
    const originalY = parseInt(original.style.top) || 0;
    clone.style.left = (originalX + 30) + 'px';
    clone.style.top = (originalY + 30) + 'px';
    
    // Add to viewport
    viewport.appendChild(clone);
    
    // Re-attach event listeners
    makeCardDraggable(clone);
    addResizeHandles(clone);
    addConnectionHandle(clone);
    
    // Add context menu listener
    clone.addEventListener('contextmenu', (e) => showContextMenu(e, clone));
    
    selectCard(clone);
    lucide.createIcons();
    
    hideContextMenu();
    
    const nodeName = original.querySelector('.card-header')?.textContent || 'Node';
    console.log('📋 노드 복제 완료:', nodeName);
    
    // Sync to Dashboard
    syncCanvasToDashboard();
}

function deleteNodeFromContextMenu() {
    if (!contextMenuTarget) return;
    
    const nodeName = contextMenuTarget.querySelector('.card-header')?.textContent || 'Node';
    
    if (confirm(`"${nodeName}" 노드를 삭제하시겠습니까?`)) {
        // Remove all connections
        const connections = document.querySelectorAll('.connection-line');
        connections.forEach(conn => {
            if (conn.dataset.from === contextMenuTarget.id || conn.dataset.to === contextMenuTarget.id) {
                conn.remove();
            }
        });
        
        // Remove node
        contextMenuTarget.remove();
        
        console.log('🗑️ 노드 삭제 완료:', nodeName);
        
        // Sync to Dashboard
        syncCanvasToDashboard();
    }
    
    hideContextMenu();
}

// Close context menu on outside click
document.addEventListener('click', hideContextMenu);

// Modal Viewer Functions
function openModal(type, url, title) {
    const modal = document.getElementById('modalViewer');
    const content = document.getElementById('modalContent');
    
    if (type === 'image') {
        content.innerHTML = `<img loading="lazy" src="${url}" alt="${title}">`;
    } else if (type === 'video') {
        content.innerHTML = `<video src="${url}" controls autoplay style="outline: none;"></video>`;
    }
    
    modal.classList.add('active');
    console.log('🖼️ 모달 열림:', title);
}

function closeModal() {
    const modal = document.getElementById('modalViewer');
    const content = document.getElementById('modalContent');
    
    // Stop video if playing
    const video = content.querySelector('video');
    if (video) {
        video.pause();
        video.currentTime = 0;
    }
    
    modal.classList.remove('active');
    content.innerHTML = '';
    console.log('❌ 모달 닫힘');
}

// ============================================
// Edit Modal Functions
// ============================================
function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditingNode = null;
    selectedColor = '#FFFFFF';
    console.log('❌ Edit 모달 닫힘');
}

function saveWidgetEdit() {
    if (!currentEditingNode) return;
    
    const newName = document.getElementById('editWidgetName').value.trim();
    const newDesc = document.getElementById('editWidgetDescription').value.trim();
    
    if (!newName) {
        alert('위젯 이름을 입력해주세요.');
        return;
    }
    
    // Update node
    const header = currentEditingNode.querySelector('.card-header');
    const desc = currentEditingNode.querySelector('.card-description');
    
    if (header) header.textContent = newName;
    if (desc) desc.textContent = newDesc;
    
    // Update color
    currentEditingNode.style.borderColor = selectedColor;
    currentEditingNode.style.boxShadow = `0 4px 20px ${selectedColor}33`;
    
    // Save to localStorage
    const widgetId = currentEditingNode.id || `widget-${Date.now()}`;
    if (!currentEditingNode.id) currentEditingNode.id = widgetId;
    
    saveWidgetConfig(widgetId, {
        name: newName,
        description: newDesc,
        color: selectedColor,
        x: parseInt(currentEditingNode.style.left) || 0,
        y: parseInt(currentEditingNode.style.top) || 0,
        width: currentEditingNode.offsetWidth,
        height: currentEditingNode.offsetHeight
    });
    
    closeEditModal();
    
    // Sync to Dashboard
    syncCanvasToDashboard();
    
    console.log('💾 위젯 편집 저장 완료:', newName);
}

// Color picker event listeners
document.addEventListener('DOMContentLoaded', () => {
    const colorOptions = document.querySelectorAll('.color-option');
    
    colorOptions.forEach(option => {
        option.addEventListener('click', () => {
            selectedColor = option.dataset.color;
            
            colorOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            console.log('🎨 색상 선택:', selectedColor);
        });
    });
});

// Close edit modal on outside click
document.addEventListener('click', (e) => {
    const editModal = document.getElementById('editModal');
    if (e.target === editModal) {
        closeEditModal();
    }
});

// Close modal on overlay click
document.getElementById('modalViewer').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Close modal on Escape key  
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('modalViewer');
        if (modal.classList.contains('active')) {
            closeModal();
        }
    }
});

// Auto-create workflow connections based on typical museum workflow
function createAutoWorkflowConnections() {
    const allCards = document.querySelectorAll('.card');
    const cardsByTitle = {};
    
    allCards.forEach(card => {
        const title = card.dataset.title;
        if (title) cardsByTitle[title] = card;
    });
    
    // Define workflow connections (from → to)
    const workflowConnections = [
        ['홍보 영상', '전시 포스터'],      // Video → Poster design
        ['전시 포스터', '현장 사진'],      // Poster → Site photos
        ['오디오 가이드', '큐레이터 노트'], // Audio guide → Curator notes
        ['관람객 통계', '피드백'],         // Stats → Feedback
        ['3D 모델', '관람객 통계'],        // 3D model → Stats
        ['현장 사진', '일정표']            // Photos → Schedule
    ];
    
    // Create connections
    workflowConnections.forEach(([fromTitle, toTitle]) => {
        const fromCard = cardsByTitle[fromTitle];
        const toCard = cardsByTitle[toTitle];
        
        if (fromCard && toCard) {
            createConnection(fromCard, toCard);
            console.log('🔗 자동 연결:', fromTitle, '→', toTitle);
        }
    });
    
    console.log('✅ 워크플로우 자동 연결 완료:', workflowConnections.length, '개 연결');
}

// Initialize auto workflow after cards are created
setTimeout(() => {
    createAutoWorkflowConnections();
}, 500);

// ============================================
// Canvas-Dashboard 데이터 연동
// ============================================

/**
 * Dashboard로 Canvas 업데이트 전송
 * @param {string} updateType - 'canvas_nodes' 또는 'dashboard_widgets'
 * @param {object} updateData - { title, items[] }
 */
function sendToDashboard(updateType, updateData) {
    try {
        const updates = JSON.parse(localStorage.getItem('dashboard_updates') || '[]');
        
        updates.push({
            type: updateType,
            title: updateData.title || 'Canvas 업데이트',
            data: updateData.items || [],
            timestamp: Date.now()
        });
        
        localStorage.setItem('dashboard_updates', JSON.stringify(updates));
        console.log(`✅ [Canvas → Dashboard] Sent ${updateType}:`, updateData.title, `(${updateData.items?.length || 0} items)`);
    } catch (error) {
        console.error('❌ [Canvas → Dashboard] Error:', error);
    }
}

/**
 * Canvas 상태를 Dashboard로 전송
 */
function syncCanvasStateToDashboard() {
    const cards = Array.from(viewport.querySelectorAll('.card'));
    
    if (cards.length === 0) return;
    
    const cardData = cards.map(card => {
        const header = card.querySelector('.card-header');
        const content = card.querySelector('.card-content p');
        
        return {
            title: header ? header.textContent.trim() : 'Untitled',
            content: content ? content.textContent.trim() : '',
            x: card.style.left,
            y: card.style.top,
            status: 'active',
            timestamp: Date.now()
        };
    });
    
    sendToDashboard('canvas_nodes', {
        title: `Canvas 상태 (${cards.length}개 노드)`,
        items: cardData
    });
}

// 카드 삭제 시 Dashboard 알림
document.addEventListener('keydown', e => {
    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedCard) {
        const cardTitle = selectedCard.querySelector('.card-header').textContent.trim();
        
        // Dashboard로 삭제 알림 전송
        sendToDashboard('canvas_nodes', {
            title: '카드 삭제',
            items: [{ 
                title: cardTitle, 
                status: 'deleted',
                timestamp: Date.now()
            }]
        });
    }
});

// 초기 Canvas 상태 전송 (페이지 로드 후 2초 후)
setTimeout(() => {
    syncCanvasStateToDashboard();
    console.log('🚀 [Canvas → Dashboard] Initial sync completed');
}, 2000);

// 자동 동기화 (10초마다)
setInterval(() => {
    syncCanvasStateToDashboard();
}, 10000);

// localStorage 저장 함수 (Canvas 상태 복원용)
function saveCanvasState() {
    const cards = Array.from(viewport.querySelectorAll('.card'));
    
    const state = {
        cards: cards.map(card => ({
            id: card.dataset.id || Math.random().toString(36).substr(2, 9),
            title: card.querySelector('.card-header')?.textContent.trim() || '',
            content: card.querySelector('.card-content p')?.textContent.trim() || '',
            x: card.style.left,
            y: card.style.top,
            width: card.style.width,
            height: card.style.height
        })),
        connections: connections.map(conn => ({
            from: conn.from.querySelector('.card-header')?.textContent.trim() || '',
            to: conn.to.querySelector('.card-header')?.textContent.trim() || ''
        })),
        viewport: {
            translateX,
            translateY,
            scale
        },
        timestamp: Date.now()
    };
    
    localStorage.setItem('canvas_state', JSON.stringify(state));
    console.log('💾 Canvas 상태 저장됨:', cards.length, '개 카드');
}

// 자동 저장 (10초마다)
setInterval(saveCanvasState, 10000);

// 페이지 종료 시 저장
window.addEventListener('beforeunload', () => {
    saveCanvasState();
    syncCanvasStateToDashboard();
});

console.log('✅ Canvas-Dashboard 연동 초기화 완료');

// ============================================
// AI 어시스턴트 기능
// ============================================

/**
 * AI 응답 표시 함수
 */
function showAIResponse(message, isError = false) {
    const aiPanel = document.getElementById('aiPanel');
    const panelContent = aiPanel.querySelector('.panel-content > div');
    
    // AI 패널 자동 열기
    if (!aiPanel.classList.contains('active')) {
        document.querySelector('[data-panel="ai"]').click();
    }
    
    // 응답 메시지 추가
    const responseHtml = `
        <div style="padding: 0.75rem; background: ${isError ? 'rgba(239, 68, 68, 0.1)' : 'rgba(139, 92, 246, 0.1)'}; border-radius: 8px; border-left: 3px solid ${isError ? '#EF4444' : '#8B5CF6'}; margin-bottom: 0.75rem;">
            <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">${new Date().toLocaleTimeString('ko-KR')}</div>
            <div style="font-size: 0.9375rem; color: #e5e5e5; line-height: 1.5;">${message}</div>
        </div>
    `;
    
    panelContent.insertAdjacentHTML('afterbegin', responseHtml);
    
    // 최대 10개 응답만 유지
    const responses = panelContent.querySelectorAll('div[style*="padding: 0.75rem"]');
    if (responses.length > 10) {
        responses[responses.length - 1].remove();
    }
}

/**
 * AI API 호출 함수
 */
async function callAI(message, model = 'GPT-4o') {
    try {
        showAIResponse(`🤖 AI 분석 중... (${model})`, false);
        
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                model: model,
                context: {
                    page: 'canvas',
                    cardCount: viewport.querySelectorAll('.card').length,
                    connections: connections.length
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`AI API 에러: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.response) {
            showAIResponse(data.response, false);
            console.log('✅ [Canvas AI] Response:', data.response);
            
            // Dashboard로 AI 활동 전송
            sendToDashboard('dashboard_widgets', {
                title: 'AI 어시스턴트 활동',
                items: [{
                    title: `AI 질문: ${message.substring(0, 30)}...`,
                    content: data.response.substring(0, 100),
                    status: 'completed',
                    timestamp: Date.now()
                }]
            });
        } else {
            throw new Error(data.error || 'AI 응답 실패');
        }
    } catch (error) {
        console.error('❌ [Canvas AI] Error:', error);
        showAIResponse(`❌ AI 오류: ${error.message}`, true);
    }
}

/**
 * AI 입력 전송 처리
 */
function sendAIMessage() {
    const input = document.getElementById('aiInput');
    const select = document.querySelector('.ai-select');
    const message = input.value.trim();
    
    if (!message) {
        showAIResponse('❌ 메시지를 입력해주세요.', true);
        return;
    }
    
    const model = select.value;
    console.log(`📤 [Canvas AI] Sending: "${message}" (${model})`);
    
    // AI 호출
    callAI(message, model);
    
    // 입력창 초기화
    input.value = '';
}

// AI 전송 버튼 이벤트
document.querySelector('.ai-send')?.addEventListener('click', sendAIMessage);

// AI 입력창 Enter 키 이벤트
document.getElementById('aiInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendAIMessage();
    }
});

console.log('✅ Canvas AI 어시스턴트 초기화 완료');

// ============================================
// Widget 드래그앤드롭 초기화 (MutationObserver + DOM Ready)
// ============================================

// DOM Ready 후 초기 리스너 등록
document.addEventListener('DOMContentLoaded', () => {
    attachWidgetDragListeners();
    console.log('🔧 DOMContentLoaded: Widget 드래그 리스너 초기화');
});

// MutationObserver로 동적 Widget 감지
const widgetPanel = document.getElementById('widgetPanel');
if (widgetPanel) {
    const observer = new MutationObserver(() => {
        attachWidgetDragListeners();
    });
    
    observer.observe(widgetPanel, {
        childList: true,
        subtree: true
    });
    
    console.log('✅ Widget 동적 감지 시스템 활성화');
} else {
    console.error('❌ widgetPanel 요소를 찾을 수 없습니다!');
}

// Canvas 전체 영역에 드롭 가능하도록 설정
// Canvas 영역 = .canvas 클래스 (viewport의 부모 컨테이너)
const canvasContainer = document.querySelector('.canvas');

if (canvasContainer && viewport) {
    // Canvas 전체 영역에 dragover 이벤트
    canvasContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        // console.log('🎯 dragover 이벤트 발생'); // 디버깅용 (너무 많이 출력되므로 주석)
    });

    // Canvas 전체 영역에 drop 이벤트
    canvasContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        console.log('💧 DROP 이벤트 발생!', 'draggedWidgetData:', draggedWidgetData);
        console.log('📍 Drop 위치:', `clientX=${e.clientX}, clientY=${e.clientY}`);
        
        if (!draggedWidgetData) {
            console.error('❌ CRITICAL: draggedWidgetData is null!');
            console.error('   → dragstart 이벤트가 발생하지 않았거나, Widget에 드래그 리스너가 등록되지 않았습니다.');
            console.error('   → Widget Panel이 열려있고, Category가 펼쳐져 있는지 확인하세요.');
            return;
        }
        
        console.log('✅ draggedWidgetData 확인됨:', draggedWidgetData);
        
        // Canvas 좌표 계산 (Canvas 컨테이너 기준)
        const canvasRect = canvasContainer.getBoundingClientRect();
        const x = e.clientX - canvasRect.left - pan.x;
        const y = e.clientY - canvasRect.top - pan.y;
        
        // Widget 카드 데이터 생성 (createCard 함수 사용)
        const widgetCard = {
            title: draggedWidgetData.name,
            content: draggedWidgetData.description || '위젯 설명이 없습니다.',
            type: 'widget',
            icon: 'box',
            size: 'Widget',
            format: draggedWidgetData.isPremium ? 'Premium' : 'Free',
            x: x / zoom,
            y: y / zoom
        };
        
        // createCard 함수로 카드 생성 (기존 함수 재사용)
        const card = createCard(widgetCard);
        
        // Widget 타입 데이터 추가
        card.dataset.widgetType = draggedWidgetData.type;
        card.dataset.isPremium = draggedWidgetData.isPremium;
    
        // Premium 뱃지 추가
        if (draggedWidgetData.isPremium) {
            const header = card.querySelector('.card-header');
            if (header) {
                const premiumBadge = document.createElement('span');
                premiumBadge.className = 'badge-premium';
                premiumBadge.textContent = '⭐ PRO';
                premiumBadge.style.cssText = `
                    display: inline-block;
                    margin-left: 8px;
                    padding: 2px 6px;
                    font-size: 9px;
                    font-weight: 600;
                    background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
                    border-radius: 4px;
                    color: white;
                `;
                header.appendChild(premiumBadge);
            }
        }
        
        viewport.appendChild(card);
        console.log('✅ Card가 viewport에 추가됨');
        
        // Lucide 아이콘 렌더링
        lucide.createIcons();
        console.log('✅ Lucide 아이콘 렌더링 완료');
        
        // Dashboard 동기화
        setTimeout(() => {
            syncCanvasStateToDashboard();
            console.log('✅ Dashboard 동기화 완료');
        }, 100);
        
        console.log('🎉 Widget 노드 생성 완료:', draggedWidgetData.name, `at (${Math.round(x / zoom)}, ${Math.round(y / zoom)})`);
        
        // 드래그 데이터 초기화
        draggedWidgetData = null;
    });
    
    console.log('✅ Canvas 전체 영역 드롭 이벤트 등록 완료 (.canvas)');
} else {
    console.error('❌ Canvas 컨테이너 또는 viewport 요소를 찾을 수 없습니다!');
}

console.log('✅ Widget 드래그앤드롭 초기화 완료');

// ============================================
// Command Palette (Cmd+K) 기능
// ============================================

const commandPaletteOverlay = document.getElementById('commandPaletteOverlay');
const commandSearchInput = document.getElementById('commandSearchInput');
const commandPaletteBody = document.getElementById('commandPaletteBody');
let selectedCommandIndex = 0;
let filteredCommands = [];

// 모든 Widget 데이터 수집
function getAllWidgets() {
    const widgets = [];
    document.querySelectorAll('.widget-item').forEach(widget => {
        const widgetType = widget.dataset.widgetType;
        const widgetName = widget.querySelector('.widget-name')?.textContent || '';
        const widgetDesc = widget.querySelector('.widget-description')?.textContent || '';
        const isPremium = widget.querySelector('.badge-premium') !== null;
        const categoryGroup = widget.closest('.category-group');
        const category = categoryGroup?.querySelector('.category-name')?.textContent || 'General';
        const iconElement = widget.querySelector('.widget-icon-wrapper i');
        const iconName = iconElement?.getAttribute('data-lucide') || 'box';
        
        widgets.push({
            type: widgetType,
            name: widgetName,
            description: widgetDesc,
            isPremium: isPremium,
            category: category,
            icon: iconName
        });
    });
    return widgets;
}

// Command Palette 열기
function openCommandPalette() {
    commandPaletteOverlay.classList.add('active');
    commandSearchInput.value = '';
    commandSearchInput.focus();
    selectedCommandIndex = 0;
    renderCommandList('');
}

// Command Palette 닫기
function closeCommandPalette() {
    commandPaletteOverlay.classList.remove('active');
}

// Command 리스트 렌더링
function renderCommandList(query) {
    const allWidgets = getAllWidgets();
    
    // 검색 필터링
    if (query.trim()) {
        filteredCommands = allWidgets.filter(widget => 
            widget.name.toLowerCase().includes(query.toLowerCase()) ||
            widget.description.toLowerCase().includes(query.toLowerCase()) ||
            widget.category.toLowerCase().includes(query.toLowerCase())
        );
    } else {
        filteredCommands = allWidgets;
    }
    
    // 카테고리별로 그룹화
    const categories = {};
    filteredCommands.forEach(widget => {
        if (!categories[widget.category]) {
            categories[widget.category] = [];
        }
        categories[widget.category].push(widget);
    });
    
    // HTML 생성
    if (filteredCommands.length === 0) {
        commandPaletteBody.innerHTML = `
            <div class="command-palette-empty">
                <i data-lucide="search-x" class="command-palette-empty-icon"></i>
                <div class="command-palette-empty-text">검색 결과가 없습니다</div>
            </div>
        `;
    } else {
        let html = '';
        Object.keys(categories).forEach((category, catIndex) => {
            html += `<div class="command-category">${category}</div>`;
            categories[category].forEach((widget, widgetIndex) => {
                const globalIndex = filteredCommands.indexOf(widget);
                const selectedClass = globalIndex === selectedCommandIndex ? 'selected' : '';
                html += `
                    <div class="command-item ${selectedClass}" data-index="${globalIndex}">
                        <i data-lucide="${widget.icon}" class="command-item-icon"></i>
                        <div class="command-item-info">
                            <div class="command-item-name">${widget.name}</div>
                            <div class="command-item-desc">${widget.description}</div>
                        </div>
                        ${widget.isPremium ? '<span class="command-item-badge">⭐ PRO</span>' : ''}
                    </div>
                `;
            });
        });
        commandPaletteBody.innerHTML = html;
    }
    
    // Lucide 아이콘 다시 렌더링
    lucide.createIcons();
    
    // 클릭 이벤트 추가
    document.querySelectorAll('.command-item').forEach(item => {
        item.addEventListener('click', () => {
            const index = parseInt(item.dataset.index);
            selectCommand(index);
        });
    });
}

// Command 선택 (Enter 키 또는 클릭)
function selectCommand(index) {
    if (index < 0 || index >= filteredCommands.length) return;
    
    const widget = filteredCommands[index];
    
    // Canvas 중앙에 노드 생성
    const viewportRect = viewport.getBoundingClientRect();
    const centerX = (viewportRect.width / 2 - pan.x) / zoom;
    const centerY = (viewportRect.height / 2 - pan.y) / zoom;
    
    const card = createCardElement(
        widget.name,
        widget.description,
        centerX - 90, // 카드 너비 절반만큼 왼쪽으로
        centerY - 40  // 카드 높이 절반만큼 위로
    );
    
    // Widget 타입 데이터 추가
    card.dataset.widgetType = widget.type;
    card.dataset.isPremium = widget.isPremium;
    
    // Premium 뱃지 추가
    if (widget.isPremium) {
        const header = card.querySelector('.card-header');
        if (header) {
            const premiumBadge = document.createElement('span');
            premiumBadge.className = 'badge-premium';
            premiumBadge.textContent = '⭐ PRO';
            premiumBadge.style.cssText = `
                display: inline-block;
                margin-left: 8px;
                padding: 2px 6px;
                font-size: 9px;
                font-weight: 600;
                background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
                border-radius: 4px;
                color: white;
            `;
            header.appendChild(premiumBadge);
        }
    }
    
    viewport.appendChild(card);
    
    // Dashboard 동기화
    setTimeout(() => {
        syncCanvasStateToDashboard();
    }, 100);
    
    console.log('✅ Command Palette에서 Widget 생성:', widget.name);
    
    // Command Palette 닫기
    closeCommandPalette();
}

// 키보드 이벤트 (Cmd+K, ↑↓, Enter, ESC)
document.addEventListener('keydown', (e) => {
    // Cmd+K 또는 Ctrl+K로 열기
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (commandPaletteOverlay.classList.contains('active')) {
            closeCommandPalette();
        } else {
            openCommandPalette();
        }
        return;
    }
    
    // Command Palette가 열려있을 때만 처리
    if (!commandPaletteOverlay || !commandPaletteOverlay.classList.contains('active')) return;
    
    // ESC로 닫기
    if (e.key === 'Escape') {
        e.preventDefault();
        closeCommandPalette();
        return;
    }
    
    // Enter로 선택
    if (e.key === 'Enter') {
        e.preventDefault();
        selectCommand(selectedCommandIndex);
        return;
    }
    
    // ↓ 화살표
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedCommandIndex = Math.min(selectedCommandIndex + 1, filteredCommands.length - 1);
        renderCommandList(commandSearchInput.value);
        
        // 선택된 항목으로 스크롤
        const selectedItem = document.querySelector('.command-item.selected');
        if (selectedItem) {
            selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
        return;
    }
    
    // ↑ 화살표
    if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedCommandIndex = Math.max(selectedCommandIndex - 1, 0);
        renderCommandList(commandSearchInput.value);
        
        // 선택된 항목으로 스크롤
        const selectedItem = document.querySelector('.command-item.selected');
        if (selectedItem) {
            selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
        return;
    }
});

// 검색 입력 이벤트
commandSearchInput?.addEventListener('input', (e) => {
    selectedCommandIndex = 0; // 검색 시 첫 번째 항목 선택
    renderCommandList(e.target.value);
});

// Overlay 클릭 시 닫기
commandPaletteOverlay?.addEventListener('click', (e) => {
    if (e.target === commandPaletteOverlay) {
        closeCommandPalette();
    }
});

console.log('✅ Command Palette (Cmd+K) 초기화 완료');

// Card Action Functions
function copyCard(btn) {
    const card = btn.closest('.card');
    const title = card.querySelector('.card-title span').textContent;
    const type = card.dataset.type;
    
    const cardData = {
        title: title,
        type: type,
        timestamp: new Date().toISOString()
    };
    
    navigator.clipboard.writeText(JSON.stringify(cardData, null, 2))
        .then(() => {
            showToast('✅ 카드가 복사되었습니다', 'success');
        })
        .catch(() => {
            showToast('❌ 복사 실패', 'error');
        });
}

function exportToNotion(btn) {
    const card = btn.closest('.card');
    const title = card.querySelector('.card-title span').textContent;
    showToast(`📝 "${title}" 노션으로 내보내기 준비중...`, 'info');
    // TODO: Implement Notion API integration
}

function exportToFigma(btn) {
    const card = btn.closest('.card');
    const title = card.querySelector('.card-title span').textContent;
    showToast(`🎨 "${title}" 피그마로 내보내기 준비중...`, 'info');
    // TODO: Implement Figma API integration
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Show Card Data Modal
function showCardDataModal(cardEl) {
    const title = cardEl.querySelector('.card-title span')?.textContent || cardEl.dataset.title;
    const dataStr = cardEl.dataset.cardData;
    
    if (!dataStr) {
        showToast('이 카드에는 상세 데이터가 없습니다', 'info');
        return;
    }
    
    const data = JSON.parse(dataStr);
    
    // Create modal overlay
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s ease-out;
    `;
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: slideUp 0.3s ease-out;
    `;
    
    // Build content HTML
    let contentHTML = `
        <div style="position: sticky; top: 0; background: white; border-bottom: 1px solid #e5e7eb; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0;">
            <h2 style="margin: 0; font-size: 20px; color: #1f2937;">${title}</h2>
            <button onclick="this.closest('[style*=fixed]').remove()" style="border: none; background: #f3f4f6; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="x" style="width: 18px; height: 18px;"></i>
            </button>
        </div>
        <div style="padding: 24px;">
    `;
    
    // Format data based on type
    function formatValue(key, value) {
        if (typeof value === 'object' && value !== null) {
            if (Array.isArray(value)) {
                return `
                    <div style="margin-top: 8px;">
                        <strong style="color: #374151;">${key}:</strong>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            ${value.map(item => {
                                if (typeof item === 'object') {
                                    return `<li style="margin: 8px 0; padding: 12px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #3b82f6;">${Object.entries(item).map(([k, v]) => `<div><strong>${k}:</strong> ${v}</div>`).join('')}</li>`;
                                }
                                return `<li style="margin: 4px 0;">${item}</li>`;
                            }).join('')}
                        </ul>
                    </div>
                `;
            } else {
                return `
                    <div style="margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 8px;">
                        <strong style="color: #374151; display: block; margin-bottom: 8px;">${key}:</strong>
                        ${Object.entries(value).map(([k, v]) => `
                            <div style="margin: 6px 0; padding-left: 12px;">
                                <span style="color: #6b7280;">${k}:</span>
                                <span style="color: #1f2937; font-weight: 500;">${v}${typeof v === 'number' && k.includes('%') ? '%' : ''}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }
        return `
            <div style="margin: 12px 0; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px;">
                <strong style="color: #374151;">${key}:</strong>
                <span style="color: #1f2937; margin-left: 8px;">${value}</span>
            </div>
        `;
    }
    
    contentHTML += Object.entries(data).map(([key, value]) => formatValue(key, value)).join('');
    contentHTML += '</div>';
    
    modalContent.innerHTML = contentHTML;
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    // Close on backdrop click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    // Close on ESC key
    const escHandler = (e) => {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
    
    // Initialize lucide icons in modal
    setTimeout(() => lucide.createIcons(), 0);
    
    console.log('📊 카드 데이터 모달 열림:', title);
}

lucide.createIcons();
</script>

<!-- AI Orchestrator Engine -->
<script src="/static/js/ai-orchestrator-engine.js" defer></script>
<script src="/static/js/ai-orchestrator-workflows.js" defer></script>

<!-- Canvas Full Functionality - v22.0.0 -->
<script src="/static/js/canvas-full-functionality.js" defer></script>

<!-- Canvas V23.0 Phase A - Projects & Tasks Panel -->
<script src="/static/js/canvas-v23-phase-a.js" defer></script>

<!-- Canvas V23.0 Phase B - Templates & Layers & Export Panel -->
<script src="/static/js/canvas-v23-phase-b.js" defer></script>

<!-- AI Orchestrator Integration for Canvas -->
<script>
console.log('🚀 [Canvas] AI Orchestrator Integration starting...');

/**
 * AI Workspace Search 통합
 * Landing 페이지의 AI 검색 기능과 동일한 인터페이스
 */
const aiSearchInput = document.querySelector('.ai-input input');
const aiSearchButton = document.querySelector('.ai-input .ai-button');

if (aiSearchInput && aiSearchButton) {
    aiSearchButton.addEventListener('click', async () => {
        const command = aiSearchInput.value.trim();
        
        if (!command) {
            alert('검색어를 입력해주세요.');
            return;
        }
        
        console.log('🤖 [Canvas AI] Command received:', command);
        
        // Show loading state
        aiSearchButton.innerHTML = '<i data-lucide="loader" class="animate-spin"></i>';
        aiSearchButton.disabled = true;
        lucide.createIcons();
        
        try {
            // Execute AI Orchestrator workflow
            const session = await window.executeWorkflowByCommand(command);
            
            if (session) {
                console.log('✅ [Canvas AI] Workflow executed:', session.id);
                
                // Show success notification
                showCanvasNotification({
                    type: 'success',
                    title: 'AI 워크플로우 완료',
                    message: `"${command}" 실행 완료 (${session.totalDuration}ms)`,
                    duration: 5000
                });
                
                // Create Canvas visualization of the workflow
                visualizeWorkflowOnCanvas(session);
                
            } else {
                throw new Error('워크플로우 실행 실패');
            }
            
        } catch (error) {
            console.error('❌ [Canvas AI] Error:', error);
            
            showCanvasNotification({
                type: 'error',
                title: 'AI 실행 오류',
                message: error.message,
                duration: 5000
            });
            
        } finally {
            // Reset button
            aiSearchButton.innerHTML = '<i data-lucide="send"></i>';
            aiSearchButton.disabled = false;
            lucide.createIcons();
            
            // Clear input
            aiSearchInput.value = '';
        }
    });
    
    // Enter key support
    aiSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            aiSearchButton.click();
        }
    });
    
    console.log('✅ [Canvas AI] AI Workspace Search integrated');
}

/**
 * Canvas에 워크플로우 시각화
 */
function visualizeWorkflowOnCanvas(session) {
    console.log('🎨 [Canvas] Visualizing workflow:', session.id);
    
    const viewport = document.getElementById('canvasViewport');
    if (!viewport) return;
    
    const startX = 200;
    const startY = 200;
    const nodeSpacing = 300;
    
    // Phase별로 노드 생성
    session.phaseResults.forEach((phaseResult, phaseIndex) => {
        const phaseY = startY + (phaseIndex * 150);
        
        phaseResult.results.forEach((agentResult, agentIndex) => {
            const nodeX = startX + (agentIndex * nodeSpacing);
            
            // Create workflow node card
            const card = createWorkflowNodeCard({
                x: nodeX,
                y: phaseY,
                phase: phaseResult.phaseName,
                agentType: agentResult.agentType,
                status: agentResult.status,
                duration: agentResult.duration,
                output: agentResult.output
            });
            
            viewport.appendChild(card);
        });
    });
    
    // Sync to Dashboard
    setTimeout(() => {
        syncCanvasStateToDashboard();
    }, 500);
    
    console.log('✅ [Canvas] Workflow visualization complete');
}

/**
 * 워크플로우 노드 카드 생성
 */
function createWorkflowNodeCard(data) {
    const card = document.createElement('div');
    card.className = 'card workflow-node';
    card.style.left = data.x + 'px';
    card.style.top = data.y + 'px';
    card.style.width = '250px';
    card.dataset.agentType = data.agentType;
    card.dataset.phase = data.phase;
    
    // Status color
    const statusColors = {
        'completed': '#10B981',
        'running': '#F59E0B',
        'failed': '#EF4444',
        'pending': '#6B7280'
    };
    const statusColor = statusColors[data.status] || '#6B7280';
    
    card.innerHTML = `
        <div class="card-header" style="background: linear-gradient(135deg, ${statusColor}33, ${statusColor}11); border-left: 4px solid ${statusColor};">
            <i data-lucide="cpu" style="width:16px;height:16px;color:${statusColor}"></i>
            ${data.agentType}
        </div>
        <div class="card-content">
            <div style="font-size: 11px; color: #9CA3AF; margin-bottom: 8px;">
                ${data.phase}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                <span style="color: ${statusColor};">● ${data.status}</span>
                <span style="color: #6B7280;">${data.duration}ms</span>
            </div>
            ${data.output ? `
                <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 4px; font-size: 11px; color: #D1D5DB; max-height: 60px; overflow-y: auto;">
                    ${JSON.stringify(data.output, null, 2).substring(0, 100)}...
                </div>
            ` : ''}
        </div>
        
        <!-- Connection Handle -->
        <div class="connection-handle" title="연결선 만들기"></div>
    `;
    
    // Re-render Lucide icons
    lucide.createIcons();
    
    return card;
}

/**
 * Canvas 알림 표시
 */
function showCanvasNotification(notification) {
    const notificationEl = document.createElement('div');
    notificationEl.className = `canvas-notification notification-${notification.type}`;
    notificationEl.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${notification.type === 'success' ? '#10B981' : '#EF4444'};
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        min-width: 300px;
        max-width: 400px;
        animation: slideInRight 0.3s ease-out;
    `;
    
    notificationEl.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px;">${notification.title}</div>
        <div style="font-size: 14px; opacity: 0.9;">${notification.message}</div>
    `;
    
    document.body.appendChild(notificationEl);
    
    // Auto remove
    setTimeout(() => {
        notificationEl.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            notificationEl.remove();
        }, 300);
    }, notification.duration || 3000);
}

/**
 * Update Canvas node status (called from AI Orchestrator)
 */
window.updateCanvasNodeStatus = function(event) {
    console.log('🔄 [Canvas] Node status update:', event);
    
    // Find corresponding card and update status
    const cards = document.querySelectorAll('.workflow-node');
    cards.forEach(card => {
        if (card.dataset.agentType === event.agentType) {
            const statusEl = card.querySelector('[style*="color"]');
            if (statusEl && event.status) {
                statusEl.textContent = `● ${event.status}`;
            }
        }
    });
};

console.log('✅ [Canvas] AI Orchestrator Integration complete');
</script>

<style>
/* Workflow Node Styles */
.workflow-node {
    border: 1px solid rgba(139, 92, 246, 0.3);
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(59, 130, 246, 0.05));
}

.workflow-node .card-header {
    font-size: 12px;
    font-weight: 600;
}

/* Notification Animation */
@keyframes slideInRight {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

/* Loading spinner animation */
.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}
</style>
</script>

<!-- Command Palette Modal -->
<div id="commandPaletteOverlay" class="command-palette-overlay">
    <div class="command-palette">
        <div class="command-palette-header">
            <div class="command-search-wrapper">
                <i data-lucide="search" class="command-search-icon"></i>
                <input 
                    type="text" 
                    id="commandSearchInput"
                    class="command-search-input" 
                    placeholder="위젯 검색... (이름, 설명, 카테고리)"
                    autocomplete="off"
                />
            </div>
            <div class="command-palette-hint">
                <kbd>↑</kbd> <kbd>↓</kbd> 이동
                <kbd>Enter</kbd> 선택
                <kbd>ESC</kbd> 닫기
            </div>
        </div>
        <div id="commandPaletteBody" class="command-palette-body">
            <!-- JavaScript로 동적 생성 -->
        </div>
        <div class="command-palette-footer">
            <div class="command-palette-shortcuts">
                <div class="command-palette-shortcut">
                    <kbd>Cmd</kbd> + <kbd>K</kbd>
                    <span>열기/닫기</span>
                </div>
            </div>
            <div style="font-size: 11px; color: #6B7280;">
                87개 위젯 사용 가능
            </div>
        </div>
    </div>
</div>


    <!-- ⌨️  Keyboard Navigation & Accessibility -->
    <script src="/static/js/keyboard-navigation.js"></script>
    
</body>
</html>
