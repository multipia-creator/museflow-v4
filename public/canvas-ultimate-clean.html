<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<title>MuseFlow Canvas - Enhanced</title>

<!-- Google Analytics 4 -->



<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="preload" href="/static/css/fontawesome-all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/static/css/fontawesome-all.min.css"></noscript>

<script src="https://unpkg.com/lucide@latest"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Inter, sans-serif;
    background: #fafbfc;
    color: #1f2937;
    overflow: hidden;
}

/* Unified Navbar - Dashboard Style */
.unified-navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1001;
    padding: 0;
}

.unified-nav-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0.75rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 64px;
}

.unified-nav-logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    color: #e5e5e5;
    font-weight: 700;
    font-size: 1.25rem;
    transition: transform 0.3s;
}

.unified-nav-logo:hover {
    transform: translateY(-2px);
}

.unified-nav-logo img {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
}

.unified-nav-links {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    list-style: none;
    padding: 0;
    margin: 0;
}

.unified-nav-links a {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    color: #9CA3AF;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s;
    font-size: 1.1rem;
}

.unified-nav-links a:hover {
    background: rgba(139, 92, 246, 0.15);
    color: #8B5CF6;
    transform: translateY(-2px);
}

.unified-nav-links a.active {
    background: rgba(139, 92, 246, 0.25);
    color: #8B5CF6;
    border: 1px solid rgba(139, 92, 246, 0.4);
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
}

.unified-nav-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.unified-nav-btn {
    background: rgba(139, 92, 246, 0.15);
    border: 1px solid rgba(139, 92, 246, 0.3);
    width: 44px;
    height: 44px;
    border-radius: 12px;
    color: #9CA3AF;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    font-size: 1.1rem;
}

.unified-nav-btn:hover {
    background: rgba(139, 92, 246, 0.25);
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    color: #8B5CF6;
}

.unified-nav-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.unified-nav-btn {
    width: 44px;
    height: 44px;
    background: rgba(139, 92, 246, 0.15);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 12px;
    color: #9CA3AF;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    font-size: 1.1rem;
}

.unified-nav-btn:hover {
    background: rgba(139, 92, 246, 0.25);
    color: #8B5CF6;
    transform: scale(1.05);
}

/* Container with navbar offset */
.container {
    display: grid;
    grid-template-columns: 40px 1fr 40px;
    height: calc(100vh - 64px - 48px); /* navbar + footer */
    margin-top: 64px;
}

.sidebar {
    background: linear-gradient(180deg, #1a1a1a, #0f0f0f);
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
    padding: 8px 3px;
    gap: 4px;
}

.sidebar.right {
    border-left: 1px solid #333;
    border-right: none;
}

.icon {
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    cursor: pointer;
    border-radius: 8px;
    transition: 0.2s;
    position: relative;
}

.icon:hover {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}

.icon.active {
    background: rgba(16, 185, 129, 0.25);
    color: #10b981;
}

.badge {
    position: absolute;
    top: 2px;
    right: 2px;
    background: #ef4444;
    color: #fff;
    font-size: 9px;
    min-width: 14px;
    height: 14px;
    border-radius: 7px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
}

.canvas {
    background: #ffffff;
    overflow: hidden;
    position: relative;
}

.viewport {
    width: 100%;
    height: 100%;
    position: relative;
    cursor: grab;
}

.viewport.dragging {
    cursor: grabbing;
}

.panel {
    position: fixed;
    top: 64px;
    bottom: 48px;
    width: 280px;
    background: rgba(26, 26, 26, 0.98);
    border: 1px solid #333;
    z-index: 100;
    transform: translateX(-100%);
    transition: 0.3s;
    display: none;
}

.panel.left {
    left: 40px;
}

.panel.right {
    right: 40px;
    transform: translateX(100%);
}

.panel.active {
    display: block;
    transform: translateX(0);
}

.panel-header {
    padding: 16px;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
}

.panel-title {
    font-size: 14px;
    font-weight: 600;
}

.panel-close {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: #666;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.panel-close:hover {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}

.panel-content {
    padding: 16px;
    color: #999;
    font-size: 13px;
}

/* Media Card with thumbnail */
.card {
    position: absolute;
    width: 300px;
    min-width: 200px;
    min-height: 200px;
    background: #F5F0FF;
    border-radius: 12px;
    box-shadow: none;
    overflow: visible;
    cursor: move;
    transition: box-shadow 0.2s, transform 0.1s;
}

.card.selected {
    box-shadow: none;
    z-index: 1000 !important;
}

.card:hover {
    box-shadow: none;
}

/* Resize Handles */
.resize-handle {
    position: absolute;
    width: 12px;
    height: 12px;
    background: #8b5cf6;
    border: 2px solid #fff;
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
}

.card.selected .resize-handle {
    opacity: 1;
}

.resize-se { bottom: -6px; right: -6px; cursor: nwse-resize; }
.resize-ne { top: -6px; right: -6px; cursor: nesw-resize; }
.resize-sw { bottom: -6px; left: -6px; cursor: nesw-resize; }
.resize-nw { top: -6px; left: -6px; cursor: nwse-resize; }
.resize-e { top: 50%; right: -6px; transform: translateY(-50%); cursor: ew-resize; }
.resize-w { top: 50%; left: -6px; transform: translateY(-50%); cursor: ew-resize; }
.resize-n { top: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
.resize-s { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }

.card-thumbnail {
    width: 100%;
    height: 180px;
    background: linear-gradient(135deg, #C8A5FF 0%, #A5D5FF 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    overflow: hidden;
    position: relative;
}

.card-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-thumbnail video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-thumbnail.video {
    background: linear-gradient(135deg, #FFA5A5 0%, #A5B5FF 100%);
}

.card-thumbnail.audio {
    background: linear-gradient(135deg, #A5D5FF 0%, #A5FFA5 100%);
}

.card-thumbnail.image {
    background: linear-gradient(135deg, #FFB595 0%, #FFA5D5 100%);
}

.card-thumbnail.document {
    background: linear-gradient(135deg, #FFB595 0%, #FFA5C5 100%);
}

.card-thumbnail.data {
    background: linear-gradient(135deg, #A5B5FF 0%, #A5FFB5 100%);
}

.card-header {
    padding: 12px 16px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: #fff;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-content {
    padding: 16px;
    background: #F5F0FF;
    color: #333;
    font-size: 13px;
}

.card-meta {
    display: flex;
    gap: 12px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #e5e7eb;
    font-size: 12px;
    color: #6b7280;
}

.controls {
    display: flex;
    gap: 8px;
    background: rgba(26, 26, 26, 0.98);
    padding: 8px 12px;
    border-radius: 12px;
    border: 1px solid #333;
    z-index: 50;
}

.ctrl-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #374151;
    background: rgba(17, 24, 39, 0.6);
    color: #9ca3af;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ctrl-btn:hover {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}

.zoom-level {
    color: #9ca3af;
    font-size: 13px;
    min-width: 45px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-input {
    position: fixed;
    bottom: 68px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 12px;
    background: rgba(26, 26, 26, 0.98);
    padding: 12px 16px;
    border-radius: 16px;
    border: 1px solid #333;
    z-index: 50;
}

.ai-select {
    padding: 6px 10px;
    background: rgba(17, 24, 39, 0.6);
    border: 1px solid #374151;
    border-radius: 8px;
    color: #e5e7eb;
    font-size: 13px;
}

.ai-field {
    flex: 1;
    min-width: 300px;
    padding: 8px 12px;
    background: rgba(17, 24, 39, 0.6);
    border: 1px solid #374151;
    border-radius: 10px;
    color: #e5e7eb;
    font-size: 14px;
}

.ai-field:focus {
    outline: none;
    border-color: #10b981;
}

.ai-send {
    width: 36px;
    height: 36px;
    border: none;
    background: #10b981;
    color: #fff;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-send:hover {
    background: #059669;
}

/* Footer */
.footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 48px;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    padding: 0 2rem;
    font-size: 13px;
    color: #9ca3af;
    z-index: 1000;
}

.footer-left {
    display: flex;
    gap: 1.5rem;
}

.footer-link {
    color: #9ca3af;
    text-decoration: none;
    transition: color 0.2s;
}

.footer-link:hover {
    color: #8B5CF6;
}

/* Animations */
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.05); }
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.card {
    animation: slideIn 0.3s ease-out;
}

/* Card Click Effects */
.card:hover {
    box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
    transform: translateY(-2px);
}

.card-thumbnail:hover {
    cursor: pointer;
}

/* Modal Viewer */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease-out;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    max-width: 90vw;
    max-height: 90vh;
    position: relative;
    animation: scaleIn 0.3s ease-out;
}

.modal-content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 12px;
}

.modal-content video {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 12px;
}

.modal-close {
    position: absolute;
    top: -50px;
    right: 0;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes scaleIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* Connection Lines (Google Opal Style) */
.connection-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
}

.card-connector {
    position: absolute;
    background: rgba(139, 92, 246, 0.5);
    height: 2px;
    transform-origin: 0 0;
    transition: all 0.3s ease;
    pointer-events: none;
}

.card-connector.active {
    background: rgba(139, 92, 246, 0.8);
    height: 3px;
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
}

.card-connector-dot {
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #8B5CF6;
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
    z-index: 1;
}

.connection-handle {
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #8B5CF6;
    border: 3px solid #ffffff;
    cursor: crosshair;
    opacity: 0.6;
    transition: all 0.2s;
    z-index: 10;
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
}

.card:hover .connection-handle,
.card.selected .connection-handle {
    opacity: 1;
    transform: translateY(-50%) scale(1.2);
}

.connection-handle:hover {
    background: #f59e0b;
    border-color: #ffffff;
    box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
}

/* ============================================
   MOBILE OPTIMIZATION
   ============================================ */

@media (max-width: 768px) {
    /* Navbar Mobile */
    .unified-nav-container {
        padding: 0.5rem 1rem;
        height: 56px;
    }
    
    .unified-nav-logo {
        font-size: 1rem;
        gap: 0.5rem;
    }
    
    .unified-nav-logo img {
        width: 32px;
        height: 32px;
    }
    
    .unified-nav-links {
        gap: 0.25rem;
    }
    
    .unified-nav-links a {
        width: 38px;
        height: 38px;
        font-size: 1rem;
    }
    
    /* Sidebar Mobile - Ï†ÑÏ≤¥ ÎÑàÎπÑÎ°ú ÌïòÎã®Ïóê ÌëúÏãú */
    .left-sidebar,
    .right-sidebar {
        width: 100% !important;
        max-width: 100% !important;
        height: 60vh;
        top: auto;
        bottom: 0;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }
    
    .left-sidebar.open {
        transform: translateY(0);
    }
    
    .right-sidebar.open {
        transform: translateY(0);
    }
    
    /* Sidebar Toggle Buttons - ÌïòÎã® Í≥†Ï†ï */
    .sidebar-toggle-left {
        bottom: 56px;
        top: auto;
        left: 1rem;
        width: 48px;
        height: 48px;
    }
    
    .sidebar-toggle-right {
        bottom: 56px;
        top: auto;
        right: 1rem;
        width: 48px;
        height: 48px;
    }
    
    /* Panel Selector Mobile */
    .panel-selector {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.75rem;
    }
    
    .panel-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        min-width: 60px;
    }
    
    /* Cards Mobile - ÌÑ∞Ïπò ÏπúÌôîÏ†Å ÌÅ¨Í∏∞ */
    .card {
        min-width: 200px !important;
        max-width: 280px !important;
        padding: 1rem;
    }
    
    .card-header h3 {
        font-size: 0.9rem;
    }
    
    .card-thumbnail {
        height: 120px;
    }
    
    .card-content {
        font-size: 0.8rem;
    }
    
    /* AI Input Mobile - Ï†ÑÏ≤¥ ÎÑàÎπÑ */
    .ai-input {
        left: 0;
        right: 0;
        bottom: 56px;
        transform: none;
        flex-direction: column;
        padding: 1rem;
        border-radius: 20px 20px 0 0;
        gap: 0.75rem;
        max-width: 100%;
    }
    
    .ai-select {
        width: 100%;
        padding: 0.75rem;
        font-size: 14px;
    }
    
    .ai-field {
        min-width: auto;
        width: 100%;
        padding: 0.75rem;
        font-size: 14px;
    }
    
    .ai-send {
        width: 100%;
        height: 44px;
        border-radius: 12px;
        font-size: 1rem;
    }
    
    /* Zoom Controls Mobile */
    .zoom-controls {
        bottom: 116px;
        right: 1rem;
        gap: 0.5rem;
        padding: 0.5rem;
    }
    
    .zoom-btn {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    /* Footer Mobile */
    .footer {
        height: 56px;
        padding: 0 1rem;
        font-size: 0.75rem;
        gap: 1rem;
    }
    
    .footer-left {
        gap: 0.75rem;
    }
    
    /* Canvas Viewport Mobile */
    #canvasViewport {
        top: 56px;
        bottom: 56px;
    }
    
    /* Modal Mobile */
    .modal-content {
        width: 95%;
        max-width: 95%;
        padding: 1rem;
    }
    
    .modal-close {
        top: 0.5rem;
        right: 0.5rem;
        width: 36px;
        height: 36px;
        font-size: 1.2rem;
    }
}

/* ÌÑ∞Ïπò ÎîîÎ∞îÏù¥Ïä§ ÏµúÏ†ÅÌôî */
@media (hover: none) and (pointer: coarse) {
    /* ÌÑ∞Ïπò ÌÉÄÍ≤ü ÌÅ¨Í∏∞ Ï¶ùÍ∞Ä */
    .card {
        touch-action: pan-x pan-y;
    }
    
    .zoom-btn,
    .panel-btn,
    .sidebar-toggle-left,
    .sidebar-toggle-right {
        min-width: 44px;
        min-height: 44px;
    }
    
    /* Ìò∏Î≤Ñ Ìö®Í≥º Ï†úÍ±∞ */
    .card:hover {
        transform: none;
    }
    
    .connection-handle {
        opacity: 1;
        width: 20px;
        height: 20px;
    }
}

/* ÏûëÏùÄ Î™®Î∞îÏùº (iPhone SE Îì±) */
@media (max-width: 375px) {
    .unified-nav-logo span {
        display: none;
    }
    
    .card {
        min-width: 180px !important;
        max-width: 240px !important;
    }
    
    .ai-input {
        padding: 0.75rem;
    }
    
    .footer {
        font-size: 0.7rem;
    }
}

/* Í∞ÄÎ°ú Î™®Îìú */
@media (max-width: 768px) and (orientation: landscape) {
    .left-sidebar,
    .right-sidebar {
        height: 80vh;
    }
    
    .ai-input {
        bottom: 48px;
    }
    
    .footer {
        height: 48px;
    }
    
    #canvasViewport {
        top: 56px;
        bottom: 48px;
    }
}

/* ============================================
   WIDGET PANEL - MINIMALIST DESIGN SYSTEM
   ============================================ */

/* Lucide Icons Base */
.icon {
  width: 20px;
  height: 20px;
  stroke-width: 1.5px;
  flex-shrink: 0;
}

.icon-xs {
  width: 14px;
  height: 14px;
  stroke-width: 2px;
}

/* Widget Panel Base */
#widgetPanel .panel-content {
  padding: 4px 0;
  overflow-y: auto;
  max-height: calc(100vh - 200px); /* Ïä§ÌÅ¨Î°§ Í∞ÄÎä•ÌïòÎèÑÎ°ù ÏµúÎåÄ ÎÜíÏù¥ ÏÑ§Ï†ï */
  height: 100%; /* Ï†ÑÏ≤¥ ÎÜíÏù¥ ÏÇ¨Ïö© */
}

/* Search & Filter Toolbar */
.widget-toolbar {
  padding: 16px 20px;
  background: #0a0a0a;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.widget-search-box {
  position: relative;
  display: flex;
  align-items: center;
  background: #1a1a1a;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px;
  padding: 11px 14px;
  transition: all 0.2s;
}

.widget-search-box:focus-within {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.08);
  background: #222;
}

.widget-search-box .icon {
  stroke: #666;
  margin-right: 10px;
}

.widget-search-box input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #e5e5e5;
  font-size: 14px;
}

.widget-search-box input::placeholder {
  color: #666;
}

.widget-btn-clear {
  background: transparent;
  border: none;
  color: #666;
  cursor: pointer;
  padding: 4px;
  transition: color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.widget-btn-clear:hover {
  color: #e5e5e5;
}

/* Filter Chips */
.widget-filter-chips {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.widget-chip {
  padding: 7px 12px;
  background: #1a1a1a;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 20px;
  font-size: 12px;
  color: #9CA3AF;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.widget-chip:hover {
  background: #222;
  color: #e5e5e5;
  border-color: rgba(255,255,255,0.15);
}

.widget-chip.active {
  background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
  color: white;
  border-color: #8B5CF6;
}

/* Category Groups - Color System */
.category-group {
  margin: 4px 8px;
  border-radius: 12px;
  border-left: 2px solid;
  transition: all 0.2s;
}

/* Blue - Advanced Analytics */
.category-advanced-analytics {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.06) 0%, rgba(37, 99, 235, 0.03) 100%);
  border-left-color: rgba(59, 130, 246, 0.25);
}

.category-advanced-analytics .category-header {
  color: #93c5fd;
}

.category-advanced-analytics .category-icon {
  stroke: #60A5FA;
}

.category-advanced-analytics .widget-item:hover {
  background: rgba(59, 130, 246, 0.1);
  border-color: rgba(59, 130, 246, 0.35);
}

/* Amber - Museum Professional */
.category-museum-professional {
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.06) 0%, rgba(245, 158, 11, 0.03) 100%);
  border-left-color: rgba(251, 191, 36, 0.25);
}

.category-museum-professional .category-header {
  color: #FCD34D;
}

.category-museum-professional .category-icon {
  stroke: #FCD34D;
}

.category-museum-professional .widget-item:hover {
  background: rgba(251, 191, 36, 0.1);
  border-color: rgba(251, 191, 36, 0.35);
}

/* Green - Visitor Experience */
.category-visitor-experience {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.06) 0%, rgba(22, 163, 74, 0.03) 100%);
  border-left-color: rgba(34, 197, 94, 0.25);
}

.category-visitor-experience .category-header {
  color: #4ADE80;
}

.category-visitor-experience .category-icon {
  stroke: #4ADE80;
}

.category-visitor-experience .widget-item:hover {
  background: rgba(34, 197, 94, 0.1);
  border-color: rgba(34, 197, 94, 0.35);
}

/* Slate - Operations */
.category-operations {
  background: linear-gradient(135deg, rgba(100, 116, 139, 0.06) 0%, rgba(71, 85, 105, 0.03) 100%);
  border-left-color: rgba(100, 116, 139, 0.25);
}

.category-operations .category-header {
  color: #94A3B8;
}

.category-operations .category-icon {
  stroke: #94A3B8;
}

.category-operations .widget-item:hover {
  background: rgba(100, 116, 139, 0.1);
  border-color: rgba(100, 116, 139, 0.35);
}

/* Purple - Collaboration (Brand Color) */
.category-collaboration {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.06) 0%, rgba(124, 58, 237, 0.03) 100%);
  border-left-color: rgba(139, 92, 246, 0.25);
}

.category-collaboration .category-header {
  color: #c4b5fd;
}

.category-collaboration .category-icon {
  stroke: #A78BFA;
}

.category-collaboration .widget-item:hover {
  background: rgba(139, 92, 246, 0.1);
  border-color: rgba(139, 92, 246, 0.35);
}

/* Emerald - Finance */
.category-finance {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.06) 0%, rgba(5, 150, 105, 0.03) 100%);
  border-left-color: rgba(16, 185, 129, 0.25);
}

.category-finance .category-header {
  color: #34D399;
}

.category-finance .category-icon {
  stroke: #34D399;
}

.category-finance .widget-item:hover {
  background: rgba(16, 185, 129, 0.1);
  border-color: rgba(16, 185, 129, 0.35);
}

/* Category Header */
.category-header {
  display: flex;
  align-items: center;
  padding: 14px 18px;
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
  gap: 10px;
}

.category-header:hover {
  background: rgba(255,255,255,0.02);
}

.category-chevron {
  transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  stroke: currentColor;
  opacity: 0.6;
}

.category-group[data-expanded="true"] .category-chevron {
  transform: rotate(0deg);
}

.category-group[data-expanded="false"] .category-chevron {
  transform: rotate(-90deg);
}

.category-name {
  flex: 1;
  font-size: 14px;
  font-weight: 600;
}

.category-badge {
  background: rgba(255,255,255,0.08);
  color: currentColor;
  padding: 3px 9px;
  border-radius: 14px;
  font-size: 11px;
  font-weight: 600;
  opacity: 0.7;
}

/* Category Content (Accordion) */
.category-content {
  overflow: hidden;
  transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  padding-bottom: 8px;
}

/* Widget Items */
.widget-item {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  margin: 6px 12px;
  background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 10px;
  cursor: grab;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  gap: 12px;
}

.widget-item:hover {
  transform: translateX(4px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
}

.widget-item:active {
  cursor: grabbing;
  transform: translateX(2px);
}

.widget-item.dragging {
  opacity: 0.4;
}

.widget-icon-wrapper {
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.04);
  border-radius: 10px;
  flex-shrink: 0;
  transition: all 0.2s;
}

.widget-item:hover .widget-icon-wrapper {
  background: rgba(255,255,255,0.08);
  transform: scale(1.05);
}

.widget-icon-wrapper .icon {
  stroke: currentColor;
  opacity: 0.9;
}

.widget-info {
  flex: 1;
  min-width: 0;
}

.widget-name {
  font-size: 13px;
  font-weight: 600;
  color: #e5e5e5;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 7px;
  flex-wrap: wrap;
  line-height: 1.4;
}

.widget-description {
  font-size: 11.5px;
  color: #9CA3AF;
  line-height: 1.5;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.badge-premium {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 7px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 5px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.widget-price {
  font-size: 12px;
  font-weight: 700;
  color: #8B5CF6;
  margin-left: 4px;
  flex-shrink: 0;
}

/* Widget Panel Scrollbar - Improved */
#widgetPanel .panel-content::-webkit-scrollbar {
  width: 4px;
}

#widgetPanel .panel-content::-webkit-scrollbar-track {
  background: transparent;
}

#widgetPanel .panel-content::-webkit-scrollbar-thumb {
  background: rgba(139, 92, 246, 0.15);
  border-radius: 2px;
  transition: background 0.2s;
}

#widgetPanel .panel-content::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 92, 246, 0.3);
}

/* Category Badge Enhancement */
.category-badge {
  background: rgba(255,255,255,0.12);
  color: currentColor;
  padding: 4px 10px;
  border-radius: 14px;
  font-size: 12px;
  font-weight: 700;
  opacity: 0.9;
  border: 1px solid rgba(255,255,255,0.1);
  min-width: 28px;
  text-align: center;
}

/* ========================================
   Color Picker Styles
   ======================================== */
.color-picker {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}

.color-option {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  cursor: pointer;
  border: 3px solid transparent;
  transition: all 0.2s ease;
  position: relative;
}

.color-option:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.color-option.selected {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
}

.color-option.selected::after {
  content: '‚úì';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #000;
  font-size: 18px;
  font-weight: bold;
}

/* Search Box Enhancement */
.widget-search-box {
  position: relative;
  display: flex;
  align-items: center;
  background: linear-gradient(135deg, #1a1a1a 0%, #222 100%);
  border: 1px solid rgba(139, 92, 246, 0.15);
  border-radius: 12px;
  padding: 12px 16px;
  transition: all 0.2s;
}

.widget-search-box:focus-within {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.12);
  background: linear-gradient(135deg, #222 0%, #2a2a2a 100%);
}

.widget-search-box .icon {
  stroke: #8B5CF6;
  margin-right: 12px;
  width: 18px;
  height: 18px;
}

.widget-search-box input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #e5e5e5;
  font-size: 14px;
  font-weight: 500;
}

.widget-search-box input::placeholder {
  color: #666;
  font-weight: 400;
}

/* Widget Select Boxes */
.widget-select {
  flex: 1;
  padding: 10px 14px;
  background: rgba(139, 92, 246, 0.08);
  border: 1px solid rgba(139, 92, 246, 0.2);
  border-radius: 10px;
  color: #e5e5e5;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  outline: none;
}

.widget-select:hover {
  background: rgba(139, 92, 246, 0.12);
  border-color: rgba(139, 92, 246, 0.3);
}

.widget-select:focus {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
}

.widget-select option {
  background: #1a1a1a;
  color: #e5e5e5;
  padding: 8px;
}

/* Hint Text Below Search */
.widget-search-hint {
  margin-top: 8px;
  font-size: 11px;
  color: #666;
  text-align: center;
  padding: 0 20px;
}

.widget-search-hint kbd {
  display: inline-block;
  padding: 2px 6px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  font-family: monospace;
  font-size: 10px;
  color: #8B5CF6;
  margin: 0 2px;
}

/* ============================================
   COMMAND PALETTE (Cmd+K)
   ============================================ */

.command-palette-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  display: none;
  justify-content: center;
  align-items: flex-start;
  padding-top: 15vh;
  z-index: 10000;
  animation: fadeIn 0.2s ease-out;
}

.command-palette-overlay.active {
  display: flex;
}

.command-palette {
  width: 600px;
  max-width: 90%;
  background: linear-gradient(135deg, rgba(17, 24, 39, 0.98) 0%, rgba(31, 41, 55, 0.98) 100%);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(139, 92, 246, 0.2);
  overflow: hidden;
  animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* ========================================
   Context Menu Styles
   ======================================== */
.context-menu {
  position: fixed;
  background: rgba(17, 24, 39, 0.98);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 12px;
  padding: 8px 0;
  min-width: 200px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5),
              0 0 0 1px rgba(139, 92, 246, 0.1);
  z-index: 10000;
  backdrop-filter: blur(20px);
  animation: fadeIn 0.15s ease;
}

.context-menu-item {
  padding: 10px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.15s ease;
  color: #e5e5e5;
  font-size: 14px;
  font-weight: 500;
}

.context-menu-item:hover {
  background: rgba(139, 92, 246, 0.15);
  color: #fff;
}

.context-menu-item i {
  width: 18px;
  height: 18px;
  color: #8B5CF6;
  flex-shrink: 0;
}

.context-menu-item.danger {
  color: #EF4444;
}

.context-menu-item.danger:hover {
  background: rgba(239, 68, 68, 0.15);
  color: #FCA5A5;
}

.context-menu-item.danger i {
  color: #EF4444;
}

.context-menu-divider {
  height: 1px;
  background: rgba(255, 255, 255, 0.1);
  margin: 4px 0;
}

.command-palette-header {
  padding: 20px 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(139, 92, 246, 0.05);
}

.command-search-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  gap: 12px;
}

.command-search-icon {
  width: 20px;
  height: 20px;
  color: #8B5CF6;
  flex-shrink: 0;
}

.command-search-input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #e5e5e5;
  font-size: 16px;
  font-weight: 500;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
}

.command-search-input::placeholder {
  color: #9CA3AF;
}

.command-palette-hint {
  font-size: 11px;
  color: #6B7280;
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.command-palette-hint kbd {
  padding: 2px 6px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  font-family: monospace;
  font-size: 10px;
}

.command-palette-body {
  max-height: 400px;
  overflow-y: auto;
}

.command-palette-body::-webkit-scrollbar {
  width: 6px;
}

.command-palette-body::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.1);
}

.command-palette-body::-webkit-scrollbar-thumb {
  background: rgba(148, 163, 184, 0.3);
  border-radius: 3px;
}

.command-palette-body::-webkit-scrollbar-thumb:hover {
  background: rgba(148, 163, 184, 0.5);
}

.command-category {
  padding: 12px 20px 8px;
  font-size: 11px;
  font-weight: 600;
  color: #6B7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.command-item {
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.15s ease;
  border-left: 3px solid transparent;
}

.command-item:hover,
.command-item.selected {
  background: rgba(139, 92, 246, 0.15);
  border-left-color: #8B5CF6;
}

.command-item-icon {
  width: 18px;
  height: 18px;
  color: #8B5CF6;
  flex-shrink: 0;
}

.command-item-info {
  flex: 1;
  min-width: 0;
}

.command-item-name {
  font-size: 14px;
  font-weight: 500;
  color: #e5e5e5;
  margin-bottom: 2px;
}

.command-item-desc {
  font-size: 12px;
  color: #9CA3AF;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.command-item-badge {
  display: inline-block;
  padding: 2px 8px;
  font-size: 9px;
  font-weight: 600;
  background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
  border-radius: 4px;
  color: white;
  flex-shrink: 0;
}

.command-palette-empty {
  padding: 60px 20px;
  text-align: center;
  color: #6B7280;
}

.command-palette-empty-icon {
  width: 48px;
  height: 48px;
  margin: 0 auto 16px;
  color: #4B5563;
}

.command-palette-empty-text {
  font-size: 14px;
  font-weight: 500;
}

.command-palette-footer {
  padding: 12px 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(0, 0, 0, 0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.command-palette-shortcuts {
  display: flex;
  gap: 16px;
  font-size: 11px;
  color: #6B7280;
}

.command-palette-shortcut {
  display: flex;
  align-items: center;
  gap: 6px;
}

.command-palette-shortcut kbd {
  padding: 2px 6px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  font-family: monospace;
  font-size: 10px;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .command-palette {
    width: 95%;
    max-height: 70vh;
  }
  
  .command-palette-body {
    max-height: 300px;
  }
}

/* ============================================
   CONTEXT MENU & EDIT MODAL
   ============================================ */

/* Context Menu */
.context-menu {
  position: fixed;
  background: linear-gradient(135deg, rgba(17, 24, 39, 0.98) 0%, rgba(31, 41, 55, 0.98) 100%);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 12px;
  padding: 8px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 20px rgba(139, 92, 246, 0.2);
  min-width: 180px;
  z-index: 10001;
  animation: contextMenuSlide 0.2s ease-out;
}

@keyframes contextMenuSlide {
  from {
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.context-menu-item {
  padding: 10px 16px;
  cursor: pointer;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
  color: #e5e5e5;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}

.context-menu-item:hover {
  background: rgba(139, 92, 246, 0.2);
  transform: translateX(4px);
}

.context-menu-item i {
  color: #8B5CF6;
}

.context-menu-danger {
  color: #EF4444;
}

.context-menu-danger i {
  color: #EF4444;
}

.context-menu-danger:hover {
  background: rgba(239, 68, 68, 0.15);
}

/* Edit Modal Overlay */
.edit-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(8px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10002;
  animation: fadeIn 0.2s ease-out;
}

/* Edit Modal */
.edit-modal {
  width: 500px;
  max-width: 90%;
  background: linear-gradient(135deg, rgba(17, 24, 39, 0.98) 0%, rgba(31, 41, 55, 0.98) 100%);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(139, 92, 246, 0.2);
  animation: modalSlideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlideUp {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.edit-modal-header {
  padding: 20px 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(139, 92, 246, 0.05);
}

.edit-modal-header h3 {
  margin: 0;
  color: #e5e5e5;
  font-size: 18px;
  font-weight: 600;
}

.edit-modal-close {
  background: transparent;
  border: none;
  color: #9CA3AF;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.edit-modal-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #e5e5e5;
}

.edit-modal-body {
  padding: 24px;
}

.edit-form-group {
  margin-bottom: 20px;
}

.edit-form-group:last-child {
  margin-bottom: 0;
}

.edit-form-group label {
  display: block;
  margin-bottom: 8px;
  color: #9CA3AF;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.edit-input, .edit-textarea {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 12px 16px;
  color: #e5e5e5;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s;
}

.edit-input:focus, .edit-textarea:focus {
  outline: none;
  border-color: #8B5CF6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  background: rgba(255, 255, 255, 0.08);
}

.edit-input::placeholder, .edit-textarea::placeholder {
  color: #6B7280;
}

.edit-textarea {
  resize: vertical;
  min-height: 80px;
}

/* Color Picker */
.color-picker {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.color-option {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
  position: relative;
}

.color-option:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.color-option.selected {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
}

.color-option.selected::after {
  content: '‚úì';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-weight: bold;
  font-size: 18px;
  text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* Edit Modal Footer */
.edit-modal-footer {
  padding: 16px 24px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  background: rgba(0, 0, 0, 0.2);
}

.edit-btn-cancel, .edit-btn-save {
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}

.edit-btn-cancel {
  background: rgba(255, 255, 255, 0.05);
  color: #9CA3AF;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.edit-btn-cancel:hover {
  background: rgba(255, 255, 255, 0.1);
  color: #e5e5e5;
}

.edit-btn-save {
  background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
  color: white;
}

.edit-btn-save:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

    /* Screen Reader Only - Accessibility */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }
    
    .sr-only-focusable:focus {
        position: static;
        width: auto;
        height: auto;
        margin: 0;
        overflow: visible;
        clip: auto;
        white-space: normal;
    }
    
    /* Skip to Content Link - WCAG 2.1 Guideline 2.4.1 */
    .skip-link {
        position: absolute;
        top: -100px;
        left: 0;
        background: #000;
        color: #fff;
        padding: 1rem 2rem;
        text-decoration: none;
        font-weight: 600;
        z-index: 100000;
        border-radius: 0 0 8px 0;
        transition: top 0.3s ease;
    }
    
    .skip-link:focus {
        top: 0;
        outline: 3px solid #c4b5fd;
        outline-offset: 2px;
    }
    
    /* Enhanced Focus Styles for Keyboard Navigation */
    *:focus {
        outline: 2px solid #c4b5fd;
        outline-offset: 2px;
    }
    
    *:focus:not(:focus-visible) {
        outline: none;
    }
    
    *:focus-visible {
        outline: 3px solid #c4b5fd;
        outline-offset: 3px;
        box-shadow: 0 0 0 4px rgba(196, 181, 253, 0.3);
    }
    
    button:focus-visible,
    a:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
        outline: 3px solid #c4b5fd;
        outline-offset: 2px;
    }
    </style>

    <!-- ‚ú® Critical CSS - Inlined for instant rendering -->
    <style>/**
 * MuseFlow V18.0 - Critical CSS for Canvas Page
 * Above-the-fold styles for instant rendering
 * This will be inlined in <head> to eliminate render-blocking
 */

/* Reset & Base */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
    background: #0a0a0f;
    color: #f5f5f7;
    min-height: 100vh;
    overflow: hidden;
    line-height: 1.6;
}

/* Canvas Container - Critical */
#canvas-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.05) 0%, #0a0a0f 100%);
    overflow: hidden;
}

/* Canvas Workspace */
#canvas-workspace {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: move;
    transform-origin: center center;
}

/* Grid Pattern */
.canvas-grid {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
    background-size: 50px 50px;
    pointer-events: none;
}

/* Toolbar - Above the fold */
#canvas-toolbar {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(10, 10, 15, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 1rem;
    z-index: 100;
    display: flex;
    gap: 0.75rem;
}

.toolbar-button {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.toolbar-button:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.5);
}

.toolbar-button.active {
    background: rgba(139, 92, 246, 0.3);
    border-color: #8b5cf6;
}

/* Widget Panel - Above the fold */
#widget-panel {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 320px;
    max-height: calc(100vh - 40px);
    background: rgba(10, 10, 15, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    z-index: 100;
    overflow-y: auto;
}

.widget-panel-header {
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    position: sticky;
    top: 0;
    background: rgba(10, 10, 15, 0.95);
    backdrop-filter: blur(20px);
    z-index: 1;
}

.widget-panel-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
}

/* Widget Search */
.widget-search {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: white;
    font-size: 0.95rem;
}

.widget-search::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

/* Widget List */
.widget-list {
    padding: 1rem;
}

.widget-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: grab;
    transition: all 0.2s;
}

.widget-item:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(139, 92, 246, 0.3);
    transform: translateY(-2px);
}

.widget-item.dragging {
    cursor: grabbing;
    opacity: 0.5;
}

/* Card - Canvas Element */
.card {
    position: absolute;
    background: rgba(10, 10, 15, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 1.5rem;
    min-width: 280px;
    max-width: 480px;
    cursor: move;
    transition: box-shadow 0.2s;
}

.card:hover {
    box-shadow: 0 8px 32px rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.3);
}

.card.selected {
    border-color: #8b5cf6;
    box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.5);
}

/* AI Assistant - Above the fold */
.ai-assistant {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(10, 10, 15, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 16px;
    padding: 1rem 1.5rem;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 1rem;
    max-width: 600px;
}

.ai-assistant-input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 1rem;
    outline: none;
}

.ai-assistant-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

/* Loading States */
.skeleton {
    background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.05) 0%, 
        rgba(255, 255, 255, 0.1) 50%, 
        rgba(255, 255, 255, 0.05) 100%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
}

@keyframes skeleton-loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Prevent FOUC */
html { visibility: visible; opacity: 1; }

/* Mobile Optimization */
@media (max-width: 768px) {
    #canvas-toolbar {
        top: 10px;
        left: 10px;
        padding: 0.5rem;
        gap: 0.5rem;
    }
    
    .toolbar-button {
        width: 40px;
        height: 40px;
    }
    
    #widget-panel {
        top: auto;
        bottom: 0;
        right: 0;
        left: 0;
        width: 100%;
        max-height: 60vh;
        border-radius: 16px 16px 0 0;
    }
    
    .ai-assistant {
        bottom: 10px;
        left: 10px;
        right: 10px;
        max-width: none;
        transform: none;
    }
}
</style>
    
    <!-- ‚ö° Lazy Loading Script for Performance -->
    <script src="/static/js/lazy-loading.js"></script>
    
    <!-- üìä Google Analytics 4 - Advanced Event Tracking -->
    <script src="/static/js/analytics-ga4.js" async></script>
    </head>
<body>
    <!-- Skip to Content for Keyboard Navigation -->
    <a href="#canvas-container" class="skip-link">
        Î©îÏù∏ ÏΩòÌÖêÏ∏†Î°ú Í±¥ÎÑàÎõ∞Í∏∞
    </a>
    

<!-- Unified Navigation Bar - Dashboard Style -->
<nav class="unified-navbar">
    <div class="unified-nav-container">
        <a href="/" class="unified-nav-logo">
            <img loading="lazy" src="/static/images/logo-neon-m.png" alt="MuseFlow">
            <span>MuseFlow</span>
        </a>
        <ul class="unified-nav-links">
            <li><a href="/dashboard.html" data-tooltip="ÎåÄÏãúÎ≥¥Îìú"><i class="fas fa-home" aria-hidden="true"></i></a></li>
            <li><a href="/canvas-ultimate-clean.html" class="active" data-tooltip="Ï∫îÎ≤ÑÏä§"><i class="fas fa-palette" aria-hidden="true"></i></a></li>
            <li><a href="/workflow.html" data-tooltip="ÏõåÌÅ¨ÌîåÎ°úÏö∞"><i class="fas fa-project-diagram" aria-hidden="true"></i></a></li>
            <li><a href="/analytics-dashboard.html" data-tooltip="Î∂ÑÏÑù"><i class="fas fa-chart-line" aria-hidden="true"></i></a></li>
        </ul>
        <div class="unified-nav-actions">
            <button class="unified-nav-btn" title="ÏÑ§Ï†ï"><i class="fas fa-cog" aria-hidden="true"></i></button>
            <button class="unified-nav-btn" title="Í≥ÑÏ†ï"><i class="fas fa-user-circle" aria-hidden="true"></i></button>
        </div>
    </div>
</nav>

<!-- Main Container -->
<div class="container">
    <div class="sidebar left">
        <div class="icon" data-panel="history"><i data-lucide="clock" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="actions"><i data-lucide="zap" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="projects"><i data-lucide="folder" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="settings"><i data-lucide="settings" style="width:16px;height:16px"></i></div>
    </div>
    <div class="canvas">
        <div class="viewport" id="vp"></div>
    </div>
    <div class="sidebar right">
        <div class="icon" data-panel="stats"><i data-lucide="bar-chart-2" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="widget"><i data-lucide="package" style="width:16px;height:16px"></i><span class="badge">87</span></div>
        <div class="icon" data-panel="tasks"><i data-lucide="check-square" style="width:16px;height:16px"></i><span class="badge">2</span></div>
        <div class="icon" data-panel="ai"><i data-lucide="sparkles" style="width:16px;height:16px"></i><span class="badge">1</span></div>
        <div class="icon" data-panel="alerts"><i data-lucide="bell" style="width:16px;height:16px"></i><span class="badge">3</span></div>
    </div>
</div>

<!-- Panels -->
<div class="panel left" id="historyPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">History</span>
        <button class="panel-close" onclick="closePanel('historyPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #8B5CF6;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="image" style="width:16px;height:16px;color:#8B5CF6;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">Ìè¨Ïä§ÌÑ∞ Ïù¥ÎØ∏ÏßÄ Ìé∏Ïßë</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">Î∞©Í∏à Ï†Ñ</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #6366F1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="video" style="width:16px;height:16px;color:#6366F1;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">ÏòÅÏÉÅ Î†åÎçîÎßÅ ÏôÑÎ£å</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">5Î∂Ñ Ï†Ñ</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #22C55E;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="link" style="width:16px;height:16px;color:#22C55E;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">Ïπ¥Îìú Ïó∞Í≤∞ ÏÉùÏÑ±</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">10Î∂Ñ Ï†Ñ</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #F97316;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="move" style="width:16px;height:16px;color:#F97316;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">Ïπ¥Îìú Ïû¨Î∞∞Ïπò</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">15Î∂Ñ Ï†Ñ</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #3B82F6;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="save" style="width:16px;height:16px;color:#3B82F6;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû•</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">30Î∂Ñ Ï†Ñ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel left" id="actionsPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">Actions</span>
        <button class="panel-close" onclick="closePanel('actionsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <button style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); border: none; padding: 0.75rem 1rem; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <i data-lucide="plus" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    ÏÉà Ïπ¥Îìú ÎßåÎì§Í∏∞
                </button>
                <button style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.75rem 1rem; border-radius: 8px; color: #e5e5e5; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.25)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.15)'">
                    <i data-lucide="upload" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    ÌååÏùº ÏóÖÎ°úÎìú
                </button>
                <button style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.75rem 1rem; border-radius: 8px; color: #e5e5e5; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.25)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.15)'">
                    <i data-lucide="layout" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    Î†àÏù¥ÏïÑÏõÉ Ï†ïÎ†¨
                </button>
                <button style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.75rem 1rem; border-radius: 8px; color: #e5e5e5; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.25)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.15)'">
                    <i data-lucide="save" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû•
                </button>
            </div>
        </div>
    </div>
</div>

<div class="panel left" id="projectsPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">Projects</span>
        <button class="panel-close" onclick="closePanel('projectsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid #8B5CF6; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.2)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'">
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">ÎÆ§ÏßÄÏóÑ Ï†ÑÏãú ÌîÑÎ°úÏ†ùÌä∏</div>
                    <div style="font-size: 0.875rem; color: #9CA3AF;">ÎßàÏßÄÎßâ ÏàòÏ†ï: 2ÏãúÍ∞Ñ Ï†Ñ</div>
                </div>
                <div style="padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 3px solid #22C55E; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(34, 197, 94, 0.2)'" onmouseout="this.style.background='rgba(34, 197, 94, 0.1)'">
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">ÏòàÏà† ÏûëÌíà ÏïÑÏπ¥Ïù¥Î∏å</div>
                    <div style="font-size: 0.875rem; color: #9CA3AF;">ÎßàÏßÄÎßâ ÏàòÏ†ï: 1Ïùº Ï†Ñ</div>
                </div>
                <div style="padding: 0.75rem; background: rgba(249, 115, 22, 0.1); border-radius: 8px; border-left: 3px solid #F97316; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(249, 115, 22, 0.2)'" onmouseout="this.style.background='rgba(249, 115, 22, 0.1)'">
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">Í¥ÄÎûåÍ∞ù Í≤ΩÌóò ÎîîÏûêÏù∏</div>
                    <div style="font-size: 0.875rem; color: #9CA3AF;">ÎßàÏßÄÎßâ ÏàòÏ†ï: 3Ïùº Ï†Ñ</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel left" id="settingsPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">Settings</span>
        <button class="panel-close" onclick="closePanel('settingsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">ÌÖåÎßà</div>
                    <select style="width: 100%; padding: 0.5rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: #e5e5e5; cursor: pointer;">
                        <option>Îã§ÌÅ¨ Î™®Îìú</option>
                        <option>ÎùºÏù¥Ìä∏ Î™®Îìú</option>
                        <option>ÏãúÏä§ÌÖú ÏÑ§Ï†ï</option>
                    </select>
                </div>
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">Í∑∏Î¶¨Îìú ÌÅ¨Í∏∞</div>
                    <input type="range" min="50" max="500" value="150" style="width: 100%; cursor: pointer;">
                    <div style="font-size: 0.8125rem; color: #9CA3AF; margin-top: 0.25rem;">150px</div>
                </div>
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">ÏûêÎèô Ï†ÄÏû•</div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="color: #e5e5e5; font-size: 0.9375rem;">Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ ÏûêÎèô Ï†ÄÏû•</span>
                    </label>
                </div>
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">Ïó∞Í≤∞ÏÑ† ÌëúÏãú</div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="color: #e5e5e5; font-size: 0.9375rem;">ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïó∞Í≤∞ÏÑ† Î≥¥Í∏∞</span>
                    </label>
                </div>
                <button style="width: 100%; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); padding: 0.75rem; border-radius: 8px; color: #EF4444; cursor: pointer; font-weight: 600; margin-top: 1rem;">
                    <i data-lucide="refresh-cw" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî
                </button>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="statsPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">Stats</span>
        <button class="panel-close" onclick="closePanel('statsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">Ï¥ù Ïπ¥Îìú Ïàò</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #8B5CF6;">9</div>
                </div>
                <div style="padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">ÏôÑÎ£åÎêú ÏûëÏóÖ</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #22C55E;">5</div>
                </div>
                <div style="padding: 1rem; background: rgba(249, 115, 22, 0.1); border-radius: 8px; border: 1px solid rgba(249, 115, 22, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">ÏßÑÌñâ Ï§ë</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #F97316;">4</div>
                </div>
                <div style="padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">Ïó∞Í≤∞ Ïàò</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #3B82F6;">0</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="tasksPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">Tasks</span>
        <button class="panel-close" onclick="closePanel('tasksPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                    <input type="checkbox" style="width: 16px; height: 16px; cursor: pointer;">
                    <div>
                        <div style="font-size: 0.9375rem; color: #e5e5e5;">ÌôçÎ≥¥ ÏòÅÏÉÅ Ìé∏Ïßë ÏôÑÎ£å</div>
                        <div style="font-size: 0.8125rem; color: #9CA3AF; margin-top: 0.25rem;">Í∏∞Ìïú: Ïò§Îäò</div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                    <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;">
                    <div>
                        <div style="font-size: 0.9375rem; color: #9CA3AF; text-decoration: line-through;">Ïò§ÎîîÏò§ Í∞ÄÏù¥Îìú ÎÖπÏùå</div>
                        <div style="font-size: 0.8125rem; color: #9CA3AF; margin-top: 0.25rem;">ÏôÑÎ£åÎê®</div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                    <input type="checkbox" style="width: 16px; height: 16px; cursor: pointer;">
                    <div>
                        <div style="font-size: 0.9375rem; color: #e5e5e5;">Ìè¨Ïä§ÌÑ∞ ÎîîÏûêÏù∏ ÏäπÏù∏</div>
                        <div style="font-size: 0.8125rem; color: #9CA3AF; margin-top: 0.25rem;">Í∏∞Ìïú: ÎÇ¥Ïùº</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="aiPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">AI Assistant</span>
        <button class="panel-close" onclick="closePanel('aiPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="width: 8px; height: 8px; border-radius: 50%; background: #22C55E; animation: pulse 2s infinite;"></div>
                        <div style="font-weight: 600; color: #e5e5e5;">Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ï§ë...</div>
                    </div>
                    <div style="font-size: 0.875rem; color: #9CA3AF;">ÏßÑÌñâÎ•†: 73%</div>
                    <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 0.5rem; overflow: hidden;">
                        <div style="width: 73%; height: 100%; background: linear-gradient(90deg, #8B5CF6, #6366F1); transition: width 0.3s;"></div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px;">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">ÏµúÍ∑º AI ÏûëÏóÖ</div>
                    <div style="font-size: 0.9375rem; color: #e5e5e5;">‚Ä¢ Î∞∞Í≤Ω Ï†úÍ±∞ (3Î∂Ñ Ï†Ñ)</div>
                    <div style="font-size: 0.9375rem; color: #e5e5e5;">‚Ä¢ ÌÖçÏä§Ìä∏ Î≤àÏó≠ (15Î∂Ñ Ï†Ñ)</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="alertsPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">Alerts</span>
        <button class="panel-close" onclick="closePanel('alertsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #EF4444;">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <i data-lucide="alert-circle" style="width:16px;height:16px;color:#EF4444;flex-shrink:0;margin-top:2px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">ÌîÑÎ°úÏ†ùÌä∏ ÎßàÍ∞êÏùº ÏûÑÎ∞ï</div>
                            <div style="font-size: 0.875rem; color: #9CA3AF;">ÎÆ§ÏßÄÏóÑ Ï†ÑÏãú - 2Ïùº ÎÇ®Ïùå</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3B82F6;">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <i data-lucide="info" style="width:16px;height:16px;color:#3B82F6;flex-shrink:0;margin-top:2px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">ÏÉàÎ°úÏö¥ ÏóÖÎç∞Ïù¥Ìä∏</div>
                            <div style="font-size: 0.875rem; color: #9CA3AF;">Canvas v4 Í∏∞Îä• Ï∂îÍ∞ÄÎê®</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 3px solid #22C55E;">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <i data-lucide="check-circle" style="width:16px;height:16px;color:#22C55E;flex-shrink:0;margin-top:2px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">ÏûëÏóÖ ÏôÑÎ£å</div>
                            <div style="font-size: 0.875rem; color: #9CA3AF;">Ïò§ÎîîÏò§ Í∞ÄÏù¥Îìú ÎÖπÏùå ÏôÑÎ£å</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Widget Panel -->
<div class="panel right" id="widgetPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">
            <i data-lucide="package" class="icon" style="margin-right:8px;"></i>
            ÏúÑÏ†Ø
        </span>
        <button class="panel-close" onclick="closePanel('widgetPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <!-- Search & Filter Toolbar -->
    <div class="widget-toolbar">
        <div class="widget-search-box">
            <i data-lucide="search" class="icon"></i>
            <input type="text" 
                   id="widgetSearch" 
                   placeholder="üîç ÏúÑÏ†Ø Í≤ÄÏÉâ... (Cmd+KÎ°ú Îπ†Î•∏ Ï†ëÍ∑º)"
                   autocomplete="off">
            <button id="widgetClearSearch" class="widget-btn-clear" style="display:none;">
                <i data-lucide="x" class="icon"></i>
            </button>
        </div>
        
        <div class="widget-filter-chips">
            <button class="widget-chip active" data-filter="all">
                <i data-lucide="grid-3x3" class="icon-xs"></i>
                Ï†ÑÏ≤¥
            </button>
            <button class="widget-chip" data-filter="premium">
                <i data-lucide="star" class="icon-xs"></i>
                ÌîÑÎ¶¨ÎØ∏ÏóÑ
            </button>
            <button class="widget-chip" data-filter="free">
                <i data-lucide="gift" class="icon-xs"></i>
                Î¨¥Î£å
            </button>
            <button class="widget-chip" data-filter="recent">
                <i data-lucide="clock" class="icon-xs"></i>
                ÏµúÍ∑º
            </button>
        </div>
        
        <!-- Category & Sort Controls -->
        <div style="display: flex; gap: 12px; margin-top: 12px;">
            <select id="categoryFilter" class="widget-select">
                <option value="all">Î™®Îì† Ïπ¥ÌÖåÍ≥†Î¶¨</option>
                <option value="advanced-analytics">üìä Í≥†Í∏â Î∂ÑÏÑù & Ïù∏ÏÇ¨Ïù¥Ìä∏</option>
                <option value="museum-professional">üèõÔ∏è ÎÆ§ÏßÄÏóÑ Ï†ÑÎ¨∏ Í∏∞Îä•</option>
                <option value="visitor-experience">üë• Í¥ÄÎûåÍ∞ù Í≤ΩÌóò</option>
                <option value="operations">üíº Ïö¥ÏòÅ & Í¥ÄÎ¶¨</option>
                <option value="collaboration">ü§ù ÌòëÏóÖ & Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò</option>
                <option value="financial">üí∞ Ïû¨Î¨¥ & ÏàòÏùµ Î∂ÑÏÑù</option>
            </select>
            
            <select id="sortFilter" class="widget-select">
                <option value="default">Í∏∞Î≥∏ Ï†ïÎ†¨</option>
                <option value="name-asc">Ïù¥Î¶Ñ (Í∞ÄÎÇòÎã§Ïàú)</option>
                <option value="name-desc">Ïù¥Î¶Ñ (Ïó≠Ïàú)</option>
                <option value="price-asc">Í∞ÄÍ≤© (ÎÇÆÏùÄÏàú)</option>
                <option value="price-desc">Í∞ÄÍ≤© (ÎÜíÏùÄÏàú)</option>
            </select>
        </div>
        
        <div class="widget-search-hint">
            üí° <kbd>Cmd</kbd> + <kbd>K</kbd> Î°ú Îπ†Î•¥Í≤å Í≤ÄÏÉâÌïòÍ±∞ÎÇò, Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÌÅ¥Î¶≠ÌïòÏó¨ ÏúÑÏ†ØÏùÑ ÌÉêÏÉâÌïòÏÑ∏Ïöî
        </div>
    </div>
    
    <div class="panel-content">
        <div id="widgetCategoryList">
            <!-- üìä Í≥†Í∏â Î∂ÑÏÑù & Ïù∏ÏÇ¨Ïù¥Ìä∏ -->
            <div class="category-group category-advanced-analytics" 
                 data-category="advanced-analytics"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('advanced-analytics')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="trending-up" class="icon category-icon"></i>
                    <span class="category-name">Í≥†Í∏â Î∂ÑÏÑù & Ïù∏ÏÇ¨Ïù¥Ìä∏</span>
                    <span class="category-badge">17</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="visitor-dwell-time" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="clock" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                Í¥ÄÎûåÍ∞ù Ï≤¥Î•ò ÏãúÍ∞Ñ Î∂ÑÏÑù
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                Ï†ÑÏãúÏã§Î≥Ñ ÌèâÍ∑† Ï≤¥Î•ò ÏãúÍ∞ÑÍ≥º Ïù∏Í∏∞ Ï†ÑÏãúÎ¨º Ìå®ÌÑ¥ Î∂ÑÏÑù
                            </div>
                        </div>
                        <div class="widget-price">‚Ç©7,900</div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="predictive-visitors" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="brain" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                ÏòàÏ∏° Í¥ÄÎûåÍ∞ù Ïàò
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                AI Í∏∞Î∞ò Î∞©Î¨∏Ïûê ÏòàÏ∏° Î∞è ÏµúÏ†Å Ïù∏Î†• Î∞∞Ïπò Ï†úÏïà
                            </div>
                        </div>
                        <div class="widget-price">‚Ç©9,900</div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="exhibition-effectiveness" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="bar-chart-3" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                Ï†ÑÏãú Ìö®Í≥ºÏÑ± ÎåÄÏãúÎ≥¥Îìú
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                Í¥ÄÎûåÍ∞ù ÌîºÎìúÎ∞±, QR Ïä§Ï∫îÏú®, Ïò§ÎîîÏò§ Í∞ÄÏù¥Îìú ÏÇ¨Ïö©Î•† Ï¢ÖÌï©
                            </div>
                        </div>
                        <div class="widget-price">‚Ç©7,900</div>
                    </div>
                </div>
            </div>
            
            <!-- üèõÔ∏è ÎÆ§ÏßÄÏóÑ Ï†ÑÎ¨∏ Í∏∞Îä• -->
            <div class="category-group category-museum-professional" 
                 data-category="museum-professional"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('museum-professional')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="landmark" class="icon category-icon"></i>
                    <span class="category-name">ÎÆ§ÏßÄÏóÑ Ï†ÑÎ¨∏ Í∏∞Îä•</span>
                    <span class="category-badge">20</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="artifact-loan-status">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="package" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">ÏÜåÏû•Ìíà ÎåÄÏ∂ú ÌòÑÌô©</div>
                            <div class="widget-description">
                                ÎåÄÏ∂ú Ï§ëÏù∏ ÏûëÌíà Î™©Î°ùÍ≥º Î∞òÎÇ© ÏòàÏ†ïÏùº ÏïåÎ¶º
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="conservation-workflow">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="wrench" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">Î≥¥Ï°¥ Ï≤òÎ¶¨ ÏõåÌÅ¨ÌîåÎ°úÏö∞</div>
                            <div class="widget-description">
                                Ï≤òÎ¶¨ ÎåÄÍ∏∞ Î™©Î°ùÍ≥º ÏßÑÌñâ Îã®Í≥ÑÎ≥Ñ ÌòÑÌô©
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- üë• Í¥ÄÎûåÍ∞ù Í≤ΩÌóò -->
            <div class="category-group category-visitor-experience" 
                 data-category="visitor-experience"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('visitor-experience')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="users" class="icon category-icon"></i>
                    <span class="category-name">Í¥ÄÎûåÍ∞ù Í≤ΩÌóò</span>
                    <span class="category-badge">15</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="live-satisfaction">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="smile-plus" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">Ïã§ÏãúÍ∞Ñ ÎßåÏ°±ÎèÑ Ï°∞ÏÇ¨</div>
                            <div class="widget-description">
                                QR ÌîºÎìúÎ∞± ÏàòÏßëÍ≥º Í∏çÏ†ï/Î∂ÄÏ†ï ÎπÑÏú®
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="audio-guide-usage">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="headphones" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">Ïò§ÎîîÏò§ Í∞ÄÏù¥Îìú ÏÇ¨Ïö© ÌÜµÍ≥Ñ</div>
                            <div class="widget-description">
                                Ïñ∏Ïñ¥Î≥Ñ ÏÇ¨Ïö©Î•†Í≥º Ïù∏Í∏∞ Ìä∏Îûô ÏàúÏúÑ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- üíº Ïö¥ÏòÅ & Í¥ÄÎ¶¨ -->
            <div class="category-group category-operations" 
                 data-category="operations"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('operations')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="settings" class="icon category-icon"></i>
                    <span class="category-name">Ïö¥ÏòÅ & Í¥ÄÎ¶¨</span>
                    <span class="category-badge">15</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="facility-inspection">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="clipboard-check" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">ÏãúÏÑ§ Ï†êÍ≤Ä Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏</div>
                            <div class="widget-description">
                                ÏùºÏùº Ï†êÍ≤Ä Ìï≠Î™©Í≥º Ïù¥Ïäà Î≥¥Í≥†
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="cctv-monitoring" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="video" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                CCTV Î™®ÎãàÌÑ∞ÎßÅ ÌòÑÌô©
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                Ïπ¥Î©îÎùº ÏûëÎèô ÏÉÅÌÉúÏôÄ ÎÖπÌôî Ïö©Îüâ
                            </div>
                        </div>
                        <div class="widget-price">‚Ç©5,900</div>
                    </div>
                </div>
            </div>
            
            <!-- ü§ù ÌòëÏóÖ & Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò -->
            <div class="category-group category-collaboration" 
                 data-category="collaboration"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('collaboration')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="message-square" class="icon category-icon"></i>
                    <span class="category-name">ÌòëÏóÖ & Ïª§ÎÆ§ÎãàÏºÄÏù¥ÏÖò</span>
                    <span class="category-badge">10</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="team-messenger">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="message-circle" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">ÌåÄ Î©îÏã†Ï†Ä</div>
                            <div class="widget-description">
                                Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖÍ≥º Î∂ÄÏÑúÎ≥Ñ Ï±ÑÎÑê
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="kanban-board" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="trello" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                ÌîÑÎ°úÏ†ùÌä∏ Ïπ∏Î∞ò Î≥¥Îìú
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                To-Do/In Progress/Done ÏóÖÎ¨¥ Í¥ÄÎ¶¨
                            </div>
                        </div>
                        <div class="widget-price">‚Ç©4,900</div>
                    </div>
                </div>
            </div>
            
            <!-- üìà Ïû¨Î¨¥ & ÏàòÏùµ -->
            <div class="category-group category-finance" 
                 data-category="finance"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('finance')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="dollar-sign" class="icon category-icon"></i>
                    <span class="category-name">Ïû¨Î¨¥ & ÏàòÏùµ</span>
                    <span class="category-badge">10</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="donor-dashboard" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="heart" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                Í∏∞Î∂ÄÏûê Í¥ÄÎ¶¨ ÎåÄÏãúÎ≥¥Îìú
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                Í∏∞Î∂Ä Ïù¥Î†• Ï∂îÏ†ÅÍ≥º VIP ÌõÑÏõêÏûê Í¥ÄÎ¶¨
                            </div>
                        </div>
                        <div class="widget-price">‚Ç©4,900</div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="museum-shop-sales">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="shopping-cart" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">ÍµøÏ¶à ÌåêÎß§ ÌòÑÌô©</div>
                            <div class="widget-description">
                                ÏÉÅÌíàÎ≥Ñ Îß§Ï∂úÍ≥º Ïû¨Í≥† ÏàòÏ§Ä ÏïåÎ¶º
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Input -->
<div class="ai-input">
    <select class="ai-select">
        <option>GPT-4o</option>
        <option>Claude 3.5</option>
        <option>Gemini Pro</option>
    </select>
    <button class="ai-voice" id="voiceBtn" title="ÏùåÏÑ± ÏûÖÎ†•">
        <i data-lucide="mic" style="width:16px;height:16px"></i>
    </button>
    <input class="ai-field" id="aiInput" placeholder="AIÏóêÍ≤å ÏßàÎ¨∏ÌïòÍ±∞ÎÇò ÏùåÏÑ± ÏûÖÎ†•...">
    
    <!-- Zoom Controls (moved here) -->
    <div class="controls">
        <button class="ctrl-btn" id="zoomOut">
            <i data-lucide="zoom-out" style="width:14px;height:14px"></i>
        </button>
        <span class="zoom-level" id="zoomLevel">100%</span>
        <button class="ctrl-btn" id="zoomIn">
            <i data-lucide="zoom-in" style="width:14px;height:14px"></i>
        </button>
        <button class="ctrl-btn" id="fitScreen">
            <i data-lucide="maximize-2" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <button class="ai-send">
        <i data-lucide="send" style="width:16px;height:16px"></i>
    </button>
</div>

<!-- Modal Viewer -->
<div class="modal-overlay" id="modalViewer">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <div class="modal-content" id="modalContent"></div>
</div>

<!-- Context Menu for Widget Nodes -->
<div class="context-menu" id="widgetContextMenu" style="display: none;">
    <div class="context-menu-item" onclick="editWidgetNode()">
        <i data-lucide="edit" style="width:16px;height:16px;"></i>
        <span>Ìé∏Ïßë</span>
    </div>
    <div class="context-menu-item" onclick="duplicateWidgetNode()">
        <i data-lucide="copy" style="width:16px;height:16px;"></i>
        <span>Î≥µÏ†ú</span>
    </div>
    <div class="context-menu-item context-menu-danger" onclick="deleteWidgetNode()">
        <i data-lucide="trash-2" style="width:16px;height:16px;"></i>
        <span>ÏÇ≠Ï†ú</span>
    </div>
</div>

<!-- Widget Edit Modal -->
<div class="edit-modal-overlay" id="widgetEditModal" style="display: none;">
    <div class="edit-modal">
        <div class="edit-modal-header">
            <h3>‚úèÔ∏è Widget Ìé∏Ïßë</h3>
            <button class="edit-modal-close" onclick="closeEditModal()">
                <i data-lucide="x" style="width:18px;height:18px;"></i>
            </button>
        </div>
        <div class="edit-modal-body">
            <div class="edit-form-group">
                <label>Ïù¥Î¶Ñ</label>
                <input type="text" id="editWidgetName" class="edit-input" placeholder="Widget Ïù¥Î¶Ñ">
            </div>
            <div class="edit-form-group">
                <label>ÏÑ§Î™Ö</label>
                <textarea id="editWidgetDescription" class="edit-textarea" placeholder="Widget ÏÑ§Î™Ö" rows="3"></textarea>
            </div>
            <div class="edit-form-group">
                <label>ÏÉâÏÉÅ</label>
                <div class="color-picker">
                    <div class="color-option" data-color="#FFFFFF" style="background: #FFFFFF;" title="Í∏∞Î≥∏"></div>
                    <div class="color-option" data-color="#8B5CF6" style="background: #8B5CF6;" title="Î≥¥ÎùºÏÉâ"></div>
                    <div class="color-option" data-color="#3B82F6" style="background: #3B82F6;" title="ÌååÎûÄÏÉâ"></div>
                    <div class="color-option" data-color="#10B981" style="background: #10B981;" title="ÎÖπÏÉâ"></div>
                    <div class="color-option" data-color="#F59E0B" style="background: #F59E0B;" title="ÎÖ∏ÎûÄÏÉâ"></div>
                    <div class="color-option" data-color="#EF4444" style="background: #EF4444;" title="Îπ®Í∞ÑÏÉâ"></div>
                </div>
            </div>
        </div>
        <div class="edit-modal-footer">
            <button class="edit-btn-cancel" onclick="closeEditModal()">Ï∑®ÏÜå</button>
            <button class="edit-btn-save" onclick="saveWidgetEdit()">Ï†ÄÏû•</button>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu" style="display: none;">
    <div class="context-menu-item" onclick="editNodeFromContextMenu()">
        <i data-lucide="edit-3"></i>
        <span>Ìé∏Ïßë</span>
    </div>
    <div class="context-menu-item" onclick="duplicateNodeFromContextMenu()">
        <i data-lucide="copy"></i>
        <span>Î≥µÏ†ú</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="deleteNodeFromContextMenu()">
        <i data-lucide="trash-2"></i>
        <span>ÏÇ≠Ï†ú</span>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div class="footer-left">
        <span>¬© 2025 MuseFlow</span>
        <a href="#" class="footer-link">ÎèÑÏõÄÎßê</a>
        <a href="#" class="footer-link">Í∞úÏù∏Ï†ïÎ≥¥Ï≤òÎ¶¨Î∞©Ïπ®</a>
        <a href="#" class="footer-link">ÏÑúÎπÑÏä§ ÏïΩÍ¥Ä</a>
    </div>
    <div class="footer-right">
        <span>v4.0.0</span>
    </div>
</footer>

<script>
lucide.createIcons();

// ============================================
// Widget ÎìúÎûòÍ∑∏Ïï§ÎìúÎ°≠ - Ï†ÑÏó≠ Î≥ÄÏàò Î∞è Ìï®Ïàò (ÏµúÏö∞ÏÑ† Ï†ïÏùò)
// ============================================
let draggedWidgetData = null;

// ============================================
// Widget Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï - Ï†ÑÏó≠ Î≥ÄÏàò
// ============================================
let currentEditingNode = null;
let selectedColor = '#FFFFFF';
let contextMenuTarget = null;

// localStorage ÌÇ§
const WIDGET_CONFIGS_KEY = 'canvas_widget_configs';
const WIDGET_USAGE_STATS_KEY = 'widget_usage_stats';

// Widget ÏÑ§Ï†ï Î°úÎìú
function loadWidgetConfigs() {
    const configs = localStorage.getItem(WIDGET_CONFIGS_KEY);
    return configs ? JSON.parse(configs) : {};
}

// Widget ÏÑ§Ï†ï Ï†ÄÏû•
function saveWidgetConfig(widgetId, config) {
    const configs = loadWidgetConfigs();
    configs[widgetId] = {
        ...config,
        updated_at: new Date().toISOString()
    };
    localStorage.setItem(WIDGET_CONFIGS_KEY, JSON.stringify(configs));
    console.log('üíæ Widget config saved:', widgetId, config);
}

// Widget ÏïÑÏù¥ÌÖúÏóê ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞ÄÌïòÎäî Ìï®Ïàò
function attachWidgetDragListeners() {
    const widgets = document.querySelectorAll('.widget-item');
    
    widgets.forEach(widget => {
        // Ïù¥ÎØ∏ Î¶¨Ïä§ÎÑàÍ∞Ä Îì±Î°ùÎêòÏñ¥ ÏûàÏúºÎ©¥ Ïä§ÌÇµ
        if (widget.dataset.dragListenerAttached) return;
        
        // dragstart Ïù¥Î≤§Ìä∏
        widget.addEventListener('dragstart', (e) => {
            const widgetType = widget.dataset.widgetType;
            const widgetName = widget.querySelector('.widget-name')?.textContent?.replace(/Premium/g, '').trim() || 'New Widget';
            const widgetDesc = widget.querySelector('.widget-description')?.textContent || '';
            const isPremium = widget.querySelector('.badge-premium') !== null;
            
            draggedWidgetData = {
                type: widgetType,
                name: widgetName,
                description: widgetDesc,
                isPremium: isPremium
            };
            
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', JSON.stringify(draggedWidgetData));
            
            // ÎìúÎûòÍ∑∏ Ï§ë ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
            widget.style.opacity = '0.5';
            
            // Add to recent widgets
            addToRecentWidgets(widgetType);
            
            console.log('üé® Widget ÎìúÎûòÍ∑∏ ÏãúÏûë:', widgetName, draggedWidgetData);
        });
        
        // dragend Ïù¥Î≤§Ìä∏
        widget.addEventListener('dragend', (e) => {
            widget.style.opacity = '1';
            console.log('üé® Widget ÎìúÎûòÍ∑∏ Ï¢ÖÎ£å');
        });
        
        // Î¶¨Ïä§ÎÑà Îì±Î°ù ÌîåÎûòÍ∑∏
        widget.dataset.dragListenerAttached = 'true';
    });
    
    console.log(`‚úÖ Widget ÎìúÎûòÍ∑∏ Î¶¨Ïä§ÎÑà Îì±Î°ù ÏôÑÎ£å: ${widgets.length}Í∞ú`);
}

// ========== WIDGET PANEL - ACCORDION & SEARCH ==========
function toggleWidgetCategory(categoryId) {
  const group = document.querySelector(`[data-category="${categoryId}"]`);
  if (!group) return;
  
  const content = group.querySelector('.category-content');
  const isExpanded = group.dataset.expanded === 'true';
  
  // Toggle
  group.dataset.expanded = !isExpanded;
  
  // Animation
  if (!isExpanded) {
    content.style.display = 'block';
    const height = content.scrollHeight;
    content.style.maxHeight = '0px';
    requestAnimationFrame(() => {
      content.style.maxHeight = height + 'px';
    });
  } else {
    content.style.maxHeight = '0px';
    setTimeout(() => {
      content.style.display = 'none';
    }, 350);
  }
  
  // Re-initialize Lucide icons
  lucide.createIcons();
  
  // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌéºÏπ® Ïãú Widget ÎìúÎûòÍ∑∏ Î¶¨Ïä§ÎÑà Ïû¨Îì±Î°ù
  if (!isExpanded && typeof attachWidgetDragListeners === 'function') {
    setTimeout(() => {
      attachWidgetDragListeners();
    }, 100);
  }
}

// Widget Search
const widgetSearchInput = document.getElementById('widgetSearch');
const widgetClearBtn = document.getElementById('widgetClearSearch');

widgetSearchInput?.addEventListener('input', (e) => {
  const query = e.target.value.trim().toLowerCase();
  
  if (query.length > 0) {
    filterWidgets(query);
    widgetClearBtn.style.display = 'flex';
  } else {
    resetWidgetFilter();
    widgetClearBtn.style.display = 'none';
  }
});

widgetClearBtn?.addEventListener('click', () => {
  widgetSearchInput.value = '';
  resetWidgetFilter();
  widgetClearBtn.style.display = 'none';
});

function filterWidgets(query) {
  const allWidgets = document.querySelectorAll('.widget-item');
  const allCategories = document.querySelectorAll('.category-group');
  
  allCategories.forEach(category => {
    const categoryWidgets = category.querySelectorAll('.widget-item');
    let hasVisibleWidget = false;
    
    categoryWidgets.forEach(widget => {
      const name = widget.querySelector('.widget-name')?.textContent.toLowerCase() || '';
      const desc = widget.querySelector('.widget-description')?.textContent.toLowerCase() || '';
      
      if (name.includes(query) || desc.includes(query)) {
        widget.style.display = 'flex';
        hasVisibleWidget = true;
      } else {
        widget.style.display = 'none';
      }
    });
    
    // Show category if it has visible widgets
    if (hasVisibleWidget) {
      category.style.display = 'block';
      category.dataset.expanded = 'true';
      category.querySelector('.category-content').style.display = 'block';
      category.querySelector('.category-content').style.maxHeight = '9999px';
    } else {
      category.style.display = 'none';
    }
  });
  
  lucide.createIcons();
}

// ============================================
// Widget Filter Functions
// ============================================
let currentFilter = 'all';
let recentWidgets = [];

// Filter Chips Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    const filterChips = document.querySelectorAll('.widget-chip');
    
    filterChips.forEach(chip => {
        chip.addEventListener('click', () => {
            const filterType = chip.dataset.filter;
            
            // Update active state
            filterChips.forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            
            // Apply filter
            currentFilter = filterType;
            applyWidgetFilter(filterType);
            
            console.log('üîç Filter Ï†ÅÏö©:', filterType);
        });
    });
    
    // Category Filter
    const categoryFilter = document.getElementById('categoryFilter');
    categoryFilter?.addEventListener('change', (e) => {
        const category = e.target.value;
        applyCategoryFilter(category);
        console.log('üìÇ Category Filter:', category);
    });
    
    // Sort Filter
    const sortFilter = document.getElementById('sortFilter');
    sortFilter?.addEventListener('change', (e) => {
        const sortType = e.target.value;
        applySortFilter(sortType);
        console.log('üî¢ Sort Filter:', sortType);
    });
    
    // Load recent widgets from localStorage
    loadRecentWidgets();
});

function applyWidgetFilter(filterType) {
    const allWidgets = document.querySelectorAll('.widget-item');
    const allCategories = document.querySelectorAll('.category-group');
    
    allCategories.forEach(category => {
        const categoryWidgets = category.querySelectorAll('.widget-item');
        let hasVisibleWidget = false;
        
        categoryWidgets.forEach(widget => {
            const isPremium = widget.dataset.premium === 'true';
            const widgetType = widget.dataset.widgetType;
            let isVisible = false;
            
            switch(filterType) {
                case 'all':
                    isVisible = true;
                    break;
                case 'premium':
                    isVisible = isPremium;
                    break;
                case 'free':
                    isVisible = !isPremium;
                    break;
                case 'recent':
                    isVisible = recentWidgets.includes(widgetType);
                    break;
            }
            
            widget.style.display = isVisible ? 'flex' : 'none';
            if (isVisible) hasVisibleWidget = true;
        });
        
        // Show/hide category
        if (hasVisibleWidget) {
            category.style.display = 'block';
            category.dataset.expanded = 'true';
            const content = category.querySelector('.category-content');
            content.style.display = 'block';
            content.style.maxHeight = '9999px';
        } else {
            category.style.display = 'none';
        }
    });
    
    lucide.createIcons();
}

function loadRecentWidgets() {
    const saved = localStorage.getItem('recent_widgets');
    recentWidgets = saved ? JSON.parse(saved) : [];
    console.log('üìã Recent Widgets Î°úÎìú:', recentWidgets.length);
}

function addToRecentWidgets(widgetType) {
    if (!recentWidgets.includes(widgetType)) {
        recentWidgets.unshift(widgetType);
        
        // Keep only last 10
        if (recentWidgets.length > 10) {
            recentWidgets = recentWidgets.slice(0, 10);
        }
        
        localStorage.setItem('recent_widgets', JSON.stringify(recentWidgets));
        console.log('‚úÖ Recent Widget Ï∂îÍ∞Ä:', widgetType);
    }
}

// ============================================
// Category Filter Function
// ============================================
function applyCategoryFilter(category) {
    const allCategories = document.querySelectorAll('.category-group');
    
    if (category === 'all') {
        // Show all categories
        allCategories.forEach(cat => {
            cat.style.display = 'block';
        });
    } else {
        // Show only selected category
        allCategories.forEach(cat => {
            if (cat.dataset.category === category) {
                cat.style.display = 'block';
                cat.dataset.expanded = 'true';
                const content = cat.querySelector('.category-content');
                content.style.display = 'block';
                content.style.maxHeight = '9999px';
            } else {
                cat.style.display = 'none';
            }
        });
    }
    
    lucide.createIcons();
}

// ============================================
// Sort Filter Function
// ============================================
function applySortFilter(sortType) {
    const allCategories = document.querySelectorAll('.category-group');
    
    allCategories.forEach(category => {
        const widgetList = Array.from(category.querySelectorAll('.widget-item'));
        const content = category.querySelector('.category-content');
        
        // Sort widgets
        widgetList.sort((a, b) => {
            const nameA = a.querySelector('.widget-name')?.textContent?.trim().toLowerCase() || '';
            const nameB = b.querySelector('.widget-name')?.textContent?.trim().toLowerCase() || '';
            const priceA = parseFloat(a.querySelector('.widget-price')?.textContent?.replace(/[^\d]/g, '') || '0');
            const priceB = parseFloat(b.querySelector('.widget-price')?.textContent?.replace(/[^\d]/g, '') || '0');
            
            switch(sortType) {
                case 'name-asc':
                    return nameA.localeCompare(nameB);
                case 'name-desc':
                    return nameB.localeCompare(nameA);
                case 'price-asc':
                    return priceA - priceB;
                case 'price-desc':
                    return priceB - priceA;
                default:
                    return 0;
            }
        });
        
        // Re-append sorted widgets
        widgetList.forEach(widget => {
            content.appendChild(widget);
        });
    });
    
    lucide.createIcons();
    
    // Re-attach drag listeners
    setTimeout(() => {
        if (typeof attachWidgetDragListeners === 'function') {
            attachWidgetDragListeners();
        }
    }, 100);
}

function resetWidgetFilter() {
    const allWidgets = document.querySelectorAll('.widget-item');
    const allCategories = document.querySelectorAll('.category-group');
  
  allWidgets.forEach(widget => {
    widget.style.display = 'flex';
  });
  
  allCategories.forEach(category => {
    category.style.display = 'block';
  });
  
  lucide.createIcons();
}

// Filter Chips
document.querySelectorAll('.widget-chip').forEach(chip => {
  chip.addEventListener('click', (e) => {
    document.querySelectorAll('.widget-chip').forEach(c => c.classList.remove('active'));
    e.currentTarget.classList.add('active');
    
    const filter = e.currentTarget.dataset.filter;
    applyWidgetFilter(filter);
  });
});

function applyWidgetFilter(filter) {
  const allWidgets = document.querySelectorAll('.widget-item');
  const allCategories = document.querySelectorAll('.category-group');
  
  allCategories.forEach(category => {
    const categoryWidgets = category.querySelectorAll('.widget-item');
    let hasVisibleWidget = false;
    
    categoryWidgets.forEach(widget => {
      let isVisible = false;
      
      switch (filter) {
        case 'premium':
          isVisible = widget.dataset.premium === 'true';
          break;
        case 'free':
          isVisible = widget.dataset.premium !== 'true';
          break;
        case 'recent':
          // TODO: Implement recent widgets from localStorage
          isVisible = false;
          break;
        case 'all':
        default:
          isVisible = true;
      }
      
      widget.style.display = isVisible ? 'flex' : 'none';
      if (isVisible) hasVisibleWidget = true;
    });
    
    if (hasVisibleWidget) {
      category.style.display = 'block';
      category.dataset.expanded = 'true';
      category.querySelector('.category-content').style.display = 'block';
      category.querySelector('.category-content').style.maxHeight = '9999px';
    } else {
      category.style.display = 'none';
    }
  });
  
  lucide.createIcons();
}

// Keyboard Shortcut (Cmd+K to focus search)
document.addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    const widgetPanel = document.getElementById('widgetPanel');
    if (!widgetPanel.classList.contains('open')) {
      openPanel('widgetPanel');
    }
    widgetSearchInput?.focus();
  }
});

// ========== WEB SPEECH API - VOICE INPUT ==========
let recognition = null;
let isRecording = false;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ko-KR';
    recognition.continuous = false;
    recognition.interimResults = true;
    
    recognition.onstart = () => {
        isRecording = true;
        const btn = document.getElementById('voiceBtn');
        btn.style.background = 'linear-gradient(135deg, #EF4444, #DC2626)';
        btn.style.animation = 'pulse 1.5s infinite';
        console.log('üé§ ÏùåÏÑ± Ïù∏Ïãù ÏãúÏûë');
    };
    
    recognition.onresult = (event) => {
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            }
        }
        if (finalTranscript) {
            document.getElementById('aiInput').value = finalTranscript;
            console.log('‚úÖ Ïù∏Ïãù ÏôÑÎ£å:', finalTranscript);
        }
    };
    
    recognition.onerror = (event) => {
        console.error('‚ùå ÏùåÏÑ± Ïù∏Ïãù Ïò§Î•ò:', event.error);
        isRecording = false;
        const btn = document.getElementById('voiceBtn');
        btn.style.background = '';
        btn.style.animation = '';
    };
    
    recognition.onend = () => {
        isRecording = false;
        const btn = document.getElementById('voiceBtn');
        btn.style.background = '';
        btn.style.animation = '';
        console.log('üé§ ÏùåÏÑ± Ïù∏Ïãù Ï¢ÖÎ£å');
    };
}

// Voice Button Click
document.getElementById('voiceBtn')?.addEventListener('click', () => {
    if (!recognition) {
        alert('ÏùåÏÑ± Ïù∏ÏãùÏù¥ ÏßÄÏõêÎêòÏßÄ ÏïäÎäî Î∏åÎùºÏö∞Ï†ÄÏûÖÎãàÎã§.');
        return;
    }
    if (isRecording) {
        recognition.stop();
    } else {
        recognition.start();
    }
});

// ============================================
// D1 DatabaseÏóêÏÑú Widget ÎèôÏ†Å Î°úÎî©
// ============================================
let widgetsLoadedFromD1 = false;

async function loadWidgetsFromD1() {
    // Ïù¥ÎØ∏ Î°úÎìúÎêòÏóàÏúºÎ©¥ Ïä§ÌÇµ
    if (widgetsLoadedFromD1) {
        console.log('‚úÖ Widgets already loaded from D1');
        return;
    }
    
    try {
        console.log('üîÑ Loading widgets from D1 Database...');
        
        // API Ìò∏Ï∂ú (6Í∞ú Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ)
        const categories = [
            'advanced-analytics',
            'museum-professional',
            'visitor-experience',
            'operations',
            'collaboration',
            'financial'
        ];
        
        for (const category of categories) {
            const response = await fetch(`/api/widgets?category=${category}`);
            const data = await response.json();
            
            if (!data.success) {
                console.error(`‚ùå Failed to load ${category} widgets:`, data.error);
                continue;
            }
            
            const widgets = data.data || [];
            console.log(`‚úÖ Loaded ${widgets.length} widgets for category: ${category}`);
            
            // category-content ÏòÅÏó≠ Ï∞æÍ∏∞
            const categoryGroup = document.querySelector(`.category-${category}`);
            if (!categoryGroup) {
                console.warn(`‚ö†Ô∏è Category group not found: ${category}`);
                continue;
            }
            
            const categoryContent = categoryGroup.querySelector('.category-content');
            if (!categoryContent) {
                console.warn(`‚ö†Ô∏è Category content not found: ${category}`);
                continue;
            }
            
            // Í∏∞Ï°¥ Widget Ïú†ÏßÄÌïòÍ≥† ÏÉà Widget Ï∂îÍ∞Ä
            const existingWidgets = categoryContent.querySelectorAll('.widget-item');
            const existingTypes = Array.from(existingWidgets).map(w => w.dataset.widgetType);
            
            widgets.forEach(widget => {
                // Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî WidgetÏùÄ Ïä§ÌÇµ
                if (existingTypes.includes(widget.type)) {
                    return;
                }
                
                // Premium Î±ÉÏßÄ HTML
                const premiumBadge = widget.premium ? 
                    `<span class="premium-badge">‚≠ê PRO</span>` : '';
                
                // Price HTML
                const priceHTML = widget.price ? 
                    `<span class="widget-price">${widget.price}</span>` : '';
                
                // Widget HTML ÏÉùÏÑ±
                const widgetHTML = `
                    <div class="widget-item" draggable="true" data-widget-type="${widget.type}"${widget.premium ? ' data-premium="true"' : ''}>
                        <div class="widget-icon-wrapper">
                            <i data-lucide="${widget.icon || 'box'}" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">${widget.name} ${premiumBadge}</div>
                            <div class="widget-description">${widget.description || ''}</div>
                            ${priceHTML}
                        </div>
                    </div>
                `;
                
                // DOMÏóê Ï∂îÍ∞Ä
                categoryContent.insertAdjacentHTML('beforeend', widgetHTML);
            });
            
            // Lucide Icons Îã§Ïãú Ï¥àÍ∏∞Ìôî
            lucide.createIcons();
        }
        
        widgetsLoadedFromD1 = true;
        console.log('üéâ All widgets loaded from D1 Database!');
        
    } catch (error) {
        console.error('‚ùå Error loading widgets from D1:', error);
    }
}

// Panel Management
const activePanels = { left: null, right: null };
const viewport = document.getElementById('vp');
let scale = 1, translateX = 0, translateY = 0, isDragging = false, startX, startY;

// Pan/Zoom Í∞ùÏ≤¥ (Widget ÎìúÎ°≠ Ï¢åÌëú Í≥ÑÏÇ∞Ïö©)
const pan = { x: 0, y: 0 };
let zoom = 1;

// Touch Support Variables
let lastTouchDistance = 0;
let isTouching = false;

function closePanel(panelId) {
    const panel = document.getElementById(panelId);
    if (!panel) return;
    panel.classList.remove('active');
    activePanels[panel.dataset.side] = null;
    const icon = document.querySelector(`[data-panel="${panelId.replace('Panel', '')}"]`);
    if (icon) icon.classList.remove('active');
}

document.querySelectorAll('.icon').forEach(icon => {
    icon.addEventListener('click', function() {
        const panelName = this.dataset.panel + 'Panel';
        const panel = document.getElementById(panelName);
        if (!panel) return;
        
        const side = panel.dataset.side;
        if (panel.classList.contains('active')) {
            closePanel(panelName);
            this.classList.remove('active');
            return;
        }
        
        if (activePanels[side]) closePanel(activePanels[side]);
        panel.classList.add('active');
        this.classList.add('active');
        activePanels[side] = panelName;
        
        // Widget PanelÏù¥ Ïó¥Î¶¥ Îïå ÎìúÎûòÍ∑∏ Î¶¨Ïä§ÎÑà Îì±Î°ù + D1 DatabaseÏóêÏÑú Widget Î°úÎìú
        if (panelName === 'widgetPanel') {
            // D1 DatabaseÏóêÏÑú Widget ÎèôÏ†Å Î°úÎìú
            loadWidgetsFromD1();
            
            // ÎìúÎûòÍ∑∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
            if (typeof attachWidgetDragListeners === 'function') {
                setTimeout(() => {
                    attachWidgetDragListeners();
                    console.log('üîß Widget Panel Ïó¥Î¶º ‚Üí ÎìúÎûòÍ∑∏ Î¶¨Ïä§ÎÑà Ïû¨Îì±Î°ù');
                }, 300); // D1 Î°úÎî© ÌõÑ Ïã§ÌñâÎêòÎèÑÎ°ù ÏßÄÏó∞
            }
        }
    });
});

// Open initial panels on page load
window.addEventListener('load', function() {
    // Open left panel: Actions
    const leftIcon = document.querySelector('.icon[data-panel="actions"]');
    if (leftIcon) {
        leftIcon.click();
        console.log('‚úÖ ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞î (Actions) ÏûêÎèô Ïó¥Î¶º');
    }
    
    // Open right panel: Stats
    const rightIcon = document.querySelector('.icon[data-panel="stats"]');
    if (rightIcon) {
        rightIcon.click();
        console.log('‚úÖ Ïò§Î•∏Ï™Ω ÏÇ¨Ïù¥ÎìúÎ∞î (Stats) ÏûêÎèô Ïó¥Î¶º');
    }
});

// Canvas Interaction
viewport.addEventListener('mousedown', e => {
    // Don't drag canvas if clicking on a card
    if (e.target.closest('.card')) {
        return;
    }
    
    isDragging = true;
    viewport.classList.add('dragging');
    startX = e.pageX - translateX;
    startY = e.pageY - translateY;
});

document.addEventListener('mousemove', e => {
    if (!isDragging) return;
    e.preventDefault();
    translateX = e.pageX - startX;
    translateY = e.pageY - startY;
    
    // pan Í∞ùÏ≤¥ ÎèôÍ∏∞Ìôî (Widget ÎìúÎ°≠ Ï¢åÌëú Í≥ÑÏÇ∞Ïö©)
    pan.x = translateX;
    pan.y = translateY;
    
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
});

document.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        viewport.classList.remove('dragging');
    }
});

// ============================================
// TOUCH EVENTS for Mobile
// ============================================

// Touch Start
viewport.addEventListener('touchstart', e => {
    if (e.target.closest('.card')) {
        return;
    }
    
    if (e.touches.length === 1) {
        // Single touch - pan
        isTouching = true;
        isDragging = true;
        viewport.classList.add('dragging');
        startX = e.touches[0].pageX - translateX;
        startY = e.touches[0].pageY - translateY;
    } else if (e.touches.length === 2) {
        // Two finger pinch - zoom
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        lastTouchDistance = Math.hypot(
            touch2.pageX - touch1.pageX,
            touch2.pageY - touch1.pageY
        );
    }
}, { passive: false });

// Touch Move
viewport.addEventListener('touchmove', e => {
    if (e.touches.length === 1 && isDragging) {
        // Single touch - pan
        e.preventDefault();
        translateX = e.touches[0].pageX - startX;
        translateY = e.touches[0].pageY - startY;
        viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    } else if (e.touches.length === 2) {
        // Two finger pinch - zoom
        e.preventDefault();
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const currentDistance = Math.hypot(
            touch2.pageX - touch1.pageX,
            touch2.pageY - touch1.pageY
        );
        
        if (lastTouchDistance > 0) {
            const delta = currentDistance - lastTouchDistance;
            scale = Math.max(0.1, Math.min(3, scale * (1 + delta * 0.01)));
            viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
        }
        
        lastTouchDistance = currentDistance;
    }
}, { passive: false });

// Touch End
viewport.addEventListener('touchend', e => {
    if (e.touches.length === 0) {
        isDragging = false;
        isTouching = false;
        viewport.classList.remove('dragging');
        lastTouchDistance = 0;
    }
});

// Zoom
viewport.addEventListener('wheel', e => {
    // Allow zoom with mouse wheel (no Ctrl key required)
    e.preventDefault();
    scale = Math.max(0.1, Math.min(3, scale * (e.deltaY > 0 ? 0.9 : 1.1)));
    zoom = scale; // zoom Î≥ÄÏàò ÎèôÍ∏∞Ìôî
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
});

document.getElementById('zoomIn').addEventListener('click', () => {
    scale = Math.min(3, scale * 1.2);
    zoom = scale; // zoom Î≥ÄÏàò ÎèôÍ∏∞Ìôî
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
});

document.getElementById('zoomOut').addEventListener('click', () => {
    scale = Math.max(0.1, scale * 0.8);
    zoom = scale; // zoom Î≥ÄÏàò ÎèôÍ∏∞Ìôî
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
});

document.getElementById('fitScreen').addEventListener('click', () => {
    scale = 1;
    translateX = 0;
    translateY = 0;
    viewport.style.transform = 'translate(0, 0) scale(1)';
    document.getElementById('zoomLevel').textContent = '100%';
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        // Close all panels
        Object.values(activePanels).forEach(p => p && closePanel(p));
        document.querySelectorAll('.icon.active').forEach(i => i.classList.remove('active'));
        
        // Deselect card
        if (selectedCard) {
            selectedCard.classList.remove('selected');
            selectedCard = null;
        }
    }
    
    // Delete selected card
    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedCard) {
        const cardTitle = selectedCard.querySelector('.card-header').textContent.trim();
        selectedCard.remove();
        selectedCard = null;
        console.log('üóëÔ∏è Ïπ¥Îìú ÏÇ≠Ï†ú:', cardTitle);
        e.preventDefault();
    }
    
    // Panel shortcuts (1-8)
    const num = parseInt(e.key);
    if (num >= 1 && num <= 8) {
        const icons = Array.from(document.querySelectorAll('.icon'));
        icons[num - 1]?.click();
    }
});

// Auto-center card layout calculation
function calculateCenteredLayout() {
    const canvasWidth = window.innerWidth;
    const canvasHeight = window.innerHeight;
    const cardWidth = 300;
    const cardHeight = 350;
    const cols = 3;
    const rows = 3;
    const hGap = 150;
    const vGap = 120;
    
    // Calculate total grid size
    const gridWidth = cols * cardWidth + (cols - 1) * hGap;
    const gridHeight = rows * cardHeight + (rows - 1) * vGap;
    
    // Calculate starting position to center the grid
    const startX = (canvasWidth - gridWidth) / 2;
    const startY = (canvasHeight - gridHeight) / 2 + 100; // +100 for navbar offset
    
    return { startX, startY, hGap, vGap, cardWidth };
}

// Sample Cards with Thumbnails (positions will be auto-calculated)
const cardTemplates = [
    { title: 'ÌôçÎ≥¥ ÏòÅÏÉÅ', content: 'Ï†ÑÏãú ÏÜåÍ∞ú ÏòÅÏÉÅ (3:45)', icon: 'video', type: 'video', size: '125 MB', format: 'MP4', preview: 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4' },
    { title: 'Ïò§ÎîîÏò§ Í∞ÄÏù¥Îìú', content: 'Ï†ÑÏãú Ìï¥ÏÑ§ ÏùåÏÑ± (Ìïú/ÏòÅ)', icon: 'headphones', type: 'audio', size: '8.5 MB', format: 'MP3', preview: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
    { title: 'Ï†ÑÏãú Ìè¨Ïä§ÌÑ∞', content: 'Î©îÏù∏ ÎπÑÏ£ºÏñº ÎîîÏûêÏù∏', icon: 'image', type: 'image', size: '4.2 MB', format: 'PNG', preview: 'https://picsum.photos/400/300?random=1' },
    { title: 'Í¥ÄÎûåÍ∞ù ÌÜµÍ≥Ñ', content: 'ÏõîÍ∞Ñ Î¶¨Ìè¨Ìä∏', icon: 'bar-chart-2', type: 'data', size: '1.8 MB', format: 'XLSX' },
    { title: 'ÌÅêÎ†àÏù¥ÌÑ∞ ÎÖ∏Ìä∏', content: 'ÏûëÌíà Ìï¥ÏÑ§ ÏõêÍ≥†', icon: 'file-text', type: 'document', size: '2.4 MB', format: 'DOCX' },
    { title: '3D Î™®Îç∏', content: 'Ïú†Î¨º Ïä§Ï∫î Îç∞Ïù¥ÌÑ∞', icon: 'box', type: 'data', size: '89 MB', format: 'GLB' },
    { title: 'ÌòÑÏû• ÏÇ¨ÏßÑ', content: 'ÏÑ§Ïπò ÏßÑÌñâ ÏÇ¨ÏßÑ (24Ïû•)', icon: 'camera', type: 'image', size: '45 MB', format: 'JPG', preview: 'https://picsum.photos/400/300?random=2' },
    { title: 'ÌîºÎìúÎ∞±', content: 'Í¥ÄÎûåÍ∞ù ÏùòÍ≤¨ ÏàòÏßë', icon: 'message-circle', type: 'document', size: '512 KB', format: 'PDF' },
    { title: 'ÏùºÏ†ïÌëú', content: 'Ï†ÑÏãú Ïö¥ÏòÅ Ïä§ÏºÄÏ§Ñ', icon: 'calendar', type: 'document', size: '1.2 MB', format: 'PDF' }
];

// Generate cards with auto-centered positions
function generateCenteredCards() {
    const layout = calculateCenteredLayout();
    const cards = cardTemplates.map((template, index) => {
        const row = Math.floor(index / 3);
        const col = index % 3;
        return {
            ...template,
            x: layout.startX + col * (layout.cardWidth + layout.hGap),
            y: layout.startY + row * (layout.cardWidth + layout.vGap)
        };
    });
    return cards;
}

const cards = generateCenteredCards();

// Global variables for card management
let selectedCard = null;
let maxZIndex = 1;

// Create card function with resize handles
function createCard(card) {
    const cardEl = document.createElement('div');
    cardEl.className = 'card';
    cardEl.style.left = card.x + 'px';
    cardEl.style.top = card.y + 'px';
    cardEl.style.zIndex = maxZIndex++;
    cardEl.dataset.type = card.type;
    cardEl.dataset.title = card.title;
    if (card.preview) cardEl.dataset.preview = card.preview;
    
    // Build thumbnail content based on type and preview availability
    let thumbnailContent = '';
    if (card.preview) {
        if (card.type === 'image') {
            thumbnailContent = `<img loading="lazy" src="${card.preview}" alt="${card.title}" style="width:100%;height:100%;object-fit:cover;">`;
        } else if (card.type === 'video') {
            thumbnailContent = `<video src="${card.preview}" style="width:100%;height:100%;object-fit:cover;" muted loop autoplay></video>`;
        } else if (card.type === 'audio') {
            thumbnailContent = `
                <i data-lucide="${card.icon}" style="width:60px;height:60px;color:rgba(255,255,255,0.9);stroke-width:1.5;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);"></i>
                <audio src="${card.preview}" controls style="position:absolute;bottom:10px;left:10px;right:10px;width:calc(100% - 20px);"></audio>
            `;
        } else {
            thumbnailContent = `<i data-lucide="${card.icon}" style="width:60px;height:60px;color:rgba(255,255,255,0.9);stroke-width:1.5"></i>`;
        }
    } else {
        thumbnailContent = `<i data-lucide="${card.icon}" style="width:60px;height:60px;color:rgba(255,255,255,0.9);stroke-width:1.5"></i>`;
    }
    
    cardEl.innerHTML = `
        <div class="card-thumbnail ${card.type}">
            ${thumbnailContent}
        </div>
        <div class="card-header">
            <i data-lucide="${card.icon}" style="width:16px;height:16px"></i>
            ${card.title}
        </div>
        <div class="card-content">
            ${card.content}
            <div class="card-meta">
                <span>üì¶ ${card.size}</span>
                <span>üìÑ ${card.format}</span>
            </div>
        </div>
        
        <!-- Resize Handles -->
        <div class="resize-handle resize-nw"></div>
        <div class="resize-handle resize-n"></div>
        <div class="resize-handle resize-ne"></div>
        <div class="resize-handle resize-e"></div>
        <div class="resize-handle resize-se"></div>
        <div class="resize-handle resize-s"></div>
        <div class="resize-handle resize-sw"></div>
        <div class="resize-handle resize-w"></div>
        
        <!-- Connection Handle (Google Opal Style) -->
        <div class="connection-handle" title="Ïó∞Í≤∞ÏÑ† ÎßåÎì§Í∏∞"></div>
    `;
    
    // Thumbnail click for modal viewer
    const thumbnail = cardEl.querySelector('.card-thumbnail');
    if (thumbnail) {
        thumbnail.addEventListener('click', function(e) {
            e.stopPropagation();
            const type = cardEl.dataset.type;
            const preview = cardEl.dataset.preview;
            const title = cardEl.dataset.title;
            
            if (preview && (type === 'image' || type === 'video')) {
                openModal(type, preview, title);
            }
        });
    }
    
    // Card selection
    cardEl.addEventListener('click', function(e) {
        if (!e.target.classList.contains('resize-handle') && !e.target.closest('.card-thumbnail')) {
            selectCard(cardEl);
            e.stopPropagation();
        }
    });
    
    // Card drag functionality
    let cardDragging = false;
    let cardStartX, cardStartY, cardInitialX, cardInitialY;
    
    const onCardMouseDown = function(e) {
        // Don't drag if clicking on resize handles
        if (e.target.classList.contains('resize-handle')) {
            return;
        }
        
        // Don't drag if clicking on connection handle
        if (e.target.classList.contains('connection-handle')) {
            return;
        }
        
        // Don't drag if clicking on video/audio controls
        if (e.target.tagName === 'VIDEO' || e.target.tagName === 'AUDIO') {
            return;
        }
        
        // Allow drag from anywhere on the card
        cardDragging = true;
        cardStartX = e.clientX;
        cardStartY = e.clientY;
        cardInitialX = parseInt(cardEl.style.left) || 0;
        cardInitialY = parseInt(cardEl.style.top) || 0;
        cardEl.style.cursor = 'grabbing';
        
        // CRITICAL: Prevent canvas from dragging
        e.stopPropagation();
        
        const headerElement = cardEl.querySelector('.card-header');
        console.log('üéØ Ïπ¥Îìú ÎìúÎûòÍ∑∏ ÏãúÏûë:', headerElement ? headerElement.textContent.trim() : 'Unknown');
    };
    
    const onCardMouseMove = function(e) {
        if (cardDragging) {
            e.preventDefault();
            e.stopPropagation();
            
            const deltaX = (e.clientX - cardStartX) / scale;
            const deltaY = (e.clientY - cardStartY) / scale;
            cardEl.style.left = (cardInitialX + deltaX) + 'px';
            cardEl.style.top = (cardInitialY + deltaY) + 'px';
        }
    };
    
    const onCardMouseUp = function() {
        if (cardDragging) {
            cardDragging = false;
            cardEl.style.cursor = 'move';
            console.log('‚úÖ Ïπ¥Îìú ÎìúÎûòÍ∑∏ ÏôÑÎ£å');
        }
    };
    
    cardEl.addEventListener('mousedown', onCardMouseDown);
    document.addEventListener('mousemove', onCardMouseMove);
    document.addEventListener('mouseup', onCardMouseUp);
    
    // Touch Events for Card Dragging
    const onCardTouchStart = function(e) {
        if (e.target.classList.contains('resize-handle') || 
            e.target.classList.contains('connection-handle') ||
            e.target.tagName === 'VIDEO' || 
            e.target.tagName === 'AUDIO') {
            return;
        }
        
        cardDragging = true;
        const touch = e.touches[0];
        cardStartX = touch.clientX;
        cardStartY = touch.clientY;
        cardInitialX = parseInt(cardEl.style.left) || 0;
        cardInitialY = parseInt(cardEl.style.top) || 0;
        
        e.stopPropagation();
        console.log('üéØ Ïπ¥Îìú ÌÑ∞Ïπò ÎìúÎûòÍ∑∏ ÏãúÏûë');
    };
    
    const onCardTouchMove = function(e) {
        if (cardDragging) {
            e.preventDefault();
            e.stopPropagation();
            
            const touch = e.touches[0];
            const deltaX = (touch.clientX - cardStartX) / scale;
            const deltaY = (touch.clientY - cardStartY) / scale;
            cardEl.style.left = (cardInitialX + deltaX) + 'px';
            cardEl.style.top = (cardInitialY + deltaY) + 'px';
        }
    };
    
    const onCardTouchEnd = function() {
        if (cardDragging) {
            cardDragging = false;
            updateAllConnections();
            console.log('‚úÖ Ïπ¥Îìú ÌÑ∞Ïπò ÎìúÎûòÍ∑∏ ÏôÑÎ£å');
        }
    };
    
    cardEl.addEventListener('touchstart', onCardTouchStart, { passive: false });
    cardEl.addEventListener('touchmove', onCardTouchMove, { passive: false });
    cardEl.addEventListener('touchend', onCardTouchEnd);
    
    // Context Menu (Right-click)
    cardEl.addEventListener('contextmenu', (e) => showContextMenu(e, cardEl));
    
    // Resize functionality
    setupResizeHandles(cardEl);
    
    // Connection handle functionality
    setupConnectionHandles(cardEl);
    
    // Update connections when this card moves
    cardEl.addEventListener('mouseup', updateAllConnections);
    cardEl.addEventListener('touchend', updateAllConnections);
    
    viewport.appendChild(cardEl);
    return cardEl;
}

// Card selection management
function selectCard(cardEl) {
    // Deselect previous card
    if (selectedCard) {
        selectedCard.classList.remove('selected');
    }
    
    // Select new card and bring to front
    selectedCard = cardEl;
    cardEl.classList.add('selected');
    cardEl.style.zIndex = maxZIndex++;
    
    console.log('‚úÖ Ïπ¥Îìú ÏÑ†ÌÉù:', cardEl.querySelector('.card-header').textContent.trim());
}

// Deselect when clicking canvas
viewport.addEventListener('click', function(e) {
    if (e.target === viewport && selectedCard) {
        selectedCard.classList.remove('selected');
        selectedCard = null;
    }
});

// Resize handles setup
function setupResizeHandles(cardEl) {
    const handles = cardEl.querySelectorAll('.resize-handle');
    
    handles.forEach(handle => {
        handle.addEventListener('mousedown', function(e) {
            e.stopPropagation();
            const direction = Array.from(handle.classList).find(c => c.startsWith('resize-')).replace('resize-', '');
            
            const startX = e.clientX;
            const startY = e.clientY;
            const startWidth = cardEl.offsetWidth;
            const startHeight = cardEl.offsetHeight;
            const startLeft = parseInt(cardEl.style.left) || 0;
            const startTop = parseInt(cardEl.style.top) || 0;
            
            function onMouseMove(e) {
                const deltaX = (e.clientX - startX) / scale;
                const deltaY = (e.clientY - startY) / scale;
                
                if (direction.includes('e')) {
                    cardEl.style.width = Math.max(200, startWidth + deltaX) + 'px';
                }
                if (direction.includes('w')) {
                    const newWidth = Math.max(200, startWidth - deltaX);
                    cardEl.style.width = newWidth + 'px';
                    cardEl.style.left = (startLeft + (startWidth - newWidth)) + 'px';
                }
                if (direction.includes('s')) {
                    cardEl.style.height = Math.max(200, startHeight + deltaY) + 'px';
                }
                if (direction.includes('n')) {
                    const newHeight = Math.max(200, startHeight - deltaY);
                    cardEl.style.height = newHeight + 'px';
                    cardEl.style.top = (startTop + (startHeight - newHeight)) + 'px';
                }
            }
            
            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                console.log('‚úÖ Ïπ¥Îìú ÌÅ¨Í∏∞ Ï°∞Ï†à ÏôÑÎ£å:', cardEl.offsetWidth + 'x' + cardEl.offsetHeight);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });
}

// Google Opal Style Connection System
const connections = [];
let connectingFrom = null;

function createConnection(fromCard, toCard) {
    const conn = {
        from: fromCard,
        to: toCard,
        line: null
    };
    connections.push(conn);
    updateConnectionLine(conn);
    return conn;
}

function updateConnectionLine(conn) {
    // Get card positions directly from their style properties
    const fromX = parseInt(conn.from.style.left) || 0;
    const fromY = parseInt(conn.from.style.top) || 0;
    const fromWidth = conn.from.offsetWidth;
    const fromHeight = conn.from.offsetHeight;
    
    const toX = parseInt(conn.to.style.left) || 0;
    const toY = parseInt(conn.to.style.top) || 0;
    const toWidth = conn.to.offsetWidth;
    const toHeight = conn.to.offsetHeight;
    
    // Calculate connection points (right side of from card, left side of to card)
    const startX = fromX + fromWidth;
    const startY = fromY + fromHeight / 2;
    const endX = toX;
    const endY = toY + toHeight / 2;
    
    const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
    
    if (!conn.line) {
        conn.line = document.createElement('div');
        conn.line.className = 'card-connector';
        viewport.appendChild(conn.line);
    }
    
    conn.line.style.left = startX + 'px';
    conn.line.style.top = startY + 'px';
    conn.line.style.width = distance + 'px';
    conn.line.style.transform = `rotate(${angle}deg)`;
}

function updateAllConnections() {
    connections.forEach(conn => updateConnectionLine(conn));
}

// Setup connection handles for each card
function setupConnectionHandles(cardEl) {
    const handle = cardEl.querySelector('.connection-handle');
    
    handle.addEventListener('mousedown', function(e) {
        e.stopPropagation();
        e.preventDefault();
        
        connectingFrom = cardEl;
        handle.style.background = '#f59e0b';
        handle.style.boxShadow = '0 0 20px rgba(245, 158, 11, 0.8)';
        
        console.log('üîó Ïó∞Í≤∞ ÏãúÏûë:', cardEl.querySelector('.card-header').textContent.trim());
    });
}

// Listen for connection target
document.addEventListener('click', function(e) {
    if (connectingFrom) {
        const targetCard = e.target.closest('.card');
        
        if (targetCard && targetCard !== connectingFrom) {
            createConnection(connectingFrom, targetCard);
            console.log('‚úÖ Ïπ¥Îìú Ïó∞Í≤∞:', 
                connectingFrom.querySelector('.card-header').textContent.trim(), 
                '‚Üí', 
                targetCard.querySelector('.card-header').textContent.trim()
            );
        }
        
        // Reset connection state
        const handle = connectingFrom.querySelector('.connection-handle');
        handle.style.background = '';
        handle.style.boxShadow = '';
        connectingFrom = null;
    }
});

// Update connections on viewport transformation
const viewportObserver = new MutationObserver(updateAllConnections);
viewportObserver.observe(viewport, { attributes: true, attributeFilter: ['style'] });

// Create all initial cards
cards.forEach(card => createCard(card));

// Global function to add AI-generated content cards
window.addAICard = function(type, title, content, imageUrl = null) {
    const newCard = {
        title: title,
        content: content,
        icon: type === 'image' ? 'image' : type === 'video' ? 'video' : type === 'audio' ? 'headphones' : 'file',
        type: type,
        size: 'AI Generated',
        format: type.toUpperCase(),
        x: Math.random() * 500 + 100,
        y: Math.random() * 400 + 100
    };
    
    const cardEl = createCard(newCard);
    
    // If image/video URL provided, replace thumbnail
    if (imageUrl && (type === 'image' || type === 'video')) {
        const thumbnail = cardEl.querySelector('.card-thumbnail');
        thumbnail.innerHTML = type === 'image' 
            ? `<img loading="lazy" src="${imageUrl}" alt="${title}">`
            : `<video src="${imageUrl}" controls></video>`;
    }
    
    lucide.createIcons();
    selectCard(cardEl);
    
    console.log('‚úÖ AI ÏÉùÏÑ± Ïπ¥Îìú Ï∂îÍ∞Ä:', title, '(' + type + ')');
    return cardEl;
};

// ============================================
// Context Menu Functions
// ============================================
function showContextMenu(e, nodeElement) {
    e.preventDefault();
    e.stopPropagation();
    
    const contextMenu = document.getElementById('contextMenu');
    contextMenuTarget = nodeElement;
    
    // Position context menu
    contextMenu.style.left = e.pageX + 'px';
    contextMenu.style.top = e.pageY + 'px';
    contextMenu.style.display = 'block';
    
    // Re-initialize Lucide icons
    lucide.createIcons();
    
    console.log('üìã Context Menu Ïó¥Î¶º:', nodeElement.querySelector('.card-header')?.textContent || 'Node');
}

function hideContextMenu() {
    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.display = 'none';
    contextMenuTarget = null;
}

function editNodeFromContextMenu() {
    if (!contextMenuTarget) return;
    
    const nodeHeader = contextMenuTarget.querySelector('.card-header')?.textContent || '';
    const nodeDesc = contextMenuTarget.querySelector('.card-description')?.textContent || '';
    const currentColor = contextMenuTarget.style.borderColor || '#FFFFFF';
    
    // Open edit modal
    document.getElementById('editWidgetName').value = nodeHeader;
    document.getElementById('editWidgetDescription').value = nodeDesc;
    selectedColor = currentColor;
    
    // Highlight selected color
    document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.color === currentColor);
    });
    
    document.getElementById('editModal').style.display = 'flex';
    currentEditingNode = contextMenuTarget;
    
    hideContextMenu();
    console.log('‚úèÔ∏è Edit Î™®Îã¨ Ïó¥Î¶º:', nodeHeader);
}

function duplicateNodeFromContextMenu() {
    if (!contextMenuTarget) return;
    
    const original = contextMenuTarget;
    const clone = original.cloneNode(true);
    
    // Offset position
    const originalX = parseInt(original.style.left) || 0;
    const originalY = parseInt(original.style.top) || 0;
    clone.style.left = (originalX + 30) + 'px';
    clone.style.top = (originalY + 30) + 'px';
    
    // Add to viewport
    viewport.appendChild(clone);
    
    // Re-attach event listeners
    makeCardDraggable(clone);
    addResizeHandles(clone);
    addConnectionHandle(clone);
    
    // Add context menu listener
    clone.addEventListener('contextmenu', (e) => showContextMenu(e, clone));
    
    selectCard(clone);
    lucide.createIcons();
    
    hideContextMenu();
    
    const nodeName = original.querySelector('.card-header')?.textContent || 'Node';
    console.log('üìã ÎÖ∏Îìú Î≥µÏ†ú ÏôÑÎ£å:', nodeName);
    
    // Sync to Dashboard
    syncCanvasToDashboard();
}

function deleteNodeFromContextMenu() {
    if (!contextMenuTarget) return;
    
    const nodeName = contextMenuTarget.querySelector('.card-header')?.textContent || 'Node';
    
    if (confirm(`"${nodeName}" ÎÖ∏ÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
        // Remove all connections
        const connections = document.querySelectorAll('.connection-line');
        connections.forEach(conn => {
            if (conn.dataset.from === contextMenuTarget.id || conn.dataset.to === contextMenuTarget.id) {
                conn.remove();
            }
        });
        
        // Remove node
        contextMenuTarget.remove();
        
        console.log('üóëÔ∏è ÎÖ∏Îìú ÏÇ≠Ï†ú ÏôÑÎ£å:', nodeName);
        
        // Sync to Dashboard
        syncCanvasToDashboard();
    }
    
    hideContextMenu();
}

// Close context menu on outside click
document.addEventListener('click', hideContextMenu);

// Modal Viewer Functions
function openModal(type, url, title) {
    const modal = document.getElementById('modalViewer');
    const content = document.getElementById('modalContent');
    
    if (type === 'image') {
        content.innerHTML = `<img loading="lazy" src="${url}" alt="${title}">`;
    } else if (type === 'video') {
        content.innerHTML = `<video src="${url}" controls autoplay style="outline: none;"></video>`;
    }
    
    modal.classList.add('active');
    console.log('üñºÔ∏è Î™®Îã¨ Ïó¥Î¶º:', title);
}

function closeModal() {
    const modal = document.getElementById('modalViewer');
    const content = document.getElementById('modalContent');
    
    // Stop video if playing
    const video = content.querySelector('video');
    if (video) {
        video.pause();
        video.currentTime = 0;
    }
    
    modal.classList.remove('active');
    content.innerHTML = '';
    console.log('‚ùå Î™®Îã¨ Îã´Ìûò');
}

// ============================================
// Edit Modal Functions
// ============================================
function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    currentEditingNode = null;
    selectedColor = '#FFFFFF';
    console.log('‚ùå Edit Î™®Îã¨ Îã´Ìûò');
}

function saveWidgetEdit() {
    if (!currentEditingNode) return;
    
    const newName = document.getElementById('editWidgetName').value.trim();
    const newDesc = document.getElementById('editWidgetDescription').value.trim();
    
    if (!newName) {
        alert('ÏúÑÏ†Ø Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
    }
    
    // Update node
    const header = currentEditingNode.querySelector('.card-header');
    const desc = currentEditingNode.querySelector('.card-description');
    
    if (header) header.textContent = newName;
    if (desc) desc.textContent = newDesc;
    
    // Update color
    currentEditingNode.style.borderColor = selectedColor;
    currentEditingNode.style.boxShadow = `0 4px 20px ${selectedColor}33`;
    
    // Save to localStorage
    const widgetId = currentEditingNode.id || `widget-${Date.now()}`;
    if (!currentEditingNode.id) currentEditingNode.id = widgetId;
    
    saveWidgetConfig(widgetId, {
        name: newName,
        description: newDesc,
        color: selectedColor,
        x: parseInt(currentEditingNode.style.left) || 0,
        y: parseInt(currentEditingNode.style.top) || 0,
        width: currentEditingNode.offsetWidth,
        height: currentEditingNode.offsetHeight
    });
    
    closeEditModal();
    
    // Sync to Dashboard
    syncCanvasToDashboard();
    
    console.log('üíæ ÏúÑÏ†Ø Ìé∏Ïßë Ï†ÄÏû• ÏôÑÎ£å:', newName);
}

// Color picker event listeners
document.addEventListener('DOMContentLoaded', () => {
    const colorOptions = document.querySelectorAll('.color-option');
    
    colorOptions.forEach(option => {
        option.addEventListener('click', () => {
            selectedColor = option.dataset.color;
            
            colorOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            console.log('üé® ÏÉâÏÉÅ ÏÑ†ÌÉù:', selectedColor);
        });
    });
});

// Close edit modal on outside click
document.addEventListener('click', (e) => {
    const editModal = document.getElementById('editModal');
    if (e.target === editModal) {
        closeEditModal();
    }
});

// Close modal on overlay click
document.getElementById('modalViewer').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Close modal on Escape key  
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('modalViewer');
        if (modal.classList.contains('active')) {
            closeModal();
        }
    }
});

// Auto-create workflow connections based on typical museum workflow
function createAutoWorkflowConnections() {
    const allCards = document.querySelectorAll('.card');
    const cardsByTitle = {};
    
    allCards.forEach(card => {
        const title = card.dataset.title;
        if (title) cardsByTitle[title] = card;
    });
    
    // Define workflow connections (from ‚Üí to)
    const workflowConnections = [
        ['ÌôçÎ≥¥ ÏòÅÏÉÅ', 'Ï†ÑÏãú Ìè¨Ïä§ÌÑ∞'],      // Video ‚Üí Poster design
        ['Ï†ÑÏãú Ìè¨Ïä§ÌÑ∞', 'ÌòÑÏû• ÏÇ¨ÏßÑ'],      // Poster ‚Üí Site photos
        ['Ïò§ÎîîÏò§ Í∞ÄÏù¥Îìú', 'ÌÅêÎ†àÏù¥ÌÑ∞ ÎÖ∏Ìä∏'], // Audio guide ‚Üí Curator notes
        ['Í¥ÄÎûåÍ∞ù ÌÜµÍ≥Ñ', 'ÌîºÎìúÎ∞±'],         // Stats ‚Üí Feedback
        ['3D Î™®Îç∏', 'Í¥ÄÎûåÍ∞ù ÌÜµÍ≥Ñ'],        // 3D model ‚Üí Stats
        ['ÌòÑÏû• ÏÇ¨ÏßÑ', 'ÏùºÏ†ïÌëú']            // Photos ‚Üí Schedule
    ];
    
    // Create connections
    workflowConnections.forEach(([fromTitle, toTitle]) => {
        const fromCard = cardsByTitle[fromTitle];
        const toCard = cardsByTitle[toTitle];
        
        if (fromCard && toCard) {
            createConnection(fromCard, toCard);
            console.log('üîó ÏûêÎèô Ïó∞Í≤∞:', fromTitle, '‚Üí', toTitle);
        }
    });
    
    console.log('‚úÖ ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏûêÎèô Ïó∞Í≤∞ ÏôÑÎ£å:', workflowConnections.length, 'Í∞ú Ïó∞Í≤∞');
}

// Initialize auto workflow after cards are created
setTimeout(() => {
    createAutoWorkflowConnections();
}, 500);

// ============================================
// Canvas-Dashboard Îç∞Ïù¥ÌÑ∞ Ïó∞Îèô
// ============================================

/**
 * DashboardÎ°ú Canvas ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÑÏÜ°
 * @param {string} updateType - 'canvas_nodes' ÎòêÎäî 'dashboard_widgets'
 * @param {object} updateData - { title, items[] }
 */
function sendToDashboard(updateType, updateData) {
    try {
        const updates = JSON.parse(localStorage.getItem('dashboard_updates') || '[]');
        
        updates.push({
            type: updateType,
            title: updateData.title || 'Canvas ÏóÖÎç∞Ïù¥Ìä∏',
            data: updateData.items || [],
            timestamp: Date.now()
        });
        
        localStorage.setItem('dashboard_updates', JSON.stringify(updates));
        console.log(`‚úÖ [Canvas ‚Üí Dashboard] Sent ${updateType}:`, updateData.title, `(${updateData.items?.length || 0} items)`);
    } catch (error) {
        console.error('‚ùå [Canvas ‚Üí Dashboard] Error:', error);
    }
}

/**
 * Canvas ÏÉÅÌÉúÎ•º DashboardÎ°ú Ï†ÑÏÜ°
 */
function syncCanvasStateToDashboard() {
    const cards = Array.from(viewport.querySelectorAll('.card'));
    
    if (cards.length === 0) return;
    
    const cardData = cards.map(card => {
        const header = card.querySelector('.card-header');
        const content = card.querySelector('.card-content p');
        
        return {
            title: header ? header.textContent.trim() : 'Untitled',
            content: content ? content.textContent.trim() : '',
            x: card.style.left,
            y: card.style.top,
            status: 'active',
            timestamp: Date.now()
        };
    });
    
    sendToDashboard('canvas_nodes', {
        title: `Canvas ÏÉÅÌÉú (${cards.length}Í∞ú ÎÖ∏Îìú)`,
        items: cardData
    });
}

// Ïπ¥Îìú ÏÇ≠Ï†ú Ïãú Dashboard ÏïåÎ¶º
document.addEventListener('keydown', e => {
    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedCard) {
        const cardTitle = selectedCard.querySelector('.card-header').textContent.trim();
        
        // DashboardÎ°ú ÏÇ≠Ï†ú ÏïåÎ¶º Ï†ÑÏÜ°
        sendToDashboard('canvas_nodes', {
            title: 'Ïπ¥Îìú ÏÇ≠Ï†ú',
            items: [{ 
                title: cardTitle, 
                status: 'deleted',
                timestamp: Date.now()
            }]
        });
    }
});

// Ï¥àÍ∏∞ Canvas ÏÉÅÌÉú Ï†ÑÏÜ° (ÌéòÏù¥ÏßÄ Î°úÎìú ÌõÑ 2Ï¥à ÌõÑ)
setTimeout(() => {
    syncCanvasStateToDashboard();
    console.log('üöÄ [Canvas ‚Üí Dashboard] Initial sync completed');
}, 2000);

// ÏûêÎèô ÎèôÍ∏∞Ìôî (10Ï¥àÎßàÎã§)
setInterval(() => {
    syncCanvasStateToDashboard();
}, 10000);

// localStorage Ï†ÄÏû• Ìï®Ïàò (Canvas ÏÉÅÌÉú Î≥µÏõêÏö©)
function saveCanvasState() {
    const cards = Array.from(viewport.querySelectorAll('.card'));
    
    const state = {
        cards: cards.map(card => ({
            id: card.dataset.id || Math.random().toString(36).substr(2, 9),
            title: card.querySelector('.card-header')?.textContent.trim() || '',
            content: card.querySelector('.card-content p')?.textContent.trim() || '',
            x: card.style.left,
            y: card.style.top,
            width: card.style.width,
            height: card.style.height
        })),
        connections: connections.map(conn => ({
            from: conn.from.querySelector('.card-header')?.textContent.trim() || '',
            to: conn.to.querySelector('.card-header')?.textContent.trim() || ''
        })),
        viewport: {
            translateX,
            translateY,
            scale
        },
        timestamp: Date.now()
    };
    
    localStorage.setItem('canvas_state', JSON.stringify(state));
    console.log('üíæ Canvas ÏÉÅÌÉú Ï†ÄÏû•Îê®:', cards.length, 'Í∞ú Ïπ¥Îìú');
}

// ÏûêÎèô Ï†ÄÏû• (10Ï¥àÎßàÎã§)
setInterval(saveCanvasState, 10000);

// ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å Ïãú Ï†ÄÏû•
window.addEventListener('beforeunload', () => {
    saveCanvasState();
    syncCanvasStateToDashboard();
});

console.log('‚úÖ Canvas-Dashboard Ïó∞Îèô Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');

// ============================================
// AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ Í∏∞Îä•
// ============================================

/**
 * AI ÏùëÎãµ ÌëúÏãú Ìï®Ïàò
 */
function showAIResponse(message, isError = false) {
    const aiPanel = document.getElementById('aiPanel');
    const panelContent = aiPanel.querySelector('.panel-content > div');
    
    // AI Ìå®ÎÑê ÏûêÎèô Ïó¥Í∏∞
    if (!aiPanel.classList.contains('active')) {
        document.querySelector('[data-panel="ai"]').click();
    }
    
    // ÏùëÎãµ Î©îÏãúÏßÄ Ï∂îÍ∞Ä
    const responseHtml = `
        <div style="padding: 0.75rem; background: ${isError ? 'rgba(239, 68, 68, 0.1)' : 'rgba(139, 92, 246, 0.1)'}; border-radius: 8px; border-left: 3px solid ${isError ? '#EF4444' : '#8B5CF6'}; margin-bottom: 0.75rem;">
            <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">${new Date().toLocaleTimeString('ko-KR')}</div>
            <div style="font-size: 0.9375rem; color: #e5e5e5; line-height: 1.5;">${message}</div>
        </div>
    `;
    
    panelContent.insertAdjacentHTML('afterbegin', responseHtml);
    
    // ÏµúÎåÄ 10Í∞ú ÏùëÎãµÎßå Ïú†ÏßÄ
    const responses = panelContent.querySelectorAll('div[style*="padding: 0.75rem"]');
    if (responses.length > 10) {
        responses[responses.length - 1].remove();
    }
}

/**
 * AI API Ìò∏Ï∂ú Ìï®Ïàò
 */
async function callAI(message, model = 'GPT-4o') {
    try {
        showAIResponse(`ü§ñ AI Î∂ÑÏÑù Ï§ë... (${model})`, false);
        
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                model: model,
                context: {
                    page: 'canvas',
                    cardCount: viewport.querySelectorAll('.card').length,
                    connections: connections.length
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`AI API ÏóêÎü¨: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.response) {
            showAIResponse(data.response, false);
            console.log('‚úÖ [Canvas AI] Response:', data.response);
            
            // DashboardÎ°ú AI ÌôúÎèô Ï†ÑÏÜ°
            sendToDashboard('dashboard_widgets', {
                title: 'AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ ÌôúÎèô',
                items: [{
                    title: `AI ÏßàÎ¨∏: ${message.substring(0, 30)}...`,
                    content: data.response.substring(0, 100),
                    status: 'completed',
                    timestamp: Date.now()
                }]
            });
        } else {
            throw new Error(data.error || 'AI ÏùëÎãµ Ïã§Ìå®');
        }
    } catch (error) {
        console.error('‚ùå [Canvas AI] Error:', error);
        showAIResponse(`‚ùå AI Ïò§Î•ò: ${error.message}`, true);
    }
}

/**
 * AI ÏûÖÎ†• Ï†ÑÏÜ° Ï≤òÎ¶¨
 */
function sendAIMessage() {
    const input = document.getElementById('aiInput');
    const select = document.querySelector('.ai-select');
    const message = input.value.trim();
    
    if (!message) {
        showAIResponse('‚ùå Î©îÏãúÏßÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', true);
        return;
    }
    
    const model = select.value;
    console.log(`üì§ [Canvas AI] Sending: "${message}" (${model})`);
    
    // AI Ìò∏Ï∂ú
    callAI(message, model);
    
    // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
    input.value = '';
}

// AI Ï†ÑÏÜ° Î≤ÑÌäº Ïù¥Î≤§Ìä∏
document.querySelector('.ai-send')?.addEventListener('click', sendAIMessage);

// AI ÏûÖÎ†•Ï∞Ω Enter ÌÇ§ Ïù¥Î≤§Ìä∏
document.getElementById('aiInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendAIMessage();
    }
});

console.log('‚úÖ Canvas AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');

// ============================================
// Widget ÎìúÎûòÍ∑∏Ïï§ÎìúÎ°≠ Ï¥àÍ∏∞Ìôî (MutationObserver + DOM Ready)
// ============================================

// DOM Ready ÌõÑ Ï¥àÍ∏∞ Î¶¨Ïä§ÎÑà Îì±Î°ù
document.addEventListener('DOMContentLoaded', () => {
    attachWidgetDragListeners();
    console.log('üîß DOMContentLoaded: Widget ÎìúÎûòÍ∑∏ Î¶¨Ïä§ÎÑà Ï¥àÍ∏∞Ìôî');
});

// MutationObserverÎ°ú ÎèôÏ†Å Widget Í∞êÏßÄ
const widgetPanel = document.getElementById('widgetPanel');
if (widgetPanel) {
    const observer = new MutationObserver(() => {
        attachWidgetDragListeners();
    });
    
    observer.observe(widgetPanel, {
        childList: true,
        subtree: true
    });
    
    console.log('‚úÖ Widget ÎèôÏ†Å Í∞êÏßÄ ÏãúÏä§ÌÖú ÌôúÏÑ±Ìôî');
} else {
    console.error('‚ùå widgetPanel ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
}

// Canvas Ï†ÑÏ≤¥ ÏòÅÏó≠Ïóê ÎìúÎ°≠ Í∞ÄÎä•ÌïòÎèÑÎ°ù ÏÑ§Ï†ï
// Canvas ÏòÅÏó≠ = .canvas ÌÅ¥ÎûòÏä§ (viewportÏùò Î∂ÄÎ™® Ïª®ÌÖåÏù¥ÎÑà)
const canvasContainer = document.querySelector('.canvas');

if (canvasContainer && viewport) {
    // Canvas Ï†ÑÏ≤¥ ÏòÅÏó≠Ïóê dragover Ïù¥Î≤§Ìä∏
    canvasContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        // console.log('üéØ dragover Ïù¥Î≤§Ìä∏ Î∞úÏÉù'); // ÎîîÎ≤ÑÍπÖÏö© (ÎÑàÎ¨¥ ÎßéÏù¥ Ï∂úÎ†•ÎêòÎØÄÎ°ú Ï£ºÏÑù)
    });

    // Canvas Ï†ÑÏ≤¥ ÏòÅÏó≠Ïóê drop Ïù¥Î≤§Ìä∏
    canvasContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        console.log('üíß DROP Ïù¥Î≤§Ìä∏ Î∞úÏÉù!', 'draggedWidgetData:', draggedWidgetData);
        console.log('üìç Drop ÏúÑÏπò:', `clientX=${e.clientX}, clientY=${e.clientY}`);
        
        if (!draggedWidgetData) {
            console.error('‚ùå CRITICAL: draggedWidgetData is null!');
            console.error('   ‚Üí dragstart Ïù¥Î≤§Ìä∏Í∞Ä Î∞úÏÉùÌïòÏßÄ ÏïäÏïòÍ±∞ÎÇò, WidgetÏóê ÎìúÎûòÍ∑∏ Î¶¨Ïä§ÎÑàÍ∞Ä Îì±Î°ùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
            console.error('   ‚Üí Widget PanelÏù¥ Ïó¥Î†§ÏûàÍ≥†, CategoryÍ∞Ä ÌéºÏ≥êÏ†∏ ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
            return;
        }
        
        console.log('‚úÖ draggedWidgetData ÌôïÏù∏Îê®:', draggedWidgetData);
        
        // Canvas Ï¢åÌëú Í≥ÑÏÇ∞ (Canvas Ïª®ÌÖåÏù¥ÎÑà Í∏∞Ï§Ä)
        const canvasRect = canvasContainer.getBoundingClientRect();
        const x = e.clientX - canvasRect.left - pan.x;
        const y = e.clientY - canvasRect.top - pan.y;
        
        // Widget Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (createCard Ìï®Ïàò ÏÇ¨Ïö©)
        const widgetCard = {
            title: draggedWidgetData.name,
            content: draggedWidgetData.description || 'ÏúÑÏ†Ø ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§.',
            type: 'widget',
            icon: 'box',
            size: 'Widget',
            format: draggedWidgetData.isPremium ? 'Premium' : 'Free',
            x: x / zoom,
            y: y / zoom
        };
        
        // createCard Ìï®ÏàòÎ°ú Ïπ¥Îìú ÏÉùÏÑ± (Í∏∞Ï°¥ Ìï®Ïàò Ïû¨ÏÇ¨Ïö©)
        const card = createCard(widgetCard);
        
        // Widget ÌÉÄÏûÖ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
        card.dataset.widgetType = draggedWidgetData.type;
        card.dataset.isPremium = draggedWidgetData.isPremium;
    
        // Premium Î±ÉÏßÄ Ï∂îÍ∞Ä
        if (draggedWidgetData.isPremium) {
            const header = card.querySelector('.card-header');
            if (header) {
                const premiumBadge = document.createElement('span');
                premiumBadge.className = 'badge-premium';
                premiumBadge.textContent = '‚≠ê PRO';
                premiumBadge.style.cssText = `
                    display: inline-block;
                    margin-left: 8px;
                    padding: 2px 6px;
                    font-size: 9px;
                    font-weight: 600;
                    background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
                    border-radius: 4px;
                    color: white;
                `;
                header.appendChild(premiumBadge);
            }
        }
        
        viewport.appendChild(card);
        console.log('‚úÖ CardÍ∞Ä viewportÏóê Ï∂îÍ∞ÄÎê®');
        
        // Lucide ÏïÑÏù¥ÏΩò Î†åÎçîÎßÅ
        lucide.createIcons();
        console.log('‚úÖ Lucide ÏïÑÏù¥ÏΩò Î†åÎçîÎßÅ ÏôÑÎ£å');
        
        // Dashboard ÎèôÍ∏∞Ìôî
        setTimeout(() => {
            syncCanvasStateToDashboard();
            console.log('‚úÖ Dashboard ÎèôÍ∏∞Ìôî ÏôÑÎ£å');
        }, 100);
        
        console.log('üéâ Widget ÎÖ∏Îìú ÏÉùÏÑ± ÏôÑÎ£å:', draggedWidgetData.name, `at (${Math.round(x / zoom)}, ${Math.round(y / zoom)})`);
        
        // ÎìúÎûòÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
        draggedWidgetData = null;
    });
    
    console.log('‚úÖ Canvas Ï†ÑÏ≤¥ ÏòÅÏó≠ ÎìúÎ°≠ Ïù¥Î≤§Ìä∏ Îì±Î°ù ÏôÑÎ£å (.canvas)');
} else {
    console.error('‚ùå Canvas Ïª®ÌÖåÏù¥ÎÑà ÎòêÎäî viewport ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!');
}

console.log('‚úÖ Widget ÎìúÎûòÍ∑∏Ïï§ÎìúÎ°≠ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');

// ============================================
// Command Palette (Cmd+K) Í∏∞Îä•
// ============================================

const commandPaletteOverlay = document.getElementById('commandPaletteOverlay');
const commandSearchInput = document.getElementById('commandSearchInput');
const commandPaletteBody = document.getElementById('commandPaletteBody');
let selectedCommandIndex = 0;
let filteredCommands = [];

// Î™®Îì† Widget Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
function getAllWidgets() {
    const widgets = [];
    document.querySelectorAll('.widget-item').forEach(widget => {
        const widgetType = widget.dataset.widgetType;
        const widgetName = widget.querySelector('.widget-name')?.textContent || '';
        const widgetDesc = widget.querySelector('.widget-description')?.textContent || '';
        const isPremium = widget.querySelector('.badge-premium') !== null;
        const categoryGroup = widget.closest('.category-group');
        const category = categoryGroup?.querySelector('.category-name')?.textContent || 'General';
        const iconElement = widget.querySelector('.widget-icon-wrapper i');
        const iconName = iconElement?.getAttribute('data-lucide') || 'box';
        
        widgets.push({
            type: widgetType,
            name: widgetName,
            description: widgetDesc,
            isPremium: isPremium,
            category: category,
            icon: iconName
        });
    });
    return widgets;
}

// Command Palette Ïó¥Í∏∞
function openCommandPalette() {
    commandPaletteOverlay.classList.add('active');
    commandSearchInput.value = '';
    commandSearchInput.focus();
    selectedCommandIndex = 0;
    renderCommandList('');
}

// Command Palette Îã´Í∏∞
function closeCommandPalette() {
    commandPaletteOverlay.classList.remove('active');
}

// Command Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ
function renderCommandList(query) {
    const allWidgets = getAllWidgets();
    
    // Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅ
    if (query.trim()) {
        filteredCommands = allWidgets.filter(widget => 
            widget.name.toLowerCase().includes(query.toLowerCase()) ||
            widget.description.toLowerCase().includes(query.toLowerCase()) ||
            widget.category.toLowerCase().includes(query.toLowerCase())
        );
    } else {
        filteredCommands = allWidgets;
    }
    
    // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥ÑÎ°ú Í∑∏Î£πÌôî
    const categories = {};
    filteredCommands.forEach(widget => {
        if (!categories[widget.category]) {
            categories[widget.category] = [];
        }
        categories[widget.category].push(widget);
    });
    
    // HTML ÏÉùÏÑ±
    if (filteredCommands.length === 0) {
        commandPaletteBody.innerHTML = `
            <div class="command-palette-empty">
                <i data-lucide="search-x" class="command-palette-empty-icon"></i>
                <div class="command-palette-empty-text">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>
            </div>
        `;
    } else {
        let html = '';
        Object.keys(categories).forEach((category, catIndex) => {
            html += `<div class="command-category">${category}</div>`;
            categories[category].forEach((widget, widgetIndex) => {
                const globalIndex = filteredCommands.indexOf(widget);
                const selectedClass = globalIndex === selectedCommandIndex ? 'selected' : '';
                html += `
                    <div class="command-item ${selectedClass}" data-index="${globalIndex}">
                        <i data-lucide="${widget.icon}" class="command-item-icon"></i>
                        <div class="command-item-info">
                            <div class="command-item-name">${widget.name}</div>
                            <div class="command-item-desc">${widget.description}</div>
                        </div>
                        ${widget.isPremium ? '<span class="command-item-badge">‚≠ê PRO</span>' : ''}
                    </div>
                `;
            });
        });
        commandPaletteBody.innerHTML = html;
    }
    
    // Lucide ÏïÑÏù¥ÏΩò Îã§Ïãú Î†åÎçîÎßÅ
    lucide.createIcons();
    
    // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
    document.querySelectorAll('.command-item').forEach(item => {
        item.addEventListener('click', () => {
            const index = parseInt(item.dataset.index);
            selectCommand(index);
        });
    });
}

// Command ÏÑ†ÌÉù (Enter ÌÇ§ ÎòêÎäî ÌÅ¥Î¶≠)
function selectCommand(index) {
    if (index < 0 || index >= filteredCommands.length) return;
    
    const widget = filteredCommands[index];
    
    // Canvas Ï§ëÏïôÏóê ÎÖ∏Îìú ÏÉùÏÑ±
    const viewportRect = viewport.getBoundingClientRect();
    const centerX = (viewportRect.width / 2 - pan.x) / zoom;
    const centerY = (viewportRect.height / 2 - pan.y) / zoom;
    
    const card = createCardElement(
        widget.name,
        widget.description,
        centerX - 90, // Ïπ¥Îìú ÎÑàÎπÑ Ï†àÎ∞òÎßåÌÅº ÏôºÏ™ΩÏúºÎ°ú
        centerY - 40  // Ïπ¥Îìú ÎÜíÏù¥ Ï†àÎ∞òÎßåÌÅº ÏúÑÎ°ú
    );
    
    // Widget ÌÉÄÏûÖ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
    card.dataset.widgetType = widget.type;
    card.dataset.isPremium = widget.isPremium;
    
    // Premium Î±ÉÏßÄ Ï∂îÍ∞Ä
    if (widget.isPremium) {
        const header = card.querySelector('.card-header');
        if (header) {
            const premiumBadge = document.createElement('span');
            premiumBadge.className = 'badge-premium';
            premiumBadge.textContent = '‚≠ê PRO';
            premiumBadge.style.cssText = `
                display: inline-block;
                margin-left: 8px;
                padding: 2px 6px;
                font-size: 9px;
                font-weight: 600;
                background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
                border-radius: 4px;
                color: white;
            `;
            header.appendChild(premiumBadge);
        }
    }
    
    viewport.appendChild(card);
    
    // Dashboard ÎèôÍ∏∞Ìôî
    setTimeout(() => {
        syncCanvasStateToDashboard();
    }, 100);
    
    console.log('‚úÖ Command PaletteÏóêÏÑú Widget ÏÉùÏÑ±:', widget.name);
    
    // Command Palette Îã´Í∏∞
    closeCommandPalette();
}

// ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ (Cmd+K, ‚Üë‚Üì, Enter, ESC)
document.addEventListener('keydown', (e) => {
    // Cmd+K ÎòêÎäî Ctrl+KÎ°ú Ïó¥Í∏∞
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (commandPaletteOverlay.classList.contains('active')) {
            closeCommandPalette();
        } else {
            openCommandPalette();
        }
        return;
    }
    
    // Command PaletteÍ∞Ä Ïó¥Î†§ÏûàÏùÑ ÎïåÎßå Ï≤òÎ¶¨
    if (!commandPaletteOverlay || !commandPaletteOverlay.classList.contains('active')) return;
    
    // ESCÎ°ú Îã´Í∏∞
    if (e.key === 'Escape') {
        e.preventDefault();
        closeCommandPalette();
        return;
    }
    
    // EnterÎ°ú ÏÑ†ÌÉù
    if (e.key === 'Enter') {
        e.preventDefault();
        selectCommand(selectedCommandIndex);
        return;
    }
    
    // ‚Üì ÌôîÏÇ¥Ìëú
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedCommandIndex = Math.min(selectedCommandIndex + 1, filteredCommands.length - 1);
        renderCommandList(commandSearchInput.value);
        
        // ÏÑ†ÌÉùÎêú Ìï≠Î™©ÏúºÎ°ú Ïä§ÌÅ¨Î°§
        const selectedItem = document.querySelector('.command-item.selected');
        if (selectedItem) {
            selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
        return;
    }
    
    // ‚Üë ÌôîÏÇ¥Ìëú
    if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedCommandIndex = Math.max(selectedCommandIndex - 1, 0);
        renderCommandList(commandSearchInput.value);
        
        // ÏÑ†ÌÉùÎêú Ìï≠Î™©ÏúºÎ°ú Ïä§ÌÅ¨Î°§
        const selectedItem = document.querySelector('.command-item.selected');
        if (selectedItem) {
            selectedItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
        return;
    }
});

// Í≤ÄÏÉâ ÏûÖÎ†• Ïù¥Î≤§Ìä∏
commandSearchInput?.addEventListener('input', (e) => {
    selectedCommandIndex = 0; // Í≤ÄÏÉâ Ïãú Ï≤´ Î≤àÏß∏ Ìï≠Î™© ÏÑ†ÌÉù
    renderCommandList(e.target.value);
});

// Overlay ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
commandPaletteOverlay?.addEventListener('click', (e) => {
    if (e.target === commandPaletteOverlay) {
        closeCommandPalette();
    }
});

console.log('‚úÖ Command Palette (Cmd+K) Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');

lucide.createIcons();
</script>

<!-- AI Orchestrator Engine -->
<script src="/static/js/ai-orchestrator-engine.js" defer></script>
<script src="/static/js/ai-orchestrator-workflows.js" defer></script>

<!-- AI Orchestrator Integration for Canvas -->
<script>
console.log('üöÄ [Canvas] AI Orchestrator Integration starting...');

/**
 * AI Workspace Search ÌÜµÌï©
 * Landing ÌéòÏù¥ÏßÄÏùò AI Í≤ÄÏÉâ Í∏∞Îä•Í≥º ÎèôÏùºÌïú Ïù∏ÌÑ∞ÌéòÏù¥Ïä§
 */
const aiSearchInput = document.querySelector('.ai-input input');
const aiSearchButton = document.querySelector('.ai-input .ai-button');

if (aiSearchInput && aiSearchButton) {
    aiSearchButton.addEventListener('click', async () => {
        const command = aiSearchInput.value.trim();
        
        if (!command) {
            alert('Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            return;
        }
        
        console.log('ü§ñ [Canvas AI] Command received:', command);
        
        // Show loading state
        aiSearchButton.innerHTML = '<i data-lucide="loader" class="animate-spin"></i>';
        aiSearchButton.disabled = true;
        lucide.createIcons();
        
        try {
            // Execute AI Orchestrator workflow
            const session = await window.executeWorkflowByCommand(command);
            
            if (session) {
                console.log('‚úÖ [Canvas AI] Workflow executed:', session.id);
                
                // Show success notification
                showCanvasNotification({
                    type: 'success',
                    title: 'AI ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏôÑÎ£å',
                    message: `"${command}" Ïã§Ìñâ ÏôÑÎ£å (${session.totalDuration}ms)`,
                    duration: 5000
                });
                
                // Create Canvas visualization of the workflow
                visualizeWorkflowOnCanvas(session);
                
            } else {
                throw new Error('ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïã§Ìñâ Ïã§Ìå®');
            }
            
        } catch (error) {
            console.error('‚ùå [Canvas AI] Error:', error);
            
            showCanvasNotification({
                type: 'error',
                title: 'AI Ïã§Ìñâ Ïò§Î•ò',
                message: error.message,
                duration: 5000
            });
            
        } finally {
            // Reset button
            aiSearchButton.innerHTML = '<i data-lucide="send"></i>';
            aiSearchButton.disabled = false;
            lucide.createIcons();
            
            // Clear input
            aiSearchInput.value = '';
        }
    });
    
    // Enter key support
    aiSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            aiSearchButton.click();
        }
    });
    
    console.log('‚úÖ [Canvas AI] AI Workspace Search integrated');
}

/**
 * CanvasÏóê ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏãúÍ∞ÅÌôî
 */
function visualizeWorkflowOnCanvas(session) {
    console.log('üé® [Canvas] Visualizing workflow:', session.id);
    
    const viewport = document.getElementById('canvasViewport');
    if (!viewport) return;
    
    const startX = 200;
    const startY = 200;
    const nodeSpacing = 300;
    
    // PhaseÎ≥ÑÎ°ú ÎÖ∏Îìú ÏÉùÏÑ±
    session.phaseResults.forEach((phaseResult, phaseIndex) => {
        const phaseY = startY + (phaseIndex * 150);
        
        phaseResult.results.forEach((agentResult, agentIndex) => {
            const nodeX = startX + (agentIndex * nodeSpacing);
            
            // Create workflow node card
            const card = createWorkflowNodeCard({
                x: nodeX,
                y: phaseY,
                phase: phaseResult.phaseName,
                agentType: agentResult.agentType,
                status: agentResult.status,
                duration: agentResult.duration,
                output: agentResult.output
            });
            
            viewport.appendChild(card);
        });
    });
    
    // Sync to Dashboard
    setTimeout(() => {
        syncCanvasStateToDashboard();
    }, 500);
    
    console.log('‚úÖ [Canvas] Workflow visualization complete');
}

/**
 * ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÎÖ∏Îìú Ïπ¥Îìú ÏÉùÏÑ±
 */
function createWorkflowNodeCard(data) {
    const card = document.createElement('div');
    card.className = 'card workflow-node';
    card.style.left = data.x + 'px';
    card.style.top = data.y + 'px';
    card.style.width = '250px';
    card.dataset.agentType = data.agentType;
    card.dataset.phase = data.phase;
    
    // Status color
    const statusColors = {
        'completed': '#10B981',
        'running': '#F59E0B',
        'failed': '#EF4444',
        'pending': '#6B7280'
    };
    const statusColor = statusColors[data.status] || '#6B7280';
    
    card.innerHTML = `
        <div class="card-header" style="background: linear-gradient(135deg, ${statusColor}33, ${statusColor}11); border-left: 4px solid ${statusColor};">
            <i data-lucide="cpu" style="width:16px;height:16px;color:${statusColor}"></i>
            ${data.agentType}
        </div>
        <div class="card-content">
            <div style="font-size: 11px; color: #9CA3AF; margin-bottom: 8px;">
                ${data.phase}
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 12px;">
                <span style="color: ${statusColor};">‚óè ${data.status}</span>
                <span style="color: #6B7280;">${data.duration}ms</span>
            </div>
            ${data.output ? `
                <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 4px; font-size: 11px; color: #D1D5DB; max-height: 60px; overflow-y: auto;">
                    ${JSON.stringify(data.output, null, 2).substring(0, 100)}...
                </div>
            ` : ''}
        </div>
        
        <!-- Connection Handle -->
        <div class="connection-handle" title="Ïó∞Í≤∞ÏÑ† ÎßåÎì§Í∏∞"></div>
    `;
    
    // Re-render Lucide icons
    lucide.createIcons();
    
    return card;
}

/**
 * Canvas ÏïåÎ¶º ÌëúÏãú
 */
function showCanvasNotification(notification) {
    const notificationEl = document.createElement('div');
    notificationEl.className = `canvas-notification notification-${notification.type}`;
    notificationEl.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: ${notification.type === 'success' ? '#10B981' : '#EF4444'};
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        min-width: 300px;
        max-width: 400px;
        animation: slideInRight 0.3s ease-out;
    `;
    
    notificationEl.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px;">${notification.title}</div>
        <div style="font-size: 14px; opacity: 0.9;">${notification.message}</div>
    `;
    
    document.body.appendChild(notificationEl);
    
    // Auto remove
    setTimeout(() => {
        notificationEl.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            notificationEl.remove();
        }, 300);
    }, notification.duration || 3000);
}

/**
 * Update Canvas node status (called from AI Orchestrator)
 */
window.updateCanvasNodeStatus = function(event) {
    console.log('üîÑ [Canvas] Node status update:', event);
    
    // Find corresponding card and update status
    const cards = document.querySelectorAll('.workflow-node');
    cards.forEach(card => {
        if (card.dataset.agentType === event.agentType) {
            const statusEl = card.querySelector('[style*="color"]');
            if (statusEl && event.status) {
                statusEl.textContent = `‚óè ${event.status}`;
            }
        }
    });
};

console.log('‚úÖ [Canvas] AI Orchestrator Integration complete');
</script>

<style>
/* Workflow Node Styles */
.workflow-node {
    border: 1px solid rgba(139, 92, 246, 0.3);
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), rgba(59, 130, 246, 0.05));
}

.workflow-node .card-header {
    font-size: 12px;
    font-weight: 600;
}

/* Notification Animation */
@keyframes slideInRight {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

/* Loading spinner animation */
.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}
</style>
</script>

<!-- Command Palette Modal -->
<div id="commandPaletteOverlay" class="command-palette-overlay">
    <div class="command-palette">
        <div class="command-palette-header">
            <div class="command-search-wrapper">
                <i data-lucide="search" class="command-search-icon"></i>
                <input 
                    type="text" 
                    id="commandSearchInput"
                    class="command-search-input" 
                    placeholder="ÏúÑÏ†Ø Í≤ÄÏÉâ... (Ïù¥Î¶Ñ, ÏÑ§Î™Ö, Ïπ¥ÌÖåÍ≥†Î¶¨)"
                    autocomplete="off"
                />
            </div>
            <div class="command-palette-hint">
                <kbd>‚Üë</kbd> <kbd>‚Üì</kbd> Ïù¥Îèô
                <kbd>Enter</kbd> ÏÑ†ÌÉù
                <kbd>ESC</kbd> Îã´Í∏∞
            </div>
        </div>
        <div id="commandPaletteBody" class="command-palette-body">
            <!-- JavaScriptÎ°ú ÎèôÏ†Å ÏÉùÏÑ± -->
        </div>
        <div class="command-palette-footer">
            <div class="command-palette-shortcuts">
                <div class="command-palette-shortcut">
                    <kbd>Cmd</kbd> + <kbd>K</kbd>
                    <span>Ïó¥Í∏∞/Îã´Í∏∞</span>
                </div>
            </div>
            <div style="font-size: 11px; color: #6B7280;">
                87Í∞ú ÏúÑÏ†Ø ÏÇ¨Ïö© Í∞ÄÎä•
            </div>
        </div>
    </div>
</div>


    <!-- ‚å®Ô∏è  Keyboard Navigation & Accessibility -->
    <script src="/static/js/keyboard-navigation.js"></script>
    
</body>
</html>
