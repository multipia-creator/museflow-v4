<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<title>MuseFlow Canvas - Enhanced</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<script src="https://unpkg.com/lucide@latest"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: Inter, sans-serif;
    background: #0a0a0a;
    color: #e5e5e5;
    overflow: hidden;
}

/* Unified Navbar - Dashboard Style */
.unified-navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1001;
    padding: 0;
}

.unified-nav-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0.75rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 64px;
}

.unified-nav-logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    color: #e5e5e5;
    font-weight: 700;
    font-size: 1.25rem;
    transition: transform 0.3s;
}

.unified-nav-logo:hover {
    transform: translateY(-2px);
}

.unified-nav-logo img {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
}

.unified-nav-links {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    list-style: none;
    padding: 0;
    margin: 0;
}

.unified-nav-links a {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    color: #9CA3AF;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s;
    font-size: 1.1rem;
}

.unified-nav-links a:hover {
    background: rgba(139, 92, 246, 0.15);
    color: #8B5CF6;
    transform: translateY(-2px);
}

.unified-nav-links a.active {
    background: rgba(139, 92, 246, 0.25);
    color: #8B5CF6;
    border: 1px solid rgba(139, 92, 246, 0.4);
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
}

.unified-nav-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.unified-nav-btn {
    background: rgba(139, 92, 246, 0.15);
    border: 1px solid rgba(139, 92, 246, 0.3);
    width: 44px;
    height: 44px;
    border-radius: 12px;
    color: #9CA3AF;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    font-size: 1.1rem;
}

.unified-nav-btn:hover {
    background: rgba(139, 92, 246, 0.25);
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    color: #8B5CF6;
}

.unified-nav-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.unified-nav-btn {
    width: 44px;
    height: 44px;
    background: rgba(139, 92, 246, 0.15);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 12px;
    color: #9CA3AF;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    font-size: 1.1rem;
}

.unified-nav-btn:hover {
    background: rgba(139, 92, 246, 0.25);
    color: #8B5CF6;
    transform: scale(1.05);
}

/* Container with navbar offset */
.container {
    display: grid;
    grid-template-columns: 40px 1fr 40px;
    height: calc(100vh - 64px - 48px); /* navbar + footer */
    margin-top: 64px;
}

.sidebar {
    background: linear-gradient(180deg, #1a1a1a, #0f0f0f);
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
    padding: 8px 3px;
    gap: 4px;
}

.sidebar.right {
    border-left: 1px solid #333;
    border-right: none;
}

.icon {
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    cursor: pointer;
    border-radius: 8px;
    transition: 0.2s;
    position: relative;
}

.icon:hover {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}

.icon.active {
    background: rgba(16, 185, 129, 0.25);
    color: #10b981;
}

.badge {
    position: absolute;
    top: 2px;
    right: 2px;
    background: #ef4444;
    color: #fff;
    font-size: 9px;
    min-width: 14px;
    height: 14px;
    border-radius: 7px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
}

.canvas {
    background: #fafbfc;
    overflow: hidden;
    background-image: linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px);
    background-size: 20px 20px;
    position: relative;
}

.viewport {
    width: 100%;
    height: 100%;
    position: relative;
    cursor: grab;
}

.viewport.dragging {
    cursor: grabbing;
}

.panel {
    position: fixed;
    top: 64px;
    bottom: 48px;
    width: 280px;
    background: rgba(26, 26, 26, 0.98);
    border: 1px solid #333;
    z-index: 100;
    transform: translateX(-100%);
    transition: 0.3s;
    display: none;
}

.panel.left {
    left: 40px;
}

.panel.right {
    right: 40px;
    transform: translateX(100%);
}

.panel.active {
    display: block;
    transform: translateX(0);
}

.panel-header {
    padding: 16px;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
}

.panel-title {
    font-size: 14px;
    font-weight: 600;
}

.panel-close {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: #666;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.panel-close:hover {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}

.panel-content {
    padding: 16px;
    color: #999;
    font-size: 13px;
}

/* Media Card with thumbnail */
.card {
    position: absolute;
    width: 300px;
    min-width: 200px;
    min-height: 200px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    overflow: visible;
    cursor: move;
    transition: box-shadow 0.2s, transform 0.1s;
}

.card.selected {
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.5), 0 8px 30px rgba(0, 0, 0, 0.2);
    z-index: 1000 !important;
}

.card:hover {
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
}

/* Resize Handles */
.resize-handle {
    position: absolute;
    width: 12px;
    height: 12px;
    background: #8b5cf6;
    border: 2px solid #fff;
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
}

.card.selected .resize-handle {
    opacity: 1;
}

.resize-se { bottom: -6px; right: -6px; cursor: nwse-resize; }
.resize-ne { top: -6px; right: -6px; cursor: nesw-resize; }
.resize-sw { bottom: -6px; left: -6px; cursor: nesw-resize; }
.resize-nw { top: -6px; left: -6px; cursor: nwse-resize; }
.resize-e { top: 50%; right: -6px; transform: translateY(-50%); cursor: ew-resize; }
.resize-w { top: 50%; left: -6px; transform: translateY(-50%); cursor: ew-resize; }
.resize-n { top: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
.resize-s { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }

.card-thumbnail {
    width: 100%;
    height: 180px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    overflow: hidden;
    position: relative;
}

.card-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-thumbnail video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-thumbnail.video {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.card-thumbnail.audio {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.card-thumbnail.image {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.card-thumbnail.document {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.card-thumbnail.data {
    background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
}

.card-header {
    padding: 12px 16px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: #fff;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-content {
    padding: 16px;
    color: #333;
    font-size: 13px;
}

.card-meta {
    display: flex;
    gap: 12px;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #e5e7eb;
    font-size: 12px;
    color: #6b7280;
}

.controls {
    display: flex;
    gap: 8px;
    background: rgba(26, 26, 26, 0.98);
    padding: 8px 12px;
    border-radius: 12px;
    border: 1px solid #333;
    z-index: 50;
}

.ctrl-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #374151;
    background: rgba(17, 24, 39, 0.6);
    color: #9ca3af;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ctrl-btn:hover {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
}

.zoom-level {
    color: #9ca3af;
    font-size: 13px;
    min-width: 45px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-input {
    position: fixed;
    bottom: 68px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 12px;
    background: rgba(26, 26, 26, 0.98);
    padding: 12px 16px;
    border-radius: 16px;
    border: 1px solid #333;
    z-index: 50;
}

.ai-select {
    padding: 6px 10px;
    background: rgba(17, 24, 39, 0.6);
    border: 1px solid #374151;
    border-radius: 8px;
    color: #e5e7eb;
    font-size: 13px;
}

.ai-field {
    flex: 1;
    min-width: 300px;
    padding: 8px 12px;
    background: rgba(17, 24, 39, 0.6);
    border: 1px solid #374151;
    border-radius: 10px;
    color: #e5e7eb;
    font-size: 14px;
}

.ai-field:focus {
    outline: none;
    border-color: #10b981;
}

.ai-send {
    width: 36px;
    height: 36px;
    border: none;
    background: #10b981;
    color: #fff;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.ai-send:hover {
    background: #059669;
}

/* Footer */
.footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 48px;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    padding: 0 2rem;
    font-size: 13px;
    color: #9ca3af;
    z-index: 1000;
}

.footer-left {
    display: flex;
    gap: 1.5rem;
}

.footer-link {
    color: #9ca3af;
    text-decoration: none;
    transition: color 0.2s;
}

.footer-link:hover {
    color: #8B5CF6;
}

/* Animations */
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.05); }
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.card {
    animation: slideIn 0.3s ease-out;
}

/* Card Click Effects */
.card:hover {
    box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
    transform: translateY(-2px);
}

.card-thumbnail:hover {
    cursor: pointer;
}

/* Modal Viewer */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease-out;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    max-width: 90vw;
    max-height: 90vh;
    position: relative;
    animation: scaleIn 0.3s ease-out;
}

.modal-content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: 12px;
}

.modal-content video {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 12px;
}

.modal-close {
    position: absolute;
    top: -50px;
    right: 0;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes scaleIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* Connection Lines (Google Opal Style) */
.connection-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
}

.card-connector {
    position: absolute;
    background: rgba(139, 92, 246, 0.5);
    height: 2px;
    transform-origin: 0 0;
    transition: all 0.3s ease;
    pointer-events: none;
}

.card-connector.active {
    background: rgba(139, 92, 246, 0.8);
    height: 3px;
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
}

.card-connector-dot {
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #8B5CF6;
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
    z-index: 1;
}

.connection-handle {
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #8B5CF6;
    border: 3px solid #ffffff;
    cursor: crosshair;
    opacity: 0.6;
    transition: all 0.2s;
    z-index: 10;
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
}

.card:hover .connection-handle,
.card.selected .connection-handle {
    opacity: 1;
    transform: translateY(-50%) scale(1.2);
}

.connection-handle:hover {
    background: #f59e0b;
    border-color: #ffffff;
    box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
}

/* ============================================
   MOBILE OPTIMIZATION
   ============================================ */

@media (max-width: 768px) {
    /* Navbar Mobile */
    .unified-nav-container {
        padding: 0.5rem 1rem;
        height: 56px;
    }
    
    .unified-nav-logo {
        font-size: 1rem;
        gap: 0.5rem;
    }
    
    .unified-nav-logo img {
        width: 32px;
        height: 32px;
    }
    
    .unified-nav-links {
        gap: 0.25rem;
    }
    
    .unified-nav-links a {
        width: 38px;
        height: 38px;
        font-size: 1rem;
    }
    
    /* Sidebar Mobile - 전체 너비로 하단에 표시 */
    .left-sidebar,
    .right-sidebar {
        width: 100% !important;
        max-width: 100% !important;
        height: 60vh;
        top: auto;
        bottom: 0;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }
    
    .left-sidebar.open {
        transform: translateY(0);
    }
    
    .right-sidebar.open {
        transform: translateY(0);
    }
    
    /* Sidebar Toggle Buttons - 하단 고정 */
    .sidebar-toggle-left {
        bottom: 56px;
        top: auto;
        left: 1rem;
        width: 48px;
        height: 48px;
    }
    
    .sidebar-toggle-right {
        bottom: 56px;
        top: auto;
        right: 1rem;
        width: 48px;
        height: 48px;
    }
    
    /* Panel Selector Mobile */
    .panel-selector {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.75rem;
    }
    
    .panel-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        min-width: 60px;
    }
    
    /* Cards Mobile - 터치 친화적 크기 */
    .card {
        min-width: 200px !important;
        max-width: 280px !important;
        padding: 1rem;
    }
    
    .card-header h3 {
        font-size: 0.9rem;
    }
    
    .card-thumbnail {
        height: 120px;
    }
    
    .card-content {
        font-size: 0.8rem;
    }
    
    /* AI Input Mobile - 전체 너비 */
    .ai-input {
        left: 0;
        right: 0;
        bottom: 56px;
        transform: none;
        flex-direction: column;
        padding: 1rem;
        border-radius: 20px 20px 0 0;
        gap: 0.75rem;
        max-width: 100%;
    }
    
    .ai-select {
        width: 100%;
        padding: 0.75rem;
        font-size: 14px;
    }
    
    .ai-field {
        min-width: auto;
        width: 100%;
        padding: 0.75rem;
        font-size: 14px;
    }
    
    .ai-send {
        width: 100%;
        height: 44px;
        border-radius: 12px;
        font-size: 1rem;
    }
    
    /* Zoom Controls Mobile */
    .zoom-controls {
        bottom: 116px;
        right: 1rem;
        gap: 0.5rem;
        padding: 0.5rem;
    }
    
    .zoom-btn {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    /* Footer Mobile */
    .footer {
        height: 56px;
        padding: 0 1rem;
        font-size: 0.75rem;
        gap: 1rem;
    }
    
    .footer-left {
        gap: 0.75rem;
    }
    
    /* Canvas Viewport Mobile */
    #canvasViewport {
        top: 56px;
        bottom: 56px;
    }
    
    /* Modal Mobile */
    .modal-content {
        width: 95%;
        max-width: 95%;
        padding: 1rem;
    }
    
    .modal-close {
        top: 0.5rem;
        right: 0.5rem;
        width: 36px;
        height: 36px;
        font-size: 1.2rem;
    }
}

/* 터치 디바이스 최적화 */
@media (hover: none) and (pointer: coarse) {
    /* 터치 타겟 크기 증가 */
    .card {
        touch-action: pan-x pan-y;
    }
    
    .zoom-btn,
    .panel-btn,
    .sidebar-toggle-left,
    .sidebar-toggle-right {
        min-width: 44px;
        min-height: 44px;
    }
    
    /* 호버 효과 제거 */
    .card:hover {
        transform: none;
    }
    
    .connection-handle {
        opacity: 1;
        width: 20px;
        height: 20px;
    }
}

/* 작은 모바일 (iPhone SE 등) */
@media (max-width: 375px) {
    .unified-nav-logo span {
        display: none;
    }
    
    .card {
        min-width: 180px !important;
        max-width: 240px !important;
    }
    
    .ai-input {
        padding: 0.75rem;
    }
    
    .footer {
        font-size: 0.7rem;
    }
}

/* 가로 모드 */
@media (max-width: 768px) and (orientation: landscape) {
    .left-sidebar,
    .right-sidebar {
        height: 80vh;
    }
    
    .ai-input {
        bottom: 48px;
    }
    
    .footer {
        height: 48px;
    }
    
    #canvasViewport {
        top: 56px;
        bottom: 48px;
    }
}

/* ============================================
   WIDGET PANEL - MINIMALIST DESIGN SYSTEM
   ============================================ */

/* Lucide Icons Base */
.icon {
  width: 20px;
  height: 20px;
  stroke-width: 1.5px;
  flex-shrink: 0;
}

.icon-xs {
  width: 14px;
  height: 14px;
  stroke-width: 2px;
}

/* Widget Panel Base */
#widgetPanel .panel-content {
  padding: 4px 0;
  overflow-y: auto;
}

/* Search & Filter Toolbar */
.widget-toolbar {
  padding: 16px 20px;
  background: #0a0a0a;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.widget-search-box {
  position: relative;
  display: flex;
  align-items: center;
  background: #1a1a1a;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px;
  padding: 11px 14px;
  transition: all 0.2s;
}

.widget-search-box:focus-within {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.08);
  background: #222;
}

.widget-search-box .icon {
  stroke: #666;
  margin-right: 10px;
}

.widget-search-box input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #e5e5e5;
  font-size: 14px;
}

.widget-search-box input::placeholder {
  color: #666;
}

.widget-btn-clear {
  background: transparent;
  border: none;
  color: #666;
  cursor: pointer;
  padding: 4px;
  transition: color 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.widget-btn-clear:hover {
  color: #e5e5e5;
}

/* Filter Chips */
.widget-filter-chips {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.widget-chip {
  padding: 7px 12px;
  background: #1a1a1a;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 20px;
  font-size: 12px;
  color: #9CA3AF;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.widget-chip:hover {
  background: #222;
  color: #e5e5e5;
  border-color: rgba(255,255,255,0.15);
}

.widget-chip.active {
  background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
  color: white;
  border-color: #8B5CF6;
}

/* Category Groups - Color System */
.category-group {
  margin: 4px 8px;
  border-radius: 12px;
  border-left: 2px solid;
  transition: all 0.2s;
}

/* Blue - Advanced Analytics */
.category-advanced-analytics {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.06) 0%, rgba(37, 99, 235, 0.03) 100%);
  border-left-color: rgba(59, 130, 246, 0.25);
}

.category-advanced-analytics .category-header {
  color: #60A5FA;
}

.category-advanced-analytics .category-icon {
  stroke: #60A5FA;
}

.category-advanced-analytics .widget-item:hover {
  background: rgba(59, 130, 246, 0.1);
  border-color: rgba(59, 130, 246, 0.35);
}

/* Amber - Museum Professional */
.category-museum-professional {
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.06) 0%, rgba(245, 158, 11, 0.03) 100%);
  border-left-color: rgba(251, 191, 36, 0.25);
}

.category-museum-professional .category-header {
  color: #FCD34D;
}

.category-museum-professional .category-icon {
  stroke: #FCD34D;
}

.category-museum-professional .widget-item:hover {
  background: rgba(251, 191, 36, 0.1);
  border-color: rgba(251, 191, 36, 0.35);
}

/* Green - Visitor Experience */
.category-visitor-experience {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.06) 0%, rgba(22, 163, 74, 0.03) 100%);
  border-left-color: rgba(34, 197, 94, 0.25);
}

.category-visitor-experience .category-header {
  color: #4ADE80;
}

.category-visitor-experience .category-icon {
  stroke: #4ADE80;
}

.category-visitor-experience .widget-item:hover {
  background: rgba(34, 197, 94, 0.1);
  border-color: rgba(34, 197, 94, 0.35);
}

/* Slate - Operations */
.category-operations {
  background: linear-gradient(135deg, rgba(100, 116, 139, 0.06) 0%, rgba(71, 85, 105, 0.03) 100%);
  border-left-color: rgba(100, 116, 139, 0.25);
}

.category-operations .category-header {
  color: #94A3B8;
}

.category-operations .category-icon {
  stroke: #94A3B8;
}

.category-operations .widget-item:hover {
  background: rgba(100, 116, 139, 0.1);
  border-color: rgba(100, 116, 139, 0.35);
}

/* Purple - Collaboration (Brand Color) */
.category-collaboration {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.06) 0%, rgba(124, 58, 237, 0.03) 100%);
  border-left-color: rgba(139, 92, 246, 0.25);
}

.category-collaboration .category-header {
  color: #A78BFA;
}

.category-collaboration .category-icon {
  stroke: #A78BFA;
}

.category-collaboration .widget-item:hover {
  background: rgba(139, 92, 246, 0.1);
  border-color: rgba(139, 92, 246, 0.35);
}

/* Emerald - Finance */
.category-finance {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.06) 0%, rgba(5, 150, 105, 0.03) 100%);
  border-left-color: rgba(16, 185, 129, 0.25);
}

.category-finance .category-header {
  color: #34D399;
}

.category-finance .category-icon {
  stroke: #34D399;
}

.category-finance .widget-item:hover {
  background: rgba(16, 185, 129, 0.1);
  border-color: rgba(16, 185, 129, 0.35);
}

/* Category Header */
.category-header {
  display: flex;
  align-items: center;
  padding: 14px 18px;
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
  gap: 10px;
}

.category-header:hover {
  background: rgba(255,255,255,0.02);
}

.category-chevron {
  transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  stroke: currentColor;
  opacity: 0.6;
}

.category-group[data-expanded="true"] .category-chevron {
  transform: rotate(0deg);
}

.category-group[data-expanded="false"] .category-chevron {
  transform: rotate(-90deg);
}

.category-name {
  flex: 1;
  font-size: 14px;
  font-weight: 600;
}

.category-badge {
  background: rgba(255,255,255,0.08);
  color: currentColor;
  padding: 3px 9px;
  border-radius: 14px;
  font-size: 11px;
  font-weight: 600;
  opacity: 0.7;
}

/* Category Content (Accordion) */
.category-content {
  overflow: hidden;
  transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  padding-bottom: 8px;
}

/* Widget Items */
.widget-item {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  margin: 6px 12px;
  background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.04);
  border-radius: 10px;
  cursor: grab;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  gap: 12px;
}

.widget-item:hover {
  transform: translateX(4px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
}

.widget-item:active {
  cursor: grabbing;
  transform: translateX(2px);
}

.widget-item.dragging {
  opacity: 0.4;
}

.widget-icon-wrapper {
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.04);
  border-radius: 10px;
  flex-shrink: 0;
  transition: all 0.2s;
}

.widget-item:hover .widget-icon-wrapper {
  background: rgba(255,255,255,0.08);
  transform: scale(1.05);
}

.widget-icon-wrapper .icon {
  stroke: currentColor;
  opacity: 0.9;
}

.widget-info {
  flex: 1;
  min-width: 0;
}

.widget-name {
  font-size: 13px;
  font-weight: 600;
  color: #e5e5e5;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 7px;
  flex-wrap: wrap;
  line-height: 1.4;
}

.widget-description {
  font-size: 11.5px;
  color: #9CA3AF;
  line-height: 1.5;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.badge-premium {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 7px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 5px;
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.widget-price {
  font-size: 12px;
  font-weight: 700;
  color: #8B5CF6;
  margin-left: 4px;
  flex-shrink: 0;
}

/* Widget Panel Scrollbar - Improved */
#widgetPanel .panel-content::-webkit-scrollbar {
  width: 4px;
}

#widgetPanel .panel-content::-webkit-scrollbar-track {
  background: transparent;
}

#widgetPanel .panel-content::-webkit-scrollbar-thumb {
  background: rgba(139, 92, 246, 0.15);
  border-radius: 2px;
  transition: background 0.2s;
}

#widgetPanel .panel-content::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 92, 246, 0.3);
}

/* Category Badge Enhancement */
.category-badge {
  background: rgba(255,255,255,0.12);
  color: currentColor;
  padding: 4px 10px;
  border-radius: 14px;
  font-size: 12px;
  font-weight: 700;
  opacity: 0.9;
  border: 1px solid rgba(255,255,255,0.1);
  min-width: 28px;
  text-align: center;
}

/* Search Box Enhancement */
.widget-search-box {
  position: relative;
  display: flex;
  align-items: center;
  background: linear-gradient(135deg, #1a1a1a 0%, #222 100%);
  border: 1px solid rgba(139, 92, 246, 0.15);
  border-radius: 12px;
  padding: 12px 16px;
  transition: all 0.2s;
}

.widget-search-box:focus-within {
  border-color: #8B5CF6;
  box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.12);
  background: linear-gradient(135deg, #222 0%, #2a2a2a 100%);
}

.widget-search-box .icon {
  stroke: #8B5CF6;
  margin-right: 12px;
  width: 18px;
  height: 18px;
}

.widget-search-box input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: #e5e5e5;
  font-size: 14px;
  font-weight: 500;
}

.widget-search-box input::placeholder {
  color: #666;
  font-weight: 400;
}

/* Hint Text Below Search */
.widget-search-hint {
  margin-top: 8px;
  font-size: 11px;
  color: #666;
  text-align: center;
  padding: 0 20px;
}

.widget-search-hint kbd {
  display: inline-block;
  padding: 2px 6px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 4px;
  font-family: monospace;
  font-size: 10px;
  color: #8B5CF6;
  margin: 0 2px;
}
</style>
</head>
<body>

<!-- Unified Navigation Bar - Dashboard Style -->
<nav class="unified-navbar">
    <div class="unified-nav-container">
        <a href="/" class="unified-nav-logo">
            <img src="/static/images/logo-neon-m.png" alt="MuseFlow">
            <span>MuseFlow</span>
        </a>
        <ul class="unified-nav-links">
            <li><a href="/dashboard.html" data-tooltip="대시보드"><i class="fas fa-home"></i></a></li>
            <li><a href="/canvas-ultimate-clean.html" class="active" data-tooltip="캔버스"><i class="fas fa-palette"></i></a></li>
            <li><a href="/workflow.html" data-tooltip="워크플로우"><i class="fas fa-project-diagram"></i></a></li>
            <li><a href="/analytics-dashboard.html" data-tooltip="분석"><i class="fas fa-chart-line"></i></a></li>
        </ul>
        <div class="unified-nav-actions">
            <button class="unified-nav-btn" title="설정"><i class="fas fa-cog"></i></button>
            <button class="unified-nav-btn" title="계정"><i class="fas fa-user-circle"></i></button>
        </div>
    </div>
</nav>

<!-- Main Container -->
<div class="container">
    <div class="sidebar left">
        <div class="icon" data-panel="history"><i data-lucide="clock" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="actions"><i data-lucide="zap" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="projects"><i data-lucide="folder" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="settings"><i data-lucide="settings" style="width:16px;height:16px"></i></div>
    </div>
    <div class="canvas">
        <div class="viewport" id="vp"></div>
    </div>
    <div class="sidebar right">
        <div class="icon" data-panel="stats"><i data-lucide="bar-chart-2" style="width:16px;height:16px"></i></div>
        <div class="icon" data-panel="widget"><i data-lucide="package" style="width:16px;height:16px"></i><span class="badge">29</span></div>
        <div class="icon" data-panel="tasks"><i data-lucide="check-square" style="width:16px;height:16px"></i><span class="badge">2</span></div>
        <div class="icon" data-panel="ai"><i data-lucide="sparkles" style="width:16px;height:16px"></i><span class="badge">1</span></div>
        <div class="icon" data-panel="alerts"><i data-lucide="bell" style="width:16px;height:16px"></i><span class="badge">3</span></div>
    </div>
</div>

<!-- Panels -->
<div class="panel left" id="historyPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">History</span>
        <button class="panel-close" onclick="closePanel('historyPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #8B5CF6;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="image" style="width:16px;height:16px;color:#8B5CF6;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">포스터 이미지 편집</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">방금 전</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #6366F1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="video" style="width:16px;height:16px;color:#6366F1;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">영상 렌더링 완료</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">5분 전</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #22C55E;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="link" style="width:16px;height:16px;color:#22C55E;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">카드 연결 생성</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">10분 전</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #F97316;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="move" style="width:16px;height:16px;color:#F97316;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">카드 재배치</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">15분 전</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; border-left: 3px solid #3B82F6;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i data-lucide="save" style="width:16px;height:16px;color:#3B82F6;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; font-size: 0.9375rem;">프로젝트 저장</div>
                            <div style="font-size: 0.8125rem; color: #9CA3AF;">30분 전</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel left" id="actionsPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">Actions</span>
        <button class="panel-close" onclick="closePanel('actionsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <button style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); border: none; padding: 0.75rem 1rem; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    <i data-lucide="plus" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    새 카드 만들기
                </button>
                <button style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.75rem 1rem; border-radius: 8px; color: #e5e5e5; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.25)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.15)'">
                    <i data-lucide="upload" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    파일 업로드
                </button>
                <button style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.75rem 1rem; border-radius: 8px; color: #e5e5e5; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.25)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.15)'">
                    <i data-lucide="layout" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    레이아웃 정렬
                </button>
                <button style="background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.75rem 1rem; border-radius: 8px; color: #e5e5e5; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.25)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.15)'">
                    <i data-lucide="save" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    프로젝트 저장
                </button>
            </div>
        </div>
    </div>
</div>

<div class="panel left" id="projectsPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">Projects</span>
        <button class="panel-close" onclick="closePanel('projectsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid #8B5CF6; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.2)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'">
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">뮤지엄 전시 프로젝트</div>
                    <div style="font-size: 0.875rem; color: #9CA3AF;">마지막 수정: 2시간 전</div>
                </div>
                <div style="padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 3px solid #22C55E; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(34, 197, 94, 0.2)'" onmouseout="this.style.background='rgba(34, 197, 94, 0.1)'">
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">예술 작품 아카이브</div>
                    <div style="font-size: 0.875rem; color: #9CA3AF;">마지막 수정: 1일 전</div>
                </div>
                <div style="padding: 0.75rem; background: rgba(249, 115, 22, 0.1); border-radius: 8px; border-left: 3px solid #F97316; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(249, 115, 22, 0.2)'" onmouseout="this.style.background='rgba(249, 115, 22, 0.1)'">
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">관람객 경험 디자인</div>
                    <div style="font-size: 0.875rem; color: #9CA3AF;">마지막 수정: 3일 전</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel left" id="settingsPanel" data-side="left">
    <div class="panel-header">
        <span class="panel-title">Settings</span>
        <button class="panel-close" onclick="closePanel('settingsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">테마</div>
                    <select style="width: 100%; padding: 0.5rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: #e5e5e5; cursor: pointer;">
                        <option>다크 모드</option>
                        <option>라이트 모드</option>
                        <option>시스템 설정</option>
                    </select>
                </div>
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">그리드 크기</div>
                    <input type="range" min="50" max="500" value="150" style="width: 100%; cursor: pointer;">
                    <div style="font-size: 0.8125rem; color: #9CA3AF; margin-top: 0.25rem;">150px</div>
                </div>
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">자동 저장</div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="color: #e5e5e5; font-size: 0.9375rem;">변경 사항 자동 저장</span>
                    </label>
                </div>
                <div>
                    <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.5rem; font-size: 0.9375rem;">연결선 표시</div>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="color: #e5e5e5; font-size: 0.9375rem;">워크플로우 연결선 보기</span>
                    </label>
                </div>
                <button style="width: 100%; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); padding: 0.75rem; border-radius: 8px; color: #EF4444; cursor: pointer; font-weight: 600; margin-top: 1rem;">
                    <i data-lucide="refresh-cw" style="width:14px;height:14px;display:inline-block;margin-right:8px;"></i>
                    설정 초기화
                </button>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="statsPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">Stats</span>
        <button class="panel-close" onclick="closePanel('statsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">총 카드 수</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #8B5CF6;">9</div>
                </div>
                <div style="padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">완료된 작업</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #22C55E;">5</div>
                </div>
                <div style="padding: 1rem; background: rgba(249, 115, 22, 0.1); border-radius: 8px; border: 1px solid rgba(249, 115, 22, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">진행 중</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #F97316;">4</div>
                </div>
                <div style="padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">연결 수</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #3B82F6;">0</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="tasksPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">Tasks</span>
        <button class="panel-close" onclick="closePanel('tasksPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                    <input type="checkbox" style="width: 16px; height: 16px; cursor: pointer;">
                    <div>
                        <div style="font-size: 0.9375rem; color: #e5e5e5;">홍보 영상 편집 완료</div>
                        <div style="font-size: 0.8125rem; color: #9CA3AF; margin-top: 0.25rem;">기한: 오늘</div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                    <input type="checkbox" checked style="width: 16px; height: 16px; cursor: pointer;">
                    <div>
                        <div style="font-size: 0.9375rem; color: #9CA3AF; text-decoration: line-through;">오디오 가이드 녹음</div>
                        <div style="font-size: 0.8125rem; color: #9CA3AF; margin-top: 0.25rem;">완료됨</div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                    <input type="checkbox" style="width: 16px; height: 16px; cursor: pointer;">
                    <div>
                        <div style="font-size: 0.9375rem; color: #e5e5e5;">포스터 디자인 승인</div>
                        <div style="font-size: 0.8125rem; color: #9CA3AF; margin-top: 0.25rem;">기한: 내일</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="aiPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">AI Assistant</span>
        <button class="panel-close" onclick="closePanel('aiPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.2);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div style="width: 8px; height: 8px; border-radius: 50%; background: #22C55E; animation: pulse 2s infinite;"></div>
                        <div style="font-weight: 600; color: #e5e5e5;">이미지 생성 중...</div>
                    </div>
                    <div style="font-size: 0.875rem; color: #9CA3AF;">진행률: 73%</div>
                    <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 0.5rem; overflow: hidden;">
                        <div style="width: 73%; height: 100%; background: linear-gradient(90deg, #8B5CF6, #6366F1); transition: width 0.3s;"></div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 8px;">
                    <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">최근 AI 작업</div>
                    <div style="font-size: 0.9375rem; color: #e5e5e5;">• 배경 제거 (3분 전)</div>
                    <div style="font-size: 0.9375rem; color: #e5e5e5;">• 텍스트 번역 (15분 전)</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel right" id="alertsPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">Alerts</span>
        <button class="panel-close" onclick="closePanel('alertsPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    <div class="panel-content">
        <div style="padding: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #EF4444;">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <i data-lucide="alert-circle" style="width:16px;height:16px;color:#EF4444;flex-shrink:0;margin-top:2px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">프로젝트 마감일 임박</div>
                            <div style="font-size: 0.875rem; color: #9CA3AF;">뮤지엄 전시 - 2일 남음</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3B82F6;">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <i data-lucide="info" style="width:16px;height:16px;color:#3B82F6;flex-shrink:0;margin-top:2px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">새로운 업데이트</div>
                            <div style="font-size: 0.875rem; color: #9CA3AF;">Canvas v4 기능 추가됨</div>
                        </div>
                    </div>
                </div>
                <div style="padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 3px solid #22C55E;">
                    <div style="display: flex; align-items: start; gap: 0.5rem;">
                        <i data-lucide="check-circle" style="width:16px;height:16px;color:#22C55E;flex-shrink:0;margin-top:2px;"></i>
                        <div>
                            <div style="font-weight: 600; color: #e5e5e5; margin-bottom: 0.25rem;">작업 완료</div>
                            <div style="font-size: 0.875rem; color: #9CA3AF;">오디오 가이드 녹음 완료</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Widget Panel -->
<div class="panel right" id="widgetPanel" data-side="right">
    <div class="panel-header">
        <span class="panel-title">
            <i data-lucide="package" class="icon" style="margin-right:8px;"></i>
            위젯
        </span>
        <button class="panel-close" onclick="closePanel('widgetPanel')">
            <i data-lucide="x" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <!-- Search & Filter Toolbar -->
    <div class="widget-toolbar">
        <div class="widget-search-box">
            <i data-lucide="search" class="icon"></i>
            <input type="text" 
                   id="widgetSearch" 
                   placeholder="🔍 위젯 검색... (Cmd+K로 빠른 접근)"
                   autocomplete="off">
            <button id="widgetClearSearch" class="widget-btn-clear" style="display:none;">
                <i data-lucide="x" class="icon"></i>
            </button>
        </div>
        
        <div class="widget-filter-chips">
            <button class="widget-chip active" data-filter="all">
                <i data-lucide="grid-3x3" class="icon-xs"></i>
                전체
            </button>
            <button class="widget-chip" data-filter="premium">
                <i data-lucide="star" class="icon-xs"></i>
                프리미엄
            </button>
            <button class="widget-chip" data-filter="free">
                <i data-lucide="gift" class="icon-xs"></i>
                무료
            </button>
            <button class="widget-chip" data-filter="recent">
                <i data-lucide="clock" class="icon-xs"></i>
                최근
            </button>
        </div>
        
        <div class="widget-search-hint">
            💡 <kbd>Cmd</kbd> + <kbd>K</kbd> 로 빠르게 검색하거나, 카테고리를 클릭하여 위젯을 탐색하세요
        </div>
    </div>
    
    <div class="panel-content">
        <div id="widgetCategoryList">
            <!-- 📊 고급 분석 & 인사이트 -->
            <div class="category-group category-advanced-analytics" 
                 data-category="advanced-analytics"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('advanced-analytics')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="trending-up" class="icon category-icon"></i>
                    <span class="category-name">고급 분석 & 인사이트</span>
                    <span class="category-badge">7</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="visitor-dwell-time" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="clock" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                관람객 체류 시간 분석
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                전시실별 평균 체류 시간과 인기 전시물 패턴 분석
                            </div>
                        </div>
                        <div class="widget-price">₩7,900</div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="predictive-visitors" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="brain" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                예측 관람객 수
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                AI 기반 방문자 예측 및 최적 인력 배치 제안
                            </div>
                        </div>
                        <div class="widget-price">₩9,900</div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="exhibition-effectiveness" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="bar-chart-3" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                전시 효과성 대시보드
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                관람객 피드백, QR 스캔율, 오디오 가이드 사용률 종합
                            </div>
                        </div>
                        <div class="widget-price">₩7,900</div>
                    </div>
                </div>
            </div>
            
            <!-- 🏛️ 뮤지엄 전문 기능 -->
            <div class="category-group category-museum-professional" 
                 data-category="museum-professional"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('museum-professional')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="landmark" class="icon category-icon"></i>
                    <span class="category-name">뮤지엄 전문 기능</span>
                    <span class="category-badge">6</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="artifact-loan-status">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="package" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">소장품 대출 현황</div>
                            <div class="widget-description">
                                대출 중인 작품 목록과 반납 예정일 알림
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="conservation-workflow">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="wrench" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">보존 처리 워크플로우</div>
                            <div class="widget-description">
                                처리 대기 목록과 진행 단계별 현황
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 👥 관람객 경험 -->
            <div class="category-group category-visitor-experience" 
                 data-category="visitor-experience"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('visitor-experience')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="users" class="icon category-icon"></i>
                    <span class="category-name">관람객 경험</span>
                    <span class="category-badge">5</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="live-satisfaction">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="smile-plus" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">실시간 만족도 조사</div>
                            <div class="widget-description">
                                QR 피드백 수집과 긍정/부정 비율
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="audio-guide-usage">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="headphones" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">오디오 가이드 사용 통계</div>
                            <div class="widget-description">
                                언어별 사용률과 인기 트랙 순위
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 💼 운영 & 관리 -->
            <div class="category-group category-operations" 
                 data-category="operations"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('operations')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="settings" class="icon category-icon"></i>
                    <span class="category-name">운영 & 관리</span>
                    <span class="category-badge">5</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="facility-inspection">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="clipboard-check" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">시설 점검 체크리스트</div>
                            <div class="widget-description">
                                일일 점검 항목과 이슈 보고
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="cctv-monitoring" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="video" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                CCTV 모니터링 현황
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                카메라 작동 상태와 녹화 용량
                            </div>
                        </div>
                        <div class="widget-price">₩5,900</div>
                    </div>
                </div>
            </div>
            
            <!-- 🤝 협업 & 커뮤니케이션 -->
            <div class="category-group category-collaboration" 
                 data-category="collaboration"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('collaboration')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="message-square" class="icon category-icon"></i>
                    <span class="category-name">협업 & 커뮤니케이션</span>
                    <span class="category-badge">3</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="team-messenger">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="message-circle" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">팀 메신저</div>
                            <div class="widget-description">
                                실시간 채팅과 부서별 채널
                            </div>
                        </div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="kanban-board" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="trello" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                프로젝트 칸반 보드
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                To-Do/In Progress/Done 업무 관리
                            </div>
                        </div>
                        <div class="widget-price">₩4,900</div>
                    </div>
                </div>
            </div>
            
            <!-- 📈 재무 & 수익 -->
            <div class="category-group category-finance" 
                 data-category="finance"
                 data-expanded="false">
                <div class="category-header" onclick="toggleWidgetCategory('finance')">
                    <i data-lucide="chevron-right" class="category-chevron icon"></i>
                    <i data-lucide="dollar-sign" class="icon category-icon"></i>
                    <span class="category-name">재무 & 수익</span>
                    <span class="category-badge">3</span>
                </div>
                
                <div class="category-content" style="display:none;">
                    <div class="widget-item" draggable="true" data-widget-type="donor-dashboard" data-premium="true">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="heart" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">
                                기부자 관리 대시보드
                                <span class="badge-premium">
                                    <i data-lucide="star" class="icon-xs"></i>
                                    Premium
                                </span>
                            </div>
                            <div class="widget-description">
                                기부 이력 추적과 VIP 후원자 관리
                            </div>
                        </div>
                        <div class="widget-price">₩4,900</div>
                    </div>
                    
                    <div class="widget-item" draggable="true" data-widget-type="museum-shop-sales">
                        <div class="widget-icon-wrapper">
                            <i data-lucide="shopping-cart" class="icon"></i>
                        </div>
                        <div class="widget-info">
                            <div class="widget-name">굿즈 판매 현황</div>
                            <div class="widget-description">
                                상품별 매출과 재고 수준 알림
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Input -->
<div class="ai-input">
    <select class="ai-select">
        <option>GPT-4o</option>
        <option>Claude 3.5</option>
        <option>Gemini Pro</option>
    </select>
    <button class="ai-voice" id="voiceBtn" title="음성 입력">
        <i data-lucide="mic" style="width:16px;height:16px"></i>
    </button>
    <input class="ai-field" id="aiInput" placeholder="AI에게 질문하거나 음성 입력...">
    
    <!-- Zoom Controls (moved here) -->
    <div class="controls">
        <button class="ctrl-btn" id="zoomOut">
            <i data-lucide="zoom-out" style="width:14px;height:14px"></i>
        </button>
        <span class="zoom-level" id="zoomLevel">100%</span>
        <button class="ctrl-btn" id="zoomIn">
            <i data-lucide="zoom-in" style="width:14px;height:14px"></i>
        </button>
        <button class="ctrl-btn" id="fitScreen">
            <i data-lucide="maximize-2" style="width:14px;height:14px"></i>
        </button>
    </div>
    
    <button class="ai-send">
        <i data-lucide="send" style="width:16px;height:16px"></i>
    </button>
</div>

<!-- Modal Viewer -->
<div class="modal-overlay" id="modalViewer">
    <button class="modal-close" onclick="closeModal()">×</button>
    <div class="modal-content" id="modalContent"></div>
</div>

<!-- Footer -->
<footer class="footer">
    <div class="footer-left">
        <span>© 2025 MuseFlow</span>
        <a href="#" class="footer-link">도움말</a>
        <a href="#" class="footer-link">개인정보처리방침</a>
        <a href="#" class="footer-link">서비스 약관</a>
    </div>
    <div class="footer-right">
        <span>v4.0.0</span>
    </div>
</footer>

<script>
lucide.createIcons();

// ========== WIDGET PANEL - ACCORDION & SEARCH ==========
function toggleWidgetCategory(categoryId) {
  const group = document.querySelector(`[data-category="${categoryId}"]`);
  if (!group) return;
  
  const content = group.querySelector('.category-content');
  const isExpanded = group.dataset.expanded === 'true';
  
  // Toggle
  group.dataset.expanded = !isExpanded;
  
  // Animation
  if (!isExpanded) {
    content.style.display = 'block';
    const height = content.scrollHeight;
    content.style.maxHeight = '0px';
    requestAnimationFrame(() => {
      content.style.maxHeight = height + 'px';
    });
  } else {
    content.style.maxHeight = '0px';
    setTimeout(() => {
      content.style.display = 'none';
    }, 350);
  }
  
  // Re-initialize Lucide icons
  lucide.createIcons();
}

// Widget Search
const widgetSearchInput = document.getElementById('widgetSearch');
const widgetClearBtn = document.getElementById('widgetClearSearch');

widgetSearchInput?.addEventListener('input', (e) => {
  const query = e.target.value.trim().toLowerCase();
  
  if (query.length > 0) {
    filterWidgets(query);
    widgetClearBtn.style.display = 'flex';
  } else {
    resetWidgetFilter();
    widgetClearBtn.style.display = 'none';
  }
});

widgetClearBtn?.addEventListener('click', () => {
  widgetSearchInput.value = '';
  resetWidgetFilter();
  widgetClearBtn.style.display = 'none';
});

function filterWidgets(query) {
  const allWidgets = document.querySelectorAll('.widget-item');
  const allCategories = document.querySelectorAll('.category-group');
  
  allCategories.forEach(category => {
    const categoryWidgets = category.querySelectorAll('.widget-item');
    let hasVisibleWidget = false;
    
    categoryWidgets.forEach(widget => {
      const name = widget.querySelector('.widget-name')?.textContent.toLowerCase() || '';
      const desc = widget.querySelector('.widget-description')?.textContent.toLowerCase() || '';
      
      if (name.includes(query) || desc.includes(query)) {
        widget.style.display = 'flex';
        hasVisibleWidget = true;
      } else {
        widget.style.display = 'none';
      }
    });
    
    // Show category if it has visible widgets
    if (hasVisibleWidget) {
      category.style.display = 'block';
      category.dataset.expanded = 'true';
      category.querySelector('.category-content').style.display = 'block';
      category.querySelector('.category-content').style.maxHeight = '9999px';
    } else {
      category.style.display = 'none';
    }
  });
  
  lucide.createIcons();
}

function resetWidgetFilter() {
  const allWidgets = document.querySelectorAll('.widget-item');
  const allCategories = document.querySelectorAll('.category-group');
  
  allWidgets.forEach(widget => {
    widget.style.display = 'flex';
  });
  
  allCategories.forEach(category => {
    category.style.display = 'block';
  });
  
  lucide.createIcons();
}

// Filter Chips
document.querySelectorAll('.widget-chip').forEach(chip => {
  chip.addEventListener('click', (e) => {
    document.querySelectorAll('.widget-chip').forEach(c => c.classList.remove('active'));
    e.currentTarget.classList.add('active');
    
    const filter = e.currentTarget.dataset.filter;
    applyWidgetFilter(filter);
  });
});

function applyWidgetFilter(filter) {
  const allWidgets = document.querySelectorAll('.widget-item');
  const allCategories = document.querySelectorAll('.category-group');
  
  allCategories.forEach(category => {
    const categoryWidgets = category.querySelectorAll('.widget-item');
    let hasVisibleWidget = false;
    
    categoryWidgets.forEach(widget => {
      let isVisible = false;
      
      switch (filter) {
        case 'premium':
          isVisible = widget.dataset.premium === 'true';
          break;
        case 'free':
          isVisible = widget.dataset.premium !== 'true';
          break;
        case 'recent':
          // TODO: Implement recent widgets from localStorage
          isVisible = false;
          break;
        case 'all':
        default:
          isVisible = true;
      }
      
      widget.style.display = isVisible ? 'flex' : 'none';
      if (isVisible) hasVisibleWidget = true;
    });
    
    if (hasVisibleWidget) {
      category.style.display = 'block';
      category.dataset.expanded = 'true';
      category.querySelector('.category-content').style.display = 'block';
      category.querySelector('.category-content').style.maxHeight = '9999px';
    } else {
      category.style.display = 'none';
    }
  });
  
  lucide.createIcons();
}

// Keyboard Shortcut (Cmd+K to focus search)
document.addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    const widgetPanel = document.getElementById('widgetPanel');
    if (!widgetPanel.classList.contains('open')) {
      openPanel('widgetPanel');
    }
    widgetSearchInput?.focus();
  }
});

// ========== WEB SPEECH API - VOICE INPUT ==========
let recognition = null;
let isRecording = false;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ko-KR';
    recognition.continuous = false;
    recognition.interimResults = true;
    
    recognition.onstart = () => {
        isRecording = true;
        const btn = document.getElementById('voiceBtn');
        btn.style.background = 'linear-gradient(135deg, #EF4444, #DC2626)';
        btn.style.animation = 'pulse 1.5s infinite';
        console.log('🎤 음성 인식 시작');
    };
    
    recognition.onresult = (event) => {
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
            }
        }
        if (finalTranscript) {
            document.getElementById('aiInput').value = finalTranscript;
            console.log('✅ 인식 완료:', finalTranscript);
        }
    };
    
    recognition.onerror = (event) => {
        console.error('❌ 음성 인식 오류:', event.error);
        isRecording = false;
        const btn = document.getElementById('voiceBtn');
        btn.style.background = '';
        btn.style.animation = '';
    };
    
    recognition.onend = () => {
        isRecording = false;
        const btn = document.getElementById('voiceBtn');
        btn.style.background = '';
        btn.style.animation = '';
        console.log('🎤 음성 인식 종료');
    };
}

// Voice Button Click
document.getElementById('voiceBtn')?.addEventListener('click', () => {
    if (!recognition) {
        alert('음성 인식이 지원되지 않는 브라우저입니다.');
        return;
    }
    if (isRecording) {
        recognition.stop();
    } else {
        recognition.start();
    }
});

// Panel Management
const activePanels = { left: null, right: null };
const viewport = document.getElementById('vp');
let scale = 1, translateX = 0, translateY = 0, isDragging = false, startX, startY;

// Touch Support Variables
let lastTouchDistance = 0;
let isTouching = false;

function closePanel(panelId) {
    const panel = document.getElementById(panelId);
    if (!panel) return;
    panel.classList.remove('active');
    activePanels[panel.dataset.side] = null;
    const icon = document.querySelector(`[data-panel="${panelId.replace('Panel', '')}"]`);
    if (icon) icon.classList.remove('active');
}

document.querySelectorAll('.icon').forEach(icon => {
    icon.addEventListener('click', function() {
        const panelName = this.dataset.panel + 'Panel';
        const panel = document.getElementById(panelName);
        if (!panel) return;
        
        const side = panel.dataset.side;
        if (panel.classList.contains('active')) {
            closePanel(panelName);
            this.classList.remove('active');
            return;
        }
        
        if (activePanels[side]) closePanel(activePanels[side]);
        panel.classList.add('active');
        this.classList.add('active');
        activePanels[side] = panelName;
    });
});

// Open initial panels on page load
window.addEventListener('load', function() {
    // Open left panel: Actions
    const leftIcon = document.querySelector('.icon[data-panel="actions"]');
    if (leftIcon) {
        leftIcon.click();
        console.log('✅ 왼쪽 사이드바 (Actions) 자동 열림');
    }
    
    // Open right panel: Stats
    const rightIcon = document.querySelector('.icon[data-panel="stats"]');
    if (rightIcon) {
        rightIcon.click();
        console.log('✅ 오른쪽 사이드바 (Stats) 자동 열림');
    }
});

// Canvas Interaction
viewport.addEventListener('mousedown', e => {
    // Don't drag canvas if clicking on a card
    if (e.target.closest('.card')) {
        return;
    }
    
    isDragging = true;
    viewport.classList.add('dragging');
    startX = e.pageX - translateX;
    startY = e.pageY - translateY;
});

document.addEventListener('mousemove', e => {
    if (!isDragging) return;
    e.preventDefault();
    translateX = e.pageX - startX;
    translateY = e.pageY - startY;
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
});

document.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        viewport.classList.remove('dragging');
    }
});

// ============================================
// TOUCH EVENTS for Mobile
// ============================================

// Touch Start
viewport.addEventListener('touchstart', e => {
    if (e.target.closest('.card')) {
        return;
    }
    
    if (e.touches.length === 1) {
        // Single touch - pan
        isTouching = true;
        isDragging = true;
        viewport.classList.add('dragging');
        startX = e.touches[0].pageX - translateX;
        startY = e.touches[0].pageY - translateY;
    } else if (e.touches.length === 2) {
        // Two finger pinch - zoom
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        lastTouchDistance = Math.hypot(
            touch2.pageX - touch1.pageX,
            touch2.pageY - touch1.pageY
        );
    }
}, { passive: false });

// Touch Move
viewport.addEventListener('touchmove', e => {
    if (e.touches.length === 1 && isDragging) {
        // Single touch - pan
        e.preventDefault();
        translateX = e.touches[0].pageX - startX;
        translateY = e.touches[0].pageY - startY;
        viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    } else if (e.touches.length === 2) {
        // Two finger pinch - zoom
        e.preventDefault();
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const currentDistance = Math.hypot(
            touch2.pageX - touch1.pageX,
            touch2.pageY - touch1.pageY
        );
        
        if (lastTouchDistance > 0) {
            const delta = currentDistance - lastTouchDistance;
            scale = Math.max(0.1, Math.min(3, scale * (1 + delta * 0.01)));
            viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
        }
        
        lastTouchDistance = currentDistance;
    }
}, { passive: false });

// Touch End
viewport.addEventListener('touchend', e => {
    if (e.touches.length === 0) {
        isDragging = false;
        isTouching = false;
        viewport.classList.remove('dragging');
        lastTouchDistance = 0;
    }
});

// Zoom
viewport.addEventListener('wheel', e => {
    // Allow zoom with mouse wheel (no Ctrl key required)
    e.preventDefault();
    scale = Math.max(0.1, Math.min(3, scale * (e.deltaY > 0 ? 0.9 : 1.1)));
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
});

document.getElementById('zoomIn').addEventListener('click', () => {
    scale = Math.min(3, scale * 1.2);
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
});

document.getElementById('zoomOut').addEventListener('click', () => {
    scale = Math.max(0.1, scale * 0.8);
    viewport.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
});

document.getElementById('fitScreen').addEventListener('click', () => {
    scale = 1;
    translateX = 0;
    translateY = 0;
    viewport.style.transform = 'translate(0, 0) scale(1)';
    document.getElementById('zoomLevel').textContent = '100%';
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        // Close all panels
        Object.values(activePanels).forEach(p => p && closePanel(p));
        document.querySelectorAll('.icon.active').forEach(i => i.classList.remove('active'));
        
        // Deselect card
        if (selectedCard) {
            selectedCard.classList.remove('selected');
            selectedCard = null;
        }
    }
    
    // Delete selected card
    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedCard) {
        const cardTitle = selectedCard.querySelector('.card-header').textContent.trim();
        selectedCard.remove();
        selectedCard = null;
        console.log('🗑️ 카드 삭제:', cardTitle);
        e.preventDefault();
    }
    
    // Panel shortcuts (1-8)
    const num = parseInt(e.key);
    if (num >= 1 && num <= 8) {
        const icons = Array.from(document.querySelectorAll('.icon'));
        icons[num - 1]?.click();
    }
});

// Auto-center card layout calculation
function calculateCenteredLayout() {
    const canvasWidth = window.innerWidth;
    const canvasHeight = window.innerHeight;
    const cardWidth = 300;
    const cardHeight = 350;
    const cols = 3;
    const rows = 3;
    const hGap = 150;
    const vGap = 120;
    
    // Calculate total grid size
    const gridWidth = cols * cardWidth + (cols - 1) * hGap;
    const gridHeight = rows * cardHeight + (rows - 1) * vGap;
    
    // Calculate starting position to center the grid
    const startX = (canvasWidth - gridWidth) / 2;
    const startY = (canvasHeight - gridHeight) / 2 + 100; // +100 for navbar offset
    
    return { startX, startY, hGap, vGap, cardWidth };
}

// Sample Cards with Thumbnails (positions will be auto-calculated)
const cardTemplates = [
    { title: '홍보 영상', content: '전시 소개 영상 (3:45)', icon: 'video', type: 'video', size: '125 MB', format: 'MP4', preview: 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4' },
    { title: '오디오 가이드', content: '전시 해설 음성 (한/영)', icon: 'headphones', type: 'audio', size: '8.5 MB', format: 'MP3', preview: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
    { title: '전시 포스터', content: '메인 비주얼 디자인', icon: 'image', type: 'image', size: '4.2 MB', format: 'PNG', preview: 'https://picsum.photos/400/300?random=1' },
    { title: '관람객 통계', content: '월간 리포트', icon: 'bar-chart-2', type: 'data', size: '1.8 MB', format: 'XLSX' },
    { title: '큐레이터 노트', content: '작품 해설 원고', icon: 'file-text', type: 'document', size: '2.4 MB', format: 'DOCX' },
    { title: '3D 모델', content: '유물 스캔 데이터', icon: 'box', type: 'data', size: '89 MB', format: 'GLB' },
    { title: '현장 사진', content: '설치 진행 사진 (24장)', icon: 'camera', type: 'image', size: '45 MB', format: 'JPG', preview: 'https://picsum.photos/400/300?random=2' },
    { title: '피드백', content: '관람객 의견 수집', icon: 'message-circle', type: 'document', size: '512 KB', format: 'PDF' },
    { title: '일정표', content: '전시 운영 스케줄', icon: 'calendar', type: 'document', size: '1.2 MB', format: 'PDF' }
];

// Generate cards with auto-centered positions
function generateCenteredCards() {
    const layout = calculateCenteredLayout();
    const cards = cardTemplates.map((template, index) => {
        const row = Math.floor(index / 3);
        const col = index % 3;
        return {
            ...template,
            x: layout.startX + col * (layout.cardWidth + layout.hGap),
            y: layout.startY + row * (layout.cardWidth + layout.vGap)
        };
    });
    return cards;
}

const cards = generateCenteredCards();

// Global variables for card management
let selectedCard = null;
let maxZIndex = 1;

// Create card function with resize handles
function createCard(card) {
    const cardEl = document.createElement('div');
    cardEl.className = 'card';
    cardEl.style.left = card.x + 'px';
    cardEl.style.top = card.y + 'px';
    cardEl.style.zIndex = maxZIndex++;
    cardEl.dataset.type = card.type;
    cardEl.dataset.title = card.title;
    if (card.preview) cardEl.dataset.preview = card.preview;
    
    // Build thumbnail content based on type and preview availability
    let thumbnailContent = '';
    if (card.preview) {
        if (card.type === 'image') {
            thumbnailContent = `<img src="${card.preview}" alt="${card.title}" style="width:100%;height:100%;object-fit:cover;">`;
        } else if (card.type === 'video') {
            thumbnailContent = `<video src="${card.preview}" style="width:100%;height:100%;object-fit:cover;" muted loop autoplay></video>`;
        } else if (card.type === 'audio') {
            thumbnailContent = `
                <i data-lucide="${card.icon}" style="width:60px;height:60px;color:rgba(255,255,255,0.9);stroke-width:1.5;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);"></i>
                <audio src="${card.preview}" controls style="position:absolute;bottom:10px;left:10px;right:10px;width:calc(100% - 20px);"></audio>
            `;
        } else {
            thumbnailContent = `<i data-lucide="${card.icon}" style="width:60px;height:60px;color:rgba(255,255,255,0.9);stroke-width:1.5"></i>`;
        }
    } else {
        thumbnailContent = `<i data-lucide="${card.icon}" style="width:60px;height:60px;color:rgba(255,255,255,0.9);stroke-width:1.5"></i>`;
    }
    
    cardEl.innerHTML = `
        <div class="card-thumbnail ${card.type}">
            ${thumbnailContent}
        </div>
        <div class="card-header">
            <i data-lucide="${card.icon}" style="width:16px;height:16px"></i>
            ${card.title}
        </div>
        <div class="card-content">
            ${card.content}
            <div class="card-meta">
                <span>📦 ${card.size}</span>
                <span>📄 ${card.format}</span>
            </div>
        </div>
        
        <!-- Resize Handles -->
        <div class="resize-handle resize-nw"></div>
        <div class="resize-handle resize-n"></div>
        <div class="resize-handle resize-ne"></div>
        <div class="resize-handle resize-e"></div>
        <div class="resize-handle resize-se"></div>
        <div class="resize-handle resize-s"></div>
        <div class="resize-handle resize-sw"></div>
        <div class="resize-handle resize-w"></div>
        
        <!-- Connection Handle (Google Opal Style) -->
        <div class="connection-handle" title="연결선 만들기"></div>
    `;
    
    // Thumbnail click for modal viewer
    const thumbnail = cardEl.querySelector('.card-thumbnail');
    if (thumbnail) {
        thumbnail.addEventListener('click', function(e) {
            e.stopPropagation();
            const type = cardEl.dataset.type;
            const preview = cardEl.dataset.preview;
            const title = cardEl.dataset.title;
            
            if (preview && (type === 'image' || type === 'video')) {
                openModal(type, preview, title);
            }
        });
    }
    
    // Card selection
    cardEl.addEventListener('click', function(e) {
        if (!e.target.classList.contains('resize-handle') && !e.target.closest('.card-thumbnail')) {
            selectCard(cardEl);
            e.stopPropagation();
        }
    });
    
    // Card drag functionality
    let cardDragging = false;
    let cardStartX, cardStartY, cardInitialX, cardInitialY;
    
    const onCardMouseDown = function(e) {
        // Don't drag if clicking on resize handles
        if (e.target.classList.contains('resize-handle')) {
            return;
        }
        
        // Don't drag if clicking on connection handle
        if (e.target.classList.contains('connection-handle')) {
            return;
        }
        
        // Don't drag if clicking on video/audio controls
        if (e.target.tagName === 'VIDEO' || e.target.tagName === 'AUDIO') {
            return;
        }
        
        // Allow drag from anywhere on the card
        cardDragging = true;
        cardStartX = e.clientX;
        cardStartY = e.clientY;
        cardInitialX = parseInt(cardEl.style.left) || 0;
        cardInitialY = parseInt(cardEl.style.top) || 0;
        cardEl.style.cursor = 'grabbing';
        
        // CRITICAL: Prevent canvas from dragging
        e.stopPropagation();
        
        const headerElement = cardEl.querySelector('.card-header');
        console.log('🎯 카드 드래그 시작:', headerElement ? headerElement.textContent.trim() : 'Unknown');
    };
    
    const onCardMouseMove = function(e) {
        if (cardDragging) {
            e.preventDefault();
            e.stopPropagation();
            
            const deltaX = (e.clientX - cardStartX) / scale;
            const deltaY = (e.clientY - cardStartY) / scale;
            cardEl.style.left = (cardInitialX + deltaX) + 'px';
            cardEl.style.top = (cardInitialY + deltaY) + 'px';
        }
    };
    
    const onCardMouseUp = function() {
        if (cardDragging) {
            cardDragging = false;
            cardEl.style.cursor = 'move';
            console.log('✅ 카드 드래그 완료');
        }
    };
    
    cardEl.addEventListener('mousedown', onCardMouseDown);
    document.addEventListener('mousemove', onCardMouseMove);
    document.addEventListener('mouseup', onCardMouseUp);
    
    // Touch Events for Card Dragging
    const onCardTouchStart = function(e) {
        if (e.target.classList.contains('resize-handle') || 
            e.target.classList.contains('connection-handle') ||
            e.target.tagName === 'VIDEO' || 
            e.target.tagName === 'AUDIO') {
            return;
        }
        
        cardDragging = true;
        const touch = e.touches[0];
        cardStartX = touch.clientX;
        cardStartY = touch.clientY;
        cardInitialX = parseInt(cardEl.style.left) || 0;
        cardInitialY = parseInt(cardEl.style.top) || 0;
        
        e.stopPropagation();
        console.log('🎯 카드 터치 드래그 시작');
    };
    
    const onCardTouchMove = function(e) {
        if (cardDragging) {
            e.preventDefault();
            e.stopPropagation();
            
            const touch = e.touches[0];
            const deltaX = (touch.clientX - cardStartX) / scale;
            const deltaY = (touch.clientY - cardStartY) / scale;
            cardEl.style.left = (cardInitialX + deltaX) + 'px';
            cardEl.style.top = (cardInitialY + deltaY) + 'px';
        }
    };
    
    const onCardTouchEnd = function() {
        if (cardDragging) {
            cardDragging = false;
            updateAllConnections();
            console.log('✅ 카드 터치 드래그 완료');
        }
    };
    
    cardEl.addEventListener('touchstart', onCardTouchStart, { passive: false });
    cardEl.addEventListener('touchmove', onCardTouchMove, { passive: false });
    cardEl.addEventListener('touchend', onCardTouchEnd);
    
    // Resize functionality
    setupResizeHandles(cardEl);
    
    // Connection handle functionality
    setupConnectionHandles(cardEl);
    
    // Update connections when this card moves
    cardEl.addEventListener('mouseup', updateAllConnections);
    cardEl.addEventListener('touchend', updateAllConnections);
    
    viewport.appendChild(cardEl);
    return cardEl;
}

// Card selection management
function selectCard(cardEl) {
    // Deselect previous card
    if (selectedCard) {
        selectedCard.classList.remove('selected');
    }
    
    // Select new card and bring to front
    selectedCard = cardEl;
    cardEl.classList.add('selected');
    cardEl.style.zIndex = maxZIndex++;
    
    console.log('✅ 카드 선택:', cardEl.querySelector('.card-header').textContent.trim());
}

// Deselect when clicking canvas
viewport.addEventListener('click', function(e) {
    if (e.target === viewport && selectedCard) {
        selectedCard.classList.remove('selected');
        selectedCard = null;
    }
});

// Resize handles setup
function setupResizeHandles(cardEl) {
    const handles = cardEl.querySelectorAll('.resize-handle');
    
    handles.forEach(handle => {
        handle.addEventListener('mousedown', function(e) {
            e.stopPropagation();
            const direction = Array.from(handle.classList).find(c => c.startsWith('resize-')).replace('resize-', '');
            
            const startX = e.clientX;
            const startY = e.clientY;
            const startWidth = cardEl.offsetWidth;
            const startHeight = cardEl.offsetHeight;
            const startLeft = parseInt(cardEl.style.left) || 0;
            const startTop = parseInt(cardEl.style.top) || 0;
            
            function onMouseMove(e) {
                const deltaX = (e.clientX - startX) / scale;
                const deltaY = (e.clientY - startY) / scale;
                
                if (direction.includes('e')) {
                    cardEl.style.width = Math.max(200, startWidth + deltaX) + 'px';
                }
                if (direction.includes('w')) {
                    const newWidth = Math.max(200, startWidth - deltaX);
                    cardEl.style.width = newWidth + 'px';
                    cardEl.style.left = (startLeft + (startWidth - newWidth)) + 'px';
                }
                if (direction.includes('s')) {
                    cardEl.style.height = Math.max(200, startHeight + deltaY) + 'px';
                }
                if (direction.includes('n')) {
                    const newHeight = Math.max(200, startHeight - deltaY);
                    cardEl.style.height = newHeight + 'px';
                    cardEl.style.top = (startTop + (startHeight - newHeight)) + 'px';
                }
            }
            
            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                console.log('✅ 카드 크기 조절 완료:', cardEl.offsetWidth + 'x' + cardEl.offsetHeight);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });
}

// Google Opal Style Connection System
const connections = [];
let connectingFrom = null;

function createConnection(fromCard, toCard) {
    const conn = {
        from: fromCard,
        to: toCard,
        line: null
    };
    connections.push(conn);
    updateConnectionLine(conn);
    return conn;
}

function updateConnectionLine(conn) {
    // Get card positions directly from their style properties
    const fromX = parseInt(conn.from.style.left) || 0;
    const fromY = parseInt(conn.from.style.top) || 0;
    const fromWidth = conn.from.offsetWidth;
    const fromHeight = conn.from.offsetHeight;
    
    const toX = parseInt(conn.to.style.left) || 0;
    const toY = parseInt(conn.to.style.top) || 0;
    const toWidth = conn.to.offsetWidth;
    const toHeight = conn.to.offsetHeight;
    
    // Calculate connection points (right side of from card, left side of to card)
    const startX = fromX + fromWidth;
    const startY = fromY + fromHeight / 2;
    const endX = toX;
    const endY = toY + toHeight / 2;
    
    const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
    
    if (!conn.line) {
        conn.line = document.createElement('div');
        conn.line.className = 'card-connector';
        viewport.appendChild(conn.line);
    }
    
    conn.line.style.left = startX + 'px';
    conn.line.style.top = startY + 'px';
    conn.line.style.width = distance + 'px';
    conn.line.style.transform = `rotate(${angle}deg)`;
}

function updateAllConnections() {
    connections.forEach(conn => updateConnectionLine(conn));
}

// Setup connection handles for each card
function setupConnectionHandles(cardEl) {
    const handle = cardEl.querySelector('.connection-handle');
    
    handle.addEventListener('mousedown', function(e) {
        e.stopPropagation();
        e.preventDefault();
        
        connectingFrom = cardEl;
        handle.style.background = '#f59e0b';
        handle.style.boxShadow = '0 0 20px rgba(245, 158, 11, 0.8)';
        
        console.log('🔗 연결 시작:', cardEl.querySelector('.card-header').textContent.trim());
    });
}

// Listen for connection target
document.addEventListener('click', function(e) {
    if (connectingFrom) {
        const targetCard = e.target.closest('.card');
        
        if (targetCard && targetCard !== connectingFrom) {
            createConnection(connectingFrom, targetCard);
            console.log('✅ 카드 연결:', 
                connectingFrom.querySelector('.card-header').textContent.trim(), 
                '→', 
                targetCard.querySelector('.card-header').textContent.trim()
            );
        }
        
        // Reset connection state
        const handle = connectingFrom.querySelector('.connection-handle');
        handle.style.background = '';
        handle.style.boxShadow = '';
        connectingFrom = null;
    }
});

// Update connections on viewport transformation
const viewportObserver = new MutationObserver(updateAllConnections);
viewportObserver.observe(viewport, { attributes: true, attributeFilter: ['style'] });

// Create all initial cards
cards.forEach(card => createCard(card));

// Global function to add AI-generated content cards
window.addAICard = function(type, title, content, imageUrl = null) {
    const newCard = {
        title: title,
        content: content,
        icon: type === 'image' ? 'image' : type === 'video' ? 'video' : type === 'audio' ? 'headphones' : 'file',
        type: type,
        size: 'AI Generated',
        format: type.toUpperCase(),
        x: Math.random() * 500 + 100,
        y: Math.random() * 400 + 100
    };
    
    const cardEl = createCard(newCard);
    
    // If image/video URL provided, replace thumbnail
    if (imageUrl && (type === 'image' || type === 'video')) {
        const thumbnail = cardEl.querySelector('.card-thumbnail');
        thumbnail.innerHTML = type === 'image' 
            ? `<img src="${imageUrl}" alt="${title}">`
            : `<video src="${imageUrl}" controls></video>`;
    }
    
    lucide.createIcons();
    selectCard(cardEl);
    
    console.log('✅ AI 생성 카드 추가:', title, '(' + type + ')');
    return cardEl;
};

// Modal Viewer Functions
function openModal(type, url, title) {
    const modal = document.getElementById('modalViewer');
    const content = document.getElementById('modalContent');
    
    if (type === 'image') {
        content.innerHTML = `<img src="${url}" alt="${title}">`;
    } else if (type === 'video') {
        content.innerHTML = `<video src="${url}" controls autoplay style="outline: none;"></video>`;
    }
    
    modal.classList.add('active');
    console.log('🖼️ 모달 열림:', title);
}

function closeModal() {
    const modal = document.getElementById('modalViewer');
    const content = document.getElementById('modalContent');
    
    // Stop video if playing
    const video = content.querySelector('video');
    if (video) {
        video.pause();
        video.currentTime = 0;
    }
    
    modal.classList.remove('active');
    content.innerHTML = '';
    console.log('❌ 모달 닫힘');
}

// Close modal on overlay click
document.getElementById('modalViewer').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Close modal on Escape key  
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('modalViewer');
        if (modal.classList.contains('active')) {
            closeModal();
        }
    }
});

// Auto-create workflow connections based on typical museum workflow
function createAutoWorkflowConnections() {
    const allCards = document.querySelectorAll('.card');
    const cardsByTitle = {};
    
    allCards.forEach(card => {
        const title = card.dataset.title;
        if (title) cardsByTitle[title] = card;
    });
    
    // Define workflow connections (from → to)
    const workflowConnections = [
        ['홍보 영상', '전시 포스터'],      // Video → Poster design
        ['전시 포스터', '현장 사진'],      // Poster → Site photos
        ['오디오 가이드', '큐레이터 노트'], // Audio guide → Curator notes
        ['관람객 통계', '피드백'],         // Stats → Feedback
        ['3D 모델', '관람객 통계'],        // 3D model → Stats
        ['현장 사진', '일정표']            // Photos → Schedule
    ];
    
    // Create connections
    workflowConnections.forEach(([fromTitle, toTitle]) => {
        const fromCard = cardsByTitle[fromTitle];
        const toCard = cardsByTitle[toTitle];
        
        if (fromCard && toCard) {
            createConnection(fromCard, toCard);
            console.log('🔗 자동 연결:', fromTitle, '→', toTitle);
        }
    });
    
    console.log('✅ 워크플로우 자동 연결 완료:', workflowConnections.length, '개 연결');
}

// Initialize auto workflow after cards are created
setTimeout(() => {
    createAutoWorkflowConnections();
}, 500);

// ============================================
// Canvas-Dashboard 데이터 연동
// ============================================

/**
 * Dashboard로 Canvas 업데이트 전송
 * @param {string} updateType - 'canvas_nodes' 또는 'dashboard_widgets'
 * @param {object} updateData - { title, items[] }
 */
function sendToDashboard(updateType, updateData) {
    try {
        const updates = JSON.parse(localStorage.getItem('dashboard_updates') || '[]');
        
        updates.push({
            type: updateType,
            title: updateData.title || 'Canvas 업데이트',
            data: updateData.items || [],
            timestamp: Date.now()
        });
        
        localStorage.setItem('dashboard_updates', JSON.stringify(updates));
        console.log(`✅ [Canvas → Dashboard] Sent ${updateType}:`, updateData.title, `(${updateData.items?.length || 0} items)`);
    } catch (error) {
        console.error('❌ [Canvas → Dashboard] Error:', error);
    }
}

/**
 * Canvas 상태를 Dashboard로 전송
 */
function syncCanvasStateToDashboard() {
    const cards = Array.from(viewport.querySelectorAll('.card'));
    
    if (cards.length === 0) return;
    
    const cardData = cards.map(card => {
        const header = card.querySelector('.card-header');
        const content = card.querySelector('.card-content p');
        
        return {
            title: header ? header.textContent.trim() : 'Untitled',
            content: content ? content.textContent.trim() : '',
            x: card.style.left,
            y: card.style.top,
            status: 'active',
            timestamp: Date.now()
        };
    });
    
    sendToDashboard('canvas_nodes', {
        title: `Canvas 상태 (${cards.length}개 노드)`,
        items: cardData
    });
}

// 카드 삭제 시 Dashboard 알림
document.addEventListener('keydown', e => {
    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedCard) {
        const cardTitle = selectedCard.querySelector('.card-header').textContent.trim();
        
        // Dashboard로 삭제 알림 전송
        sendToDashboard('canvas_nodes', {
            title: '카드 삭제',
            items: [{ 
                title: cardTitle, 
                status: 'deleted',
                timestamp: Date.now()
            }]
        });
    }
});

// 초기 Canvas 상태 전송 (페이지 로드 후 2초 후)
setTimeout(() => {
    syncCanvasStateToDashboard();
    console.log('🚀 [Canvas → Dashboard] Initial sync completed');
}, 2000);

// 자동 동기화 (10초마다)
setInterval(() => {
    syncCanvasStateToDashboard();
}, 10000);

// localStorage 저장 함수 (Canvas 상태 복원용)
function saveCanvasState() {
    const cards = Array.from(viewport.querySelectorAll('.card'));
    
    const state = {
        cards: cards.map(card => ({
            id: card.dataset.id || Math.random().toString(36).substr(2, 9),
            title: card.querySelector('.card-header')?.textContent.trim() || '',
            content: card.querySelector('.card-content p')?.textContent.trim() || '',
            x: card.style.left,
            y: card.style.top,
            width: card.style.width,
            height: card.style.height
        })),
        connections: connections.map(conn => ({
            from: conn.from.querySelector('.card-header')?.textContent.trim() || '',
            to: conn.to.querySelector('.card-header')?.textContent.trim() || ''
        })),
        viewport: {
            translateX,
            translateY,
            scale
        },
        timestamp: Date.now()
    };
    
    localStorage.setItem('canvas_state', JSON.stringify(state));
    console.log('💾 Canvas 상태 저장됨:', cards.length, '개 카드');
}

// 자동 저장 (10초마다)
setInterval(saveCanvasState, 10000);

// 페이지 종료 시 저장
window.addEventListener('beforeunload', () => {
    saveCanvasState();
    syncCanvasStateToDashboard();
});

console.log('✅ Canvas-Dashboard 연동 초기화 완료');

// ============================================
// AI 어시스턴트 기능
// ============================================

/**
 * AI 응답 표시 함수
 */
function showAIResponse(message, isError = false) {
    const aiPanel = document.getElementById('aiPanel');
    const panelContent = aiPanel.querySelector('.panel-content > div');
    
    // AI 패널 자동 열기
    if (!aiPanel.classList.contains('active')) {
        document.querySelector('[data-panel="ai"]').click();
    }
    
    // 응답 메시지 추가
    const responseHtml = `
        <div style="padding: 0.75rem; background: ${isError ? 'rgba(239, 68, 68, 0.1)' : 'rgba(139, 92, 246, 0.1)'}; border-radius: 8px; border-left: 3px solid ${isError ? '#EF4444' : '#8B5CF6'}; margin-bottom: 0.75rem;">
            <div style="font-size: 0.875rem; color: #9CA3AF; margin-bottom: 0.5rem;">${new Date().toLocaleTimeString('ko-KR')}</div>
            <div style="font-size: 0.9375rem; color: #e5e5e5; line-height: 1.5;">${message}</div>
        </div>
    `;
    
    panelContent.insertAdjacentHTML('afterbegin', responseHtml);
    
    // 최대 10개 응답만 유지
    const responses = panelContent.querySelectorAll('div[style*="padding: 0.75rem"]');
    if (responses.length > 10) {
        responses[responses.length - 1].remove();
    }
}

/**
 * AI API 호출 함수
 */
async function callAI(message, model = 'GPT-4o') {
    try {
        showAIResponse(`🤖 AI 분석 중... (${model})`, false);
        
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                model: model,
                context: {
                    page: 'canvas',
                    cardCount: viewport.querySelectorAll('.card').length,
                    connections: connections.length
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`AI API 에러: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.response) {
            showAIResponse(data.response, false);
            console.log('✅ [Canvas AI] Response:', data.response);
            
            // Dashboard로 AI 활동 전송
            sendToDashboard('dashboard_widgets', {
                title: 'AI 어시스턴트 활동',
                items: [{
                    title: `AI 질문: ${message.substring(0, 30)}...`,
                    content: data.response.substring(0, 100),
                    status: 'completed',
                    timestamp: Date.now()
                }]
            });
        } else {
            throw new Error(data.error || 'AI 응답 실패');
        }
    } catch (error) {
        console.error('❌ [Canvas AI] Error:', error);
        showAIResponse(`❌ AI 오류: ${error.message}`, true);
    }
}

/**
 * AI 입력 전송 처리
 */
function sendAIMessage() {
    const input = document.getElementById('aiInput');
    const select = document.querySelector('.ai-select');
    const message = input.value.trim();
    
    if (!message) {
        showAIResponse('❌ 메시지를 입력해주세요.', true);
        return;
    }
    
    const model = select.value;
    console.log(`📤 [Canvas AI] Sending: "${message}" (${model})`);
    
    // AI 호출
    callAI(message, model);
    
    // 입력창 초기화
    input.value = '';
}

// AI 전송 버튼 이벤트
document.querySelector('.ai-send')?.addEventListener('click', sendAIMessage);

// AI 입력창 Enter 키 이벤트
document.getElementById('aiInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendAIMessage();
    }
});

console.log('✅ Canvas AI 어시스턴트 초기화 완료');

// ============================================
// Widget 드래그앤드롭 기능
// ============================================

let draggedWidgetData = null;

// Widget 드래그 시작
document.querySelectorAll('.widget-item').forEach(widget => {
    widget.addEventListener('dragstart', (e) => {
        const widgetType = widget.dataset.widgetType;
        const widgetName = widget.querySelector('.widget-name')?.textContent || 'New Widget';
        const widgetDesc = widget.querySelector('.widget-description')?.textContent || '';
        const isPremium = widget.querySelector('.badge-premium') !== null;
        
        draggedWidgetData = {
            type: widgetType,
            name: widgetName,
            description: widgetDesc,
            isPremium: isPremium
        };
        
        e.dataTransfer.effectAllowed = 'copy';
        e.dataTransfer.setData('text/plain', JSON.stringify(draggedWidgetData));
        
        // 드래그 중 시각적 피드백
        widget.style.opacity = '0.5';
        console.log('🎨 Widget 드래그 시작:', widgetName);
    });
    
    widget.addEventListener('dragend', (e) => {
        widget.style.opacity = '1';
    });
});

// Canvas에 드롭 가능하도록 설정
const viewport = document.getElementById('viewport');

viewport.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
});

viewport.addEventListener('drop', (e) => {
    e.preventDefault();
    
    if (!draggedWidgetData) {
        console.warn('⚠️ Widget 데이터가 없습니다');
        return;
    }
    
    // Canvas 좌표 계산 (viewport 기준)
    const viewportRect = viewport.getBoundingClientRect();
    const x = e.clientX - viewportRect.left - pan.x;
    const y = e.clientY - viewportRect.top - pan.y;
    
    // Widget 노드 생성
    const card = createCardElement(
        draggedWidgetData.name,
        draggedWidgetData.description,
        x / zoom,
        y / zoom
    );
    
    // Widget 타입 데이터 추가
    card.dataset.widgetType = draggedWidgetData.type;
    card.dataset.isPremium = draggedWidgetData.isPremium;
    
    // Premium 뱃지 추가
    if (draggedWidgetData.isPremium) {
        const header = card.querySelector('.card-header');
        if (header) {
            const premiumBadge = document.createElement('span');
            premiumBadge.className = 'badge-premium';
            premiumBadge.textContent = '⭐ PRO';
            premiumBadge.style.cssText = `
                display: inline-block;
                margin-left: 8px;
                padding: 2px 6px;
                font-size: 9px;
                font-weight: 600;
                background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
                border-radius: 4px;
                color: white;
            `;
            header.appendChild(premiumBadge);
        }
    }
    
    viewport.appendChild(card);
    
    // Dashboard 동기화
    setTimeout(() => {
        syncCanvasToDashboard();
    }, 100);
    
    console.log('✅ Widget 노드 생성:', draggedWidgetData.name, `at (${Math.round(x)}, ${Math.round(y)})`);
    
    // 드래그 데이터 초기화
    draggedWidgetData = null;
});

console.log('✅ Widget 드래그앤드롭 초기화 완료');

lucide.createIcons();
</script>
</body>
</html>
