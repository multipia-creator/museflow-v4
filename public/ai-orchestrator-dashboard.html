<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MuseFlow - AI Orchestrator Dashboard</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- External Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #111827;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Main Container */
        .ai-dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Header */
        .dashboard-header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        
        .dashboard-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-header p {
            font-size: 1.125rem;
            opacity: 0.9;
        }
        
        /* AI Command Panel */
        .ai-command-panel {
            background: white;
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            margin-bottom: 2rem;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #F3F4F6;
        }
        
        .panel-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }
        
        .ai-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #ECFDF5;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #059669;
        }
        
        .ai-status i {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Workflow Selection */
        .workflow-selection {
            margin-bottom: 2rem;
        }
        
        .workflow-label {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
            display: block;
        }
        
        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .workflow-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .workflow-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.3);
        }
        
        .workflow-card.active {
            border-color: #FBBF24;
            box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.2);
        }
        
        .workflow-card i {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }
        
        .workflow-card h3 {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .workflow-card p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        /* AI Command Input */
        .ai-command-input {
            margin-bottom: 1.5rem;
        }
        
        .command-label {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
            display: block;
        }
        
        .command-textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .command-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .command-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #F3F4F6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #E5E7EB;
        }
        
        /* Execution Progress */
        .execution-progress {
            background: #F9FAFB;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: none;
        }
        
        .execution-progress.active {
            display: block;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .progress-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #111827;
        }
        
        .progress-status {
            font-size: 0.875rem;
            font-weight: 600;
            color: #059669;
        }
        
        .progress-bar-container {
            background: #E5E7EB;
            border-radius: 8px;
            height: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-phases {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .phase-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            border: 2px solid #E5E7EB;
            transition: all 0.3s ease;
        }
        
        .phase-item.active {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .phase-item.completed {
            border-color: #059669;
            background: #ECFDF5;
        }
        
        .phase-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .phase-item.active .phase-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: spin 2s linear infinite;
        }
        
        .phase-item.completed .phase-icon {
            background: #059669;
            color: white;
        }
        
        .phase-item.pending .phase-icon {
            background: #F3F4F6;
            color: #9CA3AF;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .phase-content {
            flex: 1;
        }
        
        .phase-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
        }
        
        .phase-description {
            font-size: 0.875rem;
            color: #6B7280;
        }
        
        .phase-timestamp {
            font-size: 0.75rem;
            color: #9CA3AF;
            margin-top: 0.25rem;
        }
        
        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .result-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 2px solid #E5E7EB;
            transition: all 0.3s ease;
        }
        
        .result-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.1);
        }
        
        .result-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .result-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .result-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #111827;
        }
        
        .result-content {
            color: #6B7280;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        
        .result-action {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: #F3F4F6;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
        }
        
        .result-action:hover {
            background: #E5E7EB;
        }
        
        /* Event Stream */
        .event-stream {
            background: #1F2937;
            border-radius: 16px;
            padding: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            color: #10B981;
        }
        
        .event-stream::-webkit-scrollbar {
            width: 8px;
        }
        
        .event-stream::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 4px;
        }
        
        .event-stream::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        .event-line {
            margin-bottom: 0.5rem;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .event-timestamp {
            color: #9CA3AF;
        }
        
        .event-type {
            color: #60A5FA;
            font-weight: 600;
        }
        
        .event-message {
            color: #D1D5DB;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .workflow-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .command-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="ai-dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1><i class="fas fa-robot"></i> MuseFlow AI Orchestrator</h1>
            <p>AI가 큐레이터의 업무를 자동화합니다. 명령만 내리면 나머지는 AI가 처리합니다.</p>
        </div>
        
        <!-- AI Command Panel -->
        <div class="ai-command-panel">
            <div class="panel-header">
                <h2 class="panel-title"><i class="fas fa-terminal"></i> AI Command Panel</h2>
                <div class="ai-status">
                    <i class="fas fa-circle"></i>
                    <span>AI Ready</span>
                </div>
            </div>
            
            <!-- Workflow Selection -->
            <div class="workflow-selection">
                <label class="workflow-label">1. 워크플로우 선택</label>
                <div class="workflow-grid">
                    <div class="workflow-card" data-workflow="exhibition_planning">
                        <i class="fas fa-palette"></i>
                        <h3>전시 기획</h3>
                        <p>AI가 전시를 자동으로 기획합니다</p>
                    </div>
                    <div class="workflow-card" data-workflow="budget_approval">
                        <i class="fas fa-dollar-sign"></i>
                        <h3>예산 승인</h3>
                        <p>예산 계획 및 승인 자동화</p>
                    </div>
                    <div class="workflow-card" data-workflow="collection_selection">
                        <i class="fas fa-images"></i>
                        <h3>소장품 선정</h3>
                        <p>AI가 최적의 작품을 선정합니다</p>
                    </div>
                    <div class="workflow-card" data-workflow="education_program">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>교육 프로그램</h3>
                        <p>교육 커리큘럼 자동 생성</p>
                    </div>
                    <div class="workflow-card" data-workflow="promotion_plan">
                        <i class="fas fa-bullhorn"></i>
                        <h3>홍보 계획</h3>
                        <p>SNS, 보도자료 자동 생성</p>
                    </div>
                </div>
            </div>
            
            <!-- AI Command Input -->
            <div class="ai-command-input">
                <label class="command-label">2. AI에게 명령하기</label>
                <textarea 
                    id="aiCommandInput" 
                    class="command-textarea" 
                    placeholder="예시: '인상주의 특별전을 3000만원 예산으로 기획해줘. 모네, 르누아르, 마네 작품 중심으로 구성하고, 3개월 기간으로 계획해줘.'"
                ></textarea>
            </div>
            
            <!-- Command Actions -->
            <div class="command-actions">
                <button class="btn btn-secondary" id="clearBtn">
                    <i class="fas fa-times"></i> 초기화
                </button>
                <button class="btn btn-primary" id="executeBtn">
                    <i class="fas fa-rocket"></i> AI 실행
                </button>
            </div>
        </div>
        
        <!-- Execution Progress -->
        <div class="execution-progress" id="executionProgress">
            <div class="progress-header">
                <h3 class="progress-title">AI 실행 중...</h3>
                <span class="progress-status" id="progressStatus">0% 완료</span>
            </div>
            
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="progress-phases" id="progressPhases">
                <!-- Phases will be dynamically added here -->
            </div>
        </div>
        
        <!-- Results Grid -->
        <div class="results-grid" id="resultsGrid" style="display: none;">
            <!-- Results will be dynamically added here -->
        </div>
        
        <!-- Event Stream -->
        <div style="margin-bottom: 2rem;">
            <h3 style="color: white; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">
                <i class="fas fa-stream"></i> 실시간 이벤트 스트림
            </h3>
            <div class="event-stream" id="eventStream">
                <div class="event-line">
                    <span class="event-timestamp">[시스템]</span>
                    <span class="event-type">AI Orchestrator</span>
                    <span class="event-message">준비 완료. 명령을 기다리고 있습니다...</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let selectedWorkflow = null;
        let eventSource = null;
        let sessionId = null;
        
        // Workflow Cards Selection
        document.querySelectorAll('.workflow-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.workflow-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                selectedWorkflow = this.dataset.workflow;
                addEventLog('사용자', `워크플로우 선택: ${this.querySelector('h3').textContent}`);
            });
        });
        
        // Clear Button
        document.getElementById('clearBtn').addEventListener('click', function() {
            document.getElementById('aiCommandInput').value = '';
            document.querySelectorAll('.workflow-card').forEach(c => c.classList.remove('active'));
            selectedWorkflow = null;
            document.getElementById('executionProgress').classList.remove('active');
            document.getElementById('resultsGrid').style.display = 'none';
            addEventLog('시스템', '초기화 완료');
        });
        
        // Execute Button
        document.getElementById('executeBtn').addEventListener('click', async function() {
            const command = document.getElementById('aiCommandInput').value.trim();
            
            if (!selectedWorkflow) {
                alert('워크플로우를 먼저 선택해주세요!');
                return;
            }
            
            if (!command) {
                alert('AI 명령을 입력해주세요!');
                return;
            }
            
            addEventLog('사용자', `실행 명령: ${command.substring(0, 50)}...`);
            
            // Start AI Execution
            await startAIExecution(selectedWorkflow, command);
        });
        
        // Start AI Execution
        async function startAIExecution(workflowType, userInput) {
            try {
                // Show progress panel
                document.getElementById('executionProgress').classList.add('active');
                document.getElementById('resultsGrid').style.display = 'none';
                
                addEventLog('AI', 'AI Orchestrator 시작...');
                
                // Call API to start execution
                const response = await fetch('/api/orchestrator/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workflow_type: workflowType,
                        user_input: userInput,
                        user_id: 'curator-demo',
                        autonomy_preference: 'balanced'
                    })
                });
                
                const data = await response.json();
                sessionId = data.session_id;
                
                addEventLog('시스템', `세션 ID: ${sessionId}`);
                addEventLog('AI', 'SSE 스트림 연결 중...');
                
                // Connect to SSE stream
                connectToEventStream(sessionId);
                
            } catch (error) {
                console.error('AI 실행 오류:', error);
                addEventLog('에러', error.message);
                alert('AI 실행 중 오류가 발생했습니다.');
            }
        }
        
        // Connect to SSE Event Stream
        function connectToEventStream(sessionId) {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`/api/orchestrator/stream/${sessionId}`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleStreamEvent(data);
            };
            
            eventSource.onerror = function(error) {
                console.error('SSE 오류:', error);
                addEventLog('에러', 'SSE 연결 실패');
                eventSource.close();
            };
        }
        
        // Handle Stream Event
        function handleStreamEvent(data) {
            const { type, payload } = data;
            
            switch (type) {
                case 'start':
                    addEventLog('AI', `시작: ${payload.workflow_type}`);
                    initializePhases(payload.phases);
                    break;
                
                case 'phase-start':
                    addEventLog('AI', `Phase 시작: ${payload.phase_name}`);
                    updatePhaseStatus(payload.phase_index, 'active');
                    break;
                
                case 'agent-action':
                    addEventLog('Agent', `${payload.agent_type}: ${payload.action}`);
                    break;
                
                case 'phase-complete':
                    addEventLog('AI', `Phase 완료: ${payload.phase_name}`);
                    updatePhaseStatus(payload.phase_index, 'completed');
                    updateProgress(payload.progress);
                    break;
                
                case 'complete':
                    addEventLog('AI', '모든 Phase 완료!');
                    updateProgress(100);
                    displayResults(payload.results);
                    eventSource.close();
                    break;
                
                case 'error':
                    addEventLog('에러', payload.message);
                    eventSource.close();
                    break;
                
                case 'keep-alive':
                    // Keep-alive, no action needed
                    break;
            }
        }
        
        // Initialize Phases
        function initializePhases(phases) {
            const container = document.getElementById('progressPhases');
            container.innerHTML = '';
            
            phases.forEach((phase, index) => {
                const phaseHtml = `
                    <div class="phase-item pending" data-index="${index}">
                        <div class="phase-icon">
                            <i class="fas fa-circle"></i>
                        </div>
                        <div class="phase-content">
                            <div class="phase-name">${phase.name}</div>
                            <div class="phase-description">${phase.description}</div>
                            <div class="phase-timestamp"></div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', phaseHtml);
            });
        }
        
        // Update Phase Status
        function updatePhaseStatus(phaseIndex, status) {
            const phaseItem = document.querySelector(`.phase-item[data-index="${phaseIndex}"]`);
            if (!phaseItem) return;
            
            phaseItem.classList.remove('pending', 'active', 'completed');
            phaseItem.classList.add(status);
            
            const icon = phaseItem.querySelector('.phase-icon i');
            if (status === 'active') {
                icon.className = 'fas fa-spinner';
            } else if (status === 'completed') {
                icon.className = 'fas fa-check';
                const timestamp = phaseItem.querySelector('.phase-timestamp');
                timestamp.textContent = new Date().toLocaleTimeString('ko-KR');
            }
        }
        
        // Update Progress Bar
        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressStatus').textContent = Math.round(percent) + '% 완료';
        }
        
        // Display Results
        function displayResults(results) {
            const container = document.getElementById('resultsGrid');
            container.innerHTML = '';
            container.style.display = 'grid';
            
            // Canvas Nodes
            if (results.canvas_nodes && results.canvas_nodes.length > 0) {
                const nodeHtml = `
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon"><i class="fas fa-project-diagram"></i></div>
                            <div class="result-title">Canvas 노드</div>
                        </div>
                        <div class="result-content">
                            ${results.canvas_nodes.length}개의 Canvas 노드가 생성되었습니다.
                        </div>
                        <div class="result-action">
                            <i class="fas fa-eye"></i> Canvas에서 보기
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', nodeHtml);
            }
            
            // Documents
            if (results.documents && results.documents.length > 0) {
                const docHtml = `
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon"><i class="fas fa-file-alt"></i></div>
                            <div class="result-title">생성된 문서</div>
                        </div>
                        <div class="result-content">
                            ${results.documents.length}개의 문서가 자동 생성되었습니다.
                        </div>
                        <div class="result-action">
                            <i class="fas fa-download"></i> 문서 다운로드
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', docHtml);
            }
            
            // Widgets
            if (results.widgets && results.widgets.length > 0) {
                const widgetHtml = `
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon"><i class="fas fa-th"></i></div>
                            <div class="result-title">Dashboard 위젯</div>
                        </div>
                        <div class="result-content">
                            ${results.widgets.length}개의 위젯이 Dashboard에 추가되었습니다.
                        </div>
                        <div class="result-action">
                            <i class="fas fa-external-link-alt"></i> Dashboard 보기
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', widgetHtml);
            }
            
            addEventLog('시스템', '결과 표시 완료');
        }
        
        // Add Event Log
        function addEventLog(type, message) {
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const eventStream = document.getElementById('eventStream');
            
            const eventHtml = `
                <div class="event-line">
                    <span class="event-timestamp">[${timestamp}]</span>
                    <span class="event-type">${type}</span>
                    <span class="event-message">${message}</span>
                </div>
            `;
            
            eventStream.insertAdjacentHTML('beforeend', eventHtml);
            eventStream.scrollTop = eventStream.scrollHeight;
        }
    </script>
</body>
</html>
