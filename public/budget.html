<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="4.0.0">
    <title>ÏòàÏÇ∞ Í¥ÄÎ¶¨ - MuseFlow</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/tracker.js?v=4.0.0"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --museum-purple: #8b5cf6;
            --museum-pink: #ec4899;
            --museum-gold: #f59e0b;
            --urgent: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a0f2e 50%, #0a0a0f 100%);
            color: #f5f5f7;
            min-height: 100vh;
        }
        
        .nav-bar {
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: saturate(180%) blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(139, 92, 246, 0.4);
            border-color: rgba(139, 92, 246, 0.3);
        }
        
        .content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--museum-purple), var(--museum-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        
        .budget-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
        }
        
        .summary-card h3 {
            font-size: 0.9rem;
            color: #999;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-amount {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .summary-change {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .summary-change.positive {
            color: var(--success);
        }
        
        .summary-change.negative {
            color: var(--urgent);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
        }
        
        .chart-card canvas {
            max-height: 350px !important;
            height: 350px !important;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .chart-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .budget-table {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .table-header {
            background: rgba(139, 92, 246, 0.1);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(255, 255, 255, 0.03);
        }
        
        th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.over {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .status-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .status-badge.good {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 100px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 100px;
            transition: width 0.3s ease;
        }
        
        .progress-fill.over {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
        
        .progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .progress-fill.good {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--museum-purple), var(--museum-pink));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-secondary {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.5);
            color: #a78bfa;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .budget-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Load Unified Navigation -->
    <div id="unified-navbar-container"></div>
    <script>
        fetch('/static/components/unified-navbar.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('unified-navbar-container').innerHTML = html;
            });
    </script>
    
    <div class="content">
        <div class="page-header">
            <h1 class="page-title">üí∞ ÏòàÏÇ∞ Í¥ÄÎ¶¨</h1>
            <p style="color: #999; font-size: 1.1rem;">Ï†ÑÏãúÎ≥Ñ ÏòàÏÇ∞ ÌòÑÌô©ÏùÑ ÌïúÎààÏóê ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>
        </div>
        
        <!-- Budget Summary -->
        <div class="budget-summary">
            <div class="summary-card">
                <h3>Ï¥ù ÏòàÏÇ∞</h3>
                <div class="summary-amount" id="total-budget">‚Ç©0</div>
                <div class="summary-change">
                    <i class="fas fa-info-circle"></i>
                    <span>2024ÎÖÑ Ï†ÑÏ≤¥ ÏòàÏÇ∞</span>
                </div>
            </div>
            
            <div class="summary-card">
                <h3>Ï¥ù ÏßÄÏ∂ú</h3>
                <div class="summary-amount" id="total-spent" style="color: var(--museum-pink);">‚Ç©0</div>
                <div class="summary-change">
                    <span id="spent-percentage">0%</span> ÏÇ¨Ïö©
                </div>
            </div>
            
            <div class="summary-card">
                <h3>ÎÇ®ÏùÄ ÏòàÏÇ∞</h3>
                <div class="summary-amount" id="remaining-budget" style="color: var(--success);">‚Ç©0</div>
                <div class="summary-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span id="remaining-percentage">0%</span> ÏûîÏó¨
                </div>
            </div>
            
            <div class="summary-card">
                <h3>ÏòàÏÇ∞ Ï¥àÍ≥º</h3>
                <div class="summary-amount" id="over-budget" style="color: var(--urgent);">‚Ç©0</div>
                <div class="summary-change negative">
                    <span id="over-budget-count">0</span>Í∞ú ÌîÑÎ°úÏ†ùÌä∏
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3>ÏõîÎ≥Ñ ÏòàÏÇ∞ ÏÇ¨Ïö© Ï∂îÏù¥</h3>
                    <button class="btn-secondary" onclick="exportMonthlyChart()" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                        <i class="fas fa-download"></i> ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                    </button>
                </div>
                <canvas id="monthly-budget-chart"></canvas>
            </div>
            
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Ï†ÑÏãú Ïú†ÌòïÎ≥Ñ ÏòàÏÇ∞ Î∂ÑÌè¨</h3>
                    <button class="btn-secondary" onclick="exportDistributionChart()" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                        <i class="fas fa-download"></i> ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                    </button>
                </div>
                <canvas id="budget-distribution-chart"></canvas>
            </div>
        </div>
        
        <!-- Budget Table -->
        <div class="budget-table">
            <div class="table-header">
                <h3 style="font-size: 1.25rem; font-weight: 600;">Ï†ÑÏãúÎ≥Ñ ÏòàÏÇ∞ ÌòÑÌô©</h3>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn-secondary" onclick="exportBudgetCSV()">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button class="btn-primary" onclick="exportBudgetReport()">
                        <i class="fas fa-file-excel"></i> Excel Î≥¥Í≥†ÏÑú
                    </button>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Ï†ÑÏãúÎ™Ö</th>
                        <th>Ïú†Ìòï</th>
                        <th>ÏòàÏÇ∞</th>
                        <th>ÏßÄÏ∂ú</th>
                        <th>ÏßÑÌñâÎ•†</th>
                        <th>ÏÉÅÌÉú</th>
                        <th>Ìé∏Ïßë</th>
                        <th>Ïù¥Î†•</th>
                    </tr>
                </thead>
                <tbody id="budget-table-body">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Mock budget data
        const budgetData = {
            projects: [
                { id: 1, name: 'ÌïúÍµ≠ ÎèÑÏûêÍ∏∞ ÌäπÎ≥ÑÏ†Ñ', type: 'ÌäπÎ≥ÑÏ†Ñ', budget: 50000000, spent: 45000000, status: 'warning' },
                { id: 2, name: 'ÌòÑÎåÄ ÎØ∏Ïà†Ïùò ÌùêÎ¶Ñ', type: 'ÏÉÅÏÑ§Ï†Ñ', budget: 30000000, spent: 28000000, status: 'good' },
                { id: 3, name: 'ÏÑ∏Í≥Ñ Î¨∏Ìôî Ïú†ÏÇ∞ ÏàúÌöåÏ†Ñ', type: 'ÏàúÌöåÏ†Ñ', budget: 80000000, spent: 85000000, status: 'over' },
                { id: 4, name: 'AI ÏïÑÌä∏ Í∏∞ÌöçÏ†Ñ', type: 'Í∏∞ÌöçÏ†Ñ', budget: 40000000, spent: 35000000, status: 'good' },
                { id: 5, name: 'Ïñ¥Î¶∞Ïù¥ Ï≤¥Ìóò ÍµêÏú°Ï†Ñ', type: 'ÍµêÏú°', budget: 25000000, spent: 20000000, status: 'good' }
            ],
            monthly: {
                labels: ['1Ïõî', '2Ïõî', '3Ïõî', '4Ïõî', '5Ïõî', '6Ïõî'],
                budget: [35000000, 40000000, 45000000, 50000000, 55000000, 60000000],
                spent: [32000000, 38000000, 42000000, 48000000, 53000000, 58000000]
            }
        };
        
        // Calculate summary
        function calculateSummary() {
            const totalBudget = budgetData.projects.reduce((sum, p) => sum + p.budget, 0);
            const totalSpent = budgetData.projects.reduce((sum, p) => sum + p.spent, 0);
            const remainingBudget = totalBudget - totalSpent;
            const overBudgetProjects = budgetData.projects.filter(p => p.spent > p.budget);
            const overBudgetAmount = overBudgetProjects.reduce((sum, p) => sum + (p.spent - p.budget), 0);
            
            document.getElementById('total-budget').textContent = formatCurrency(totalBudget);
            document.getElementById('total-spent').textContent = formatCurrency(totalSpent);
            document.getElementById('remaining-budget').textContent = formatCurrency(remainingBudget);
            document.getElementById('over-budget').textContent = formatCurrency(overBudgetAmount);
            
            document.getElementById('spent-percentage').textContent = ((totalSpent / totalBudget) * 100).toFixed(1) + '%';
            document.getElementById('remaining-percentage').textContent = ((remainingBudget / totalBudget) * 100).toFixed(1) + '%';
            document.getElementById('over-budget-count').textContent = overBudgetProjects.length;
        }
        
        // Format currency
        function formatCurrency(amount) {
            return '‚Ç©' + amount.toLocaleString();
        }
        
        // Render budget table
        function renderBudgetTable() {
            const tbody = document.getElementById('budget-table-body');
            tbody.innerHTML = budgetData.projects.map(project => {
                const percentage = (project.spent / project.budget) * 100;
                const statusClass = project.status;
                const statusText = project.status === 'over' ? 'Ï¥àÍ≥º' : project.status === 'warning' ? 'Ï£ºÏùò' : 'Ï†ïÏÉÅ';
                
                return `
                    <tr id="project-row-${project.id}">
                        <td><strong>${project.name}</strong></td>
                        <td>${project.type}</td>
                        <td>
                            <div class="inline-edit-container">
                                <span class="display-value">${formatCurrency(project.budget)}</span>
                                <input type="number" class="edit-input" data-field="budget" data-id="${project.id}" value="${project.budget}" style="display:none; width: 120px; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(139, 92, 246, 0.5); border-radius: 8px; color: white;">
                            </div>
                        </td>
                        <td>
                            <div class="inline-edit-container">
                                <span class="display-value">${formatCurrency(project.spent)}</span>
                                <input type="number" class="edit-input" data-field="spent" data-id="${project.id}" value="${project.spent}" style="display:none; width: 120px; padding: 0.5rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(236, 72, 153, 0.5); border-radius: 8px; color: white;">
                            </div>
                        </td>
                        <td>
                            <div>${percentage.toFixed(1)}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill ${statusClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td>
                            <button class="edit-btn" onclick="enableEditMode(${project.id})" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.5); color: #a78bfa; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-edit"></i> ÏàòÏ†ï
                            </button>
                            <button class="save-btn" onclick="saveBudgetChanges(${project.id})" style="display:none; background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-save"></i> Ï†ÄÏû•
                            </button>
                            <button class="cancel-btn" onclick="cancelEditMode(${project.id})" style="display:none; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: #f87171; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                        <td>
                            <button onclick="showBudgetHistory(${project.id}, '${project.name}')" style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); color: #60a5fa; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-history"></i> Ïù¥Î†•
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Enable inline edit mode for a project
        function enableEditMode(projectId) {
            const row = document.getElementById(`project-row-${projectId}`);
            const displayValues = row.querySelectorAll('.display-value');
            const editInputs = row.querySelectorAll('.edit-input');
            const editBtn = row.querySelector('.edit-btn');
            const saveBtn = row.querySelector('.save-btn');
            const cancelBtn = row.querySelector('.cancel-btn');
            
            displayValues.forEach(el => el.style.display = 'none');
            editInputs.forEach(el => el.style.display = 'inline-block');
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
        }
        
        // Cancel inline edit mode
        function cancelEditMode(projectId) {
            const row = document.getElementById(`project-row-${projectId}`);
            const displayValues = row.querySelectorAll('.display-value');
            const editInputs = row.querySelectorAll('.edit-input');
            const editBtn = row.querySelector('.edit-btn');
            const saveBtn = row.querySelector('.save-btn');
            const cancelBtn = row.querySelector('.cancel-btn');
            
            displayValues.forEach(el => el.style.display = 'inline');
            editInputs.forEach(el => el.style.display = 'none');
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }
        
        // Save budget changes via API
        async function saveBudgetChanges(projectId) {
            const row = document.getElementById(`project-row-${projectId}`);
            const budgetInput = row.querySelector('[data-field="budget"]');
            const spentInput = row.querySelector('[data-field="spent"]');
            
            const newBudget = parseInt(budgetInput.value) || 0;
            const newSpent = parseInt(spentInput.value) || 0;
            
            try {
                const result = await window.apiClient.projects.update(projectId, {
                    budget_total: newBudget,
                    budget_used: newSpent
                });
                
                if (result.success) {
                    // Update local data
                    const project = budgetData.projects.find(p => p.id === projectId);
                    const oldBudget = project ? project.budget : 0;
                    const oldSpent = project ? project.spent : 0;
                    
                    if (project) {
                        project.budget = newBudget;
                        project.spent = newSpent;
                        
                        // Recalculate status
                        const percentage = (newSpent / newBudget) * 100;
                        project.status = percentage >= 100 ? 'over' : percentage >= 90 ? 'warning' : 'good';
                    }
                    
                    // Save budget history to LocalStorage
                    saveBudgetHistory(projectId, project.name, {
                        oldBudget,
                        newBudget,
                        oldSpent,
                        newSpent,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Refresh UI
                    renderBudgetTable();
                    calculateSummary();
                    
                    if (window.notificationSystem) {
                        window.notificationSystem.showInAppNotification('ÏòàÏÇ∞Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§! ‚úÖ', 'success');
                    }
                    
                    // Warning if over budget
                    if (newSpent > newBudget) {
                        setTimeout(() => {
                            if (window.notificationSystem) {
                                window.notificationSystem.showInAppNotification('‚ö†Ô∏è ÏòàÏÇ∞ Ï¥àÍ≥º! ÏÇ¨Ïö© ÏòàÏÇ∞Ïù¥ Ï¥ù ÏòàÏÇ∞ÏùÑ Ï¥àÍ≥ºÌñàÏäµÎãàÎã§.', 'warning');
                            }
                        }, 500);
                    }
                }
            } catch (error) {
                console.error('Error updating budget:', error);
                if (window.notificationSystem) {
                    window.notificationSystem.showInAppNotification('ÏòàÏÇ∞ ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
                cancelEditMode(projectId);
            }
        }
        
        // Monthly budget chart
        function renderMonthlyBudgetChart() {
            const ctx = document.getElementById('monthly-budget-chart').getContext('2d');
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: budgetData.monthly.labels,
                    datasets: [
                        {
                            label: 'ÏòàÏÇ∞',
                            data: budgetData.monthly.budget,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'ÏßÄÏ∂ú',
                            data: budgetData.monthly.spent,
                            borderColor: '#ec4899',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#f5f5f7' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: '#999',
                                callback: function(value) {
                                    return '‚Ç©' + (value / 1000000) + 'M';
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#999' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }
        
        // Budget distribution chart
        function renderBudgetDistributionChart() {
            const ctx = document.getElementById('budget-distribution-chart').getContext('2d');
            
            const typeData = {};
            budgetData.projects.forEach(p => {
                typeData[p.type] = (typeData[p.type] || 0) + p.budget;
            });
            
            distributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeData),
                    datasets: [{
                        data: Object.values(typeData),
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#f5f5f7', padding: 20 }
                        }
                    }
                }
            });
        }
        
        // Store chart instances
        let monthlyChart = null;
        let distributionChart = null;
        
        // Export budget report (Excel)
        async function exportBudgetReport() {
            try {
                // Load SheetJS library
                if (!window.XLSX) {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => script.onload = resolve);
                }
                
                const wb = window.XLSX.utils.book_new();
                
                // Sheet 1: Summary
                const summaryData = [
                    ['ÏòàÏÇ∞ Í¥ÄÎ¶¨ Î≥¥Í≥†ÏÑú'],
                    ['ÏÉùÏÑ±Ïùº', new Date().toLocaleDateString('ko-KR')],
                    [],
                    ['Íµ¨Î∂Ñ', 'Í∏àÏï°'],
                    ['Ï¥ù ÏòàÏÇ∞', budgetData.projects.reduce((sum, p) => sum + p.budget, 0)],
                    ['Ï¥ù ÏßÄÏ∂ú', budgetData.projects.reduce((sum, p) => sum + p.spent, 0)],
                    ['ÎÇ®ÏùÄ ÏòàÏÇ∞', budgetData.projects.reduce((sum, p) => sum + p.budget, 0) - budgetData.projects.reduce((sum, p) => sum + p.spent, 0)],
                    ['ÏòàÏÇ∞ Ï¥àÍ≥ºÏï°', budgetData.projects.filter(p => p.spent > p.budget).reduce((sum, p) => sum + (p.spent - p.budget), 0)],
                    ['ÏòàÏÇ∞ Ï¥àÍ≥º ÌîÑÎ°úÏ†ùÌä∏ Ïàò', budgetData.projects.filter(p => p.spent > p.budget).length]
                ];
                const ws1 = window.XLSX.utils.aoa_to_sheet(summaryData);
                ws1['!cols'] = [{wch: 20}, {wch: 20}];
                window.XLSX.utils.book_append_sheet(wb, ws1, 'ÏöîÏïΩ');
                
                // Sheet 2: Project List
                const projectData = [
                    ['Ï†ÑÏãúÎ™Ö', 'Ïú†Ìòï', 'ÏòàÏÇ∞', 'ÏßÄÏ∂ú', 'ÏßÑÌñâÎ•†(%)', 'ÏÉÅÌÉú']
                ];
                budgetData.projects.forEach(p => {
                    projectData.push([
                        p.name,
                        p.type,
                        p.budget,
                        p.spent,
                        ((p.spent / p.budget) * 100).toFixed(1),
                        p.status === 'over' ? 'Ï¥àÍ≥º' : p.status === 'warning' ? 'Ï£ºÏùò' : 'Ï†ïÏÉÅ'
                    ]);
                });
                const ws2 = window.XLSX.utils.aoa_to_sheet(projectData);
                ws2['!cols'] = [{wch: 30}, {wch: 12}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 10}];
                window.XLSX.utils.book_append_sheet(wb, ws2, 'ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù');
                
                // Sheet 3: Type Statistics
                const typeData = {};
                budgetData.projects.forEach(p => {
                    if (!typeData[p.type]) {
                        typeData[p.type] = { budget: 0, spent: 0, count: 0 };
                    }
                    typeData[p.type].budget += p.budget;
                    typeData[p.type].spent += p.spent;
                    typeData[p.type].count += 1;
                });
                
                const typeStatsData = [
                    ['Ïú†ÌòïÎ≥Ñ ÏòàÏÇ∞ ÌÜµÍ≥Ñ'],
                    [],
                    ['Ïú†Ìòï', 'ÌîÑÎ°úÏ†ùÌä∏ Ïàò', 'Ï¥ù ÏòàÏÇ∞', 'Ï¥ù ÏßÄÏ∂ú', 'ÏÇ¨Ïö©Î•†(%)']
                ];
                Object.entries(typeData).forEach(([type, data]) => {
                    typeStatsData.push([
                        type,
                        data.count,
                        data.budget,
                        data.spent,
                        ((data.spent / data.budget) * 100).toFixed(1)
                    ]);
                });
                const ws3 = window.XLSX.utils.aoa_to_sheet(typeStatsData);
                ws3['!cols'] = [{wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}];
                window.XLSX.utils.book_append_sheet(wb, ws3, 'Ïú†ÌòïÎ≥Ñ ÌÜµÍ≥Ñ');
                
                // Sheet 4: Monthly Trend
                const monthlyData = [
                    ['ÏõîÎ≥Ñ ÏòàÏÇ∞ ÏÇ¨Ïö© Ï∂îÏù¥'],
                    [],
                    ['Ïõî', 'ÏòàÏÇ∞', 'ÏßÄÏ∂ú']
                ];
                budgetData.monthly.labels.forEach((label, i) => {
                    monthlyData.push([
                        label,
                        budgetData.monthly.budget[i],
                        budgetData.monthly.spent[i]
                    ]);
                });
                const ws4 = window.XLSX.utils.aoa_to_sheet(monthlyData);
                ws4['!cols'] = [{wch: 10}, {wch: 15}, {wch: 15}];
                window.XLSX.utils.book_append_sheet(wb, ws4, 'ÏõîÎ≥Ñ Ï∂îÏù¥');
                
                // Download
                const fileName = `ÏòàÏÇ∞Í¥ÄÎ¶¨_Î≥¥Í≥†ÏÑú_${new Date().toISOString().split('T')[0]}.xlsx`;
                window.XLSX.writeFile(wb, fileName);
                
                if (window.notificationSystem) {
                    notificationSystem.showInAppNotification('‚úÖ ÏòàÏÇ∞ Î≥¥Í≥†ÏÑúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!', 'success');
                } else {
                    alert('‚úÖ ÏòàÏÇ∞ Î≥¥Í≥†ÏÑúÍ∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§!');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå Î≥¥Í≥†ÏÑú ÏÉùÏÑ± Ïã§Ìå®: ' + error.message);
            }
        }
        
        // Export monthly chart as image
        async function exportMonthlyChart() {
            if (monthlyChart) {
                const base64Image = monthlyChart.toBase64Image();
                const link = document.createElement('a');
                link.href = base64Image;
                link.download = `ÏõîÎ≥Ñ_ÏòàÏÇ∞_Ï∂îÏù¥_${new Date().toISOString().split('T')[0]}.png`;
                link.click();
                
                if (window.notificationSystem) {
                    notificationSystem.showInAppNotification('‚úÖ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄÍ∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§!', 'success');
                }
            }
        }
        
        // Export distribution chart as image
        async function exportDistributionChart() {
            if (distributionChart) {
                const base64Image = distributionChart.toBase64Image();
                const link = document.createElement('a');
                link.href = base64Image;
                link.download = `Ïú†ÌòïÎ≥Ñ_ÏòàÏÇ∞_Î∂ÑÌè¨_${new Date().toISOString().split('T')[0]}.png`;
                link.click();
                
                if (window.notificationSystem) {
                    notificationSystem.showInAppNotification('‚úÖ Ï∞®Ìä∏ Ïù¥ÎØ∏ÏßÄÍ∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§!', 'success');
                }
            }
        }
        
        // Export as CSV
        function exportBudgetCSV() {
            const headers = ['Ï†ÑÏãúÎ™Ö', 'Ïú†Ìòï', 'ÏòàÏÇ∞', 'ÏßÄÏ∂ú', 'ÏßÑÌñâÎ•†(%)', 'ÏÉÅÌÉú'];
            const rows = budgetData.projects.map(p => [
                p.name,
                p.type,
                p.budget,
                p.spent,
                ((p.spent / p.budget) * 100).toFixed(1),
                p.status === 'over' ? 'Ï¥àÍ≥º' : p.status === 'warning' ? 'Ï£ºÏùò' : 'Ï†ïÏÉÅ'
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ÏòàÏÇ∞Í¥ÄÎ¶¨_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            if (window.notificationSystem) {
                notificationSystem.showInAppNotification('‚úÖ CSV ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§!', 'success');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Load real data from D1 database
            await loadRealBudgetData();
            
            calculateSummary();
            renderBudgetTable();
            
            // Delay chart rendering to ensure canvas is ready
            setTimeout(() => {
                renderMonthlyBudgetChart();
                renderBudgetDistributionChart();
            }, 100);
        });
        
        async function loadRealBudgetData() {
            try {
                // Fetch projects from API
                const result = await window.apiClient.projects.list();
                
                if (result.success && result.data) {
                    console.log('‚úÖ Loaded real budget data:', result.data.length, 'projects');
                    
                    // Update budgetData with real projects
                    budgetData.length = 0; // Clear demo data
                    
                    result.data.forEach(project => {
                        budgetData.push({
                            id: project.id,
                            name: project.title,
                            allocated: project.budget_total || 0,
                            spent: project.budget_used || 0,
                            category: project.type || 'exhibition',
                            status: getProjectStatus(project),
                            lastUpdated: project.updated_at || project.created_at
                        });
                    });
                    
                    console.log('‚úÖ Budget data updated with', budgetData.length, 'real projects');
                }
            } catch (error) {
                console.error('Error loading budget data:', error);
                // Keep demo data if API fails
            }
        }
        
        function getProjectStatus(project) {
            if (!project.budget_total || project.budget_total === 0) return 'Í≥ÑÌöçÏ§ë';
            
            const usagePercent = (project.budget_used / project.budget_total) * 100;
            
            if (usagePercent >= 90) return 'Ï¥àÍ≥ºÏúÑÌóò';
            if (usagePercent >= 70) return 'Ï£ºÏùò';
            if (project.phase === 'completed') return 'ÏôÑÎ£å';
            return 'ÏßÑÌñâÏ§ë';
        }
        
        // ========================================================================
        // Budget History Tracking
        // ========================================================================
        
        function saveBudgetHistory(projectId, projectName, change) {
            const historyKey = `budget_history_${projectId}`;
            let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            
            history.unshift({
                ...change,
                projectName,
                user: 'admin@museflow.com',
                timestamp: change.timestamp || new Date().toISOString()
            });
            
            // Keep last 50 records
            if (history.length > 50) history = history.slice(0, 50);
            
            localStorage.setItem(historyKey, JSON.stringify(history));
        }
        
        function showBudgetHistory(projectId, projectName) {
            const historyKey = `budget_history_${projectId}`;
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); z-index: 3000; padding: 2rem; overflow-y: auto;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div style="max-width: 900px; margin: 0 auto; background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 24px; padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.75rem; font-weight: 700; color: white;">
                            <i class="fas fa-history" style="color: #60a5fa;"></i>
                            ÏòàÏÇ∞ Î≥ÄÍ≤Ω Ïù¥Î†• - ${projectName}
                        </h2>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; color: rgba(255, 255, 255, 0.6); font-size: 1.5rem; cursor: pointer; padding: 0.5rem;">&times;</button>
                    </div>
                    
                    ${history.length === 0 ? `
                        <div style="text-align: center; padding: 4rem; color: rgba(255, 255, 255, 0.5);">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p style="font-size: 1.1rem;">ÏïÑÏßÅ ÏòàÏÇ∞ Î≥ÄÍ≤Ω Ïù¥Î†•Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">ÏòàÏÇ∞ÏùÑ ÏàòÏ†ïÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Í∏∞Î°ùÎê©ÎãàÎã§.</p>
                        </div>
                    ` : `
                        <div style="position: relative; padding-left: 2rem;">
                            <div style="position: absolute; left: 0.5rem; top: 0; bottom: 0; width: 2px; background: linear-gradient(180deg, #60a5fa, rgba(96, 165, 250, 0.1));"></div>
                            
                            ${history.map((record, index) => {
                                const budgetChange = record.newBudget - record.oldBudget;
                                const spentChange = record.newSpent - record.oldSpent;
                                const date = new Date(record.timestamp);
                                const dateStr = date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                                
                                return `
                                    <div style="position: relative; margin-bottom: 2rem; padding-left: 2rem;">
                                        <div style="position: absolute; left: -0.75rem; width: 1.5rem; height: 1.5rem; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #3b82f6); border: 3px solid #1a1a2e;"></div>
                                        
                                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1.5rem;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                                <div>
                                                    <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.875rem;">
                                                        <i class="fas fa-clock"></i> ${dateStr}
                                                    </div>
                                                    <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem; margin-top: 0.25rem;">
                                                        <i class="fas fa-user"></i> ${record.user || 'System'}
                                                    </div>
                                                </div>
                                                <span style="background: rgba(59, 130, 246, 0.2); padding: 0.25rem 0.75rem; border-radius: 100px; font-size: 0.8rem; color: #60a5fa; font-weight: 600;">
                                                    #${history.length - index}
                                                </span>
                                            </div>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                                <div>
                                                    <div style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem; margin-bottom: 0.5rem;">Ï¥ù ÏòàÏÇ∞</div>
                                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <span style="color: rgba(255, 255, 255, 0.7);">‚Ç©${(record.oldBudget / 1000000).toFixed(1)}M</span>
                                                        <i class="fas fa-arrow-right" style="color: rgba(255, 255, 255, 0.3); font-size: 0.8rem;"></i>
                                                        <span style="color: white; font-weight: 600;">‚Ç©${(record.newBudget / 1000000).toFixed(1)}M</span>
                                                        ${budgetChange !== 0 ? `
                                                            <span style="color: ${budgetChange > 0 ? '#10b981' : '#ef4444'}; font-size: 0.9rem; font-weight: 600;">
                                                                ${budgetChange > 0 ? '+' : ''}${(budgetChange / 1000000).toFixed(1)}M
                                                            </span>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <div style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem; margin-bottom: 0.5rem;">ÏÇ¨Ïö© ÏòàÏÇ∞</div>
                                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                        <span style="color: rgba(255, 255, 255, 0.7);">‚Ç©${(record.oldSpent / 1000000).toFixed(1)}M</span>
                                                        <i class="fas fa-arrow-right" style="color: rgba(255, 255, 255, 0.3); font-size: 0.8rem;"></i>
                                                        <span style="color: white; font-weight: 600;">‚Ç©${(record.newSpent / 1000000).toFixed(1)}M</span>
                                                        ${spentChange !== 0 ? `
                                                            <span style="color: ${spentChange > 0 ? '#ef4444' : '#10b981'}; font-size: 0.9rem; font-weight: 600;">
                                                                ${spentChange > 0 ? '+' : ''}${(spentChange / 1000000).toFixed(1)}M
                                                            </span>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
            
            document.body.appendChild(modal);
        }
    </script>
    
    <!-- Notification System -->
    <script src="/static/js/notification-system.js"></script>
    
    <!-- Floating Action Button -->
    <script src="/static/js/components/floating-action.js"></script>
    <script src="/static/js/api-client-d1.js"></script>
</body>
</html>
